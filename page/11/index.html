<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="前端 web react" />
       
      <meta name="description" content="前端技术与生活。" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 四月八日</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">
 
<link rel="stylesheet" href="/css/fonts/remixicon.css">
 
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="/js/pace.min.js"></script>
       
 

      <link rel="stylesheet" href="/css/bulma.min.css" />
      <script src="/js/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <script src="https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js"></script>
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/katex.min.css">

<link rel="stylesheet" href="/css/style.css">
<!-- hexo injector head_end end --></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">四月八日</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['愿你足够强大，也要足够温柔', '最轻的并不是一根羽毛，而是一双飞鸟的翅膀', ''],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="post-devops/StyleLint配置指南"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/d81239d4645c/"
    >StyleLint配置指南</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/d81239d4645c/" class="article-date">
  <time datetime="2021-09-13T03:02:29.000Z" itemprop="datePublished">2021-09-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/DevOps/">DevOps</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="基础包"><a href="#基础包" class="headerlink" title="基础包"></a>基础包</h4><p><a target="_blank" rel="noopener" href="https://stylelint.io/user-guide/get-started">stylelint</a> 有力的，现代的 lint 工具，帮助你在 style 中避免错误， 按照约定转换会规则。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/stylelint/stylelint-config-standard">stylelint-config-standard</a> stylelint 配置共享库，可以通过 rules 覆盖规则</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hudochenkov/stylelint-order">stylelint-order</a> 一个为 stylelint 规则排序的插件包</p>
<p><a target="_blank" rel="noopener" href="https://github.com/bjankord/stylelint-config-sass-guidelines">stylelint-config-sass-guidelines</a> 如果你写 SCSS 可以用这个包</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kristerkari/stylelint-scss">stylelint-scss</a> 一个SCSS的规则集合</p>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;extends&quot;</span>: <span class="string">&quot;stylelint-config-sass-guidelines&quot;</span>,</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;stylelint-scss&quot;</span>,</span><br><span class="line">    <span class="string">&quot;stylelint-order&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;rules&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;order/properties-order&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;position&quot;</span>,</span><br><span class="line">      <span class="string">&quot;top&quot;</span>,</span><br><span class="line">      <span class="string">&quot;right&quot;</span>,</span><br><span class="line">      <span class="string">&quot;bottom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;left&quot;</span>,</span><br><span class="line">      <span class="string">&quot;z-index&quot;</span>,</span><br><span class="line">      <span class="string">&quot;display&quot;</span>,</span><br><span class="line">      <span class="string">&quot;justify-content&quot;</span>,</span><br><span class="line">      <span class="string">&quot;align-items&quot;</span>,</span><br><span class="line">      <span class="string">&quot;float&quot;</span>,</span><br><span class="line">      <span class="string">&quot;clear&quot;</span>,</span><br><span class="line">      <span class="string">&quot;overflow&quot;</span>,</span><br><span class="line">      <span class="string">&quot;overflow-x&quot;</span>,</span><br><span class="line">      <span class="string">&quot;overflow-y&quot;</span>,</span><br><span class="line">      <span class="string">&quot;margin&quot;</span>,</span><br><span class="line">      <span class="string">&quot;margin&quot;</span>,</span><br><span class="line">      <span class="string">&quot;margin-top&quot;</span>,</span><br><span class="line">      <span class="string">&quot;margin-right&quot;</span>,</span><br><span class="line">      <span class="string">&quot;margin-bottom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;margin-left&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-style&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-width&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-color&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-top&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-top-style&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-top-width&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-top-color&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-right&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-right-style&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-right-width&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-right-color&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-bottom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-bottom-style&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-bottom-width&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-bottom-color&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-left&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-left-style&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-left-width&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-left-color&quot;</span>,</span><br><span class="line">      <span class="string">&quot;border-radius&quot;</span>,</span><br><span class="line">      <span class="string">&quot;padding&quot;</span>,</span><br><span class="line">      <span class="string">&quot;padding-top&quot;</span>,</span><br><span class="line">      <span class="string">&quot;padding-right&quot;</span>,</span><br><span class="line">      <span class="string">&quot;padding-bottom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;padding-left&quot;</span>,</span><br><span class="line">      <span class="string">&quot;width&quot;</span>,</span><br><span class="line">      <span class="string">&quot;min-width&quot;</span>,</span><br><span class="line">      <span class="string">&quot;max-width&quot;</span>,</span><br><span class="line">      <span class="string">&quot;height&quot;</span>,</span><br><span class="line">      <span class="string">&quot;min-height&quot;</span>,</span><br><span class="line">      <span class="string">&quot;max-height&quot;</span>,</span><br><span class="line">      <span class="string">&quot;font-size&quot;</span>,</span><br><span class="line">      <span class="string">&quot;font-family&quot;</span>,</span><br><span class="line">      <span class="string">&quot;font-weight&quot;</span>,</span><br><span class="line">      <span class="string">&quot;text-align&quot;</span>,</span><br><span class="line">      <span class="string">&quot;text-justify&quot;</span>,</span><br><span class="line">      <span class="string">&quot;text-indent&quot;</span>,</span><br><span class="line">      <span class="string">&quot;text-overflow&quot;</span>,</span><br><span class="line">      <span class="string">&quot;text-decoration&quot;</span>,</span><br><span class="line">      <span class="string">&quot;white-space&quot;</span>,</span><br><span class="line">      <span class="string">&quot;color&quot;</span>,</span><br><span class="line">      <span class="string">&quot;background&quot;</span>,</span><br><span class="line">      <span class="string">&quot;background-position&quot;</span>,</span><br><span class="line">      <span class="string">&quot;background-repeat&quot;</span>,</span><br><span class="line">      <span class="string">&quot;background-size&quot;</span>,</span><br><span class="line">      <span class="string">&quot;background-color&quot;</span>,</span><br><span class="line">      <span class="string">&quot;background-clip&quot;</span>,</span><br><span class="line">      <span class="string">&quot;opacity&quot;</span>,</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>,</span><br><span class="line">      <span class="string">&quot;list-style&quot;</span>,</span><br><span class="line">      <span class="string">&quot;outline&quot;</span>,</span><br><span class="line">      <span class="string">&quot;visibility&quot;</span>,</span><br><span class="line">      <span class="string">&quot;box-shadow&quot;</span>,</span><br><span class="line">      <span class="string">&quot;text-shadow&quot;</span>,</span><br><span class="line">      <span class="string">&quot;resize&quot;</span>,</span><br><span class="line">      <span class="string">&quot;transition&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="忽略配置"><a href="#忽略配置" class="headerlink" title="忽略配置"></a>忽略配置</h4><ul>
<li>忽略整个文件，在首行加入 <code>/* stylelint-disable */</code></li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/* stylelint-disable */</span><br><span class="line">html &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>忽略多行</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/* stylelint-disable */</span><br><span class="line">html &#123;&#125;</span><br><span class="line">.div &#123;</span><br><span class="line">    color: red;</span><br><span class="line">&#125;</span><br><span class="line">/* stylelint-enable */</span><br></pre></td></tr></table></figure>

<ul>
<li>忽略一行， 在样式前加入 <code>/* stylelint-disable-next-line */</code> 以忽略该行</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#id &#123;</span><br><span class="line">  /* stylelint-disable-next-line */</span><br><span class="line">  color: pink !important;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>.stylelintrc.json</code> 配置文件</li>
</ul>
<h4 id="自动格式化"><a href="#自动格式化" class="headerlink" title="自动格式化"></a>自动格式化</h4><ul>
<li><p>安裝 StyleLint</p>
</li>
<li><p>在 settings.json 文件设置</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;editor.codeActionsOnSave&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;source.fixAll.stylelint&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="与-Prettier-结合"><a href="#与-Prettier-结合" class="headerlink" title="与 Prettier 结合"></a>与 Prettier 结合</h4><p><a target="_blank" rel="noopener" href="https://github.com/prettier/stylelint-prettier">stylelint-prettier</a> 让 Prettier 作为 StyleLint 的规则，并让 StyleLint 统一报错</p>
<p><a target="_blank" rel="noopener" href="https://github.com/prettier/stylelint-config-prettier">stylelint-config-prettier</a> 关闭所有可能冲突的配置</p>
<p>配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;extends&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;stylelint-config-sass-guidelines&quot;</span>,</span><br><span class="line">    <span class="string">&quot;stylelint-prettier/recommended&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;stylelint-scss&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-devops/Prettire配置指南"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/cbc0dbaf8f33/"
    >Prettire配置指南</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/cbc0dbaf8f33/" class="article-date">
  <time datetime="2021-09-12T13:50:39.000Z" itemprop="datePublished">2021-09-12</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/DevOps/">DevOps</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="基础库"><a href="#基础库" class="headerlink" title="基础库"></a>基础库</h4><p><a target="_blank" rel="noopener" href="https://github.com/prettier/prettier">prettier</a> 定义并实现了基本规则</p>
<p><a target="_blank" rel="noopener" href="https://github.com/prettier/eslint-config-prettier">eslint-config-prettier</a> 关闭所有可能和 <code>prettier</code> 有冲突的规则</p>
<p><a target="_blank" rel="noopener" href="https://github.com/prettier/eslint-plugin-prettier">eslint-plugin-prettier</a> 屏蔽了冲突规则之后，仍然想让<code>eslint</code>统一报错信息</p>
<p><a target="_blank" rel="noopener" href="https://github.com/prettier/prettier-eslint">prettier-eslint</a> 可以通过 <code>eslint --fix</code> 来使用 <code>prettier</code> 格式化代码</p>
<p><a target="_blank" rel="noopener" href="https://github.com/prettier/prettier-eslint-cli">prettier-eslint-cli</a> 以 cli 方式执行<code>prettier-eslint</code></p>
<h4 id="Prettier-影响的规则"><a href="#Prettier-影响的规则" class="headerlink" title="Prettier 影响的规则"></a>Prettier 影响的规则</h4><p><a target="_blank" rel="noopener" href="https://prettier.io/docs/en/options.html">规则</a></p>
<h4 id="Prettier-配置文件"><a href="#Prettier-配置文件" class="headerlink" title="Prettier 配置文件"></a>Prettier 配置文件</h4><p>一共有三种方式支持对 Prettier 进行配置：</p>
<ul>
<li>根目录创建.prettierrc 文件，能够写入 YML、JSON 的配置格式，并且支持.yaml&#x2F;.yml&#x2F;.json&#x2F;.js 后缀；</li>
<li>根目录创建.prettier.config.js 文件，并对外 export 一个对象；</li>
<li>在 package.json 中新建 prettier 属性。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://prettier.io/docs/en/options.html">更多配置</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;singleQuote&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;semi&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;printWidth&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;useTabs&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="与-ESLint-结合"><a href="#与-ESLint-结合" class="headerlink" title="与 ESLint 结合"></a>与 ESLint 结合</h4><p>安装 prettier 插件</p>
<p><a href="/posts/ef51be94/">ESLint 配置指南</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-devops/ESLint配置指南"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/87a060953f56/"
    >ESLint配置指南</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/87a060953f56/" class="article-date">
  <time datetime="2021-09-12T11:05:29.000Z" itemprop="datePublished">2021-09-12</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/DevOps/">DevOps</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="基础包"><a href="#基础包" class="headerlink" title="基础包"></a>基础包</h4><p><a target="_blank" rel="noopener" href="https://github.com/eslint/eslint">ESLint</a>: lint 代码的主要工具，所以的一切都是基于此包</p>
<h4 id="解析器-parser"><a href="#解析器-parser" class="headerlink" title="解析器(parser)"></a>解析器(parser)</h4><p><a target="_blank" rel="noopener" href="https://github.com/babel/babel-eslint">babel-eslint</a> 已经变更为 <a target="_blank" rel="noopener" href="https://github.com/babel/babel/tree/main/eslint/babel-eslint-parser">@babel&#x2F;eslint-parser</a>: 该依赖包允许你使用一些实验特性的时候，依然能够用上 ESlint 语法检查。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/typescript-eslint/typescript-eslint/tree/master/packages/parser">@typescript-eslint&#x2F;parser</a>: 与<code>@babel/eslint-parser</code>类似，如果你使用 typescript,需要使用 typescript 专有的解析器</p>
<h4 id="扩展的配置"><a href="#扩展的配置" class="headerlink" title="扩展的配置"></a>扩展的配置</h4><p><a target="_blank" rel="noopener" href="https://github.com/airbnb/javascript/tree/master/packages/eslint-config-airbnb">eslint-config-airbnb</a>: 提供了 Airbnb 的 eslintrc 作为可扩展的共享配置。默认导出包含我们所有的 ESLint 规则，包括 ECMAScript 6+ 和 React。引入了 <code>eslint</code>，<code>eslint-plugin-import</code>，<code>eslint-plugin-react</code>，<code>eslint-plugin-react-hooks</code>，和 <code>eslint-plugin-jsx-a11y</code>。如果您不需要 React，请使用<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/eslint-config-airbnb-base">eslint-config-airbnb-base</a>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/enzymejs/enzyme-matchers/tree/master/packages/eslint-config-jest-enzyme">eslint-config-jest-enzyme</a>: 只用当你使用<a target="_blank" rel="noopener" href="https://github.com/enzymejs/enzyme-matchers/tree/master/packages/jest-environment-enzyme">jest-environment-enzyme</a> 这个库的时候，这个扩展才会有效，使用 <code>jest-environment-enzyme</code> 时有一些全局变量，这个规则可以让 <code>eslint</code> 不报警告。</p>
<h4 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h4><p><a href="@babel/eslint-plugin">eslint-plugin-babel</a> 已经变更为 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@babel/eslint-plugin">@babel&#x2F;eslint-plugin</a>: 和 babel-eslint 一起用的一款插件.babel-eslint 在将 eslint 应用于 Babel 方面做得很好，但是它不能更改内置规则来支持实验性特性。eslint-plugin-babel 重新实现了有问题的规则，因此就不会误报一些错误信息</p>
<p><a target="_blank" rel="noopener" href="https://github.com/import-js/eslint-plugin-import#sublimelinter-eslint">eslint-plugin-import</a> 该插目的是要支持对 ES2015+ (ES6+) import&#x2F;export 语法的校验, 并防止一些文件路径拼错或者是导入名称错误的情况</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jsx-eslint/eslint-plugin-jsx-a11y">eslint-plugin-jsx-a11y</a> 在 JSX 元素上，对可访问性规则进行静态 AST 检查。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/import-js/eslint-plugin-import/tree/main/resolvers/webpack">eslint-import-resolver-webpack</a> 在 webpack 项目之中， 我们会借助 alias 别名提升代码效率和打包效率。但是在使用了自定义的路径指向后，eslint 就会对应产生找不到模块的报错。这时候就需要<code>eslint-import-resolver-webpack</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alexgorbatchev/eslint-import-resolver-typescript">eslint-import-resolver-typescript</a> 和 eslint-import-resolver-webpack 类似，主要是为了解决 alias 的问题</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yannickcr/eslint-plugin-react">eslint-plugin-react</a> React 专用的校验规则插件.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jest-community/eslint-plugin-jest">eslint-plugin-jest</a> Jest 专用的 Eslint 规则校验插件.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/prettier/eslint-plugin-prettier">eslint-plugin-prettier</a> 该插件辅助 Eslint 可以平滑地与 Prettier 一起协作，并将 Prettier 的解析作为 Eslint 的一部分，在最后的输出可以给出修改意见。这样当 Prettier 格式化代码的时候，依然能够遵循我们的 Eslint 规则。如果你禁用掉了所有和代码格式化相关的 Eslint 规则的话，该插件可以更好得工作。所以你可以使用 eslint-config-prettier 禁用掉所有的格式化相关的规则(如果其他有效的 Eslint 规则与 prettier 在代码如何格式化的问题上不一致的时候，报错是在所难免的了)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/typescript-eslint/typescript-eslint/tree/master/packages/eslint-plugin">@typescript-eslint&#x2F;eslint-plugin</a> Typescript 辅助 Eslint 的插件。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/typescript-eslint/typescript-eslint/tree/master/packages/eslint-plugin">eslint-plugin-promise</a> promise 规范写法检查插件，附带了一些校验规则。</p>
<h4 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a>其他工具</h4><p><a target="_blank" rel="noopener" href="https://github.com/typicode/husky">husky</a> git 命令 hook 专用配置.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/okonet/lint-staged">lint-staged</a> 可以定制在特定的 git 阶段执行特定的命令。</p>
<h4 id="ESLint-配置文件"><a href="#ESLint-配置文件" class="headerlink" title="ESLint 配置文件"></a>ESLint 配置文件</h4><p><a target="_blank" rel="noopener" href="https://eslint.org/docs/user-guide/configuring/">ESLint 配置</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> =  &#123;</span><br><span class="line">  <span class="comment">// 表示eslint检查只在当前目录生效</span></span><br><span class="line">  <span class="attr">root</span>:<span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认ESlint使用Espree作为解析器，但是一旦我们使用babel的话，我们需要用@babel/eslint-parser。</span></span><br><span class="line">  <span class="comment">// 如果使用TS，则使用 @typescript-eslint/parser</span></span><br><span class="line">  <span class="comment">// Specifies the ESLint parser</span></span><br><span class="line">  <span class="attr">parser</span>:  <span class="string">&#x27;@babel/eslint-parser&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">parserOptions</span>: &#123;</span><br><span class="line">    <span class="comment">// ecmaVersion: 默认值是5，可以设置为3、5、6、7、8、9、10，用来指定使用哪一个ECMAScript版本的 // 语法。也可以设置基于年份的JS标准，比如2015(ECMA 6),也可以设置 latest 使用最近支持的版本</span></span><br><span class="line">    <span class="comment">// specify the version of ECMAScript syntax you want to use: 2015 =&gt; (ES6)</span></span><br><span class="line">    <span class="attr">ecmaVersion</span>: <span class="string">&#x27;latest&#x27;</span>,</span><br><span class="line">    <span class="comment">// 如果你的代码是ECMAScript 模块写的，该字段配置为module，否则为script(默认值)</span></span><br><span class="line">    <span class="attr">sourceType</span>:  <span class="string">&#x27;module&#x27;</span>,  <span class="comment">// Allows for the use of imports</span></span><br><span class="line">    <span class="comment">// 额外的语言特性</span></span><br><span class="line">    <span class="attr">ecmaFeatures</span>: &#123;</span><br><span class="line">      <span class="attr">jsx</span>: <span class="literal">true</span>, <span class="comment">// enable JSX</span></span><br><span class="line">      <span class="attr">impliedStrict</span>: <span class="literal">true</span> <span class="comment">// enable global strict mode</span></span><br><span class="line">    &#125;，</span><br><span class="line">      <span class="comment">// babel 文件路径</span></span><br><span class="line">    <span class="attr">babelOptions</span>: &#123;</span><br><span class="line">      <span class="attr">configFile</span>: <span class="string">&#x27;./.babelrc&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 指定扩展的配置，配置支持递归扩展，支持规则的覆盖和聚合。</span></span><br><span class="line">  <span class="attr">extends</span>:  [</span><br><span class="line">    <span class="comment">// // Uses airbnb, it including the react rule(eslint-plugin-react/eslint-plugin-jsx-a11y)</span></span><br><span class="line">    <span class="string">&#x27;airbnb&#x27;</span>,</span><br><span class="line">    <span class="comment">// prettier规则额放在最后需要覆盖默认规则</span></span><br><span class="line">    <span class="string">&#x27;plugin:prettier/recommended&#x27;</span>,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 字段定义的数据可以在所有的插件中共享。这样每条规则执行的时候都可以访问这里面定义的数据</span></span><br><span class="line">  <span class="attr">settings</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;import/resolver&#x27;</span>: &#123; <span class="comment">// This config is used by eslint-import-resolver-webpack</span></span><br><span class="line">      <span class="attr">webpack</span>: &#123;</span><br><span class="line">        <span class="attr">config</span>: <span class="string">&#x27;./webpack/webpack-common-config.js&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 环境可以提供的全局变量</span></span><br><span class="line">  <span class="attr">env</span>: &#123;</span><br><span class="line">    <span class="comment">// enable all browser global variables</span></span><br><span class="line">    <span class="attr">browser</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置那些我们想要Linting规则的插件。</span></span><br><span class="line">  <span class="comment">// plugins: [&#x27;react-hooks&#x27;, &#x27;promise&#x27;],</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义规则，可以覆盖掉extends的配置。</span></span><br><span class="line">  <span class="attr">rules</span>:  &#123;</span><br><span class="line">    <span class="string">&#x27;no-debugger&#x27;</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span> ? <span class="string">&#x27;error&#x27;</span> : <span class="string">&#x27;off&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="VSCode-使用-eslint-自动修复"><a href="#VSCode-使用-eslint-自动修复" class="headerlink" title="VSCode 使用 eslint 自动修复"></a>VSCode 使用 eslint 自动修复</h4><ul>
<li><p>下载插件 <code>eslint</code></p>
</li>
<li><p>在<code>setting.json</code>开启 eslint 自动修复配置</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;editor.codeActionsOnSave&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;source.fixAll.eslint&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-devops/ESLint和Prettier区别"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/02f0336782db/"
    >ESLint 和 Prettier 区别</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/02f0336782db/" class="article-date">
  <time datetime="2021-09-10T16:15:41.000Z" itemprop="datePublished">2021-09-11</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/DevOps/">DevOps</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="ESLint-是什么呢？"><a href="#ESLint-是什么呢？" class="headerlink" title="ESLint 是什么呢？"></a>ESLint 是什么呢？</h4><p>是一个开源的 JavaScript 的 linting 工具，使用 espree 将 JavaScript 代码解析成抽象语法树 (AST)，然后通过AST 来分析我们代码，从而给予我们两种提示：</p>
<ul>
<li>代码质量问题：使用方式有可能有问题(problematic patterns)</li>
<li>代码风格问题：风格不符合一定规则 (doesn’t adhere to certain style guidelines)<br>(这里的两种问题的分类很重要，下面会主要讲）</li>
</ul>
<p>你可能开始为了缩进问题配置了一个规则</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc    </span></span><br><span class="line"><span class="punctuation">&#123;</span>        </span><br><span class="line">    <span class="attr">&quot;indent&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;error&quot;</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span>    </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>还安装了 ESLint 的 VSCode 插件，没有通过 ESLint 校验的代码 VSCode 会给予下滑波浪线提示。</p>
</li>
<li><p>为了万无一失，你还添加一个 <code>pre-commit</code> 钩子 <code>eslint --ext .js src</code>，确保没有通过 lint 的代码不会被提交。</p>
</li>
<li><p>更让人开心的是，之前不统一的代码也能通过 eslint –fix 来修改成新的格式。</p>
</li>
</ul>
<h4 id="Airbnb-Style-Guide"><a href="#Airbnb-Style-Guide" class="headerlink" title="Airbnb Style Guide"></a>Airbnb Style Guide</h4><p>配置完了缩进之后你可能又会发现有人写大括号的时候不会换行。最终你找到了一个和你有一样困惑的公司Airbnb,并且他们自行讨论出一套完整的校验规则。你 <code>install</code> 了 <code>eslint-config-airbnb</code> ，并且将 <code>.eslintrc</code> 文件改成了下面这样，终于大功告成。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;extends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;airbnb&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Prettier"><a href="#Prettier" class="headerlink" title="Prettier"></a>Prettier</h4><p>上面我们说到，ESLint 主要解决了两类问题，但其实 ESLint 主要解决的是代码质量问题。另外一类代码风格问题其实 Airbnb JavaScript Style Guide 并没有完完全全做完，因为这些问题”没那么重要”，代码质量出问题意味着程序有潜在 Bug，而风格问题充其量也只是看着不爽。</p>
<ul>
<li><p>代码质量规则 (code-quality rules)</p>
</li>
<li><p>no-unused-vars</p>
</li>
<li><p>no-extra-bind</p>
</li>
<li><p>no-implicit-globals</p>
</li>
<li><p>prefer-promise-reject-errors<br>…</p>
</li>
<li><p>代码风格规则 (code-formatting rules)</p>
</li>
<li><p>max-len</p>
</li>
<li><p>no-mixed-spaces-and-tabs</p>
</li>
<li><p>keyword-spacing</p>
</li>
<li><p>comma-style<br>…</p>
</li>
</ul>
<p>这时候就出现了 Prettier，Prettier 声称自己是一个有主见 (偏见) 的代码格式化工具 (opinionated code formatter)，Prettier 认为格式很重要，但是格式好麻烦，我来帮你们定好吧。简单来说，不需要我们再思考究竟是用 single quote，还是 double quote 这些乱起八糟的格式问题，Prettier 帮你处理。最后的结果，可能不是你完全满意，但是，绝对不会丑，况且，Prettier 还给予了一部分配置项，可以通过 <code>.prettierrc</code> 文件修改。</p>
<p>所以相当于 Prettier 接管了两个问题其中的代码格式的问题，而使用 Prettier + ESLint 就完完全全解决了两个问题。但实际上使用起来配置有些小麻烦，但也不是什么大问题。因为 Prettier 和 ESLint 一起使用的时候会有冲突，所以</p>
<p>首先我们需要使用 eslint-config-prettier 来关掉 (disable) 所有和 Prettier 冲突的 ESLint 的配置（这部分配置就是上面说的，格式问题的配置，所以关掉不会有问题），方法就是在 <code>.eslintrc</code> 里面将 prettier 设为最后一个 extends</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;extends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;prettier&quot;</span><span class="punctuation">]</span> <span class="comment">// prettier 一定要是最后一个，才能确保覆盖</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 然后再启用 <code>eslint-plugin-prettier</code> ，将 prettier 的 rules 以插件的形式加入到 ESLint 里面。这里插一句，为什么”可选” ？当你使用 Prettier + ESLint 的时候，其实格式问题两个都有参与，disable ESLint 之后，其实格式的问题已经全部由 prettier 接手了。那我们为什么还要这个 plugin？其实是因为我们期望报错的来源依旧是 ESLint ，使用这个，相当于把 Prettier 推荐的格式问题的配置以 ESLint rules 的方式写入，这样相当于可以统一代码问题的来源。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc    </span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;prettier&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>        </span><br><span class="line">        <span class="attr">&quot;prettier/prettier&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将上面两个步骤和在一起就是下面的配置，也是官方的推荐配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .eslintrc</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;extends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;plugin:prettier/recommended&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-react/④(原理)react生命周期"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/afa1cc89da08/"
    >React原理 生命周期</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/afa1cc89da08/" class="article-date">
  <time datetime="2021-09-08T04:30:13.000Z" itemprop="datePublished">2021-09-08</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="预备"><a href="#预备" class="headerlink" title="预备"></a>预备</h4><p>React 有两个重要阶段，render 阶段和 commit 阶段，React 在调和( render )阶段会深度遍历 React fiber 树，目的就是发现不同( diff )，不同的地方就是接下来需要更新的地方，对于变化的组件，就会执行 render 函数。在一次调和过程完毕之后，就到了commit 阶段，commit 阶段会创建修改真实的 DOM 节点。</p>
<blockquote>
<p>类组件的处理逻辑在<a href="/posts/72e97988/#%E7%BB%84%E4%BB%B6%E7%9A%84%E6%9C%AC%E8%B4%A8">beginWork</a>中被调用，react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.js</p>
</blockquote>
<p>① instance 类组件对应实例。<br>② workInProgress 树，当前正在调和的 fiber 树 ，一次更新中，React 会自上而下深度遍历子代 fiber ，如果遍历到一个 fiber ，会把当前 fiber 指向 workInProgress。<br>③ current 树，在初始化更新中，current &#x3D; null ，在第一次 fiber 调和之后，会将 workInProgress 树赋值给 current 树。React 来用workInProgress 和 current 来确保一次更新中，快速构建，并且状态不丢失。<br>④ Component 就是项目中的 class 组件。<br>⑤ nextProps 作为组件在一次更新中新的 props 。<br>⑥ renderLanes 作为下一次渲染的优先级。</p>
<p>在组件实例上可以通过 <code>_reactInternals</code> 属性来访问组件对应的 <code>fiber</code> 对象。在 <code>fiber</code> 对象上，可以通过 <code>stateNode</code> 来访问当前 <code>fiber</code> 对应的组件实例。</p>
<p><code>class Instance</code> . <code>_reactInternals</code> &#x3D;&gt; <code>class Fiber</code></p>
<p><code>class Fiber</code> . <code>stateNode</code> &#x3D;&gt; <code>class Instance</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateClassComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  Component: any,</span></span><br><span class="line"><span class="params">  nextProps: any,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// stateNode 是 fiber 指向 类组件实例的指针。</span></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span>;</span><br><span class="line">  <span class="keyword">let</span> shouldUpdate;</span><br><span class="line">  <span class="comment">// instance 为组件实例,如果组件实例不存在，证明该类组件没有被挂载过，那么会走初始化流程</span></span><br><span class="line">  <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 在这个方法中组件通过new被实例化</span></span><br><span class="line">    <span class="title function_">constructClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps);</span><br><span class="line">    <span class="comment">// 初始化挂载组件流程</span></span><br><span class="line">    <span class="title function_">mountClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps, renderLanes);</span><br><span class="line">    <span class="comment">// shouldUpdate 标识用来证明 组件是否需要更新。</span></span><br><span class="line">    shouldUpdate = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 已经存在了一个实例可以被复用</span></span><br><span class="line">    shouldUpdate = <span class="title function_">resumeMountClassInstance</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新组件流程</span></span><br><span class="line">    shouldUpdate = <span class="title function_">updateClassInstance</span>(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> nextUnitOfWork = <span class="title function_">finishClassComponent</span>(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderLanes,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> nextUnitOfWork;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">finishClassComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  Component: any,</span></span><br><span class="line"><span class="params">  shouldUpdate: boolean,</span></span><br><span class="line"><span class="params">  hasContext: boolean,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 即使 shouldComponentUpdate 返回了 false,Refs也应该被更新</span></span><br><span class="line">  <span class="title function_">markRef</span>(current, workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Rerender</span></span><br><span class="line">  <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = workInProgress;</span><br><span class="line">  <span class="comment">// 获取子节点</span></span><br><span class="line">  <span class="keyword">let</span> nextChildren = instance.<span class="title function_">render</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调和子节点</span></span><br><span class="line">  <span class="title function_">reconcileChildren</span>(current, workInProgress, nextChildren, renderLanes);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Memoize state using the values we just used to render.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Restructure so we never read values from the instance.</span></span><br><span class="line">  workInProgress.<span class="property">memoizedState</span> = instance.<span class="property">state</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The context might have changed so we need to recalculate it.</span></span><br><span class="line">  <span class="keyword">if</span> (hasContext) &#123;</span><br><span class="line">    <span class="title function_">invalidateContextProvider</span>(workInProgress, <span class="title class_">Component</span>, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="初始化阶段"><a href="#初始化阶段" class="headerlink" title="初始化阶段"></a>初始化阶段</h4><p><code>constructClassInstance</code>构建了组件的<a href="/posts/72e97988/#%E7%BB%84%E4%BB%B6%E7%9A%84%E6%9C%AC%E8%B4%A8">实例</a>，在实例化组件之后，会调用 <code>mountClassInstance</code> 组件初始化。</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在从没有渲染过的实例上执行挂载生命周期</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountClassInstance</span>(<span class="params"></span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  ctor: any,</span></span><br><span class="line"><span class="params">  newProps: any,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 组件实例</span></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span>;</span><br><span class="line">  instance.<span class="property">props</span> = newProps;</span><br><span class="line">  instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line">  instance.<span class="property">refs</span> = emptyRefsObject;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">initializeUpdateQueue</span>(workInProgress);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 拿到类组件构造函数的静态方法</span></span><br><span class="line">  <span class="keyword">const</span> getDerivedStateFromProps = ctor.<span class="property">getDerivedStateFromProps</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> prevState = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line">        <span class="comment">// 返回更新之后的state</span></span><br><span class="line">        <span class="keyword">var</span> partialState = <span class="title function_">getDerivedStateFromProps</span>(nextProps, prevState);</span><br><span class="line">        <span class="comment">// 如果返回的state不合法，使用原有状态，否则合并两个状态生成一个新的state对象</span></span><br><span class="line">        <span class="keyword">var</span> memoizedState = partialState === <span class="literal">null</span> || partialState === <span class="literal">undefined</span> ? prevState : <span class="title function_">_assign</span>(&#123;&#125;, prevState, partialState);</span><br><span class="line">        workInProgress.<span class="property">memoizedState</span> = memoizedState; </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Once the update queue is empty, persist the derived state onto the</span></span><br><span class="line">        <span class="comment">// base state.</span></span><br><span class="line">        <span class="keyword">if</span> (workInProgress.<span class="property">lanes</span> === <span class="title class_">NoLanes</span>) &#123;</span><br><span class="line">            <span class="comment">// Queue is always non-null for classes</span></span><br><span class="line">            <span class="keyword">var</span> updateQueue = workInProgress.<span class="property">updateQueue</span>;</span><br><span class="line">            updateQueue.<span class="property">baseState</span> = memoizedState;</span><br><span class="line">        &#125;</span><br><span class="line">        instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentDidMount</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    workInProgress.<span class="property">flags</span> |= fiberFlags;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><code>render</code> 函数执行</strong></p>
<p>到此为止 <code>mountClassInstance</code> 函数完成，但是上面 <code>updateClassComponent</code> 函数， 在执行完 <code>mountClassInstance</code> 后，执行了 <code>render</code> 渲染函数，形成了 children ， 接下来 React 调用 <code>reconcileChildren</code> 方法深度调和 <code>children</code> 。</p>
<p><strong><code>componentDidMount</code>函数执行</strong></p>
<p>上述提及的几生命周期都是在 render 阶段执行的。一旦 React 调和完所有的 fiber 节点，就会到 commit 阶段，在组件初始化 commit 阶段，会调用 componentDidMount 生命周期。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRootImpl</span>(<span class="params">root, renderPriorityLevel</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> finishedWork = root.<span class="property">finishedWork</span>;</span><br><span class="line">    <span class="title function_">commitLayoutEffects</span>(finishedWork, root, lanes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>17.0.2</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLifeCycles</span>(<span class="params">finishedRoot,current,finishedWork</span>)&#123;</span><br><span class="line">     <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>)&#123;                             <span class="comment">/* fiber tag 在第一节讲了不同fiber类型 */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;                              <span class="comment">/* 如果是 类组件 类型 */</span></span><br><span class="line">             <span class="keyword">const</span> instance = finishedWork.<span class="property">stateNode</span>        <span class="comment">/* 类实例 */</span></span><br><span class="line">             <span class="keyword">if</span>(current === <span class="literal">null</span>)&#123;                          <span class="comment">/* 类组件第一次调和渲染 */</span></span><br><span class="line">                instance.<span class="title function_">componentDidMount</span>() </span><br><span class="line">             &#125;<span class="keyword">else</span>&#123;                                         <span class="comment">/* 类组件更新 */</span></span><br><span class="line">                instance.<span class="title function_">componentDidUpdate</span>(prevProps,prevState，instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span>); </span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>17.0.3</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffectOnFiber</span>(<span class="params"></span></span><br><span class="line"><span class="params">  finishedRoot: FiberRoot,</span></span><br><span class="line"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  finishedWork: Fiber,</span></span><br><span class="line"><span class="params">  committedLanes: Lanes,</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">            <span class="keyword">const</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">            <span class="keyword">if</span> (!offscreenSubtreeWasHidden) &#123;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    enableProfilerTimer &amp;&amp;</span><br><span class="line">                    enableProfilerCommitHooks &amp;&amp;</span><br><span class="line">                    finishedWork.<span class="property">mode</span> &amp; <span class="title class_">ProfileMode</span></span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="title function_">startLayoutEffectTimer</span>();</span><br><span class="line">                    instance.<span class="title function_">componentDidMount</span>();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="title function_">recordLayoutEffectDuration</span>(finishedWork);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    instance.<span class="title function_">componentDidMount</span>();</span><br><span class="line">                &#125;</span><br><span class="line">               </span><br><span class="line">            <span class="title function_">commitUpdateQueue</span>(finishedWork, updateQueue, instance);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="更新阶段"><a href="#更新阶段" class="headerlink" title="更新阶段"></a>更新阶段</h4><p>回到了最开始 updateClassComponent 函数了，当发现 current 不为 null 的情况时，说明该类组件被挂载过，那么直接按照更新逻辑来处理。</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateClassInstance</span>(<span class="params">current,workInProgress,ctor,newProps,renderExpirationTime</span>)&#123;</span><br><span class="line">    <span class="comment">// 类组件实例</span></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span>;</span><br><span class="line">    <span class="comment">// 判断是否具有 getDerivedStateFromProps 生命周期</span></span><br><span class="line">    <span class="keyword">const</span> hasNewLifecycles =  <span class="keyword">typeof</span> ctor.<span class="property">getDerivedStateFromProps</span> === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    <span class="keyword">if</span>(!hasNewLifecycles &amp;&amp; <span class="keyword">typeof</span> instance.<span class="property">componentWillReceiveProps</span> === <span class="string">&#x27;function&#x27;</span> )&#123;</span><br><span class="line">        <span class="comment">// 浅比较 props 不相等</span></span><br><span class="line">         <span class="keyword">if</span> (oldProps !== newProps || oldContext !== nextContext) &#123;</span><br><span class="line">            <span class="comment">// 执行生命周期 componentWillReceiveProps</span></span><br><span class="line">            instance.<span class="title function_">componentWillReceiveProps</span>(newProps, nextContext);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> newState = (instance.<span class="property">state</span> = oldState);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">/* 执行生命周期getDerivedStateFromProps  ，逻辑和mounted类似 ，合并state  */</span></span><br><span class="line">        ctor.<span class="title function_">getDerivedStateFromProps</span>(nextProps,prevState)  </span><br><span class="line">        newState = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> shouldUpdate = <span class="literal">true</span></span><br><span class="line">    <span class="comment">/* 执行生命周期 shouldComponentUpdate 返回值决定是否执行render ，调和子节点 */</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> instance.<span class="property">shouldComponentUpdate</span> === <span class="string">&#x27;function&#x27;</span> )&#123; </span><br><span class="line">        shouldUpdate = instance.<span class="title function_">shouldComponentUpdate</span>(newProps,newState,nextContext,);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(shouldUpdate)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentWillUpdate</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">/* 执行生命周期 componentWillUpdate  */</span></span><br><span class="line">            instance.<span class="title function_">componentWillUpdate</span>(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shouldUpdate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getSnapshotBeforeUpdate</strong> 的执行也是在 commit 阶段，commit 阶段细分为 before Mutation( DOM 修改前)，Mutation ( DOM 修改)，Layout( DOM 修改后) 三个阶段，getSnapshotBeforeUpdate 发生在before Mutation 阶段</p>
<h4 id="销毁阶段"><a href="#销毁阶段" class="headerlink" title="销毁阶段"></a>销毁阶段</h4><p>在一次调和更新中，如果发现元素被移除，就会打对应的 Deletion 标签 ，然后在 commit 阶段就会调用 <code>componentWillUnmount</code> 生命周期，接下来统一卸载组件以及 DOM 元素。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> callComponentWillUnmountWithTimer = <span class="keyword">function</span> (<span class="params">current, instance</span>) &#123;</span><br><span class="line">  instance.<span class="property">props</span> = current.<span class="property">memoizedProps</span>;</span><br><span class="line">  instance.<span class="property">state</span> = current.<span class="property">memoizedState</span>;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    instance.<span class="title function_">componentWillUnmount</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/afa1cc89da08/0001.jpg"></p>
<h4 id="各生命周期最佳实践"><a href="#各生命周期最佳实践" class="headerlink" title="各生命周期最佳实践"></a>各生命周期最佳实践</h4><h5 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)        <span class="comment">// 执行 super ，别忘了传递props,才能在接下来的上下文中，获取到props。</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>=&#123;       <span class="comment">//① 可以用来初始化state，比如可以用来获取路由中的</span></span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleClick</span> = <span class="variable language_">this</span>.<span class="property">handleClick</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>) <span class="comment">/* ② 绑定 this */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleInputChange</span> = <span class="title function_">debounce</span>(<span class="variable language_">this</span>.<span class="property">handleInputChange</span> , <span class="number">500</span>) <span class="comment">/* ③ 绑定防抖函数，防抖 500 毫秒 */</span></span><br><span class="line">    <span class="keyword">const</span> _render = <span class="variable language_">this</span>.<span class="property">render</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">render</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> _render.<span class="title function_">bind</span>(<span class="variable language_">this</span>)  <span class="comment">/* ④ 劫持修改类组件上的一些生命周期 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UNSAFE-componentWillMount"><a href="#UNSAFE-componentWillMount" class="headerlink" title="UNSAFE_componentWillMount"></a>UNSAFE_componentWillMount</h5><p>在新版本的react（v16.3）中<code>componentWillMount</code>已经变更为<code>UNSAFE_componentWillMount</code>,而且不在推荐使用，其中很大一部分原因是经常被滥用</p>
<ul>
<li>初始化状态</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&quot;red&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&quot;red&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">componentWillMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 应该将初始化状态放到构造函数或属性的初始化状态中</span></span><br><span class="line">    <span class="comment">// this.setState(&#123;</span></span><br><span class="line">    <span class="comment">//   color: &quot;red&quot;</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取异步的外部数据</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">externalData</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentWillMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_asyncRequest</span> = <span class="title function_">loadMyAsyncData</span>().<span class="title function_">then</span>(</span><br><span class="line">      <span class="function"><span class="params">externalData</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_asyncRequest</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;externalData&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_asyncRequest</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_asyncRequest</span>.<span class="title function_">cancel</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">externalData</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 渲染加载状态 ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 渲染真实 UI ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码对于服务器渲染（异步的请求数据不会被放到state中）和即将推出的异步渲染模式（可能执行多次）都存在问题。通常会把上面的操作放到 <code>componentDidMount</code> </p>
<p>另一个问题是，<code>componentWillMount</code>的名字比较反直觉，听起来觉得在这个生命周期中获取数据，可以避免第一次<code>render</code>的时候进行一次空渲染，单实际上 <code>componentWillMount</code>执行后 <code>render</code>方法会立即执行，如果<code>componentWillMount</code> 没有获取到可用数据，<code>render</code>方法中同样获取不到数据。</p>
<p>如果想稍微提前一点请求，从而适应低性能的设备可以使用下面的方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is an advanced example! It is not intended for use in application code.</span></span><br><span class="line"><span class="comment">// Libraries like Relay may make use of this technique to save some time on low-end mobile devices.</span></span><br><span class="line"><span class="comment">// Most components should just initiate async requests in componentDidMount.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  _hasUnmounted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">externalData</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prime an external cache as early as possible.</span></span><br><span class="line">    <span class="comment">// Async requests are unlikely to complete before render anyway,</span></span><br><span class="line">    <span class="comment">// So we aren&#x27;t missing out by not providing a callback here.</span></span><br><span class="line">    <span class="title function_">asyncLoadData</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">someId</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Now that this component has mounted,</span></span><br><span class="line">    <span class="comment">// Wait for earlier pre-fetch to complete and update its state.</span></span><br><span class="line">    <span class="comment">// (This assumes some kind of external cache to avoid duplicate requests.)</span></span><br><span class="line">    <span class="title function_">asyncLoadData</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">someId</span>).<span class="title function_">then</span>(<span class="function"><span class="params">externalData</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_hasUnmounted</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; externalData &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_hasUnmounted</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">externalData</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Render loading state ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Render real UI ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>事件监听</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">componentWillMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      <span class="attr">subscribedValue</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dataSource</span>.<span class="property">value</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 这是不安全的，它会导致内存泄漏！</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dataSource</span>.<span class="title function_">subscribe</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handleSubscriptionChange</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dataSource</span>.<span class="title function_">unsubscribe</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handleSubscriptionChange</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleSubscriptionChange = <span class="function"><span class="params">dataSource</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      <span class="attr">subscribedValue</span>: dataSource.<span class="property">value</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码在服务端可能永远不会调用 <code>componentWillUnmount</code>, 或者在渲染完成之前可能被中断，导致不调用 <code>componentWillUnmount</code>,这两种场景都可能导致内存泄露，推荐的做法是移到<code>componentDidMount</code> </p>
<p>订阅的触发，导致属性和状态的改变，<code>Redux</code> 或 <code>MobX</code> 会帮助我们实现，对于应用开发场景可以使用 <a target="_blank" rel="noopener" href="https://github.com/facebook/react/tree/main/packages/create-subscription"><code>create-subscription</code></a>, 在这里可以看到源码分析。</p>
<h5 id="UNSAFE-componentWillReceiveProps-getDerivedStateFromProps"><a href="#UNSAFE-componentWillReceiveProps-getDerivedStateFromProps" class="headerlink" title="UNSAFE_componentWillReceiveProps getDerivedStateFromProps"></a>UNSAFE_componentWillReceiveProps getDerivedStateFromProps</h5><p>首先明确一下这个两个方法在使用时，最常见的错误</p>
<ol>
<li>直接复制 props 到 state 上</li>
<li>如果 props 和 state 不一致就更新 state</li>
<li>经常被误解只有<code>props</code>改变时这两个方法才会调用，实际上只要父组件重新渲染这两个方法就会被调用</li>
</ol>
<p>想说清楚造成这两个错误的原因，需要先了解一个概念叫做 <strong>受控</strong></p>
<p><strong>受控</strong>和<strong>非受控</strong>通常用来指代表单的 <code>inputs</code>,但是也可以用来描述数据频繁更新的组件。如果组件完全依赖于外部传入的<code>props</code>,可以认为是受控状态，因为组件完全被父组件的<code>props</code>控制。如果组件的状态只保存在组件（state）内部，可以认为是非受控的，因为组件有自己的状态，不受父组件的控制。</p>
<p>而组件中一旦将两种模式混为一谈（同时包含<code>props</code>和<code>state</code>）就会造成问题</p>
<p><strong>直接复制 props 到 state 上造成的问题</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EmailInput</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  state = &#123; <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">email</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;this.handleChange&#125;</span> <span class="attr">value</span>=<span class="string">&#123;this.state.email&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleChange = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">email</span>: event.<span class="property">target</span>.<span class="property">value</span> &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentWillReceiveProps</span>(<span class="params">nextProps</span>) &#123;</span><br><span class="line">    <span class="comment">// 这会覆盖所有组件内的 state 更新！</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">email</span>: nextProps.<span class="property">email</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初看还觉得可以，但是问题很严重，当通过<code>input</code>的输入改变了组件的状态，这时如果父组件更新就会触发<code>componentWillReceiveProps</code>方法，会将<code>state.email</code>状态重写，覆盖了刚才通过<code>input</code>输入更新的状态，导致状态丢失，这是两种模式混用最明显的错误。在实际的使用中会有多个<code>props</code>属性，任意一个属性的更新都会导致内部状态可能被覆盖。</p>
<p>既然这样，可以很容易想到，能不能只用<code>props</code>来更新组件，不让组件有自己的内部状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EmailInput</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">email</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentWillReceiveProps</span>(<span class="params">nextProps</span>) &#123;</span><br><span class="line">    <span class="comment">// 只要 props.email 改变，就改变 state</span></span><br><span class="line">    <span class="keyword">if</span> (nextProps.<span class="property">email</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">email</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">email</span>: nextProps.<span class="property">email</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>但是仍然有个问题。想象一下，如果这是一个密码输入组件，拥有同样 email 的两个账户(假设一个邮箱可以注册多个账户)进行切换时，这个输入框不会重置（用来让用户重新登录）。因为父组件传来的 <code>prop</code> 值没有变化！这会让用户非常惊讶，因为这看起来像是帮助一个用户分享了另外一个用户的密码</p>
<p><strong>最佳实践:完全可控的组件</strong></p>
<p>从组件里面删除<code>state</code>,完全让外部的<code>props</code>的接管组件的状态</p>
<p><strong>最佳实践：有 key 的非可控组件</strong></p>
<p>让组件自己存储临时的 email state。在这种情况下，组件仍然可以从 prop 接收“初始值”，但是更改之后的值就和 prop 没关系了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EmailInput</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  state = &#123; <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">defaultEmail</span> &#125;;</span><br><span class="line"></span><br><span class="line">  handleChange = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">email</span>: event.<span class="property">target</span>.<span class="property">value</span> &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;this.handleChange&#125;</span> <span class="attr">value</span>=<span class="string">&#123;this.state.email&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以使用 key 这个特殊的 React 属性。当 key 变化时， React 会创建一个新的而不是更新一个既有的组件。 Keys 一般用来渲染动态列表，但是这里也可以使用。在这个示例里，当用户输入时，我们使用 user ID 当作 key 重新创建一个新的 email input 组件</p>
<p>不用为每次输入都添加 key，在整个表单上添加 key 更有位合理。每次 key 变化，表单里的所有组件都会用新的初始值重新创建。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">EmailInput</span></span><br><span class="line">  defaultEmail=&#123;<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">user</span>.<span class="property">email</span>&#125;</span><br><span class="line">  key=&#123;<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">user</span>.<span class="property">id</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这听起来很慢，但是这点的性能是可以忽略的。如果在组件树的更新上有很重的逻辑，这样反而会更快，因为省略了子组件 diff。</p>
</blockquote>
<p><strong>备选：用 prop 的 ID 重置非受控组件</strong></p>
<p>如果某些情况下 key 不起作用（可能是组件初始化的开销太大），一个麻烦但是可行的方案是在 getDerivedStateFromProps 观察 userID 的变化：、</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EmailInput</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">defaultEmail</span>,</span><br><span class="line">    <span class="attr">prevPropsUserID</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">userID</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getDerivedStateFromProps</span>(<span class="params">props, state</span>) &#123;</span><br><span class="line">    <span class="comment">// 只要当前 user 变化，</span></span><br><span class="line">    <span class="comment">// 重置所有跟 user 相关的状态。</span></span><br><span class="line">    <span class="comment">// 这个例子中，只有 email 和 user 相关。</span></span><br><span class="line">    <span class="keyword">if</span> (props.<span class="property">userID</span> !== state.<span class="property">prevPropsUserID</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">prevPropsUserID</span>: props.<span class="property">userID</span>,</span><br><span class="line">        <span class="attr">email</span>: props.<span class="property">defaultEmail</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getDerivedStateFromProps</code> 的存在只有一个目的：让组件在 props 变化时更新 state。 代替了原来的<code>componentWillReceiveProps</code></p>
<p><code>nextProps</code> 父组件新传递的 <code>props</code> ;</p>
<p>你可能想知道为什么我们不将上一个 props 作为参数传递给 getDerivedStateFromProps。我们在设计 API 时考虑过这个方案，但最终决定不采用它，原因有两个：</p>
<ul>
<li><p>prevProps 参数在第一次调用 getDerivedStateFromProps（实例化之后）时为 null，需要在每次访问 prevProps 时添加 if-not-null 检查。</p>
</li>
<li><p>在 React 的未来版本中，不传递上一个 props 给这个方法是为了释放内存。（如果 React 无需传递上一个 props 给生命周期，那么它就无需保存上一个 props 对象在内存中。）</p>
</li>
</ul>
<p><code>prevState</code> 组件在此次更新前的 <code>state</code> 。</p>
<p>需要注意每次组件更新时<code>getDerivedStateFromProps</code>都会执行，无论是以哪那种方式更新</p>
<p>通常用于吧<code>props</code>混入<code>state</code>作为初始状态，合并后的<code>state</code>可以作为 <code>shouldComponentUpdate</code> 第二个参数 <code>newState</code> ，可以判断是否渲染组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getDerivedStateFromProps</span>(nextProps,prevState)</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<p>最重要的是确定组件是受控组件还是非受控组件。不要直接复制（mirror） props 的值到 state 中，而是去实现一个受控的组件，然后在父组件里合并两个值。</p>
<p>对于不受控的组件，当你想在 prop 变化（通常是 ID ）时重置 state 的话，可以选择以下几种方式：</p>
<p>建议: 重置内部所有的初始 state，使用 key 属性<br>选项一：仅更改某些字段，观察特殊属性的变化（比如 props.userID）。</p>
<h5 id="UNSAFE-componentWillUpdate-getSnapshotBeforeUpdate"><a href="#UNSAFE-componentWillUpdate-getSnapshotBeforeUpdate" class="headerlink" title="UNSAFE_componentWillUpdate getSnapshotBeforeUpdate"></a>UNSAFE_componentWillUpdate getSnapshotBeforeUpdate</h5><p>当组件收到新的 <code>props</code> 或 <code>state</code> 时，会在渲染之前调用 <code>UNSAFE_componentWillUpdate()</code>。 有时人们使用 <code>componentWillUpdate</code> 是出于一种反直觉，当 <code>componentDidUpdate</code> 触发时，更新其他组件的 <code>state</code> 已经”太晚”了。事实并非如此。在UI渲染之前，<code>componentWillUpdate</code>和<code>componentDidUpdate</code>中的<code>state</code>改变都将被记录。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getSnapshotBeforeUpdate</span>(prevProps, prevState)</span><br></pre></td></tr></table></figure>

<p><code>componentWillUpdate</code>常见的错误是在生命周期中使用异步获取数据的方法，因为任何<code>state</code>的更新和父组件的重新渲染会触发<code>componentWillUpdate</code>重新执行，所有获取数据的方法可能被执行多次。相反，应该使用 <code>componentDidUpdate</code> 生命周期，因为它保证每次更新只调用一次。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps, prevState</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">someStatefulValue</span> !==</span><br><span class="line">      prevState.<span class="property">someStatefulValue</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onChange</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">someStatefulValue</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>更新前读取 DOM 属性</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ListBox</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  ref = <span class="title class_">React</span>.<span class="title function_">createRef</span>();</span><br><span class="line">  previousScrollOffset=<span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 在列表更新的时候，读取DOM属性</span></span><br><span class="line">  <span class="title function_">componentWillUpdate</span>(<span class="params">nextProps, nextState</span>) &#123;</span><br><span class="line">    <span class="comment">// 当列列表个数被改变的时候计算偏移量</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">list</span>.<span class="property">length</span> &lt; nextProps.<span class="property">list</span>.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">previousScrollOffset</span> =</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollHeight</span> - <span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollTop</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 在列表被挂载的时候修改DOM属性</span></span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// previousScrollOffset ！== 容器高度时(2px是边框高度)，表示滚动条没有滚动到底部，可能在查看历史记录的状态</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">previousScrollOffset</span>!== <span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">offsetHeight</span>-<span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// newScrollHeight - oldScrollHeight + lastScrollTop</span></span><br><span class="line">    <span class="comment">// 相当于在上一次的scrollTop上加上ScrollHeight的增量</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollTop</span> =  (<span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollHeight</span> -　<span class="variable language_">this</span>.<span class="property">previousScrollOffset</span>　)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">previousScrollOffset</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> <span class="attr">300</span>, <span class="attr">height:</span> <span class="attr">200</span>, <span class="attr">overflow:</span> &#x27;<span class="attr">auto</span>&#x27;, <span class="attr">border:</span> &#x27;<span class="attr">1px</span> <span class="attr">solid</span>&#x27; &#125;&#125; <span class="attr">ref</span>=<span class="string">&#123;this.ref&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;this.props.list.map(item =&gt; <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height:</span> <span class="attr">20</span> &#125;&#125;&gt;</span>&#123;item.val&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>)&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的示例中，componentWillUpdate 用于读取 DOM 属性。但是，对于异步渲染，“渲染”阶段的生命周期（如 componentWillUpdate 和 render）和”提交”阶段的生命周期（如 componentDidUpdate）之间可能存在延迟。如果用户在这段时间内调整窗口大小，那么从 componentWillUpdate 读取的 scrollHeight 值将过时。</p>
<p>这个问题的解决方案是使用新的“提交”阶段生命周期 <code>getSnapshotBeforeUpdate</code>。这个方法在发生变化 前立即 被调用（例如在更新 DOM 之前）。它可以返回一个 React 的值作为参数传递给 componentDidUpdate 方法，该方法在发生变化 后立即 被调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ListBox</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  ref = <span class="title class_">React</span>.<span class="title function_">createRef</span>();</span><br><span class="line">  <span class="title function_">getSnapshotBeforeUpdate</span>(<span class="params">prevProps, nextState</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">list</span>.<span class="property">length</span> &gt; prevProps.<span class="property">list</span>.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollHeight</span> - <span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollTop</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps, prevState, snapshot</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(snapshot&gt;<span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">offsetHeight</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollTop</span> =  (<span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollHeight</span> -　snapshot　)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">ref</span>.<span class="property">current</span>.<span class="property">scrollTop</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> <span class="attr">300</span>, <span class="attr">height:</span> <span class="attr">200</span>, <span class="attr">overflow:</span> &#x27;<span class="attr">auto</span>&#x27;, <span class="attr">border:</span> &#x27;<span class="attr">1px</span> <span class="attr">solid</span>&#x27; &#125;&#125; <span class="attr">ref</span>=<span class="string">&#123;this.ref&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;this.props.list.map(item =&gt; <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height:</span> <span class="attr">20</span> &#125;&#125;&gt;</span>&#123;item.val&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>)&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h5 id="componentDidMount"><a href="#componentDidMount" class="headerlink" title="componentDidMount"></a>componentDidMount</h5><p>componentDidMount() 会在组件挂载后（插入 DOM 树中）立即调用。依赖于 DOM 节点的初始化应该放在这里。如需通过网络请求获取数据，此处是实例化请求的好地方。</p>
<p>这个方法是比较适合添加订阅的地方。如果添加了订阅，请不要忘记在 componentWillUnmount() 里取消订阅</p>
<p>你可以在 componentDidMount() 里直接调用 setState()。它将触发额外渲染，但此渲染会发生在浏览器更新屏幕之前。如此保证了即使在 render() 两次调用的情况下，用户也不会看到中间状态。请谨慎使用该模式，因为它会导致性能问题。通常，你应该在 constructor() 中初始化 state。如果你的渲染依赖于 DOM 节点的大小或位置，比如实现 modals 和 tooltips 等情况下，你可以使用此方式处理</p>
<h5 id="useEffect-和-useLayoutEffect"><a href="#useEffect-和-useLayoutEffect" class="headerlink" title="useEffect 和 useLayoutEffect"></a>useEffect 和 useLayoutEffect</h5><p>对于 <code>useEffect</code> 执行， <code>React</code> 处理逻辑是采用异步调用 ，对于每一个 <code>effect</code> 的 <code>callback，</code> React 会像 <code>setTimeout</code>回调函数一样，放入任务队列，等到主线程任务完成，DOM 更新，js 执行完成，视图绘制完毕，才执行。所以 <code>effect</code> 回调函数不会阻塞浏览器绘制视图。</p>
<p><code>useLayoutEffect</code> 和 <code>useEffect</code> 不同的地方是采用了同步执行</p>
<p>首先 <code>useLayoutEffect</code> 是在 DOM 绘制之前，这样可以方便修改 DOM ，这样浏览器只会绘制一次，如果修改 DOM 布局放在 <code>useEffect</code> ，那 <code>useEffect</code> 执行是在浏览器绘制视图之后，接下来又改 DOM ，就可能会导致浏览器再次回流和重绘。而且由于两次绘制，视图上可能会造成闪现突兀的效果。<code>useLayoutEffect</code> callback 中代码执行会阻塞浏览器绘制。</p>
<p>useEffect 对 React 执行栈来看是异步执行的，而 componentDidMount &#x2F; componentDidUpdate 是同步执行的，useEffect代码不会阻塞浏览器绘制。在时机上 ，componentDidMount &#x2F; componentDidUpdate 和 useLayoutEffect 更类似。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-react/③(原理)props深入"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/8d49fda41a82/"
    >React原理 props深入</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/8d49fda41a82/" class="article-date">
  <time datetime="2021-09-07T02:00:18.000Z" itemprop="datePublished">2021-09-07</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="props的几种用法"><a href="#props的几种用法" class="headerlink" title="props的几种用法"></a>props的几种用法</h4><p>① props 作为一个子组件渲染数据源。<br>② props 作为一个通知父组件的回调函数。<br>③ props 作为一个单纯的组件传递。<br>④ props 作为渲染函数。<br>⑤ render props ， 和④的区别是放在了 children 属性上。<br>⑥ render component 插槽组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* children 组件 */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ChidrenComponent</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> In this chapter, let&#x27;s learn about react props ! <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* props 接受处理 */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PropsComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>,<span class="string">&#x27;_this&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;  children , mes , renderName , say ,<span class="title class_">Component</span> &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">const</span> renderFunction = children[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> renderComponent = children[<span class="number">1</span>]</span><br><span class="line">        <span class="comment">/* 对于子组件，不同的props是怎么被处理 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; renderFunction() &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; mes &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; renderName() &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; renderComponent &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Component</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> () =&gt;</span> say() &#125; &gt; change content <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* props 定义绑定 */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123;  </span><br><span class="line">        <span class="attr">mes</span>: <span class="string">&quot;hello,React&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    node = <span class="literal">null</span></span><br><span class="line">    say= <span class="function">() =&gt;</span>  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">mes</span>:<span class="string">&#x27;let us learn React!&#x27;</span> &#125;)</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">PropsComponent</span>  </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">mes</span>=<span class="string">&#123;this.state.mes&#125;</span>  // ① <span class="attr">props</span> 作为一个渲染数据源</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">say</span>=<span class="string">&#123;</span> <span class="attr">this.say</span>  &#125;     // ② <span class="attr">props</span> 作为一个回调函数 <span class="attr">callback</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">Component</span>=<span class="string">&#123;</span> <span class="attr">ChidrenComponent</span> &#125; // ③ <span class="attr">props</span> 作为一个组件</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">renderName</span>=<span class="string">&#123;</span> ()=&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span> my name is alien <span class="tag">&lt;/<span class="name">div</span>&gt;</span> &#125; // ④ props 作为渲染函数</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                &#123; ()=&gt; <span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  &#125; &#123; /* ⑤render props */ &#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ChidrenComponent</span> /&gt;</span>             &#123; /* ⑥render component */ &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">PropsComponent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="监听props改变"><a href="#监听props改变" class="headerlink" title="监听props改变"></a>监听props改变</h4><p><strong>类组件</strong></p>
<p>getDerivedStateFromProps 会在调用 render 方法之前调用，并且在初始挂载及后续更新时都会被调用。它应返回一个对象来更新 state，如果返回 null 则不更新任何内容。</p>
<p><strong>函数组件</strong></p>
<p>函数组件中同理可以用 useEffect 来作为 props 改变后的监听函数。</p>
<h4 id="props-children-最佳实践"><a href="#props-children-最佳实践" class="headerlink" title="props+children 最佳实践"></a>props+children 最佳实践</h4><p><strong>增强子组件</strong></p>
<p>通过 props.children 属性访问到 Chidren 组件，为 React element 对象。</p>
<ol>
<li><p>可以根据需要控制 Chidren 是否渲染。</p>
</li>
<li><p>Container 可以用 React.cloneElement 强化 props (混入新的 props )，或者修改 Chidren 的子元素。</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Container</span>&gt;</span><br><span class="line">    &lt;<span class="title class_">Children</span>&gt;</span><br><span class="line">&lt;/<span class="title class_">Container</span>&gt;</span><br></pre></td></tr></table></figure>


<p><strong>函数式子组件</strong></p>
<ol>
<li>根据需要控制 Chidren 渲染与否。</li>
<li>可以将需要传给 Children 的 props 直接通过函数参数的方式传递给执行函数 children 。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Container</span>&gt;</span><br><span class="line">   &#123; <span class="function">(<span class="params">ContainerProps</span>)=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Children</span> &#123;<span class="attr">...ContainerProps</span>&#125;  /&gt;</span></span> &#125;</span><br><span class="line">&lt;/<span class="title class_">Container</span>&gt;</span><br></pre></td></tr></table></figure>

<p>像下面这种情况下 children 是不能直接渲染的，直接渲染会报错。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>  <span class="title function_">Container</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span>  <span class="title class_">ContainerProps</span> = &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">        <span class="attr">mes</span>:<span class="string">&#x27;let us learn react&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  props.<span class="title function_">children</span>(<span class="title class_">ContainerProps</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>混合使用</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Container</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Children</span> /&gt;</span></span></span><br><span class="line">    &#123; <span class="function">(<span class="params">ContainerProps</span>)=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Children</span> &#123;<span class="attr">...ContainerProps</span>&#125; <span class="attr">name</span>=<span class="string">&#123;</span>&#x27;<span class="attr">haha</span>&#x27;&#125;  /&gt;</span></span>  &#125;</span><br><span class="line">&lt;/<span class="title class_">Container</span>&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Children</span> = (<span class="params">props</span>)=&gt; (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>hello, my name is &#123;  props.name &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span> &#123; props.mes &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>  <span class="title function_">Container</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">ContainerProps</span> = &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">        <span class="attr">mes</span>:<span class="string">&#x27;let us learn react&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">return</span> props.<span class="property">children</span>.<span class="title function_">map</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">React</span>.<span class="title function_">isValidElement</span>(item))&#123; <span class="comment">// 判断是 react elment  混入 props</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(item,&#123; ...<span class="title class_">ContainerProps</span> &#125;,item.<span class="property">props</span>.<span class="property">children</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> item === <span class="string">&#x27;function&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">item</span>(<span class="title class_">ContainerProps</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">     &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Index</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Container</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Children</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; (ContainerProps)=&gt; <span class="tag">&lt;<span class="name">Children</span> &#123;<span class="attr">...ContainerProps</span>&#125; <span class="attr">name</span>=<span class="string">&#123;</span>&#x27;<span class="attr">haha</span>&#x27;&#125;  /&gt;</span>  &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Container</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="props的意义"><a href="#props的意义" class="headerlink" title="props的意义"></a>props的意义</h4><p><strong>层级间数据传递</strong></p>
<p>父组件 props 可以把数据层传递给子组件去渲染消费。另一方面子组件可以通过 props 中的 callback ，来向父组件传递信息。还有一种可以将视图容器作为 props 进行渲染。</p>
<p>React 可以把组件的闭合标签里的插槽，转化成 children 属性，一会将详细介绍这个模式。</p>
<p><strong>用于更新判断</strong></p>
<p>在 React 中，props 在组件更新中充当了重要的角色，在 fiber 调和阶段中，diff 可以说是 React 更新的驱动器，熟悉 vue 的同学都知道 vue 中基于响应式，数据的变化，就会颗粒化到组件层级，通知其更新，但是在 React 中，无法直接检测出数据更新波及到的范围，props 可以作为组件是否更新的重要准则，变化即更新，于是有了 PureComponent ，memo 等性能优化方案。</p>
<h4 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h4><p><strong>使用剩余参数过滤props</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; age,...fatherProps  &#125; = props</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Son</span>  &#123; <span class="attr">...fatherProps</span> &#125;  /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>混合props</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params">prop</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(prop.<span class="property">children</span>,&#123;  <span class="attr">mes</span>:<span class="string">&#x27;let us learn React !&#x27;</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-webpack/实现一个webpack"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/f135d4253edb/"
    >实现一个简易 webpack</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/f135d4253edb/" class="article-date">
  <time datetime="2021-09-05T12:53:23.000Z" itemprop="datePublished">2021-09-05</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/webpack/">webpack</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="webpack-的执行流程"><a href="#webpack-的执行流程" class="headerlink" title="webpack 的执行流程"></a>webpack 的执行流程</h4><ul>
<li>初始化 Compiler: new Webpack(config) 得到 Compiler 对象</li>
<li>开始编译，调用 Compiler 对象 run 方法开始编译。</li>
<li>确定入口，根据配置中的 entry 找出所有入口文件</li>
<li>编译模块，从入口出发，调用所有配置的 Loader 对模块进行编译，找出该模块依赖的模块，递归直到所有的模块被加载进来。</li>
<li>完成模块编译：在经过第四步使用 Loader 编译完所有模块之后，得到了每个模块被编译后的最终内容以及他们之间的依赖关系。</li>
<li>输出资源:根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk,再把每个 Chunk 转换成一个单独的文件加入到输出列表。（注意：这步是可以修改输出内容的最后机会）</li>
<li>输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。</li>
</ul>
<h4 id="做一些准备工作"><a href="#做一些准备工作" class="headerlink" title="做一些准备工作"></a>做一些准备工作</h4><p>想要打包总要有个项目吧，让我们着手准备一些项目文件</p>
<p><img src="/posts/f135d4253edb/0001.png"></p>
<p><code>src</code>，目录是项目的源文件，包含了一个工具方法<code>util/add.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">add</span> = (<span class="params">a, b</span>) =&gt; a + b;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> add;</span><br></pre></td></tr></table></figure>

<p>还有另一个打印方法 <code>log.js</code> 有一个更深层的依赖文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bind <span class="keyword">from</span> <span class="string">&quot;./util/bind&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> log = <span class="title function_">bind</span>(<span class="variable language_">console</span>.<span class="property">log</span>, <span class="variable language_">console</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> log;</span><br></pre></td></tr></table></figure>

<p>在项目的入口文件中，引入并使用这两个方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> add <span class="keyword">from</span> <span class="string">&quot;./util/add&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> log <span class="keyword">from</span> <span class="string">&quot;./log&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> count = <span class="title function_">add</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="title function_">log</span>(count);</span><br></pre></td></tr></table></figure>

<p>下面我们需要添加打包命令，就像 create-react-app 做的一样，我们想通过一个<code>npm build</code>命令打包, 所以通过 <code>npm init -y</code>初始化了<code>package.json</code>文件并添加了一个脚本</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my-webpack&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node scripts/build&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>显然我们并没有用于打包的可执行脚本，所以要创建一个，放在<code>scripts/build.js</code>文件夹下面</p>
<p>正如上一小结流程描述的一样，我们通过一个自定义的<code>myWebpack</code>方法，传入配置后生成了<code>compiler</code>对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&quot;../lib/myWebpack&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&quot;../config/webpack.config&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> compiler = <span class="title function_">webpack</span>(config);</span><br><span class="line">compiler.<span class="title function_">run</span>();</span><br></pre></td></tr></table></figure>

<p><code>myWebpack</code>文件是主要要去实现的功能，我们暂时先建一个空文件，那么剩下的就只有这个<code>webpack.config.js</code>配置文件了,简单的给一些必须配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;../src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../dist&quot;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;main.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="解析入口文件依赖并编译代码"><a href="#解析入口文件依赖并编译代码" class="headerlink" title="解析入口文件依赖并编译代码"></a>解析入口文件依赖并编译代码</h4><p><code>myWebpack.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; parse &#125; = <span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&quot;@babel/traverse&quot;</span>).<span class="property">default</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; transformFromAst &#125; = <span class="built_in">require</span>(<span class="string">&quot;@babel/core&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">webpack</span> = (<span class="params">config</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Compiler</span>(config);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; entry &#125; = <span class="variable language_">this</span>.<span class="property">options</span>;</span><br><span class="line">    <span class="comment">// 获取node进程执行的目录</span></span><br><span class="line">    <span class="keyword">const</span> cwdPath = process.<span class="title function_">cwd</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为readFile中使用相对路径是以node进程执行时的路径作为基准路径</span></span><br><span class="line">    <span class="comment">// 可能有查不到文件报错的情况，这里使用path.resolve转换成绝对路径</span></span><br><span class="line">    <span class="keyword">const</span> relativeEntryPath = path.<span class="title function_">resolve</span>(__dirname, entry);</span><br><span class="line">    <span class="keyword">const</span> file = fs.<span class="title function_">readFileSync</span>(relativeEntryPath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把文件内容转换成ast抽象语法树</span></span><br><span class="line">    <span class="comment">// https://www.babeljs.cn/docs/babel-parser</span></span><br><span class="line">    <span class="keyword">const</span> ast = <span class="title function_">parse</span>(file, &#123;</span><br><span class="line">      <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收集入口文件依赖</span></span><br><span class="line">    <span class="keyword">const</span> deps = [];</span><br><span class="line">    <span class="comment">// 分析ast中的依赖关系保存奥依赖中</span></span><br><span class="line">    <span class="title function_">traverse</span>(ast, &#123;</span><br><span class="line">      <span class="title class_">ImportDeclaration</span>: <span class="function">(<span class="params">&#123; node &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 获取到依赖文件的引用路径</span></span><br><span class="line">        <span class="keyword">const</span> traverseModulePath = node.<span class="property">source</span>.<span class="property">value</span>;</span><br><span class="line">        <span class="comment">// 转换为绝对路径</span></span><br><span class="line">        <span class="keyword">const</span> relativePath = path.<span class="title function_">resolve</span>(cwdPath, <span class="string">&quot;src&quot;</span>, traverseModulePath);</span><br><span class="line">        deps.<span class="title function_">push</span>(relativePath);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 编译代码，从ast编译为es5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; code &#125; = <span class="title function_">transformFromAst</span>(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">      <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(code);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = webpack;</span><br></pre></td></tr></table></figure>

<h4 id="深层递归，生成依赖关系图"><a href="#深层递归，生成依赖关系图" class="headerlink" title="深层递归，生成依赖关系图"></a>深层递归，生成依赖关系图</h4><p>虽然我们拿到了入口文件的依赖，但显然是不够的，依赖的文件可能还有自己的依赖，需要递归的去获取</p>
<p>可以把递归解析依赖的方法，抽取成公共方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; parse &#125; = <span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&quot;@babel/traverse&quot;</span>).<span class="property">default</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; transformFromAst &#125; = <span class="built_in">require</span>(<span class="string">&quot;@babel/core&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">webpack</span> = (<span class="params">config</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Compiler</span>(config);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">analysis</span>(<span class="params">entry</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取node进程执行的目录</span></span><br><span class="line">    <span class="keyword">const</span> cwdPath = process.<span class="title function_">cwd</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为readFile中使用相对路径是以node进程执行时的路径作为基准路径</span></span><br><span class="line">    <span class="comment">// 可能有查不到文件报错的情况，这里使用path.resolve转换成绝对路径</span></span><br><span class="line">    <span class="keyword">const</span> relativeEntryPath = path.<span class="title function_">resolve</span>(cwdPath, <span class="string">&quot;src&quot;</span>, entry);</span><br><span class="line">    <span class="keyword">const</span> file = fs.<span class="title function_">readFileSync</span>(relativeEntryPath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把文件内容转换成ast抽象语法树</span></span><br><span class="line">    <span class="comment">// https://www.babeljs.cn/docs/babel-parser</span></span><br><span class="line">    <span class="keyword">const</span> ast = <span class="title function_">parse</span>(file, &#123;</span><br><span class="line">      <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收集入口文件依赖</span></span><br><span class="line">    <span class="keyword">const</span> deps = &#123;&#125;;</span><br><span class="line">    <span class="comment">// 分析ast中的依赖关系保存到依赖中</span></span><br><span class="line">    <span class="title function_">traverse</span>(ast, &#123;</span><br><span class="line">      <span class="title class_">ImportDeclaration</span>: <span class="function">(<span class="params">&#123; node &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 获取到依赖文件的引用路径</span></span><br><span class="line">        <span class="keyword">const</span> traverseModulePath = node.<span class="property">source</span>.<span class="property">value</span> + <span class="string">&quot;.js&quot;</span>;</span><br><span class="line">        <span class="comment">// 转换为绝对路径</span></span><br><span class="line">        <span class="keyword">const</span> relativePath = path.<span class="title function_">resolve</span>(cwdPath, <span class="string">&quot;src&quot;</span>, traverseModulePath);</span><br><span class="line">        deps[traverseModulePath] = relativePath;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 编译代码，从ast编译为es5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; code &#125; = <span class="title function_">transformFromAst</span>(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">      <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      code,</span><br><span class="line">      deps,</span><br><span class="line">      entry,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; entry &#125; = <span class="variable language_">this</span>.<span class="property">options</span>;</span><br><span class="line">    <span class="comment">// 保存加载的模块</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable language_">module</span> = [];</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> parseModule = <span class="variable language_">this</span>.<span class="title function_">analysis</span>(entry);</span><br><span class="line">    <span class="variable language_">module</span>.<span class="title function_">push</span>(parseModule);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((parseModule = <span class="variable language_">module</span>[index])) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; deps &#125; = parseModule;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(deps).<span class="title function_">forEach</span>(<span class="function">(<span class="params">depPath</span>) =&gt;</span> &#123;</span><br><span class="line">        parseModule = <span class="variable language_">this</span>.<span class="title function_">analysis</span>(depPath);</span><br><span class="line">        <span class="variable language_">module</span>.<span class="title function_">push</span>(parseModule);</span><br><span class="line">      &#125;);</span><br><span class="line">      index++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把各模块依赖关系从数据形式转换成对象的形式，方便使用</span></span><br><span class="line">    <span class="variable language_">module</span> = <span class="variable language_">module</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">o, item</span>) =&gt;</span> &#123;</span><br><span class="line">      o[item.<span class="property">entry</span>] = &#123;</span><br><span class="line">        <span class="attr">deps</span>: item.<span class="property">deps</span>,</span><br><span class="line">        <span class="attr">code</span>: item.<span class="property">code</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> o;</span><br><span class="line">    &#125;, &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = webpack;</span><br></pre></td></tr></table></figure>

<h4 id="生成代码"><a href="#生成代码" class="headerlink" title="生成代码"></a>生成代码</h4><p>我们需要用刚才创建好的依赖关系图来动态加载我们的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">  <span class="title function_">generate</span>(<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 入口文件</span></span><br><span class="line"><span class="comment">     * var _add = _interopRequireDefault(require(&quot;./util/add&quot;));</span></span><br><span class="line"><span class="comment">     * var _log = _interopRequireDefault(require(&quot;./log&quot;));</span></span><br><span class="line"><span class="comment">     * function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;</span></span><br><span class="line"><span class="comment">     * var count = (0, _add[&quot;default&quot;])(1, 2);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模块文件</span></span><br><span class="line"><span class="comment">     * Object.defineProperty(exports, &quot;__esModule&quot;, &#123;</span></span><br><span class="line"><span class="comment">     *  value: true</span></span><br><span class="line"><span class="comment">     * &#125;);</span></span><br><span class="line"><span class="comment">     * exports[&quot;default&quot;] = void 0;</span></span><br><span class="line"><span class="comment">     * var bind = require(&#x27;./util/bind&#x27;);</span></span><br><span class="line"><span class="comment">     * var log = bind(console.log, console);</span></span><br><span class="line"><span class="comment">     * var _default = log;</span></span><br><span class="line"><span class="comment">     * exports[&quot;default&quot;] = _default;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> js = <span class="string">`</span></span><br><span class="line"><span class="string">        (function(modules)&#123;</span></span><br><span class="line"><span class="string">            //加载入口文件</span></span><br><span class="line"><span class="string">            var fn = function(path)&#123;</span></span><br><span class="line"><span class="string">                var code = modules[path].code;</span></span><br><span class="line"><span class="string">                // 提供给模块内部使用的require</span></span><br><span class="line"><span class="string">                var require = function(path)&#123;</span></span><br><span class="line"><span class="string">                    return fn(path+&#x27;.js&#x27;);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                const exports = &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                // 根据commonjs规范包装模块的方法</span></span><br><span class="line"><span class="string">                (function(exports,require,code)&#123;</span></span><br><span class="line"><span class="string">                    // eval方法中的字符串在运行时会向上级作用于查找需要的变量</span></span><br><span class="line"><span class="string">                    eval(code)</span></span><br><span class="line"><span class="string">                &#125;)(exports,require,code);</span></span><br><span class="line"><span class="string">                // 导出给下一个模块使用</span></span><br><span class="line"><span class="string">                return exports; </span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            // 加载入口文件</span></span><br><span class="line"><span class="string">            fn(&#x27;<span class="subst">$&#123;<span class="variable language_">this</span>.options.entry&#125;</span>&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125;)(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(<span class="variable language_">module</span>)&#125;</span>)</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">    <span class="keyword">const</span> filename = path.<span class="title function_">resolve</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">output</span>.<span class="property">path</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">output</span>.<span class="property">filename</span></span><br><span class="line">    );</span><br><span class="line">    fs.<span class="title function_">writeFileSync</span>(filename, js, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="把关系图直接变成函数声明"><a href="#把关系图直接变成函数声明" class="headerlink" title="把关系图直接变成函数声明"></a>把关系图直接变成函数声明</h4><p>由于用了<code>JSON.stringify</code>所以生成的文件中各个模块都是以字符串的形式保存，需要用<code>eval</code>执行</p>
<p>所以我们选择另一种处理方法，直接拼接出字符串形式的模块依赖表，这样在生成文件的时候可以直接变成可执行函数</p>
<p>下面是优化过的完整代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">analysis</span>(<span class="params">entry</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取node进程执行的目录</span></span><br><span class="line">    <span class="keyword">const</span> cwdPath = process.<span class="title function_">cwd</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为readFile中使用相对路径是以node进程执行时的路径作为基准路径</span></span><br><span class="line">    <span class="comment">// 可能有查不到文件报错的情况，这里使用path.resolve转换成绝对路径</span></span><br><span class="line">    <span class="keyword">const</span> relativeEntryPath = path.<span class="title function_">resolve</span>(cwdPath, <span class="string">&quot;src&quot;</span>, entry);</span><br><span class="line">    <span class="keyword">const</span> file = fs.<span class="title function_">readFileSync</span>(relativeEntryPath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把文件内容转换成ast抽象语法树</span></span><br><span class="line">    <span class="comment">// https://www.babeljs.cn/docs/babel-parser</span></span><br><span class="line">    <span class="keyword">const</span> ast = <span class="title function_">parse</span>(file, &#123;</span><br><span class="line">      <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收集入口文件依赖</span></span><br><span class="line">    <span class="keyword">const</span> deps = &#123;&#125;;</span><br><span class="line">    <span class="comment">// 分析ast中的依赖关系保存到依赖中</span></span><br><span class="line">    <span class="title function_">traverse</span>(ast, &#123;</span><br><span class="line">      <span class="title class_">ImportDeclaration</span>: <span class="function">(<span class="params">&#123; node &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 获取到依赖文件的引用路径</span></span><br><span class="line">        <span class="keyword">const</span> traverseModulePath = node.<span class="property">source</span>.<span class="property">value</span> + <span class="string">&quot;.js&quot;</span>;</span><br><span class="line">        <span class="comment">// 转换为绝对路径</span></span><br><span class="line">        <span class="keyword">const</span> relativePath = path.<span class="title function_">resolve</span>(cwdPath, <span class="string">&quot;src&quot;</span>, traverseModulePath);</span><br><span class="line">        deps[traverseModulePath] = relativePath;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 编译代码，从ast编译为es5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> &#123; code &#125; = <span class="title function_">transformFromAst</span>(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">      <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    code = <span class="string">`</span></span><br><span class="line"><span class="string">            (function(exports,require)&#123;</span></span><br><span class="line"><span class="string">                <span class="subst">$&#123;code&#125;</span></span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      code,</span><br><span class="line">      deps,</span><br><span class="line">      entry,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; entry &#125; = <span class="variable language_">this</span>.<span class="property">options</span>;</span><br><span class="line">    <span class="comment">// 保存加载的模块</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable language_">module</span> = [];</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> parseModule = <span class="variable language_">this</span>.<span class="title function_">analysis</span>(entry);</span><br><span class="line">    <span class="variable language_">module</span>.<span class="title function_">push</span>(parseModule);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((parseModule = <span class="variable language_">module</span>[index])) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; deps &#125; = parseModule;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(deps).<span class="title function_">forEach</span>(<span class="function">(<span class="params">depPath</span>) =&gt;</span> &#123;</span><br><span class="line">        parseModule = <span class="variable language_">this</span>.<span class="title function_">analysis</span>(depPath);</span><br><span class="line">        <span class="variable language_">module</span>.<span class="title function_">push</span>(parseModule);</span><br><span class="line">      &#125;);</span><br><span class="line">      index++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> moduleString = <span class="string">&quot;&#123;&quot;</span>;</span><br><span class="line">    <span class="variable language_">module</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">      moduleString += <span class="string">`&quot;<span class="subst">$&#123;m.entry&#125;</span>&quot;:<span class="subst">$&#123;m.code&#125;</span>,`</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    moduleString += <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generate</span>(moduleString);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">generate</span>(<span class="params">moduleString</span>) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 入口文件</span></span><br><span class="line"><span class="comment">     * var _add = _interopRequireDefault(require(&quot;./util/add&quot;));</span></span><br><span class="line"><span class="comment">     * var _log = _interopRequireDefault(require(&quot;./log&quot;));</span></span><br><span class="line"><span class="comment">     * function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;</span></span><br><span class="line"><span class="comment">     * var count = (0, _add[&quot;default&quot;])(1, 2);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模块文件</span></span><br><span class="line"><span class="comment">     * Object.defineProperty(exports, &quot;__esModule&quot;, &#123;</span></span><br><span class="line"><span class="comment">     *  value: true</span></span><br><span class="line"><span class="comment">     * &#125;);</span></span><br><span class="line"><span class="comment">     * exports[&quot;default&quot;] = void 0;</span></span><br><span class="line"><span class="comment">     * var bind = require(&#x27;./util/bind&#x27;);</span></span><br><span class="line"><span class="comment">     * var log = bind(console.log, console);</span></span><br><span class="line"><span class="comment">     * var _default = log;</span></span><br><span class="line"><span class="comment">     * exports[&quot;default&quot;] = _default;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> js = <span class="string">`</span></span><br><span class="line"><span class="string">        (function(modules)&#123;</span></span><br><span class="line"><span class="string">            function require(path)&#123;</span></span><br><span class="line"><span class="string">                var exports = &#123;&#125;;</span></span><br><span class="line"><span class="string">                modules[path+&#x27;.js&#x27;](exports,require)</span></span><br><span class="line"><span class="string">                return exports;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            // 加载入口文件</span></span><br><span class="line"><span class="string">            modules[&#x27;<span class="subst">$&#123;<span class="variable language_">this</span>.options.entry&#125;</span>&#x27;](&#123;&#125;,require)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125;)(<span class="subst">$&#123;moduleString&#125;</span>)</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">    <span class="keyword">const</span> filename = path.<span class="title function_">resolve</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">output</span>.<span class="property">path</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">output</span>.<span class="property">filename</span></span><br><span class="line">    );</span><br><span class="line">    fs.<span class="title function_">writeFileSync</span>(filename, js, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">工程化</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-webpack/发布npm包"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/7b1df0314d16/"
    >发布一个npm包</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/7b1df0314d16/" class="article-date">
  <time datetime="2021-09-04T15:58:12.000Z" itemprop="datePublished">2021-09-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/webpack/">webpack</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="注册账号"><a href="#注册账号" class="headerlink" title="注册账号"></a>注册账号</h4><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/signup">npm注册</a> <strong>记得要去邮箱确认，不然发布的时候回报错</strong></p>
<p>也可以使用命令行的方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm adduser</span><br><span class="line"></span><br><span class="line"><span class="comment">#注册并登录</span></span><br><span class="line">npm login</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登录成功提示 Logged in as xxx on <a target="_blank" rel="noopener" href="https://registry.npmjs.org/">https://registry.npmjs.org/</a>.</p>
</blockquote>
<h4 id="创建一个包"><a href="#创建一个包" class="headerlink" title="创建一个包"></a>创建一个包</h4><p>一个最小的包，只需要一个<code>package.json</code>文件,可以用<code>npm init</code>来生成这个文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@noopn/log&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;logger&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;console&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MIT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>其中有一些字段是必须的：</p>
<p><strong>name</strong>： 包的名字，你可能看到我用了 <code>@noopn/log</code> 这样的名字,这表示会创建一个在我们用户名 scope（作用范围） 下的一个包。这个叫做 <code>scoped package</code>。它允许我们将已经被其他包使用的名称作为包名，比如说，log 包 已经在 npm 中存在。比如 <code>@angular/core</code> 和 <code>@angular/http</code>。</p>
<p><strong>version</strong>: 版本号，以便开发人员在安全地更新包版本的同时不会破坏其余的代码。npm 使用的版本系统被叫做 SemVer，是 Semantic Versioning 的缩写。</p>
<blockquote>
<p>给定版本号 MAJOR.MINOR.PATCH，增量规则如下：<br>  MAJOR 版本号的变更说明新版本产生了不兼容低版本的 API 等，<br>  MINOR 版本号的变更说明你在以向后兼容的方式添加功能<br>  PATCH 版本号的变更说明你在新版本中做了向后兼容的 bug 修复.</p>
</blockquote>
<h4 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h4><p>现在准备好可以使用 <code>npm publish</code> 发布了，但不兴的是会得到一个错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm ERR! publish Failed PUT 402</span><br><span class="line">npm ERR! code E402</span><br><span class="line">npm ERR! You must sign up <span class="keyword">for</span> private packages : @noopn/log</span><br></pre></td></tr></table></figure>

<p><code>Scoped packages</code> 会被自动发布为私有包，因为这样不但对我们这样的独立用户有用，而且它们也被公司用于在项目之间共享代码。我们想让每个人都可以使用这个模块.使用下面这个命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm publish --access=public</span><br></pre></td></tr></table></figure>

<p>成功之后会看见 <code>+ @noopn/log@0.0.1</code> </p>
<h4 id="渐入佳境"><a href="#渐入佳境" class="headerlink" title="渐入佳境"></a>渐入佳境</h4><p>虽然发布了我们的第一个包，但是现在还不能向别人展示我们的代码，那这个地方就是github</p>
<p>首先新建一个项目</p>
<p><img src="/posts/7b1df0314d16/0001.png"></p>
<p>让我们把本地项目和远程项目关联起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 跟踪新文件,或者说将内容从工作目录添加到暂存区</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 将暂存区内容添加到本地仓库中。</span></span><br><span class="line">git commit -m <span class="string">&quot;xx&quot;</span></span><br><span class="line"><span class="comment"># 拉去远程代码</span></span><br><span class="line">git pull origin master</span><br><span class="line"><span class="comment"># 提交代码</span></span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<p>在添加了新的内容之后，升级一下包的版本,并重新发布</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm version batch</span><br><span class="line">npm publish</span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/npm/" rel="tag">npm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">工程化</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-react/②(原理)state深入"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/9bd2ea4bc399/"
    >React原理 state深入</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/9bd2ea4bc399/" class="article-date">
  <time datetime="2021-09-02T07:26:41.000Z" itemprop="datePublished">2021-09-02</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="同步还是异步"><a href="#同步还是异步" class="headerlink" title="同步还是异步"></a>同步还是异步</h4><p><code>batchUpdate</code>批量更新可能并不准确，React 是有多种模式的，基本平时用的都是 <code>legacy</code> 模式下的 <code>React</code>，除了<code>legacy</code> 模式，还有 <code>blocking</code> 模式和 <code>concurrent</code> 模式， <code>blocking</code> 可以视为 <code>concurrent</code> 的优雅降级版本和过渡版本，React 未来将以 <code>concurrent</code> 模式作为默认版本，这个模式下会开启一些新功能。</p>
<p>对于 concurrent 模式下，会采用不同 State 更新逻辑。前不久透露出未来的React v18 版本，concurrent 将作为一个稳定的功能出现。</p>
<h4 id="setState时候发生了什么"><a href="#setState时候发生了什么" class="headerlink" title="setState时候发生了什么"></a>setState时候发生了什么</h4><ul>
<li><p>首先，<code>setState</code> 会产生当前更新的优先级（老版本用 expirationTime ，新版本用 lane ）。</p>
</li>
<li><p>接下来 React 会从 <code>fiber Root</code> 根部 <code>root fiber</code> 向下调和子节点，调和阶段将对比发生更新的地方，更新对比 expirationTime ，找到发生更新的组件，合并 <code>state</code>，然后触发 <code>render</code> 函数，得到新的 UI 视图层，完成 <code>render</code> 阶段。</p>
</li>
<li><p>接下来到 <code>commit</code> 阶段，<code>commit</code> 阶段，替换真实 DOM ，完成此次更新流程。</p>
</li>
<li><p>接下来会执行 <code>setState</code> 中 <code>callback</code> 函数,如上的()&#x3D;&gt;{ console.log(this.state.number) }，到此为止完成了一次 <code>setState</code> 全过程。</p>
</li>
</ul>
<h4 id="对更新的限制"><a href="#对更新的限制" class="headerlink" title="对更新的限制"></a>对更新的限制</h4><p>① pureComponent 可以对 state 和 props 进行浅比较，如果没有发生变化，那么组件不更新。</p>
<p>② shouldComponentUpdate 生命周期可以通过判断前后 state 变化来决定组件需不需要更新，需要更新返回true，否则返回false。</p>
<h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p><code>setState</code>实际上调用了<code>Component</code>上的<a href="/posts/72e97988/#class%E7%B1%BB%E7%BB%84%E4%BB%B6">updater对象的类方法</a></p>
<blockquote>
<p>&#x2F;react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.new.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">adoptClassInstance</span>(<span class="params">workInProgress: Fiber, instance: any</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  instance.<span class="property">updater</span> = classComponentUpdater;</span><br><span class="line">  workInProgress.<span class="property">stateNode</span> = instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> classComponentUpdater = &#123;</span><br><span class="line">  <span class="title function_">enqueueSetState</span>(<span class="params">inst, payload, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取当前fiber节点</span></span><br><span class="line">    <span class="keyword">const</span> fiber = <span class="title function_">getInstance</span>(inst);</span><br><span class="line">    <span class="comment">// 获取当前更新时间</span></span><br><span class="line">    <span class="keyword">const</span> eventTime = <span class="title function_">requestEventTime</span>();</span><br><span class="line">    <span class="comment">// 获取更新优先级</span></span><br><span class="line">    <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每一次调用`setState`，react 都会创建一个 update </span></span><br><span class="line">    <span class="keyword">const</span> update = <span class="title function_">createUpdate</span>(eventTime, lane);</span><br><span class="line">    update.<span class="property">payload</span> = payload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存更新之后的会掉函数</span></span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.<span class="property">callback</span> = callback;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* enqueueUpdate 把当前的update 传入当前fiber，待更新队列中 */</span></span><br><span class="line">    <span class="title function_">enqueueUpdate</span>(fiber, update, lane);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始调度更新</span></span><br><span class="line">    <span class="keyword">const</span> root = <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>批量更新在何时处理？</strong> </p>
<p>大部分的更新都是由UI交互产生，或异步的方法和函数，例如<code>setTimeout</code>或<code>xhr</code>,批量更新和事件系统息息相关</p>
<p>事件系统的函数调用过程为：</p>
<blockquote>
<p>&#x2F;react-dom&#x2F;src&#x2F;client&#x2F;ReactDOMRoot.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">hydrateRoot</span>(<span class="params"></span></span><br><span class="line"><span class="params">  container: Container,</span></span><br><span class="line"><span class="params">  initialChildren: ReactNodeList,</span></span><br><span class="line"><span class="params">  options?: HydrateRootOptions,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">RootType</span> &#123;</span><br><span class="line">  <span class="comment">// 在root元素上监听所有的时间</span></span><br><span class="line">  <span class="title function_">listenToAllSupportedEvents</span>(container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listenToAllSupportedEvents</span>(<span class="params">rootContainerElement: EventTarget</span>) &#123;</span><br><span class="line">    <span class="comment">// 循环所有的事件名称，绑定事件</span></span><br><span class="line">    allNativeEvents.<span class="title function_">forEach</span>(<span class="function"><span class="params">domEventName</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">true</span>, rootContainerElement);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">listenToNativeEvent</span>(<span class="params">domEventName, isCapturePhaseListener, rootContainerElement, targetElement</span>) &#123;</span><br><span class="line">    <span class="title function_">addTrappedEventListener</span>(target, domEventName, eventSystemFlags, isCapturePhaseListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addTrappedEventListener</span>(<span class="params">targetContainer, domEventName, eventSystemFlags, isCapturePhaseListener, isDeferredListenerForLegacyFBSupport</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> listener = <span class="title function_">createEventListenerWrapperWithPriority</span>(targetContainer, domEventName, eventSystemFlags); <span class="comment">// If passive option is not supported, then the</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createEventListenerWrapperWithPriority</span>(<span class="params">targetContainer, domEventName, eventSystemFlags</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> eventPriority = <span class="title function_">getEventPriorityForPluginSystem</span>(domEventName);</span><br><span class="line">  <span class="keyword">var</span> listenerWrapper;</span><br><span class="line">  <span class="keyword">switch</span> (eventPriority) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">DiscreteEvent</span>:</span><br><span class="line">      listenerWrapper = dispatchDiscreteEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">UserBlockingEvent</span>:</span><br><span class="line">      listenerWrapper = dispatchUserBlockingUpdate;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ContinuousEvent</span>:</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      listenerWrapper = dispatchEvent;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> listenerWrapper.<span class="title function_">bind</span>(<span class="literal">null</span>, domEventName, eventSystemFlags, targetContainer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchEvent</span>(<span class="params">domEventName, eventSystemFlags, targetContainer, nativeEvent</span>) &#123;</span><br><span class="line">  <span class="title function_">dispatchEventForPluginEventSystem</span>(domEventName, eventSystemFlags, nativeEvent, <span class="literal">null</span>, targetContainer);</span><br><span class="line">&#125; <span class="comment">// Attempt dispatching an event. Returns a SuspenseInstance or Container if it&#x27;s blocked.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在`legacy`模式下，所有的事件都将经过此函数同一处理 </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchEventForPluginEventSystem</span>(<span class="params">domEventName, eventSystemFlags, nativeEvent, targetInst, targetContainer</span>) &#123;</span><br><span class="line">  <span class="title function_">batchedEventUpdates</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatchEventsForPlugins</span>(domEventName, eventSystemFlags, nativeEvent, ancestorInst);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">batchedEventUpdates</span>(<span class="params">fn, a, b</span>) &#123;</span><br><span class="line">  <span class="comment">// 标记为批量更新</span></span><br><span class="line">  <span class="comment">// scheduleUpdateOnFiber中会根据这个变量判断是否批量更新</span></span><br><span class="line">  isBatchingEventUpdates = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">batchedEventUpdatesImpl</span>(fn, a, b);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// try 不会影响finally执行，执行结束后标记为false</span></span><br><span class="line">    isBatchingEventUpdates = <span class="literal">false</span>;</span><br><span class="line">    <span class="title function_">finishEventHandler</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="更新调用栈"><a href="#更新调用栈" class="headerlink" title="更新调用栈"></a>更新调用栈</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state = &#123; <span class="attr">number</span>:<span class="number">0</span> &#125;</span><br><span class="line">    handleClick= <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback1&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback2&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback3&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; this.state.number &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">this.handleClick</span> &#125;  &gt;</span>number++<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>最终打印的结果是 <code>0,0,0,callback1 ,1,callback2 ,1,callback3 ,1,</code> </p>
<p><img src="/posts/9bd2ea4bc399/0001.awebp"></p>
<p>如果是异步执行，调用栈会被改变</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback1&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;    <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback2&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback3&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/posts/9bd2ea4bc399/0002.awebp"></p>
<p>在异步环境批量更新</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">const</span> &#123; unstable_batchedUpdates &#125; = <span class="title class_">ReactDOM</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="title function_">unstable_batchedUpdates</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span>&#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>那么如何提升更新优先级呢？</strong></p>
<p>React-dom 提供了 flushSync ，flushSync 可以将回调函数中的更新任务，放在一个较高的优先级中。React 设定了很多不同优先级的更新任务。如果一次更新任务在 flushSync 回调函数内部，那么将获得一个较高优先级的更新。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">handerClick=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>: <span class="number">1</span>  &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>: <span class="number">2</span>  &#125;)</span><br><span class="line">  <span class="title class_">ReactDOM</span>.<span class="title function_">flushSync</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>: <span class="number">3</span>  &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>: <span class="number">4</span>  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">   <span class="keyword">return</span> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终结果打印 <code>3,4,1</code></p>
<p><strong>flushSync补充说明</strong>：flushSync 在同步条件下，会合并之前的 setState | useState，可以理解成，如果发现了 flushSync ，就会先执行更新，如果之前有未更新的 setState ｜ useState ，就会一起合并了，所以就解释了如上，2 和 3 被批量更新到 3 ，所以 3 先被打印。</p>
<p>综上所述， React 同一级别更新优先级关系是:</p>
<p>flushSync 中的 setState &gt; 正常执行上下文中 setState &gt; setTimeout ，Promise 中的 setState。</p>
<h4 id="hooks中的state"><a href="#hooks中的state" class="headerlink" title="hooks中的state"></a>hooks中的state</h4><p>行为与类中的相似, 需要注意的是，在一个方法中的执行上下文中，是获取不到最新的<code>state</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params">props</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">/* 监听 number 变化 */</span></span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;监听number变化，此时的number是:  &#x27;</span> + number )</span><br><span class="line">  &#125;,[ number ])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handerClick</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">      <span class="comment">// 遇到下面高优先级更新被合并更新</span></span><br><span class="line">      <span class="title function_">setNumber</span>(<span class="number">5</span>) </span><br><span class="line"></span><br><span class="line">      <span class="comment">// 和handerClick方法中下面的几个打印函数一样</span></span><br><span class="line">      <span class="comment">// 打印值都为0,每次触发更新之后，Index函数都会被重新执行</span></span><br><span class="line">      <span class="comment">// number值已经与当前环境绑定</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(number);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/** 高优先级更新 **/</span></span><br><span class="line">      <span class="title class_">ReactDOM</span>.<span class="title function_">flushSync</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="title function_">setNumber</span>(<span class="number">3</span>) </span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 批量更新，只会触发一次更新</span></span><br><span class="line">      <span class="title function_">setNumber</span>(<span class="number">1</span>) </span><br><span class="line">      <span class="title function_">setNumber</span>(<span class="number">2</span>) </span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(number);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 滞后更新 ，批量更新规则被打破</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="title function_">setNumber</span>(<span class="number">4</span>) </span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(number);</span><br><span class="line">      &#125;)</span><br><span class="line">     </span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每次函数被重新执行的时候，打印最新的state值</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(number)</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span> &#123; number &#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handerClick</span> &#125;  &gt;</span>number++<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="相同与不同"><a href="#相同与不同" class="headerlink" title="相同与不同"></a>相同与不同</h4><p><strong>相同</strong>： </p>
<p>首先从原理角度出发，setState和 useState 更新视图，底层都调用了 scheduleUpdateOnFiber 方法，而且事件驱动情况下都有批量更新规则。</p>
<p><strong>不同</strong>: </p>
<p>在不是 pureComponent 组件模式下， setState 不会浅比较两次 state 的值，只要调用 setState，在没有其他优化手段的前提下，就会执行更新。但是 useState 中的 dispatchAction 会默认比较两次 state 是否相同，然后决定是否更新组件。</p>
<p>setState 有专门监听 state 变化的回调函数 callback，可以获取最新state；但是在函数组件中，只能通过 useEffect 来执行 state 变化引起的副作用。</p>
<p>setState 在底层处理逻辑上主要是和老 state 进行合并处理，而 useState 更倾向于重新赋值。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-other/Ubuntu20.04安装VMwarePlayer"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/5c182e47d957/"
    >Ubuntu20.04安装VMwarePlayer</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/5c182e47d957/" class="article-date">
  <time datetime="2021-09-01T04:50:57.000Z" itemprop="datePublished">2021-09-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="workstation-和-player之间有什么区别"><a href="#workstation-和-player之间有什么区别" class="headerlink" title="workstation 和 player之间有什么区别"></a>workstation 和 player之间有什么区别</h4><p><img src="/posts/5c182e47d957/0007.png"></p>
<h4 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h4><p>安装 <code>build-essential</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install build-essential</span><br></pre></td></tr></table></figure>

<h4 id="下载-VMware-Player"><a href="#下载-VMware-Player" class="headerlink" title="下载 VMware Player"></a>下载 VMware Player</h4><p><a target="_blank" rel="noopener" href="https://www.vmware.com/products/workstation-player.html">VMware Workstation Player</a></p>
<h4 id="安装-VMware-Player"><a href="#安装-VMware-Player" class="headerlink" title="安装 VMware Player"></a>安装 VMware Player</h4><p>添加可执行权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> a+x ./VMware-Player-xxx.bundle</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./VMware-Player-xxx.bundle</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sh VMware-Player-xxx.bundle</span><br></pre></td></tr></table></figure>

<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p>按步骤安装 </p>
<p><img src="/posts/5c182e47d957/0001.png"></p>
<h4 id="在BIOS中开启虚拟化技术"><a href="#在BIOS中开启虚拟化技术" class="headerlink" title="在BIOS中开启虚拟化技术"></a>在BIOS中开启虚拟化技术</h4><p>一般为BIOS中，【Configuration】选项下的【Intel Virtual Technology】</p>
<h4 id="为-vmnet-和-vmmon-服务创建私有密钥"><a href="#为-vmnet-和-vmmon-服务创建私有密钥" class="headerlink" title="为 vmnet 和 vmmon 服务创建私有密钥"></a>为 vmnet 和 vmmon 服务创建私有密钥</h4><p>官方文档中解决找不到&#x2F;dev&#x2F;vmmon的问题</p>
<p><a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/2146460">“Cannot open &#x2F;dev&#x2F;vmmon: No such file or directory” error when powering on a VM (2146460)</a></p>
<p>最后一步执行需要用root权限执行,并输入密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line">mokutil –import MOK.der</span><br></pre></td></tr></table></figure>

<p>重启电脑，在UEFI BIOS中选择Enroll MOK</p>
<p><img src="/posts/5c182e47d957/0002.png"></p>
<p><img src="/posts/5c182e47d957/0003.png"></p>
<p><img src="/posts/5c182e47d957/0004.png"></p>
<p><img src="/posts/5c182e47d957/0005.png"></p>
<p><img src="/posts/5c182e47d957/0006.png"></p>
<p>重启后就可以正常使用</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/10/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/12/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2025
        <i class="ri-heart-fill heart_icon"></i> SunZhiqi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.png" alt="四月八日"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>此时无声胜有声！</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="/js/jquery.modal.min.js"></script>
<link rel="stylesheet" href="/css/jquery.modal.min.css" />
<script src="/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
  <div class="pswp__bg"></div>

  <!-- Slides wrapper with overflow:hidden. -->
  <div class="pswp__scroll-wrap">
    <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>

    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <!--  Controls are self-explanatory. Order can be changed. -->

        <div class="pswp__counter"></div>

        <button
          class="pswp__button pswp__button--close"
          title="Close (Esc)"
        ></button>

        <button
          class="pswp__button pswp__button--share"
          style="display: none"
          title="Share"
        ></button>

        <button
          class="pswp__button pswp__button--fs"
          title="Toggle fullscreen"
        ></button>

        <button
          class="pswp__button pswp__button--zoom"
          title="Zoom in/out"
        ></button>

        <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
        <!-- element will get class pswp__preloader--active when preloader is running -->
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip"></div>
      </div>

      <button
        class="pswp__button pswp__button--arrow--left"
        title="Previous (arrow left)"
      ></button>

      <button
        class="pswp__button pswp__button--arrow--right"
        title="Next (arrow right)"
      ></button>

      <div class="pswp__caption">
        <div class="pswp__caption__center"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/photoswipe.min.css" />
<link rel="stylesheet" href="/css/default-skin.min.css" />
<script src="/js/photoswipe.min.js"></script>
<script src="/js/photoswipe-ui-default.min.js"></script>

<script>
  function viewer_init() {
    let pswpElement = document.querySelectorAll(".pswp")[0];
    let $imgArr = document.querySelectorAll(
      ".article-entry img:not(.reward-img)"
    );

    $imgArr.forEach(($em, i) => {
      $em.onclick = () => {
        // slider展开状态
        // todo: 这样不好，后面改成状态
        if (document.querySelector(".left-col.show")) return;
        let items = [];
        $imgArr.forEach(($em2, i2) => {
          let img = $em2.getAttribute("data-idx", i2);
          let src =
            $em2.getAttribute("data-target") || $em2.getAttribute("src");
          let title = $em2.getAttribute("alt");
          // 获得原图尺寸
          const image = new Image();
          image.src = src;
          items.push({
            src: src,
            w: image.width || $em2.width,
            h: image.height || $em2.height,
            title: title,
          });
        });
        var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
          index: parseInt(i),
        });
        gallery.init();
      };
    });
  }
  viewer_init();
</script>
 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="/js/MathJax.js"></script>
<script src="/js/TeX-AMS-MML_HTMLorMML-full.js"></script>

<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="/js/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !(function (e, t, a) {
    var initCopyCode = function () {
      var copyHtml = "";
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += "</button>";
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS(".btn-copy", {
        target: function (trigger) {
          return trigger.nextElementSibling;
        },
      });
      clipboard.on("success", function (e) {
        let $btn = $(e.trigger);
        $btn.addClass("copied");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-checkbox-circle-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPIED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-checkbox-circle-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
      clipboard.on("error", function (e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass("copy-failed");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-time-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPY FAILED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-time-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
    };
    initCopyCode();
  })(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "default" });
  }
</script>


    
    

  </div>
</body>

</html>