<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="前端 web react" />
       
      <meta name="description" content="前端技术与生活。" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 四月八日</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">
 
<link rel="stylesheet" href="/css/fonts/remixicon.css">
 
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="/js/pace.min.js"></script>
       
 

      <link rel="stylesheet" href="/css/bulma.min.css" />
      <script src="/js/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <script src="https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js"></script>
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/katex.min.css">

<link rel="stylesheet" href="/css/style.css">
<!-- hexo injector head_end end --></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">四月八日</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['愿你足够强大，也要足够温柔', '最轻的并不是一根羽毛，而是一双飞鸟的翅膀', ''],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="posts-other/rsync备份"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/e5a73bbf0194/"
    >inotify + rsync 实现数据本地实时备份</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/e5a73bbf0194/" class="article-date">
  <time datetime="2022-03-04T14:06:48.000Z" itemprop="datePublished">2022-03-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h4><p>用 <code>inotify</code> 工具监听文件改变，将改变的文件使用 <code>rsync</code> 同步</p>
<h4 id="inotify介绍"><a href="#inotify介绍" class="headerlink" title="inotify介绍"></a>inotify介绍</h4><p>inotify 是一种强大的、细粒度的、异步文件系统监控机制，它满足各种各样的文件监控需要，可以监控文件系统的访问属性、读写属性、权限属性、创建删除、移动等操作，也可以监控文件发生的一切变化。</p>
<p>inotify-tools 是一个C库和一组命令行的工作提供Linux下inotify的简单接口。</p>
<p>inotify-tools 中包含 inotifywait 和 inotifywatch 两个命令</p>
<p>inotifywatch 命令用于收集关于被监控的文件系统的统计数据，包括每个inotify事件发生多少次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]<span class="comment"># inotifywait --help</span></span><br><span class="line">inotifywait 3.14</span><br><span class="line">Wait <span class="keyword">for</span> a particular event on a file or <span class="built_in">set</span> of files.</span><br><span class="line">Usage: inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]</span><br><span class="line">Options:</span><br><span class="line">    -h|--<span class="built_in">help</span>         Show this <span class="built_in">help</span> text.</span><br><span class="line">    @&lt;file&gt;           Exclude the specified file from being watched.</span><br><span class="line">    --exclude &lt;pattern&gt;</span><br><span class="line">                      Exclude all events on files matching the</span><br><span class="line">                      extended regular expression &lt;pattern&gt;.指定排除部分文件</span><br><span class="line">    --excludei &lt;pattern&gt;</span><br><span class="line">                      Like --exclude but <span class="keyword">case</span> insensitive.（同上，排除且忽略大小写）</span><br><span class="line">    -m|--monitor      Keep listening <span class="keyword">for</span> events forever.  Without</span><br><span class="line">                      this option, inotifywait will <span class="built_in">exit</span> after one</span><br><span class="line">                      event is received.(持续监听）</span><br><span class="line">    -d|--daemon       Same as --monitor, except run <span class="keyword">in</span> the background</span><br><span class="line">                      logging events to a file specified by --outfile.</span><br><span class="line">                      Implies --syslog.（daemon模式）</span><br><span class="line">    -r|--recursive    Watch directories recursively.（递归子目录）</span><br><span class="line">    --fromfile &lt;file&gt;</span><br><span class="line">                      Read files to watch from &lt;file&gt; or <span class="string">&#x27;-&#x27;</span> <span class="keyword">for</span> stdin.</span><br><span class="line">    -o|--outfile &lt;file&gt;</span><br><span class="line">                      Print events to &lt;file&gt; rather than stdout. （将事件输出到文件，而不是屏幕）</span><br><span class="line">    -s|--syslog       Send errors to syslog rather than stderr.</span><br><span class="line">    -q|--quiet        Print less (only <span class="built_in">print</span> events).（打印事件）</span><br><span class="line">    -qq               Print nothing (not even events).（不打印事件）</span><br><span class="line">    --format &lt;<span class="built_in">fmt</span>&gt;    Print using a specified printf-like format</span><br><span class="line">                      string; <span class="built_in">read</span> the man page <span class="keyword">for</span> more details. (设置打印格式%T时间；%w触发事件文件所在绝对路径；%f触发事件文件名称；%e触发的事件名称；)</span><br><span class="line">    --timefmt &lt;<span class="built_in">fmt</span>&gt;    strftime-compatible format string <span class="keyword">for</span> use with</span><br><span class="line">                      %T <span class="keyword">in</span> --format string.（指定输出内容，相当于将时间赋值给%T）</span><br><span class="line">    -c|--csv          Print events <span class="keyword">in</span> CSV format.</span><br><span class="line">    -t|--<span class="built_in">timeout</span> &lt;seconds&gt;</span><br><span class="line">                      When listening <span class="keyword">for</span> a single event, time out after</span><br><span class="line">                      waiting <span class="keyword">for</span> an event <span class="keyword">for</span> &lt;seconds&gt; seconds.</span><br><span class="line">                      If &lt;seconds&gt; is 0, inotifywait will never time out.</span><br><span class="line">    -e|--event &lt;event1&gt; [ -e|--event &lt;event2&gt; ... ]</span><br><span class="line">        Listen <span class="keyword">for</span> specific event(s).  If omitted, all events are </span><br><span class="line">        listened <span class="keyword">for</span>.（指定要监听的事件，多个事件用逗号隔开）</span><br><span class="line"></span><br><span class="line">Exit status:</span><br><span class="line">    0  -  An event you asked to watch <span class="keyword">for</span> was received.</span><br><span class="line">    1  -  An event you did not ask to watch <span class="keyword">for</span> was received</span><br><span class="line">          (usually delete_self or unmount), or some error occurred.</span><br><span class="line">    2  -  The --<span class="built_in">timeout</span> option was given and no events occurred</span><br><span class="line">          <span class="keyword">in</span> the specified interval of time.</span><br><span class="line"></span><br><span class="line">Events:     （事件）</span><br><span class="line">    access        file or directory contents were <span class="built_in">read</span></span><br><span class="line">    modify        file or directory contents were written</span><br><span class="line">    attrib        file or directory attributes changed</span><br><span class="line">    close_write    file or directory closed, after being opened <span class="keyword">in</span></span><br><span class="line">                   writeable mode</span><br><span class="line">    close_nowrite    file or directory closed, after being opened <span class="keyword">in</span></span><br><span class="line">                   read-only mode</span><br><span class="line">    close        file or directory closed, regardless of <span class="built_in">read</span>/write mode</span><br><span class="line">    open        file or directory opened</span><br><span class="line">    moved_to    file or directory moved to watched directory</span><br><span class="line">    moved_from    file or directory moved from watched directory</span><br><span class="line">    move        file or directory moved to or from watched directory</span><br><span class="line">    create        file or directory created within watched directory</span><br><span class="line">    delete        file or directory deleted within watched directory</span><br><span class="line">    delete_self    file or directory was deleted</span><br><span class="line">    unmount        file system containing file or directory unmounted</span><br></pre></td></tr></table></figure>

<p><strong>示例</strong> 监听&#x2F;backup&#x2F;目录下所有文件和目录的增删改操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inotifywait -mrq -e <span class="string">&#x27;create,delete,close_write,attrib,moved_to&#x27;</span> --timefmt <span class="string">&#x27;%Y-%m-%d %H:%M&#x27;</span> --format <span class="string">&#x27;%T %w%f %e&#x27;</span> /backup/</span><br></pre></td></tr></table></figure>

<h4 id="rsync介绍"><a href="#rsync介绍" class="headerlink" title="rsync介绍"></a>rsync介绍</h4><p>rsync是可以实现增量备份的工具。配合任务计划，rsync能实现定时或间隔同步，配合inotify或sersync，可以实现触发式的实时同步。</p>
<p>Rsync的命令格式可以为以下六种：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rsync [OPTION]... SRC DEST</span><br><span class="line">rsync [OPTION]... SRC [USER@]HOST:DEST</span><br><span class="line">rsync [OPTION]... [USER@]HOST:SRC DEST</span><br><span class="line">rsync [OPTION]... [USER@]HOST::SRC DEST</span><br><span class="line">rsync [OPTION]... SRC [USER@]HOST::DEST</span><br><span class="line">rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</span><br></pre></td></tr></table></figure>

<p>对应于以上六种命令格式，rsync有六种不同的工作模式：</p>
<p>　　1)拷贝本地文件。当SRC和DES路径信息都不包含有单个冒号”:”分隔符时就启动这种工作模式。如：rsync -a &#x2F;data &#x2F;backup</p>
<p>　　2)使用一个远程shell程序(如rsh、ssh)来实现将本地机器的内容拷贝到远程机器。当DST路径地址包含单个冒号”:”分隔符时启动该模式。如：rsync -avz *.c foo:src</p>
<p>　　3)使用一个远程shell程序(如rsh、ssh)来实现将远程机器的内容拷贝到本地机器。当SRC地址路径包含单个冒号”:”分隔符时启动该模式。如：rsync -avz foo:src&#x2F;bar &#x2F;data</p>
<p>　　4)从远程rsync服务器中拷贝文件到本地机。当SRC路径信息包含”::”分隔符时启动该模式。如：rsync -av <a href="mailto:&#114;&#111;&#111;&#x74;&#64;&#49;&#x37;&#50;&#x2e;&#x31;&#x36;&#x2e;&#55;&#56;&#x2e;&#49;&#x39;&#50;">&#114;&#111;&#111;&#x74;&#64;&#49;&#x37;&#50;&#x2e;&#x31;&#x36;&#x2e;&#55;&#56;&#x2e;&#49;&#x39;&#50;</a>::www &#x2F;databack</p>
<p>　　5)从本地机器拷贝文件到远程rsync服务器中。当DST路径信息包含”::”分隔符时启动该模式。如：rsync -av &#x2F;databack <a href="mailto:&#114;&#x6f;&#111;&#116;&#64;&#49;&#x37;&#x32;&#46;&#49;&#x36;&#46;&#x37;&#x38;&#x2e;&#49;&#x39;&#x32;">&#114;&#x6f;&#111;&#116;&#64;&#49;&#x37;&#x32;&#46;&#49;&#x36;&#46;&#x37;&#x38;&#x2e;&#49;&#x39;&#x32;</a>::www</p>
<p>　　6)列远程机的文件列表。这类似于rsync传输，不过只要在命令中省略掉本地机信息即可。如：rsync -v rsync:&#x2F;&#x2F;172.16.78.192&#x2F;www</p>
<p>rsync参数的具体解释如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">-v, --verbose 详细模式输出</span><br><span class="line">-q, --quiet 精简输出模式</span><br><span class="line">-c, --checksum 打开校验开关，强制对文件传输进行校验</span><br><span class="line">-a, --archive 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rlptgoD</span><br><span class="line">-r, --recursive 对子目录以递归模式处理</span><br><span class="line">-R, --relative 使用相对路径信息</span><br><span class="line">-b, --backup 创建备份，也就是对于目的已经存在有同样的文件名时，将老的文件重新命名为~filename。可以使用--suffix选项来指定不同的备份文件前缀。</span><br><span class="line">--backup-dir 将备份文件(如~filename)存放在在目录下。</span><br><span class="line">-suffix=SUFFIX 定义备份文件前缀</span><br><span class="line">-u, --update 仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件。(不覆盖更新的文件)</span><br><span class="line">-l, --links 保留软链结</span><br><span class="line">-L, --copy-links 想对待常规文件一样处理软链结</span><br><span class="line">--copy-unsafe-links 仅仅拷贝指向SRC路径目录树以外的链结</span><br><span class="line">--safe-links 忽略指向SRC路径目录树以外的链结</span><br><span class="line">-H, --hard-links 保留硬链结</span><br><span class="line">-p, --perms 保持文件权限</span><br><span class="line">-o, --owner 保持文件属主信息</span><br><span class="line">-g, --group 保持文件属组信息</span><br><span class="line">-D, --devices 保持设备文件信息</span><br><span class="line">-t, --<span class="built_in">times</span> 保持文件时间信息</span><br><span class="line">-S, --sparse 对稀疏文件进行特殊处理以节省DST的空间</span><br><span class="line">-n, --dry-run现实哪些文件将被传输</span><br><span class="line">-W, --whole-file 拷贝文件，不进行增量检测</span><br><span class="line">-x, --one-file-system 不要跨越文件系统边界</span><br><span class="line">-B, --block-size=SIZE 检验算法使用的块尺寸，默认是700字节</span><br><span class="line">-e, --rsh=COMMAND 指定使用rsh、ssh方式进行数据同步</span><br><span class="line">--rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息</span><br><span class="line">-C, --cvs-exclude 使用和CVS一样的方法自动忽略文件，用来排除那些不希望传输的文件</span><br><span class="line">--existing 仅仅更新那些已经存在于DST的文件，而不备份那些新创建的文件</span><br><span class="line">--delete 删除那些DST中SRC没有的文件</span><br><span class="line">--delete-excluded 同样删除接收端那些被该选项指定排除的文件</span><br><span class="line">--delete-after 传输结束以后再删除</span><br><span class="line">--ignore-errors 及时出现IO错误也进行删除</span><br><span class="line">--max-delete=NUM 最多删除NUM个文件</span><br><span class="line">--partial 保留那些因故没有完全传输的文件，以是加快随后的再次传输</span><br><span class="line">--force 强制删除目录，即使不为空</span><br><span class="line">--numeric-ids 不将数字的用户和组ID匹配为用户名和组名</span><br><span class="line">--<span class="built_in">timeout</span>=TIME IP超时时间，单位为秒</span><br><span class="line">-I, --ignore-times 不跳过那些有同样的时间和长度的文件</span><br><span class="line">--size-only 当决定是否要备份文件时，仅仅察看文件大小而不考虑文件时间</span><br><span class="line">--modify-window=NUM 决定文件是否时间相同时使用的时间戳窗口，默认为0</span><br><span class="line">-T --temp-dir=DIR 在DIR中创建临时文件</span><br><span class="line">--compare-dest=DIR 同样比较DIR中的文件来决定是否需要备份</span><br><span class="line">-P 等同于 --partial</span><br><span class="line">--progress 显示备份过程</span><br><span class="line">-z, --compress 对备份的文件在传输时进行压缩处理</span><br><span class="line">--exclude=PATTERN 指定排除不需要传输的文件模式</span><br><span class="line">--include=PATTERN 指定不排除而需要传输的文件模式</span><br><span class="line">--exclude-from=FILE 排除FILE中指定模式的文件</span><br><span class="line">--include-from=FILE 不排除FILE指定模式匹配的文件</span><br><span class="line">--version 打印版本信息</span><br><span class="line">--address 绑定到特定的地址</span><br><span class="line">--config=FILE 指定其他的配置文件，不使用默认的rsyncd.conf文件</span><br><span class="line">--port=PORT 指定其他的rsync服务端口</span><br><span class="line">--blocking-io 对远程shell使用阻塞IO</span><br><span class="line">-stats 给出某些文件的传输状态</span><br><span class="line">--progress 在传输时现实传输过程</span><br><span class="line">--log-format=formAT 指定日志文件格式</span><br><span class="line">--password-file=FILE 从FILE中得到密码</span><br><span class="line">--bwlimit=KBPS 限制I/O带宽，KBytes per second</span><br><span class="line">-h, --<span class="built_in">help</span> 显示帮助信息</span><br></pre></td></tr></table></figure>

<p><strong>示例1</strong> 将&#x2F;etc&#x2F;fstab拷贝到&#x2F;tmp目录下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync /etc/fstab /tmp</span><br></pre></td></tr></table></figure>

<p><strong>示例2</strong> 将&#x2F;etc&#x2F;cron.d目录拷贝到&#x2F;tmp下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -r /etc/cron.d /tmp</span><br></pre></td></tr></table></figure>

<p><strong>说明</strong>：为了保持文件夹一致，可以将路径写为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avr /src/ /backup/</span><br></pre></td></tr></table></figure>

<p>这样src下面的所有目录会被备份到 backup目录下面,而不会在backup文件夹下面创建src文件夹</p>
<h4 id="创建同步脚本"><a href="#创建同步脚本" class="headerlink" title="创建同步脚本"></a>创建同步脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">fn</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">	src=<span class="variable">$1</span>     <span class="comment"># 需要同步的源路径</span></span><br><span class="line">	des=<span class="variable">$2</span>     <span class="comment"># 目标路径</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">cd</span> <span class="variable">$&#123;src&#125;</span> <span class="comment">#定位到源文件下面</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 此方法中，由于rsync同步的特性，这里必须要先cd到源目录，inotify再监听 ./ 才能rsync同步后目录结构一致</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 把监控到有发生更改的&quot;文件路径列表&quot;循环</span></span><br><span class="line">	/usr/bin/inotifywait -mrq --format <span class="string">&#x27;%Xe %w%f&#x27;</span> -e modify,create,delete,attrib,close_write,move ./ | <span class="keyword">while</span> <span class="built_in">read</span> file; <span class="keyword">do</span></span><br><span class="line">		INO_EVENT=$(<span class="built_in">echo</span> <span class="variable">$file</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>) <span class="comment"># 把inotify输出切割 把事件类型部分赋值给INO_EVENT</span></span><br><span class="line">		INO_FILE=$(<span class="built_in">echo</span> <span class="variable">$file</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)  <span class="comment"># 把inotify输出切割 把文件路径部分赋值给INO_FILE</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;-------------------------------<span class="subst">$(date)</span>------------------------------------&quot;</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$file</span></span><br><span class="line">		<span class="comment">#增加、修改、写入完成、移动进事件</span></span><br><span class="line">		<span class="comment">#增、改放在同一个判断，因为他们都肯定是针对文件的操作，即使是新建目录，要同步的也只是一个空目录，不会影响速度。</span></span><br><span class="line">		<span class="keyword">if</span> [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;CREATE&#x27;</span> ]] || [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;MODIFY&#x27;</span> ]] || [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;CLOSE_WRITE&#x27;</span> ]] || [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;MOVED_TO&#x27;</span> ]]; <span class="keyword">then</span> <span class="comment"># 判断事件类型</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&#x27;CREATE or MODIFY or CLOSE_WRITE or MOVED_TO&#x27;</span></span><br><span class="line">			<span class="comment"># INO_FILE变量代表路径  -c校验文件内容</span></span><br><span class="line">			rsync -avzcR $(<span class="built_in">dirname</span> <span class="variable">$&#123;INO_FILE&#125;</span>) <span class="variable">$&#123;des&#125;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">#上面的rsync同步命令 源是用了$(dirname $&#123;INO_FILE&#125;)变量 即每次只针对性的同步发生改变的文件的目录</span></span><br><span class="line">			<span class="comment">#只同步目标文件的方法在生产环境的某些极端环境下会漏文件 现在可以在不漏文件下也有不错的速度 做到平衡)</span></span><br><span class="line">			<span class="comment">#然后用-R参数把源的目录结构递归到目标后面 保证目录结构一致性</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="comment">#删除、移动出事件</span></span><br><span class="line">		<span class="keyword">if</span> [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;DELETE&#x27;</span> ]] || [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;MOVED_FROM&#x27;</span> ]]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&#x27;DELETE or MOVED_FROM&#x27;</span></span><br><span class="line">			<span class="comment">#并加上--delete来删除目标上有而源中没有的文件，这里不能做到指定文件删除，如果删除的路径越靠近根，则同步的目录月多，同步删除的操作就越花时间。</span></span><br><span class="line">			rsync -avzr --delete $(<span class="built_in">dirname</span> <span class="variable">$&#123;INO_FILE&#125;</span>) <span class="variable">$&#123;des&#125;</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="comment">#修改属性事件 指 touch chmod chown等操作</span></span><br><span class="line">		<span class="keyword">if</span> [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;ATTRIB&#x27;</span> ]]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&#x27;ATTRIB&#x27;</span></span><br><span class="line">			<span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$INO_FILE</span>&quot;</span> ]; <span class="keyword">then</span> <span class="comment"># 如果修改属性的是目录 则不同步，因为同步目录会发生递归扫描，等此目录下的文件发生同步时，rsync会顺带更新此目录。</span></span><br><span class="line">				rsync -avzcR $(<span class="built_in">dirname</span> <span class="variable">$&#123;INO_FILE&#125;</span>) <span class="variable">$&#123;des&#125;</span></span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn /home/supreme/Workspace/ /media/supreme/yes/Workspace/ &amp; <span class="comment">#加上&amp;符号表示在后台执行</span></span><br><span class="line">fn 源路径2 目标路径2 &amp; <span class="comment">#加上&amp;符号表示在后台执行</span></span><br></pre></td></tr></table></figure>

<h4 id="添加开机启动项"><a href="#添加开机启动项" class="headerlink" title="添加开机启动项"></a>添加开机启动项</h4><p>将写好的脚本放到指定目录中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> ./sync.sh /usr/sbin</span><br></pre></td></tr></table></figure>
<p>创建一个服务文件 sync.service</p>
<p>systemd有系统和用户区分；系统（&#x2F;user&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;）、用户（&#x2F;etc&#x2F;lib&#x2F;systemd&#x2F;user&#x2F;）.</p>
<p>一般系统管理员手工创建的单元文件建议存放在&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;目录下面。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description= 服务的简单描述</span><br><span class="line">Documentation= 服务文档</span><br><span class="line"><span class="comment"># Before、After:定义启动顺序。Before=xxx.service,代表本服务在xxx.service启动之前启动。After=xxx.service,代表本服务在xxx.service之后启动。</span></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="comment"># systemd认为当该服务进程fork，且父进程退出后服务启动成功。对于常规的守护进程 daemon</span></span><br><span class="line"><span class="comment"># 除非你确定此启动方式无法满足需求，使用此类型启动即可。使用此启动类型应同时指定 PIDFile=，以便systemd能够跟踪服务的主进程。</span></span><br><span class="line">Type=forking</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/sbin/sync.sh</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="comment"># 单元被允许运行需要的弱依赖性单元，WantBy从Want列表获得依赖信息。</span></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>添加开机启动并重载服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> sync.service</span><br><span class="line"></span><br><span class="line">sudo systemctl start sync.service</span><br><span class="line">sudo systemctl stop sync.service</span><br><span class="line">sudo systemctl reload sync.service</span><br><span class="line"></span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/inotify/" rel="tag">inotify</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rsync/" rel="tag">rsync</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/Docker部署Jira"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/84719102d07f/"
    >Docker 部署Jira + 破解</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/84719102d07f/" class="article-date">
  <time datetime="2022-03-04T14:00:05.000Z" itemprop="datePublished">2022-03-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="创建必要目录"><a href="#创建必要目录" class="headerlink" title="创建必要目录"></a>创建必要目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p docker-compose/jira</span><br></pre></td></tr></table></figure>

<h4 id="创建docker-compose-yml"><a href="#创建docker-compose-yml" class="headerlink" title="创建docker-compose.yml"></a>创建docker-compose.yml</h4><ul>
<li>修改映射路径为当前文件夹下的相对路径</li>
<li>JIRA_PROXY_NAME &#x3D; 域名</li>
<li>JIRA_PROXY_PORT &#x3D; 外部端口</li>
<li>JIRA_PROXY_SCHEME &#x3D; 协议</li>
<li>POSTGRES_PASSWORD 修改数据库密码</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jira:</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgresql</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">image:</span> <span class="string">teamatldocker/jira:8.19.0</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jiranet</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./jiradata:/var/atlassian/jira</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;1170:8080&#x27;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;JIRA_DATABASE_URL=postgresql://jira@postgresql/jiradb&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;JIRA_DB_PASSWORD=w.521@@ong.COM&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;SETENV_JVM_MINIMUM_MEMORY=2048m&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;SETENV_JVM_MAXIMUM_MEMORY=4096m&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;JIRA_PROXY_NAME=jira.iftrue.club&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;JIRA_PROXY_PORT=1170&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;JIRA_PROXY_SCHEME=http&#x27;</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="comment"># limit logs retained on host to 25MB</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&quot;500k&quot;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&quot;50&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">postgresql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:12-alpine</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jiranet</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./postgresqldata:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_USER=jira&#x27;</span></span><br><span class="line">      <span class="comment"># CHANGE THE PASSWORD!</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_PASSWORD=w.521@@ong.COM&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_DB=jiradb&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_ENCODING=UNICODE&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_COLLATE=C&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_COLLATE_TYPE=C&#x27;</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="comment"># limit logs retained on host to 25MB</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&quot;500k&quot;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&quot;50&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">jiradata:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">postgresqldata:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">jiranet:</span></span><br></pre></td></tr></table></figure>

<h4 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h4><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/xiaonandl/atlassian-agent">下载</a> atlassian-agent.jar 文件压缩包，并解压</p>
</li>
<li><p>将 <code>atlassian-agent.jar</code> 复制到容器内 <code>docker cp ./atlassian-agent.jar jira容器名称:/opt/jira</code></p>
</li>
<li><p>在 <code>docker-compose/jira</code> 目录下执行 <code>docker-compose up</code> 启动动容器</p>
</li>
<li><p>进入容器 <code>docker exec -it jira</code> 容器名称 <code>/bin/bash</code></p>
</li>
<li><p>修改环境变量 <code>cd /opt/jira/bin vi setenv.sh</code></p>
</li>
</ul>
<p><img src="/posts/84719102d07f/0001.png"></p>
<p>export JAVA_OPTS 修改为 export JAVA_OPTS&#x3D;”-javaagent:&#x2F;opt&#x2F;jira&#x2F;atlassian-agent.jar ${JAVA_OPTS}”</p>
<ul>
<li><p>重启容器, 在日志中可以看到 <code>========= agent working =========</code> 字样表示成功</p>
</li>
<li><p>再次进入容器 执行 <code>java -jar atlassian-agent.jar -p jsm -m aaa@bbb.com -n my_name -o https://zhile.io -s ABCD-1234-EFGH-5678</code></p>
</li>
</ul>
<p><strong>特别注意 -p 参数设置，通过 java -jar atlassian-agent.jar 查看使用帮助，每种产品有不同的标识</strong></p>
<p>-m 邮箱任意填写<br>-n 名称任意填写<br>-o 网址任意填写<br>-s server id 再安装时查看</p>
<p>复制执行命令之后产生的激活码，复制到激活码的窗口完成激活。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-pattern/③装饰者模式"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/3e1242dd4c72/"
    >③悄无声息的扩展-装饰者模式</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/3e1242dd4c72/" class="article-date">
  <time datetime="2022-01-03T04:49:16.000Z" itemprop="datePublished">2022-01-03</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>简单说装饰可以让你不用修改底层代码给对象赋予新的职责。</p>
<h4 id="从分离改变，更进一步"><a href="#从分离改变，更进一步" class="headerlink" title="从分离改变，更进一步"></a>从分离改变，更进一步</h4><p>看了前两个设计模式，相信你一定感觉到继承只能解决静态时对类的扩展，如果想动态的对类的行为扩展就需要用到组合。</p>
<p>既然我们已经可以用策略模式分离改变的部分，还有什么做不到的么？ 看看下面一个问题：</p>
<ul>
<li>奶茶店有几十种品种的饮料，他们都需要继承自一个抽象类 Beverage，因为每种饮料有自己的产品说明，并且各自实现了一个计算金额的方法 cost。</li>
<li>每种奶茶除了自己特有的配料外，还可以额外付费添加配料，比如加两份的珍珠，加一份椰果，并且需要计算总价。</li>
</ul>
<p>如果想枚举出店内的每一种产品是不现实的，那时非常庞大的一个排列组合，因为不可能知道客户要加那些配料。并且严重的违反了设计中的两个原则：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BeverageAbstract</span> &#123;</span><br><span class="line">  description = <span class="string">&quot;some description&quot;</span>;</span><br><span class="line">  <span class="title function_">cost</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 果茶加牛奶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FruitTeaWithMilk</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BeverageAbstract</span> &#123;&#125;</span><br><span class="line"><span class="comment">// 柠檬茶加两份珍珠</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LemonTeaWith2Pearls</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BeverageAbstract</span> &#123;&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>既然不能枚举考虑是不是应该有一个统一的 Beverage 类，用于实现抽象类 BeverageAbstract，并且把所有的配料都添加在 Beverage 上，并记录配料的数量。<br>子类会调用父类 cost 方法计算所有配料，并加上自己品种的价格。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BeverageAbstract</span> &#123;</span><br><span class="line">  description = <span class="string">&quot;some description&quot;</span>;</span><br><span class="line">  <span class="title function_">cost</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Beverage</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BeverageAbstract</span> &#123;</span><br><span class="line">  milk = <span class="number">2</span>;</span><br><span class="line">  milkCount = <span class="number">0</span>;</span><br><span class="line">  <span class="title function_">setMilk</span>(<span class="params">count: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">milkCount</span> = count;</span><br><span class="line">  &#125;</span><br><span class="line">  coffee = <span class="number">5</span>;</span><br><span class="line">  coffeeCount = <span class="number">0</span>;</span><br><span class="line">  <span class="title function_">setCoffee</span>(<span class="params">count: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">coffeeCount</span> = count;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">cost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">milkCount</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      total += <span class="variable language_">this</span>.<span class="property">milkCount</span> * <span class="variable language_">this</span>.<span class="property">milk</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">coffeeCount</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      total += <span class="variable language_">this</span>.<span class="property">coffeeCount</span> * <span class="variable language_">this</span>.<span class="property">coffee</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FruitTea</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Beverage</span> &#123;</span><br><span class="line">  <span class="title function_">cost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span> + <span class="variable language_">super</span>.<span class="title function_">cost</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fruitTea = <span class="keyword">new</span> <span class="title class_">FruitTea</span>();</span><br><span class="line">fruitTea.<span class="title function_">setMilk</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruitTea.<span class="title function_">cost</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fruitTea2 = <span class="keyword">new</span> <span class="title class_">FruitTea</span>();</span><br><span class="line">fruitTea2.<span class="title function_">setMilk</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruitTea.<span class="title function_">cost</span>());</span><br></pre></td></tr></table></figure>

<p>这样的设计还有一些问题：</p>
<ul>
<li>并不是所有的配料都需要继承，每种饮料都有自己特有的配料。</li>
<li>一但需要新的配料或新的品种或价钱的改变，就需要修改父类。</li>
<li>当有新的品种出现的时候，他可能继承了不必要的方法。</li>
</ul>
<h4 id="定义装饰者"><a href="#定义装饰者" class="headerlink" title="定义装饰者"></a>定义装饰者</h4><p>设计类的一个原则是 <strong>❤‍🔥 类应该对扩展开放，对修改关闭，也就是类设计中提到的开放关闭原则</strong>。</p>
<p>开放且关闭并不冲突，想想观察中模式中的案例，可以通过调用类的方法添加观察者，而不改变原有的类的方法。并不需要每一个类都遵循开放关闭原则，避免过度设计，只需要针对可能经常会发生变化的类应用开发-关闭原则。</p>
<p><strong>装饰者模式：动态的将责任附加到对象上，若要扩展功能，装饰者提供了比继承更有弹性的替代方案</strong>。</p>
<p>对于上面的问题，按以下的方式思考：</p>
<ul>
<li>我们已经有一个果茶类 FruitTea</li>
<li>需要加两份额外的牛奶，用两个牛奶配料的类去修饰它</li>
<li>需要加一份额外的咖啡，用一个咖啡配料的类去修饰它</li>
<li>依赖修饰者的 cost 方法计算价格</li>
<li>在编码的时候为了明确修饰者和被修饰者的关系，<strong>需要让修饰者和被修饰者继承同样的类或实现相同的接口，因为被修饰的类仍然被视作原有的类，它的属性以及方法的作用不应该发生变化，只是扩展了方法实现。</strong></li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">BeverageInterface</span> &#123;</span><br><span class="line">  <span class="attr">description</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="title function_">cost</span>(): <span class="built_in">number</span>;</span><br><span class="line">  <span class="title function_">getDescription</span>(): <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MilkDecorator</span> <span class="keyword">implements</span> <span class="title class_">BeverageInterface</span> &#123;</span><br><span class="line">  <span class="attr">beverage</span>: <span class="title class_">BeverageInterface</span>;</span><br><span class="line">  description = <span class="string">&quot;MilkDecorator&quot;</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">beverage: BeverageInterface</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">beverage</span> = beverage;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getDescription</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">description</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">cost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> + <span class="variable language_">this</span>.<span class="property">beverage</span>.<span class="title function_">cost</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoffeeDecorator</span> <span class="keyword">implements</span> <span class="title class_">BeverageInterface</span> &#123;</span><br><span class="line">  <span class="attr">beverage</span>: <span class="title class_">BeverageInterface</span>;</span><br><span class="line">  description = <span class="string">&quot;CoffeeDecorator&quot;</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">beverage: BeverageInterface</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">beverage</span> = beverage;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getDescription</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">description</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">cost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">5</span> + <span class="variable language_">this</span>.<span class="property">beverage</span>.<span class="title function_">cost</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FruitTea</span> <span class="keyword">implements</span> <span class="title class_">BeverageInterface</span> &#123;</span><br><span class="line">  description = <span class="string">&quot;FruitTea&quot;</span>;</span><br><span class="line">  <span class="title function_">getDescription</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">description</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">cost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fruitTea = <span class="keyword">new</span> <span class="title class_">FruitTea</span>();</span><br><span class="line"><span class="comment">// 原价fruitTea</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruitTea.<span class="title function_">cost</span>());</span><br><span class="line"><span class="comment">// 添加配料一份牛奶 一份咖啡</span></span><br><span class="line">fruitTea = <span class="keyword">new</span> <span class="title class_">MilkDecorator</span>(fruitTea);</span><br><span class="line">fruitTea = <span class="keyword">new</span> <span class="title class_">CoffeeDecorator</span>(fruitTea);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruitTea.<span class="title function_">cost</span>());</span><br></pre></td></tr></table></figure>

<p>现在已经分离了装饰着对象,但是使用装饰者模式是基于一下几个前提：</p>
<ul>
<li>被修饰的对象是可以抽象的，也就是说被修饰的对象不会轻易改变，这样针对它的修饰类才有意义</li>
<li>修饰对象是不关心外部状态的，它只关心被修饰的对象，因为你想让他控制修饰链中的每个节点，需要更好的设计。</li>
<li><strong>被装饰的对象可能拥有特定的类型，在使用装饰的时候需要小心，避免功能或类型丢失。</strong></li>
</ul>
<h4 id="与-ES6-修饰器的区别"><a href="#与-ES6-修饰器的区别" class="headerlink" title="与 ES6 修饰器的区别"></a>与 ES6 修饰器的区别</h4><p>ES6 提供修饰器方提案，在 babel 转译后支持，可以修饰类或类的属性和方法，但并不是一种设计模式。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">BeverageInterface</span> &#123;</span><br><span class="line">  <span class="attr">description</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="title function_">cost</span>(): <span class="built_in">number</span>;</span><br><span class="line">  <span class="title function_">getDescription</span>(): <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">milkDecorator</span>(<span class="params">target: () =&gt; <span class="built_in">number</span></span>): <span class="function">() =&gt;</span> <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="number">2</span> + <span class="title function_">target</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FruitTea</span> <span class="keyword">implements</span> <span class="title class_">BeverageInterface</span> &#123;</span><br><span class="line">  description = <span class="string">&quot;FruitTea&quot;</span>;</span><br><span class="line">  <span class="title function_">getDescription</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">description</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">cost</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FruitTeaWithMilk</span> <span class="keyword">extends</span> <span class="title class_ inherited__">FruitTea</span> &#123;</span><br><span class="line">  <span class="meta">@milkDecorator</span></span><br><span class="line">  <span class="title function_">cost</span>(): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">cost</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> fruitTea = <span class="keyword">new</span> <span class="title class_">FruitTeaWithMilk</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fruitTea.<span class="title function_">cost</span>());</span><br></pre></td></tr></table></figure>


<ul>
<li>继承属于扩展形式之一，但不见得是达到弹性设计的最佳方式。</li>
<li>在我们的设计中，应该允许行为可以被扩展，而无须修改现有的代码。</li>
<li>组合和委托可用于在运行时动态地加上新的行为。</li>
<li>除了继承，装饰者模式也可以让我们扩展行为。</li>
<li>装饰者模式意味着一群装饰者类，这些类用来包装具体组件。</li>
<li>开放一关闭原则</li>
<li>装饰者类反映出被装饰的组件类型(事实上，他们具有相同的类型，都经过接口或继承实)</li>
<li>装饰者可以在被装饰者的行为前面与&#x2F;或后面加上自己的行为，甚至将被装饰者的行为整个取代掉，而达到特定的目的。</li>
<li>你可以用无数个装饰者包装一个组件。</li>
<li>装饰者一般对组件的客户是透明的，除非客户程序依赖于组件的具体类型。</li>
<li>装饰者会导致设计中出现许多小对象，如果过度使用，会让程序变得很复杂。</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-db/DQL语言"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/64b5a8e1f0ec/"
    >MySQL DQL查询语言</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/64b5a8e1f0ec/" class="article-date">
  <time datetime="2021-12-09T01:55:38.000Z" itemprop="datePublished">2021-12-09</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>DQL (Data Query Language)数据查询语言;</p>
<h4 id="基本查询"><a href="#基本查询" class="headerlink" title="基本查询"></a>基本查询</h4><p>1、查询的结果集 是一个虚拟表<br>2、select 查询列表  类似于<code>System.out.println(打印内容)</code>;</p>
<p>select后面跟的查询列表，可以有多个部分组成，中间用逗号隔开<br>例如：select 字段1,字段2,表达式 from 表;</p>
<p><code>System.out.println()</code>的打印内容，只能有一个。</p>
<p>3、执行顺序</p>
<p>① from子句<br>② select子句</p>
<p>4、查询列表可以是：字段、表达式、常量、函数等</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">USE myemployees;</span><br><span class="line"></span><br><span class="line">#一、查询常量</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">100</span> ;</span><br><span class="line"></span><br><span class="line">#二、查询表达式</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">100</span><span class="operator">%</span><span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">#三、查询单个字段</span><br><span class="line"><span class="keyword">SELECT</span> `last_name` <span class="keyword">FROM</span> `employees`;</span><br><span class="line"></span><br><span class="line">#四、查询多个字段</span><br><span class="line"><span class="keyword">SELECT</span> `last_name`,`email`,`employee_id` <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line">#五、查询所有字段</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `employees`;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#F12:对齐格式</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    `last_name`,</span><br><span class="line">    `first_name`,</span><br><span class="line">    `last_name`,</span><br><span class="line">    `commission_pct`,</span><br><span class="line">    `hiredate`,</span><br><span class="line">    `salary` </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    employees ;</span><br><span class="line">    </span><br><span class="line">#六、查询函数（调用函数，获取返回值）</span><br><span class="line"><span class="keyword">SELECT</span> DATABASE();</span><br><span class="line"><span class="keyword">SELECT</span> VERSION();</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>();</span><br><span class="line"></span><br><span class="line">#七、起别名</span><br><span class="line">#方式一：使用<span class="keyword">as</span>关键字</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>() <span class="keyword">AS</span> 用户名;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>() <span class="keyword">AS</span> &quot;用户名&quot;;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>() <span class="keyword">AS</span> <span class="string">&#x27;用户名&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name <span class="keyword">AS</span> &quot;姓 名&quot; <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#方式二：使用空格</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>()   用户名;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>()   &quot;用户名&quot;;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>()   <span class="string">&#x27;用户名&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name   &quot;姓 名&quot; <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#八、<span class="operator">+</span>的作用</span><br><span class="line"><span class="comment">-- 需求：查询 first_name 和last_name 拼接成的全名，最终起别名为：姓 名</span></span><br><span class="line"></span><br><span class="line">#方案<span class="number">1</span>：使用<span class="operator">+</span>    pass×</span><br><span class="line"><span class="keyword">SELECT</span> first_name<span class="operator">+</span>last_name <span class="keyword">AS</span> &quot;姓 名&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#方案<span class="number">2</span>：使用concat拼接函数</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(first_name,last_name) <span class="keyword">AS</span> &quot;姓 名&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Java中+的作用：</span></span><br><span class="line"><span class="comment">1、加法运算</span></span><br><span class="line"><span class="comment">	100+1.5      &#x27;a&#x27;+2    1.3+&#x27;2&#x27;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">2、拼接符</span></span><br><span class="line"><span class="comment">	至少有一个操作数为字符串</span></span><br><span class="line"><span class="comment">	&quot;hello&quot;+&#x27;a&#x27;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">mysql中+的作用：</span></span><br><span class="line"><span class="comment">1、加法运算</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">①两个操作数都是数值型</span></span><br><span class="line"><span class="comment">100+1.5</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">②其中一个操作数为字符型</span></span><br><span class="line"><span class="comment">将字符型数据强制转换成数值型,如果无法转换，则直接当做0处理</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#x27;张无忌&#x27;+100===&gt;100</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">③其中一个操作数为null</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">null+null====》null</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">null+100====》 null</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">#九、<span class="keyword">distinct</span>的使用 去重</span><br><span class="line"></span><br><span class="line">#需求：查询员工涉及到的部门编号有哪些</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> department_id <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#十、查看表的结构</span><br><span class="line"></span><br><span class="line"><span class="keyword">DESC</span> employees;</span><br><span class="line"><span class="keyword">SHOW</span> COLUMNS <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>练习</strong></p>
<p>显示出表 <code>employees</code> 的全部列，各个列之间用逗号连接，列头显示成 <code>OUT_PUT</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CONCAT(employee_id,<span class="string">&#x27;,&#x27;</span>,first_name,<span class="string">&#x27;,&#x27;</span>,last_name,<span class="string">&#x27;,&#x27;</span>,salary,<span class="string">&#x27;,&#x27;</span>,IFNULL(commission_pct,<span class="string">&#x27;&#x27;</span>))  <span class="keyword">AS</span> &quot;OUT_PUT&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line">#ifnull(表达式<span class="number">1</span>，表达式<span class="number">2</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">表达式1：可能为null的字段或表达式</span></span><br><span class="line"><span class="comment">表达式2：如果表达式1为null，则最终结果显示的值</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">功能：如果表达式1为null，则显示表达式2，否则显示表达式1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> commission_pct,IFNULL(commission_pct,<span class="string">&#x27;空&#x27;</span>) <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h4 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h4><p>select 查询列表<br>from  表名<br>where 筛选条件;</p>
<p>执行顺序：<br>①from子句<br>②where子句<br>③select子句</p>
<p>1、按关系表达式筛选</p>
<p>关系运算符：&gt;   &lt;    &gt;&#x3D;   &lt;&#x3D;     &#x3D;     &lt;&gt;<br>              补充：也可以使用!&#x3D;,但不建议</p>
<p>2、按逻辑表达式筛选</p>
<p>逻辑运算符：and    or   not<br>          补充：也可以使用&amp;&amp;  ||   !  ，但不建议</p>
<p>3、模糊查询</p>
<p>like<br>in<br>between and<br>is null</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">#一、按关系表达式筛选</span><br><span class="line">#案例<span class="number">1</span>：查询部门编号不是<span class="number">100</span>的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">&lt;&gt;</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：查询工资<span class="operator">&lt;</span><span class="number">15000</span>的姓名、工资</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary<span class="operator">&lt;</span><span class="number">15000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#二、按逻辑表达式筛选</span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：查询部门编号不是 <span class="number">50</span><span class="number">-100</span>之间员工姓名、部门编号、邮箱</span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> last_name,department_id,email</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">&lt;</span><span class="number">50</span> <span class="keyword">OR</span> department_id<span class="operator">&gt;</span><span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name,department_id,email</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span>(department_id<span class="operator">&gt;=</span><span class="number">50</span> <span class="keyword">AND</span> department_id<span class="operator">&lt;=</span><span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：查询奖金率<span class="operator">&gt;</span><span class="number">0.03</span> 或者 员工编号在<span class="number">60</span><span class="number">-110</span>之间的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct<span class="operator">&gt;</span><span class="number">0.03</span> <span class="keyword">OR</span> (employee_id <span class="operator">&gt;=</span><span class="number">60</span> <span class="keyword">AND</span> employee_id<span class="operator">&lt;=</span><span class="number">110</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#三、模糊查询</span><br><span class="line"></span><br><span class="line">#<span class="number">1</span>、<span class="keyword">like</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：一般和通配符搭配使用，对字符型数据进行部分匹配查询</span></span><br><span class="line"><span class="comment">常见的通配符：</span></span><br><span class="line"><span class="comment">_ 任意单个字符</span></span><br><span class="line"><span class="comment">% 任意多个字符,支持0-多个</span></span><br><span class="line"><span class="comment">like/not like </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：查询姓名中包含字符a的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;%a%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：查询姓名中包含最后一个字符为e的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;%e&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#案例<span class="number">3</span>：查询姓名中包含第一个字符为e的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;e%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#案例<span class="number">4</span>：查询姓名中包含第三个字符为x的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;__x%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#案例<span class="number">5</span>：查询姓名中包含第二个字符为_的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;_\_%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;_$_%&#x27;</span> <span class="keyword">ESCAPE</span> <span class="string">&#x27;$&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">2</span>、<span class="keyword">in</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：查询某字段的值是否属于指定的列表之内</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">a  in(常量值1,常量值2,常量值3,...)</span></span><br><span class="line"><span class="comment">a not in(常量值1,常量值2,常量值3,...)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">in/not in</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：查询部门编号是<span class="number">30</span><span class="operator">/</span><span class="number">50</span><span class="operator">/</span><span class="number">90</span>的员工名、部门编号</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> last_name,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="keyword">IN</span>(<span class="number">30</span>,<span class="number">50</span>,<span class="number">90</span>);</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">30</span></span><br><span class="line"><span class="keyword">OR</span> department_id <span class="operator">=</span> <span class="number">50</span></span><br><span class="line"><span class="keyword">OR</span> department_id <span class="operator">=</span> <span class="number">90</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：查询工种编号不是SH_CLERK或IT_PROG的员工信息</span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> job_id <span class="keyword">NOT</span> <span class="keyword">IN</span>(<span class="string">&#x27;SH_CLERK&#x27;</span>,<span class="string">&#x27;IT_PROG&#x27;</span>);</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span>(job_id <span class="operator">=</span><span class="string">&#x27;SH_CLERK&#x27;</span></span><br><span class="line"><span class="keyword">OR</span> job_id <span class="operator">=</span> <span class="string">&#x27;IT_PROG&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">3</span>、<span class="keyword">between</span> <span class="keyword">and</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：判断某个字段的值是否介于xx之间</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">between and/not between and</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：查询部门编号是<span class="number">30</span><span class="number">-90</span>之间的部门编号、员工姓名</span><br><span class="line"></span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> department_id,last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="keyword">BETWEEN</span> <span class="number">30</span> <span class="keyword">AND</span> <span class="number">90</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> department_id,last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id<span class="operator">&gt;=</span><span class="number">30</span> <span class="keyword">AND</span> department_id<span class="operator">&lt;=</span><span class="number">90</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：查询年薪不是<span class="number">100000</span><span class="number">-200000</span>之间的员工姓名、工资、年薪</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(<span class="number">1</span><span class="operator">+</span>IFNULL(commission_pct,<span class="number">0</span>)) 年薪</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(<span class="number">1</span><span class="operator">+</span>IFNULL(commission_pct,<span class="number">0</span>))<span class="operator">&lt;</span><span class="number">100000</span> <span class="keyword">OR</span> salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(<span class="number">1</span><span class="operator">+</span>IFNULL(commission_pct,<span class="number">0</span>))<span class="operator">&gt;</span><span class="number">200000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(<span class="number">1</span><span class="operator">+</span>IFNULL(commission_pct,<span class="number">0</span>)) 年薪</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(<span class="number">1</span><span class="operator">+</span>IFNULL(commission_pct,<span class="number">0</span>)) <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="number">100000</span> <span class="keyword">AND</span> <span class="number">200000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">4</span>、<span class="keyword">is</span> <span class="keyword">null</span><span class="operator">/</span><span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：查询没有奖金的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：查询有奖金的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="keyword">IS</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">#<span class="comment">----------------对比------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator">=</span>		只能判断普通的内容</span><br><span class="line"></span><br><span class="line"><span class="keyword">IS</span>              只能判断<span class="keyword">NULL</span>值</span><br><span class="line"></span><br><span class="line"><span class="operator">&lt;=&gt;</span>             安全等于，既能判断普通内容，又能判断<span class="keyword">NULL</span>值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&lt;=&gt;</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="operator">&lt;=&gt;</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h4 id="排序查询"><a href="#排序查询" class="headerlink" title="排序查询"></a>排序查询</h4><p>select 查询列表<br>from 表名<br>【where 筛选条件】<br>order by 排序列表</p>
<p>执行顺序：</p>
<p>①from子句<br>②where子句<br>③select子句<br>④order by 子句</p>
<p>特点：</p>
<p>1、排序列表可以是单个字段、多个字段、表达式、函数、列数、以及以上的组合<br>2、升序 ，通过 asc   ，默认行为<br>   降序 ，通过 desc</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#一、按单个字段排序</span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：将员工编号<span class="operator">&gt;</span><span class="number">120</span>的员工信息进行工资的升序</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> employees </span><br><span class="line"></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary ;</span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：将员工编号<span class="operator">&gt;</span><span class="number">120</span>的员工信息进行工资的降序</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> employees </span><br><span class="line"><span class="keyword">WHERE</span> employee_id<span class="operator">&gt;</span><span class="number">120</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line">#二、按表达式排序</span><br><span class="line">#案例<span class="number">1</span>：对有奖金的员工，按年薪降序</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span>,salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(<span class="number">1</span><span class="operator">+</span>IFNULL(commission_pct,<span class="number">0</span>))  年薪</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(<span class="number">1</span><span class="operator">+</span>IFNULL(commission_pct,<span class="number">0</span>)) <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#三、按别名排序</span><br><span class="line">#案例<span class="number">1</span>：对有奖金的员工，按年薪降序</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span>,salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>(<span class="number">1</span><span class="operator">+</span>IFNULL(commission_pct,<span class="number">0</span>))  年薪</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 年薪 <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line">#四、按函数的结果排序</span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：按姓名的字数长度进行升序</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> LENGTH(last_name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#五、按多个字段排序</span><br><span class="line"></span><br><span class="line">#案例<span class="number">1</span>：查询员工的姓名、工资、部门编号，先按工资升序，再按部门编号降序</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span>,department_id <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#六、补充选学：按列数排序</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">2</span> <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> first_name;</span><br></pre></td></tr></table></figure>

<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><p>函数：类似于java中学过的“方法”，<br>为了解决某个问题，将编写的一系列的命令集合封装在一起，对外仅仅暴露方法名，供外部调用</p>
<p>1、自定义方法(函数)<br>2、调用方法(函数)★<br>    叫什么  ：函数名<br>    干什么  ：函数功能</p>
<h5 id="单行函数"><a href="#单行函数" class="headerlink" title="单行函数"></a>单行函数</h5><ul>
<li><p>字符函数<br>  <code>concat</code><br>  <code>substr</code><br>  <code>length（str）</code><br>  <code>char_length</code><br>  <code>upper</code><br>  <code>lower</code><br>  <code>trim</code><br>  <code>left</code><br>  <code>right</code><br>  <code>lpad</code><br>  <code>rpad</code><br>  <code>instr</code><br>  <code>strcmp</code></p>
</li>
<li><p>数学函数<br>  <code>abs</code><br>  <code>ceil</code><br>  <code>floor</code><br>  <code>round</code><br>  <code>truncate</code><br>  <code>mod</code></p>
</li>
<li><p>日期函数<br>  <code>now</code><br>  <code>curtime</code><br>  <code>curdate</code><br>  <code>datediff</code><br>  <code>date_format</code><br>  <code>str_to_date</code></p>
</li>
<li><p>流程控制函数<br>  <code>if</code><br>  <code>case</code></p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、CONCAT 拼接字符</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;hello,&#x27;</span>,first_name,last_name)  备注 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、LENGTH 获取字节长度</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> LENGTH(<span class="string">&#x27;hello,郭襄&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、<span class="keyword">CHAR_LENGTH</span> 获取字符个数</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CHAR_LENGTH</span>(<span class="string">&#x27;hello,郭襄&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、SUBSTRING 截取子串</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">注意：起始索引从1开始！！！</span></span><br><span class="line"><span class="comment">substr(str,起始索引，截取的字符长度)</span></span><br><span class="line"><span class="comment">substr(str,起始索引)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">SELECT</span> SUBSTR(<span class="string">&#x27;张三丰爱上了郭襄&#x27;</span>,<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">SELECT</span> SUBSTR(<span class="string">&#x27;张三丰爱上了郭襄&#x27;</span>,<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、INSTR获取字符第一次出现的索引</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> INSTR(<span class="string">&#x27;三打白骨精aaa白骨精bb白骨精&#x27;</span>,<span class="string">&#x27;白骨精&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、TRIM去前后指定的字符，默认是去空格</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">TRIM</span>(<span class="string">&#x27; 虚  竹    &#x27;</span>)  <span class="keyword">AS</span> a;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">TRIM</span>(<span class="string">&#x27;x&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;xxxxxx虚xxx竹xxxxxxxxxxxxxxxxxx&#x27;</span>)  <span class="keyword">AS</span> a;</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、LPAD<span class="operator">/</span>RPAD  左填充<span class="operator">/</span>右填充</span><br><span class="line"><span class="keyword">SELECT</span> LPAD(<span class="string">&#x27;木婉清&#x27;</span>,<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">SELECT</span> RPAD(<span class="string">&#x27;木婉清&#x27;</span>,<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">8</span>、UPPER<span class="operator">/</span>LOWER  变大写<span class="operator">/</span>变小写</span><br><span class="line"></span><br><span class="line">#案例：查询员工表的姓名，要求格式：姓首字符大写，其他字符小写，名所有字符大写，且姓和名之间用_分割，最后起别名“OUTPUT”</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">UPPER</span>(SUBSTR(first_name,<span class="number">1</span>,<span class="number">1</span>)),first_name <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LOWER</span>(SUBSTR(first_name,<span class="number">2</span>)),first_name <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">UPPER</span>(last_name) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="built_in">UPPER</span>(SUBSTR(first_name,<span class="number">1</span>,<span class="number">1</span>)),<span class="built_in">LOWER</span>(SUBSTR(first_name,<span class="number">2</span>)),<span class="string">&#x27;_&#x27;</span>,<span class="built_in">UPPER</span>(last_name)) &quot;OUTPUT&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="number">9</span>、STRCMP 比较两个字符大小</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> STRCMP(<span class="string">&#x27;aec&#x27;</span>,<span class="string">&#x27;aec&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">10</span>、<span class="keyword">LEFT</span><span class="operator">/</span><span class="keyword">RIGHT</span>  截取子串</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">LEFT</span>(<span class="string">&#x27;鸠摩智&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">RIGHT</span>(<span class="string">&#x27;鸠摩智&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#二、数学函数</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、ABS 绝对值</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">ABS</span>(<span class="number">-2.4</span>);</span><br><span class="line"><span class="number">2</span>、CEIL 向上取整  返回<span class="operator">&gt;=</span>该参数的最小整数</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CEIL</span>(<span class="number">-1.09</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CEIL</span>(<span class="number">0.09</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CEIL</span>(<span class="number">1.00</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、FLOOR 向下取整，返回<span class="operator">&lt;=</span>该参数的最大整数</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">FLOOR</span>(<span class="number">-1.09</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">FLOOR</span>(<span class="number">0.09</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">FLOOR</span>(<span class="number">1.00</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、ROUND 四舍五入</span><br><span class="line"><span class="keyword">SELECT</span> ROUND(<span class="number">1.8712345</span>);</span><br><span class="line"><span class="keyword">SELECT</span> ROUND(<span class="number">1.8712345</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、<span class="keyword">TRUNCATE</span> 截断</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">TRUNCATE</span>(<span class="number">1.8712345</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、MOD 取余</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MOD</span>(<span class="number">-10</span>,<span class="number">3</span>);</span><br><span class="line">a<span class="operator">%</span>b <span class="operator">=</span> a<span class="operator">-</span>(<span class="type">INT</span>)a<span class="operator">/</span>b<span class="operator">*</span>b</span><br><span class="line"><span class="number">-10</span><span class="operator">%</span><span class="number">3</span> <span class="operator">=</span> <span class="number">-10</span> <span class="operator">-</span> (<span class="number">-10</span>)<span class="operator">/</span><span class="number">3</span><span class="operator">*</span><span class="number">3</span>   <span class="operator">=</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">-10</span><span class="operator">%</span><span class="number">3</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">10</span><span class="operator">%</span><span class="number">3</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">-10</span><span class="operator">%</span><span class="number">-3</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">10</span><span class="operator">%</span><span class="number">-3</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#三、日期函数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、NOW</span><br><span class="line"><span class="keyword">SELECT</span> NOW();</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、CURDATE</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> CURDATE();</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、CURTIME</span><br><span class="line"><span class="keyword">SELECT</span> CURTIME();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、DATEDIFF</span><br><span class="line"><span class="keyword">SELECT</span> DATEDIFF(<span class="string">&#x27;1998-7-16&#x27;</span>,<span class="string">&#x27;2019-7-13&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、DATE_FORMAT</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> DATE_FORMAT(<span class="string">&#x27;1998-7-16&#x27;</span>,<span class="string">&#x27;%Y年%M月%d日 %H小时%i分钟%s秒&#x27;</span>) 出生日期;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> DATE_FORMAT(hiredate,<span class="string">&#x27;%Y年%M月%d日 %H小时%i分钟%s秒&#x27;</span>)入职日期 </span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、STR_TO_DATE 按指定格式解析字符串为日期类型</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> hiredate<span class="operator">&lt;</span>STR_TO_DATE(<span class="string">&#x27;3/15 1998&#x27;</span>,<span class="string">&#x27;%m/%d %Y&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#四、流程控制函数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、IF函数</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> IF(<span class="number">100</span><span class="operator">&gt;</span><span class="number">9</span>,<span class="string">&#x27;好&#x27;</span>,<span class="string">&#x27;坏&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#需求：如果有奖金，则显示最终奖金，如果没有，则显示<span class="number">0</span></span><br><span class="line"><span class="keyword">SELECT</span> IF(commission_pct <span class="keyword">IS</span> <span class="keyword">NULL</span>,<span class="number">0</span>,salary<span class="operator">*</span><span class="number">12</span><span class="operator">*</span>commission_pct)  奖金,commission_pct</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、<span class="keyword">CASE</span>函数</span><br><span class="line"></span><br><span class="line">①情况<span class="number">1</span> ：类似于switch语句，可以实现等值判断</span><br><span class="line"><span class="keyword">CASE</span> 表达式</span><br><span class="line"><span class="keyword">WHEN</span> 值<span class="number">1</span> <span class="keyword">THEN</span> 结果<span class="number">1</span></span><br><span class="line"><span class="keyword">WHEN</span> 值<span class="number">2</span> <span class="keyword">THEN</span> 结果<span class="number">2</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">ELSE</span> 结果n</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">案例：</span><br><span class="line">部门编号是<span class="number">30</span>，工资显示为<span class="number">2</span>倍</span><br><span class="line">部门编号是<span class="number">50</span>，工资显示为<span class="number">3</span>倍</span><br><span class="line">部门编号是<span class="number">60</span>，工资显示为<span class="number">4</span>倍</span><br><span class="line">否则不变</span><br><span class="line"></span><br><span class="line">显示 部门编号，新工资，旧工资</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> department_id,salary,</span><br><span class="line"><span class="keyword">CASE</span> department_id</span><br><span class="line"><span class="keyword">WHEN</span> <span class="number">30</span> <span class="keyword">THEN</span> salary<span class="operator">*</span><span class="number">2</span></span><br><span class="line"><span class="keyword">WHEN</span> <span class="number">50</span> <span class="keyword">THEN</span> salary<span class="operator">*</span><span class="number">3</span></span><br><span class="line"><span class="keyword">WHEN</span> <span class="number">60</span> <span class="keyword">THEN</span> salary<span class="operator">*</span><span class="number">4</span></span><br><span class="line"><span class="keyword">ELSE</span> salary</span><br><span class="line"><span class="keyword">END</span>  newSalary</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">②情况<span class="number">2</span>：类似于多重IF语句，实现区间判断</span><br><span class="line"><span class="keyword">CASE</span> </span><br><span class="line"><span class="keyword">WHEN</span> 条件<span class="number">1</span> <span class="keyword">THEN</span> 结果<span class="number">1</span></span><br><span class="line"><span class="keyword">WHEN</span> 条件<span class="number">2</span> <span class="keyword">THEN</span> 结果<span class="number">2</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">ELSE</span> 结果n</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">案例：如果工资<span class="operator">&gt;</span><span class="number">20000</span>,显示级别A</span><br><span class="line">      工资<span class="operator">&gt;</span><span class="number">15000</span>,显示级别B</span><br><span class="line">      工资<span class="operator">&gt;</span><span class="number">10000</span>,显示级别C</span><br><span class="line">      否则，显示D</span><br><span class="line">      </span><br><span class="line"> <span class="keyword">SELECT</span> salary,</span><br><span class="line"> <span class="keyword">CASE</span> </span><br><span class="line"> <span class="keyword">WHEN</span> salary<span class="operator">&gt;</span><span class="number">20000</span> <span class="keyword">THEN</span> <span class="string">&#x27;A&#x27;</span></span><br><span class="line"> <span class="keyword">WHEN</span> salary<span class="operator">&gt;</span><span class="number">15000</span> <span class="keyword">THEN</span> <span class="string">&#x27;B&#x27;</span></span><br><span class="line"> <span class="keyword">WHEN</span> salary<span class="operator">&gt;</span><span class="number">10000</span> <span class="keyword">THEN</span> <span class="string">&#x27;C&#x27;</span></span><br><span class="line"> <span class="keyword">ELSE</span> <span class="string">&#x27;D&#x27;</span></span><br><span class="line"> <span class="keyword">END</span></span><br><span class="line"> <span class="keyword">AS</span>  a</span><br><span class="line"> <span class="keyword">FROM</span> employees;   </span><br></pre></td></tr></table></figure>

<h5 id="分组函数"><a href="#分组函数" class="headerlink" title="分组函数"></a>分组函数</h5><p>说明：分组函数往往用于实现将一组数据进行统计计算，最终得到一个值，又称为聚合函数或统计函数</p>
<p>分组函数清单：</p>
<p>sum(字段名)：求和<br>avg(字段名)：求平均数<br>max(字段名)：求最大值<br>min(字段名)：求最小值<br>count(字段名)：计算非空字段值的个数</p>
<p><strong>特点：</strong></p>
<p>sum,avg 一般处理数值类型，max,min,count 可以处理任意类型，以上分组函数都忽略null值。</p>
<p>可以和 distinct 搭配实现去重的运算</p>
<p>count函数一般使用count(*)用作统计行数</p>
<p>和分组函数一同查询的字段有限制，只能是 group by 后面的函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#案例<span class="number">1</span> ：查询员工信息表中，所有员工的工资和、工资平均值、最低工资、最高工资、有工资的个数</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(salary),<span class="built_in">AVG</span>(salary),<span class="built_in">MIN</span>(salary),<span class="built_in">MAX</span>(salary),<span class="built_in">COUNT</span>(salary) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：添加筛选条件</span><br><span class="line">	#①查询emp表中记录数：</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(employee_id) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line">	#②查询emp表中有佣金的人数：</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(salary) <span class="keyword">FROM</span> employees;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	#③查询emp表中月薪大于<span class="number">2500</span>的人数：</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(salary) <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary<span class="operator">&gt;</span><span class="number">2500</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	#④查询有领导的人数：</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(manager_id) <span class="keyword">FROM</span> employees;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">#count的补充介绍★</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">1</span>、统计结果集的行数，推荐使用<span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="number">1</span>) <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="number">1</span>) <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">2</span>、搭配<span class="keyword">distinct</span>实现去重的统计</span><br><span class="line"></span><br><span class="line">#需求：查询有员工的部门个数</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> department_id) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#思考：每个部门的总工资、平均工资？</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(salary)  <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(salary)  <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(salary) ,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id;</span><br></pre></td></tr></table></figure>

<h4 id="分组查询"><a href="#分组查询" class="headerlink" title="分组查询"></a>分组查询</h4><p>select 查询列表<br>from 表名<br>where 筛选条件<br>group by 分组列表<br>having 分组后筛选<br>order by 排序列表;</p>
<p>执行顺序：<br>①from子句<br>②where子句<br>③group by 子句<br>④having子句<br>⑤select子句<br>⑥order by子句</p>
<p>特点：<br>①查询列表往往是  分组函数和被分组的字段 ★<br>②分组查询中的筛选分为两类<br>            筛选的基表    使用的关键词        位置<br>分组前筛选        原始表        where            group by 的前面</p>
<p>分组后筛选        分组后的结果集  having            group by的后面</p>
<p>where——group by ——having</p>
<p>问题：分组函数做条件只可能放在having后面！！！</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1</span>）简单的分组</span><br><span class="line">#案例<span class="number">1</span>：查询每个工种的员工平均工资</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary),job_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> job_id;</span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：查询每个领导的手下人数</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>),manager_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> manager_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> manager_id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">2</span>）可以实现分组前的筛选</span><br><span class="line">#案例<span class="number">1</span>：查询邮箱中包含a字符的 每个部门的最高工资</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) 最高工资,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> email <span class="keyword">LIKE</span> <span class="string">&#x27;%a%&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：查询每个领导手下有奖金的员工的平均工资</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) 平均工资,manager_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> manager_id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">3</span>）可以实现分组后的筛选</span><br><span class="line">#案例<span class="number">1</span>：查询哪个部门的员工个数<span class="operator">&gt;</span><span class="number">5</span></span><br><span class="line">#分析<span class="number">1</span>：查询每个部门的员工个数</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) 员工个数,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line"></span><br><span class="line">#分析<span class="number">2</span>：在刚才的结果基础上，筛选哪个部门的员工个数<span class="operator">&gt;</span><span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) 员工个数,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line"><span class="keyword">HAVING</span>  <span class="built_in">COUNT</span>(<span class="operator">*</span>)<span class="operator">&gt;</span><span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">2</span>：每个工种有奖金的员工的最高工资<span class="operator">&gt;</span><span class="number">12000</span>的工种编号和最高工资</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> job_id,<span class="built_in">MAX</span>(salary)</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct  <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> job_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">MAX</span>(salary)<span class="operator">&gt;</span><span class="number">12000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#案例<span class="number">3</span>：领导编号<span class="operator">&gt;</span><span class="number">102</span>的    每个领导手下的最低工资大于<span class="number">5000</span>的最低工资</span><br><span class="line">#分析<span class="number">1</span>：查询每个领导手下员工的最低工资</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary) 最低工资,manager_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> manager_id;</span><br><span class="line"></span><br><span class="line">#分析<span class="number">2</span>：筛选刚才<span class="number">1</span>的结果</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary) 最低工资,manager_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> manager_id<span class="operator">&gt;</span><span class="number">102</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> manager_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">MIN</span>(salary)<span class="operator">&gt;</span><span class="number">5000</span> ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">4</span>）可以实现排序</span><br><span class="line">#案例：查询没有奖金的员工的最高工资<span class="operator">&gt;</span><span class="number">6000</span>的工种编号和最高工资,按最高工资升序</span><br><span class="line">#分析<span class="number">1</span>：按工种分组，查询每个工种有奖金的员工的最高工资</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) 最高工资,job_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span>  <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> job_id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#分析<span class="number">2</span>：筛选刚才的结果，看哪个最高工资<span class="operator">&gt;</span><span class="number">6000</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) 最高工资,job_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span>  <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> job_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">MAX</span>(salary)<span class="operator">&gt;</span><span class="number">6000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#分析<span class="number">3</span>：按最高工资升序</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) 最高工资,job_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span>  <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> job_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">MAX</span>(salary)<span class="operator">&gt;</span><span class="number">6000</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">MAX</span>(salary) <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">5</span>）按多个字段分组</span><br><span class="line">#案例：查询每个工种每个部门的最低工资,并按最低工资降序</span><br><span class="line">#提示：工种和部门都一样，才是一组</span><br><span class="line"></span><br><span class="line">工种	部门  工资</span><br><span class="line"><span class="number">1</span>	<span class="number">10</span>	<span class="number">10000</span></span><br><span class="line"><span class="number">1</span>       <span class="number">20</span>      <span class="number">2000</span></span><br><span class="line"><span class="number">2</span>	<span class="number">20</span></span><br><span class="line"><span class="number">3</span>       <span class="number">20</span></span><br><span class="line"><span class="number">1</span>       <span class="number">10</span></span><br><span class="line"><span class="number">2</span>       <span class="number">30</span></span><br><span class="line"><span class="number">2</span>       <span class="number">20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary) 最低工资,job_id,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> job_id,department_id;</span><br></pre></td></tr></table></figure>


<h4 id="链接查询"><a href="#链接查询" class="headerlink" title="链接查询"></a>链接查询</h4><p>说明：又称多表查询，当查询语句涉及到的字段来自于多个表时，就会用到连接查询</p>
<p>笛卡尔乘积现象：表1 有m行，表2有n行，结果&#x3D;m*n行</p>
<p>发生原因：没有有效的连接条件<br>如何避免：添加有效的连接条件</p>
<ul>
<li><p>分类：</p>
<ul>
<li>按年代分类：<ul>
<li>sql92标准:仅仅支持内连接<ul>
<li>内连接：<ul>
<li>等值连接</li>
<li>非等值连接</li>
<li>自连接</li>
</ul>
</li>
</ul>
</li>
<li>sql99标准【推荐】：支持内连接+外连接（左外和右外）+交叉连接</li>
</ul>
</li>
<li>按功能分类：<ul>
<li>内连接：<ul>
<li>等值连接</li>
<li>非等值连接</li>
<li>自连接</li>
</ul>
</li>
<li>外连接：<ul>
<li>左外连接</li>
<li>右外连接</li>
<li>全外连接</li>
</ul>
</li>
<li>交叉连接</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="内链接"><a href="#内链接" class="headerlink" title="内链接"></a>内链接</h5><p>语法:<br>select 查询列表<br>from 表1 别名,表2 别名<br>where 连接条件<br>and 筛选条件<br>group by 分组列表<br>having 分组后筛选<br>order by 排序列表</p>
<p>执行顺序：</p>
<p>1、from子句<br>2、where子句<br>3、and子句<br>4、group by子句<br>5、having子句<br>6、select子句<br>7、order by子句</p>
<p>SQL92和SQL99的区别：<br>    SQL99，使用JOIN关键字代替了之前的逗号，并且将连接条件和筛选条件进行了分离，提高阅读性！！！</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"><span class="keyword">SELECT</span> 查询列表</span><br><span class="line"><span class="keyword">FROM</span> 表名<span class="number">1</span> 别名</span><br><span class="line">【<span class="keyword">INNER</span>】 <span class="keyword">JOIN</span>  表名<span class="number">2</span> 别名</span><br><span class="line"><span class="keyword">ON</span> 连接条件</span><br><span class="line"><span class="keyword">WHERE</span> 筛选条件</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> 分组列表</span><br><span class="line"><span class="keyword">HAVING</span> 分组后筛选</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 排序列表;</span><br><span class="line"></span><br><span class="line">#一）等值连接</span><br><span class="line">#①简单连接</span><br><span class="line">#案例：查询员工名和部门名</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> departments d </span><br><span class="line"> <span class="keyword">JOIN</span>  employees e </span><br><span class="line"><span class="keyword">ON</span> e.department_id <span class="operator">=</span>d.department_id;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#②添加筛选条件</span><br><span class="line">#案例<span class="number">1</span>：查询部门编号<span class="operator">&gt;</span><span class="number">100</span>的部门名和所在的城市名</span><br><span class="line"><span class="keyword">SELECT</span> department_name,city</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">JOIN</span> locations l</span><br><span class="line"><span class="keyword">ON</span> d.`location_id` <span class="operator">=</span> l.`location_id`</span><br><span class="line"><span class="keyword">WHERE</span> d.`department_id`<span class="operator">&gt;</span><span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#③添加分组<span class="operator">+</span>筛选</span><br><span class="line">#案例<span class="number">1</span>：查询每个城市的部门个数</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) 部门个数,l.`city`</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">JOIN</span> locations l</span><br><span class="line"><span class="keyword">ON</span> d.`location_id`<span class="operator">=</span>l.`location_id`</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> l.`city`;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#④添加分组<span class="operator">+</span>筛选<span class="operator">+</span>排序</span><br><span class="line">#案例<span class="number">1</span>：查询部门中员工个数<span class="operator">&gt;</span><span class="number">10</span>的部门名，并按员工个数降序</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) 员工个数,d.department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id`<span class="operator">=</span>d.`department_id`</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.`department_id`</span><br><span class="line"><span class="keyword">HAVING</span> 员工个数<span class="operator">&gt;</span><span class="number">10</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 员工个数 <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#二）非等值连接</span><br><span class="line"></span><br><span class="line">#案例：查询部门编号在<span class="number">10</span><span class="number">-90</span>之间的员工的工资级别，并按级别进行分组</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sal_grade;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) 个数,grade</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> sal_grade g</span><br><span class="line"><span class="keyword">ON</span> e.`salary` <span class="keyword">BETWEEN</span> g.`min_salary` <span class="keyword">AND</span> g.`max_salary`</span><br><span class="line"><span class="keyword">WHERE</span> e.`department_id` <span class="keyword">BETWEEN</span> <span class="number">10</span> <span class="keyword">AND</span> <span class="number">90</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> g.grade;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#三）自连接</span><br><span class="line"></span><br><span class="line">#案例：查询员工名和对应的领导名</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> e.`last_name`,m.`last_name`</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> employees m</span><br><span class="line"><span class="keyword">ON</span> e.`manager_id`<span class="operator">=</span>m.`employee_id`;</span><br></pre></td></tr></table></figure>


<h5 id="外连接"><a href="#外连接" class="headerlink" title="外连接"></a>外连接</h5><p>说明：查询结果为主表中所有的记录，如果从表有匹配项，则显示匹配项；如果从表没有匹配项，则显示 null</p>
<p>应用场景：一般用于查询主表中有但从表没有的记录</p>
<p>特点：</p>
<p>1、外连接分主从表，两表的顺序不能任意调换<br>2、左连接的话，left join 左边为主表<br>右连接的话，right join 右边为主表</p>
<p>语法：</p>
<p>select 查询列表<br>from 表 1 别名<br>left|right|full 【outer】 join 表 2 别名<br>on 连接条件<br>where 筛选条件;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#案例1：查询所有女神记录，以及对应的男神名，如果没有对应的男神，则显示为null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#左连接</span></span><br><span class="line">SELECT b.*,bo.*</span><br><span class="line">FROM beauty b</span><br><span class="line">LEFT JOIN boys bo ON b.`boyfriend_id` = bo.`<span class="built_in">id</span>`;</span><br><span class="line"></span><br><span class="line"><span class="comment">#右连接</span></span><br><span class="line">SELECT b.*,bo.*</span><br><span class="line">FROM boys bo</span><br><span class="line">RIGHT JOIN  beauty b ON b.`boyfriend_id` = bo.`<span class="built_in">id</span>`;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例2：查哪个女生没有男朋友</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#左连接</span></span><br><span class="line">SELECT b.`name`</span><br><span class="line">FROM beauty b</span><br><span class="line">LEFT JOIN boys bo ON b.`boyfriend_id` = bo.`<span class="built_in">id</span>`</span><br><span class="line">WHERE bo.`<span class="built_in">id</span>`  IS NULL;</span><br><span class="line"></span><br><span class="line"><span class="comment">#右连接</span></span><br><span class="line">SELECT b.*,bo.*</span><br><span class="line">FROM boys bo</span><br><span class="line">RIGHT JOIN  beauty b ON b.`boyfriend_id` = bo.`<span class="built_in">id</span>`</span><br><span class="line">WHERE bo.`<span class="built_in">id</span>`  IS NULL;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例3：查询哪个部门没有员工，并显示其部门编号和部门名</span></span><br><span class="line"></span><br><span class="line">SELECT COUNT(*) 部门个数</span><br><span class="line">FROM departments d</span><br><span class="line">LEFT JOIN employees e ON d.`department_id` = e.`department_id`</span><br><span class="line">WHERE e.`employee_id` IS NULL;</span><br></pre></td></tr></table></figure>

<h4 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h4><p>说明：当一个查询语句中又嵌套了另一个完整的 select 语句，则被嵌套的 select 语句称为子查询或内查询<br>外面的 select 语句称为主查询或外查询。</p>
<p>分类：</p>
<p>按子查询出现的位置进行分类：</p>
<p>1、select 后面<br>要求：子查询的结果为单行单列（标量子查询）<br>2、from 后面<br>要求：子查询的结果可以为多行多列<br>3、where 或 having 后面 ★<br>要求：子查询的结果必须为单列<br>单行子查询<br>多行子查询<br>4、exists 后面<br>要求：子查询结果必须为单列（相关子查询）<br>特点：<br>1、子查询放在条件中，要求必须放在条件的右侧<br>2、子查询一般放在小括号中<br>3、子查询的执行优先于主查询<br>4、单行子查询对应了 单行操作符：&gt; &lt; &gt;&#x3D; &lt;&#x3D; &#x3D; &lt;&gt;<br>多行子查询对应了 多行操作符：any&#x2F;some all in</p>
<h5 id="单行子查询"><a href="#单行子查询" class="headerlink" title="单行子查询"></a>单行子查询</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一）单行子查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例1：谁的工资比 Abel 高?</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#①查询Abel的工资</span></span><br><span class="line">SELECT salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE last_name  = <span class="string">&#x27;Abel&#x27;</span></span><br><span class="line"><span class="comment">#②查询salary&gt;①的员工信息</span></span><br><span class="line">SELECT last_name,salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary&gt;(</span><br><span class="line">	SELECT salary</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE last_name  &lt;&gt; <span class="string">&#x27;Abel&#x27;</span></span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">#案例2：返回job_id与141号员工相同，salary比143号员工多的员工姓名，job_id 和工资</span></span><br><span class="line"><span class="comment">#①查询141号员工的job_id</span></span><br><span class="line">SELECT job_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE employee_id = 141</span><br><span class="line"></span><br><span class="line"><span class="comment">#②查询143号员工的salary</span></span><br><span class="line"></span><br><span class="line">SELECT salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE employee_id = 143</span><br><span class="line"></span><br><span class="line"><span class="comment">#③查询job_id=① and salary&gt;②的信息</span></span><br><span class="line">SELECT last_name,job_id,salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE job_id = (</span><br><span class="line">	SELECT job_id</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE employee_id = 141</span><br><span class="line">) AND salary&gt;(</span><br><span class="line"></span><br><span class="line">	SELECT salary</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE employee_id = 143</span><br><span class="line"></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="多行子查询"><a href="#多行子查询" class="headerlink" title="多行子查询"></a>多行子查询</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"><span class="keyword">in</span>:判断某字段是否在指定列表内</span><br><span class="line">x <span class="keyword">in</span>(10,30,50)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">any/some:判断某字段的值是否满足其中任意一个</span><br><span class="line"></span><br><span class="line">x&gt;any(10,30,50)</span><br><span class="line">x&gt;min()</span><br><span class="line"></span><br><span class="line">x=any(10,30,50)</span><br><span class="line">x <span class="keyword">in</span>(10,30,50)</span><br><span class="line"></span><br><span class="line">all:判断某字段的值是否满足里面所有的</span><br><span class="line"></span><br><span class="line">x &gt;all(10,30,50)</span><br><span class="line">x &gt;max()</span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例1：返回location_id是1400或1700的部门中的所有员工姓名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#①查询location_id是1400或1700的部门</span></span><br><span class="line">SELECT department_id</span><br><span class="line">FROM departments</span><br><span class="line">WHERE location_id IN(1400,1700)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#②查询department_id = ①的姓名</span></span><br><span class="line">SELECT last_name</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id IN(</span><br><span class="line">	SELECT DISTINCT department_id</span><br><span class="line">	FROM departments</span><br><span class="line">	WHERE location_id IN(1400,1700)</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#题目：返回其它部门中比job_id为‘IT_PROG’部门任一工资低的员工的员工号、姓名、job_id 以及salary</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#①查询job_id为‘IT_PROG’部门的工资</span></span><br><span class="line">SELECT DISTINCT salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE job_id = <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#②查询其他部门的工资&lt;任意一个①的结果</span></span><br><span class="line"></span><br><span class="line">SELECT employee_id,last_name,job_id,salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary&lt;ANY(</span><br><span class="line"></span><br><span class="line">	SELECT DISTINCT salary</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE job_id = <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">等价于</span><br><span class="line"></span><br><span class="line">SELECT employee_id,last_name,job_id,salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary&lt;(</span><br><span class="line"></span><br><span class="line">	SELECT MAX(salary)</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE job_id = <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例3：返回其它部门中比job_id为‘IT_PROG’部门所有工资都低的员工 的员工号、姓名、job_id 以及salary</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#①查询job_id为‘IT_PROG’部门的工资</span></span><br><span class="line">SELECT DISTINCT salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE job_id = <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#②查询其他部门的工资&lt;所有①的结果</span></span><br><span class="line"></span><br><span class="line">SELECT employee_id,last_name,job_id,salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary&lt;ALL(</span><br><span class="line"></span><br><span class="line">	SELECT DISTINCT salary</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE job_id = <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">等价于</span><br><span class="line"></span><br><span class="line">SELECT employee_id,last_name,job_id,salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary&lt;(</span><br><span class="line"></span><br><span class="line">	SELECT MIN(salary)</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE job_id = <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#二、放在select后面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例；查询部门编号是50的员工个数</span></span><br><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">(</span><br><span class="line">	SELECT COUNT(*)</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE department_id = 50</span><br><span class="line">)  个数;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#三、放在from后面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例：查询每个部门的平均工资的工资级别</span></span><br><span class="line"><span class="comment">#①查询每个部门的平均工资</span></span><br><span class="line"></span><br><span class="line">SELECT AVG(salary),department_id</span><br><span class="line">FROM employees</span><br><span class="line">GROUP BY department_id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#②将①和sal_grade两表连接查询</span></span><br><span class="line"></span><br><span class="line">SELECT dep_ag.department_id,dep_ag.ag,g.grade</span><br><span class="line">FROM sal_grade g</span><br><span class="line">JOIN (</span><br><span class="line"></span><br><span class="line">	SELECT AVG(salary) ag,department_id</span><br><span class="line">	FROM employees</span><br><span class="line">	GROUP BY department_id</span><br><span class="line"></span><br><span class="line">) dep_ag ON dep_ag.ag BETWEEN g.min_salary AND g.max_salary;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#四、放在exists后面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例1 ：查询有无名字叫“张三丰”的员工信息</span></span><br><span class="line">SELECT EXISTS(</span><br><span class="line">	SELECT *</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE last_name = <span class="string">&#x27;Abel&#x27;</span></span><br><span class="line"></span><br><span class="line">) 有无Abel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#案例2：查询没有女朋友的男神信息</span></span><br><span class="line"></span><br><span class="line">USE girls;</span><br><span class="line"></span><br><span class="line">SELECT bo.*</span><br><span class="line">FROM boys bo</span><br><span class="line">WHERE bo.`<span class="built_in">id</span>` NOT IN(</span><br><span class="line">	SELECT boyfriend_id</span><br><span class="line">	FROM beauty b</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT bo.*</span><br><span class="line">FROM boys bo</span><br><span class="line">WHERE NOT EXISTS(</span><br><span class="line">	SELECT boyfriend_id</span><br><span class="line">	FROM beauty b</span><br><span class="line">	WHERE bo.id = b.boyfriend_id</span><br><span class="line">);</span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-source/react/②设计理念"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/6125c216c845/"
    >React源码分析 ② 设计理念</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/6125c216c845/" class="article-date">
  <time datetime="2021-12-06T03:02:35.000Z" itemprop="datePublished">2021-12-06</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="状态渲染UI"><a href="#状态渲染UI" class="headerlink" title="状态渲染UI"></a>状态渲染UI</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">UI</span> = <span class="title function_">react</span>(state);</span><br></pre></td></tr></table></figure>

<p>React 程序设计哲学</p>
<ul>
<li>将设计好的 UI 划分为组件层级</li>
<li>确定 UI state 的最小（且完整）表示</li>
<li>确定 state 放置的位置</li>
<li>添加反向数据流，低层层级组件更新高层级组件状态</li>
</ul>
<h4 id="使用组合而不是继承"><a href="#使用组合而不是继承" class="headerlink" title="使用组合而不是继承"></a>使用组合而不是继承</h4><p>Props 和组合为你提供了清晰而安全地定制组件外观和行为的灵活方式。注意：组件可以接受任意 props，包括基本数据类型，React 元素以及函数。</p>
<p>如果你想要在组件间复用非 UI 的功能，我们建议将其提取为一个单独的 JavaScript 模块，如函数、对象或者类。组件可以直接引入（import）而无需通过 extend 继承它们。</p>
<h4 id="Fiber"><a href="#Fiber" class="headerlink" title="Fiber"></a>Fiber</h4><p>Fiber 其实就是Virtual DOM的一种实现，相比于通过React.createElement创建的 Virtual DOM，Fiber在此基础上添加了更多的属性，例如 return, current 等指针，用于将Fiber对象链接为链表。最终形成一颗树状结构，也就是Fiber树，他对应着真实DOM树的结构。</p>
<p>而Fiber对象上的属性还不止这些，还有像updateQueue更新队列等属性，但到目前位置知道Fiber是对DOM树的一种描述，已经足够了。而让React设计Fiber的原因，则是因为下面的协调过程。</p>
<h4 id="协调-reconciler"><a href="#协调-reconciler" class="headerlink" title="协调 reconciler"></a>协调 reconciler</h4><p>这一概念应该是当我们对React执行过程深入思考的时候最容易想到的一部分，通过JSX创建的Virtual DOM 如何与真实的 DOM 同步，真实DOM属性改变的时候，又如何被记录到 Virtual DOM 上，这个过程就叫做<a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/reconciliation.html">协调</a>。 </p>
<p>reconciler 模块，用于处理协调相关的事务。Diff算法也在这个期间发生。</p>
<p>React15之前的协调过程是同步的，也叫stack reconciler。</p>
<p>JS的执行是单线程的,由于浏览器器触发的事件（用户交互触发的事件回调）是一个宏任务，所以会等待同步任务执行完成，在更新比较耗时的任务时，会阻塞用户的交互。</p>
<p>也许会考虑将耗时任务放到异步任务中执行，但最终还是会回到主线程中执行，所以比较好的解决办法就是任务分割，当其他优先级比较高的任务到来时，将正在执行的任务打断让出执行权。之后再从中断的部分开始异步执行剩下的计算。</p>
<p>为了将老的同步更新的架构变为异步可中断更新，所以需要一套数据结构让它既能对应真实的dom又能作为分隔的单元，这就是Fiber。</p>
<h4 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h4><p>有了Fiber，就需要用浏览器的时间片异步执行这些Fiber的工作单元，浏览器有一个api叫做requestIdleCallback，它可以在浏览器空闲的时候执行一些任务，我们用这个api执行react的更新，让高优先级的任务优先响应不就可以了吗，但事实是 requestIdleCallback 存在着浏览器的兼容性和触发不稳定的问题，所以我们需要用js实现一套时间片运行的机制，在react中这部分叫做scheduler。</p>
<p>下面用伪代码理解一下 <strong>分割，异步执行，让出执行权</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> firstFiber <span class="comment">// 代表Fiber树的头节点</span></span><br><span class="line"><span class="keyword">let</span> nextFiber = firstFiber <span class="comment">// 用于遍历子节点</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span> ()&#123;</span><br><span class="line">  <span class="comment">// 处理节点相关逻辑</span></span><br><span class="line">  <span class="keyword">return</span> nextFiber.<span class="property">next</span>; <span class="comment">// 返回下一个节点</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoop</span>(<span class="params">deadline</span>)&#123;</span><br><span class="line">  <span class="keyword">while</span>(nextFiber &amp;&amp; !shouldYield)&#123;</span><br><span class="line">    nextFiber = <span class="title function_">performUnitOfWork</span>();</span><br><span class="line">    <span class="comment">// 如果没有剩余时间处理下一个节点</span></span><br><span class="line">    <span class="comment">// 则暂停执行，让出主线程，给优先级更高的任务</span></span><br><span class="line">    shouldYield = deadline &lt; <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">requestIdleCallback</span>(workLoop)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">requestIdleCallback</span>(workLoop)</span><br></pre></td></tr></table></figure>
<h4 id="Lane"><a href="#Lane" class="headerlink" title="Lane"></a>Lane</h4><p>有了异步调度，我们还需要细粒度的管理各个任务的优先级，让高优先级的任务优先执行，各个Fiber工作单元还能比较优先级，相同优先级的任务可以一起更新。</p>
<h4 id="代数效应"><a href="#代数效应" class="headerlink" title="代数效应"></a>代数效应</h4><p>（algebraic effects） 可能翻译成 <strong>可以当做参数传递的副作用</strong> 更容易理解。 它是函数式编程中的一个概念，用于将副作用从函数调用中分离。</p>
<p>从实用的角度上举例，假如我们有这样一段代码，其主要目的是进行一大段精妙的运算：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">biz</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> infoId = <span class="comment">/* do some calc */</span> id; <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">  <span class="keyword">const</span> info = <span class="keyword">await</span> <span class="title function_">getInfo</span>(infoId);   <span class="comment">// 副作用，与 server 通信</span></span><br><span class="line">  <span class="keyword">const</span> dataId = <span class="comment">/* do some calc */</span> info.<span class="property">dataId</span>; <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">  <span class="keyword">const</span> data = <span class="title function_">getData</span>(dataId);         <span class="comment">// 副作用，非幂等操作</span></span><br><span class="line">  <span class="keyword">return</span> <span class="comment">/* do some calc */</span> data.<span class="property">finalCalcData</span>;  <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽管运算逻辑很优美，但美中不足的是有两段副作用，导致它不能成为一个干净的纯函数被单元测试。而且这里会导致严重的逻辑耦合：『做什么』与『怎么做』没有拆的很干净：你的一大段计算逻辑是在处理做什么；两个副作用更关心怎么做：比如线上是接口调用，单测里是 mock 数据；但是由于这两块副作用代码，导致整个糅杂的逻辑都无法复用。直接把两个副作用传进来不就行了？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">biz</span>(<span class="params">id, getInfo, getData</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> infoId = <span class="comment">/* do some calc */</span> id; <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">  <span class="keyword">const</span> info = <span class="keyword">await</span> <span class="title function_">getInfo</span>(infoId);   <span class="comment">// 副作用，与 server 通信</span></span><br><span class="line">  <span class="keyword">const</span> dataId = <span class="comment">/* do some calc */</span> info.<span class="property">dataId</span>; <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">  <span class="keyword">const</span> data = <span class="title function_">getData</span>(dataId);         <span class="comment">// 副作用，非幂等操作</span></span><br><span class="line">  <span class="keyword">return</span> <span class="comment">/* do some calc */</span> data.<span class="property">finalCalcData</span>;  <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是的，这样确实可以复用，但还有一个叫函数染色的问题没有解决：明明是一大段干净的同步运算逻辑，因为 getInfo 是异步的，导致整个函数都得加个 async。而且很有可能在我单元测试里，这个 getInfo 是直接同步取内存数据，还得因此弄个 Promise……这时候如果 JS 里有这样一种语法就好了：</p>
<p>当函数执行到<code>perform</code>的时候，会被暂停，并被<code>handle</code>捕获，当异步执行的结果被返回，函数在继续执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">biz</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> infoId = <span class="comment">/* do some calc */</span> id; <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">  <span class="keyword">const</span> info = perform &#123; <span class="attr">type</span>: <span class="string">&#x27;getInfo&#x27;</span>, <span class="attr">payload</span>: infoId &#125;;</span><br><span class="line">  <span class="keyword">const</span> dataId = <span class="comment">/* do some calc */</span> info.<span class="property">dataId</span>; <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">  <span class="keyword">const</span> data = perform &#123; <span class="attr">type</span>: <span class="string">&#x27;getData&#x27;</span>, <span class="attr">payload</span>: dataId &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="comment">/* do some calc */</span> data.<span class="property">finalCalcData</span>;  <span class="comment">// 这里可以理解为是一大段计算逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正常业务逻辑</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">runBiz</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">biz</span>();</span><br><span class="line">  &#125; <span class="title function_">handle</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (effect.<span class="property">type</span> === <span class="string">&#x27;getInfo&#x27;</span>) &#123;</span><br><span class="line">      resume <span class="keyword">await</span> <span class="title function_">getInfo</span>(effect.<span class="property">payload</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (effect.<span class="property">type</span> === <span class="string">&#x27;getData&#x27;</span>) &#123;</span><br><span class="line">      resume <span class="keyword">await</span> <span class="title function_">getData</span>(effect.<span class="property">payload</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单元测试逻辑</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">testBiz</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">biz</span>();</span><br><span class="line">  &#125; <span class="title function_">handle</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (effect.<span class="property">type</span> === <span class="string">&#x27;getInfo&#x27;</span>) &#123;</span><br><span class="line">      resume testInfo;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (effect.<span class="property">type</span> === <span class="string">&#x27;getData&#x27;</span>) &#123;</span><br><span class="line">      resume testData;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分离副作用在函数编程中非常常见，<code>redux-saga</code>也会将副作用分离出来，只负责发起请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> * <span class="title function_">fetchUser</span>(<span class="params">action</span>)&#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">yield</span> <span class="title function_">call</span>(<span class="title class_">Api</span>.<span class="property">fetchUser</span>,action.<span class="property">payload</span>);</span><br><span class="line">    <span class="keyword">yield</span> <span class="title function_">put</span>(&#123;<span class="attr">type</span>:<span class="string">&quot;SUCCESS&quot;</span>,<span class="attr">user</span>:user&#125;)</span><br><span class="line">  &#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="title function_">put</span>(&#123;<span class="attr">type</span>:<span class="string">&quot;ERROR&quot;</span>&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样业务逻辑代码即摆脱了副作用，完成了做什么与怎么做的解耦；又完全不必担心异步副作用带来的染色问题，可以愉快的单测和复用了。Suspense也是这种概念的延伸:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ProductResource</span> = <span class="title function_">createResource</span>(fetchProduct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Product</span> = (<span class="params">props</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> p = <span class="title class_">ProductResource</span>.<span class="title function_">read</span>( <span class="comment">// 用同步的方式来编写异步代码!</span></span><br><span class="line">          props.<span class="property">id</span></span><br><span class="line">    );</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;p.price&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Product</span> <span class="attr">id</span>=<span class="string">&#123;123&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>ProductResource.read</code> 完全是同步的写法，把获取数据的部分完全分离出了 <code>Product</code> 组件之外。在源码中， <code>ProductResource.read</code> 会在获取数据之前会throw一个特殊的 <code>Promise</code>， 由于 <code>scheduler</code> 的存在， <code>scheduler</code> 可以捕获这个 <code>promise</code>，暂停更新等数据获取之后交还执行权。<code>ProductResource</code> 可以是 <code>localStorage</code> 甚至是 <code>redis</code> 、 <code>mysql</code> 等数据库，也就是组件即服务，可能以后会有 <code>server Component</code> 的出现。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-db/MySQL服务基础"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/5f3a914ba868/"
    >MySQl 服务基础</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/5f3a914ba868/" class="article-date">
  <time datetime="2021-12-01T07:13:50.000Z" itemprop="datePublished">2021-12-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="MySQL-服务启动和停止"><a href="#MySQL-服务启动和停止" class="headerlink" title="MySQL 服务启动和停止"></a>MySQL 服务启动和停止</h4><p>查看系统内是否有 mysql 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep mysql</span><br></pre></td></tr></table></figure>

<p>停止 mysql 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service mysql stop</span><br></pre></td></tr></table></figure>

<p>启动 mysql 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service mysql start</span><br></pre></td></tr></table></figure>

<p>重启 mysql 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service mysql restart</span><br></pre></td></tr></table></figure>

<h4 id="登录与退出"><a href="#登录与退出" class="headerlink" title="登录与退出"></a>登录与退出</h4><p>登录命令，属性和属性值之间可以省略空格</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h主机名 -P端口号 -u有户名 -p密码</span><br></pre></td></tr></table></figure>

<p>退出 <code>exit</code></p>
<h4 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h4><p>查看当前所有数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show databases;</span><br></pre></td></tr></table></figure>

<p>打开指定的库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use 库名;</span><br></pre></td></tr></table></figure>

<p>查看当前所在库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select database();</span><br></pre></td></tr></table></figure>

<p>查看所有表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br></pre></td></tr></table></figure>

<p>查看其他库的所有表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show tables from 库名;</span><br></pre></td></tr></table></figure>

<p>创建表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create table 表名 &#123;</span><br><span class="line">  列名 列类型，</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看表结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc 表名;</span><br></pre></td></tr></table></figure>

<p>查看表结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 进入mysql服务器中</span><br><span class="line">select version();</span><br><span class="line"></span><br><span class="line">// 在命令行中</span><br><span class="line">mysql --version</span><br><span class="line">mysql -V</span><br></pre></td></tr></table></figure>

<h4 id="语法规范"><a href="#语法规范" class="headerlink" title="语法规范"></a>语法规范</h4><ul>
<li>不区分大小写，建议关键字大写，表名，列名小写</li>
<li>每条命令<code>;</code>结尾</li>
<li>命令可以换行</li>
<li>注释<br>单行注释: <code>#注释文字</code><br>单行注释: <code>-- 注释文字</code><br>多行注释: <code>/* 注释文字 */</code></li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-react/⑤(SSR)node中间层代理请求"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/70ef756f1afd/"
    >⑤ ReactSSR node中间层代理请求</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/70ef756f1afd/" class="article-date">
  <time datetime="2021-11-22T13:07:20.000Z" itemprop="datePublished">2021-11-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a> / <a class="article-category-link" href="/categories/React/SSR/">SSR</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="代理请求"><a href="#代理请求" class="headerlink" title="代理请求"></a>代理请求</h4><p>由于客户端和服务端公用一套请求的接口，所以需要接口同时适应客户端和移动端，这里可以选用 <a target="_blank" rel="noopener" href="https://github.com/lquixada/cross-fetch">cross-fetch</a> 或 <a target="_blank" rel="noopener" href="https://github.com/axios/axios">axios</a></p>
<p>当在异步action中请求数据时，我们希望请求的是同域的服务</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">loadData</span> = (<span class="params"></span>) =&gt; <span class="function">(<span class="params">dispatch: Dispatch,getState:any,request:AxiosInstance</span>) =&gt;</span> <span class="title function_">axios</span>(<span class="string">&#x27;/api/products&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> <span class="title function_">dispatch</span>(<span class="title function_">loadDataAction</span>(data)));</span><br></pre></td></tr></table></figure>

<p>而不是直接请求后端服务器。所以需要将api开头的请求转发到后端服务器请求。用到了一个koa的中间件 <a target="_blank" rel="noopener" href="https://github.com/common110/koa-proxies">koa-proxies</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">&#x27;koa&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> koaBody <span class="keyword">from</span> <span class="string">&#x27;koa-body&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> koaStatic <span class="keyword">from</span> <span class="string">&#x27;koa-static&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> proxy <span class="keyword">from</span> <span class="string">&#x27;koa-proxies&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;../router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> errorHandle <span class="keyword">from</span> <span class="string">&#x27;./errorHandle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">.<span class="title function_">use</span>(<span class="keyword">async</span> (<span class="attr">ctx</span>:any, <span class="attr">next</span>:<span class="function">()=&gt;</span><span class="title class_">Promise</span>&lt;any&gt;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, err, ctx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">use</span>(<span class="title function_">proxy</span>(<span class="string">&#x27;/api&#x27;</span>,&#123;</span><br><span class="line">    <span class="attr">target</span>:  <span class="string">&#x27;https://fakestoreapi.com&#x27;</span>,</span><br><span class="line">    <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">rewrite</span>: <span class="function"><span class="params">path</span> =&gt;</span> path.<span class="title function_">replace</span>(<span class="regexp">/^\/api/</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">  &#125;))</span><br><span class="line">.<span class="title function_">use</span>(<span class="title function_">koaStatic</span>(path.<span class="title function_">join</span>((process.<span class="property">env</span> <span class="keyword">as</span> any).<span class="property">PWD</span>,<span class="string">&#x27;./static&#x27;</span>)))</span><br><span class="line">.<span class="title function_">use</span>(<span class="title function_">koaBody</span>())</span><br><span class="line">.<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errorHandle);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> app;</span><br></pre></td></tr></table></figure>

<h4 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h4><p>现在客户端正常访问是可以的，但是服务端会报出错误，因为当刷新页面的时候服务端会做服务端渲染，这时直接调用了组件中获取数据的方法。</p>
<p>由于组件中的路径是以 <code>/api</code> 开头的绝对路径，所以会尝试在服务器中查找根路径下<code>api</code>文件夹，因为找不到报错错误。</p>
<p>一个思路是，区分服务端的请求和客户端的请求，分别为其创建不同的axios实例用于请求，但是为了避免像上一章中，每个请求分两种写，可以考虑在项目初始化的时候创建不同的axios实例，并通过参数传递到请求方法中，从而避免业务逻辑太多冗余。</p>
<blockquote>
<p>src&#x2F;util&#x2F;request.ts </p>
</blockquote>
<p>定义一个请求方法，为服务端和客户端创建不同实例</p>
<p>由于后端服务并不是<code>api</code>开头的接口，所以后端访问时，需要为其重写<code>url</code>路径.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> serverInstance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">baseURL</span>: <span class="string">&#x27;https://fakestoreapi.com&#x27;</span>,</span><br><span class="line">    <span class="attr">adapter</span>: <span class="keyword">function</span> (<span class="params">config</span>) &#123;</span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">        config.<span class="property">url</span> = config.<span class="property">url</span>?.<span class="title function_">replace</span>(<span class="regexp">/^\/api/</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="keyword">delete</span> config.<span class="property">adapter</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">resolve</span>(<span class="title function_">axios</span>(config));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clientInstance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">baseURL</span>: <span class="string">&#x27;/&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    serverInstance,</span><br><span class="line">    clientInstance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在初始化store的时候，通过中间件把axios实例传入，让所用的异步action在请求前可以通过第三个参数拿到axios实例</p>
<blockquote>
<p>src&#x2F;store&#x2F;index.ts</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Provider</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span></span><br><span class="line"><span class="keyword">import</span> reducers <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">StoreType</span> <span class="keyword">as</span> <span class="title class_">HelloStoreType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../components/hello&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;clientInstance,serverInstance&#125; <span class="keyword">from</span> <span class="string">&#x27;../util/request&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">browserStore</span> = (<span class="params"></span>)=&gt; <span class="title function_">createStore</span>(reducers, (<span class="variable language_">window</span> <span class="keyword">as</span> any).<span class="property">__HYDRATE_DATA__</span>, <span class="title function_">applyMiddleware</span>(thunk.<span class="title function_">withExtraArgument</span>(clientInstance)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">serverStore</span> = (<span class="params"></span>) =&gt; <span class="title function_">createStore</span>(reducers, <span class="title function_">applyMiddleware</span>(thunk.<span class="title function_">withExtraArgument</span>(serverInstance)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">StoreType</span> = &#123;</span><br><span class="line">    <span class="attr">hello</span>: <span class="title class_">HelloStoreType</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    <span class="title class_">Provider</span>,</span><br><span class="line">    browserStore,</span><br><span class="line">    serverStore</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>src&#x2F;components&#x2F;hello&#x2F;action.ts</p>
</blockquote>
<p>修改action方法，通过axios实例请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Dispatch</span>, <span class="title class_">ActionCreator</span> &#125; <span class="keyword">from</span> <span class="string">&quot;redux&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">AxiosInstance</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;&#125;<span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">LOAD_DATA</span> = <span class="string">&#x27;LOAD_DATA&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="variable constant_">LOAD_DATA_TYPE</span> = <span class="keyword">typeof</span> <span class="variable constant_">LOAD_DATA</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">loadDataAction</span>: <span class="title class_">ActionCreator</span>&lt;&#123; <span class="attr">type</span>: <span class="variable constant_">LOAD_DATA_TYPE</span> &#125;&gt; = <span class="function">(<span class="params">payload</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="variable constant_">LOAD_DATA</span>,</span><br><span class="line">    payload,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">ActionTypes</span> = <span class="variable constant_">LOAD_DATA_TYPE</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">loadData</span> = (<span class="params"></span>) =&gt; <span class="function">(<span class="params">dispatch: Dispatch,getState:any,request:AxiosInstance</span>) =&gt;</span> <span class="title function_">request</span>(<span class="string">&#x27;/api/products&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> <span class="title function_">dispatch</span>(<span class="title function_">loadDataAction</span>(data)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> serverLoadData = loadData;</span><br></pre></td></tr></table></figure>

<p>最后一步，由于我们统一了调用方法，现在服务端也会通过异步action方法调用接口</p>
<p>所以需要让服务端调用方法的时候，也像客户端一样通过<code>bindActionCreators</code>传入<code>dispatch</code>方法</p>
<p>通过服务端创建的<code>store</code>传入了<code>dispatch</code>方法，并且让中间件的参数生效。这时也不需要再组合不同接口返回的<code>state</code>,通过异步<code>action</code>方法，在拿到返回值之后，<code>dispatch</code>会触发并更新<code>store</code></p>
<p>当所有的组件异步数据请求之后，在通过<code>getState</code>获取最新的<code>store</code>渲染页面</p>
<blockquote>
<p>src&#x2F;router&#x2F;index.tsx</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/(.*)&quot;</span>,<span class="keyword">async</span> (ctx)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">serverStore</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">promises</span>:<span class="title class_">Array</span>&lt;any&gt; = <span class="title function_">matchRoutes</span>(routes,ctx.<span class="property">request</span>.<span class="property">path</span>).<span class="title function_">map</span>(<span class="function">(<span class="params">&#123;route,match&#125;</span>)=&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> route.<span class="property">loadData</span>?<span class="title function_">bindActionCreators</span>(route.<span class="property">loadData</span>,store.<span class="property">dispatch</span>)():<span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">    &#125; );</span><br><span class="line">     <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises);</span><br><span class="line"></span><br><span class="line">    ctx.<span class="property">body</span>=<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">        &lt;html lang=&quot;en&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;head&gt;</span></span><br><span class="line"><span class="string">                &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;title&gt;Document&lt;/title&gt;</span></span><br><span class="line"><span class="string">            &lt;/head&gt;</span></span><br><span class="line"><span class="string">            &lt;body&gt;</span></span><br><span class="line"><span class="string">                &lt;div id=&#x27;root&#x27;&gt;<span class="subst">$&#123;ReactDOMServer.renderToString(&lt;App &#123;...&#123;ctx,store&#125;&#125;/&gt;)&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;script&gt;</span></span><br><span class="line"><span class="string">                    window.__HYDRATE_DATA__ = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(store.getState())&#125;</span></span></span><br><span class="line"><span class="string">                &lt;/script&gt;</span></span><br><span class="line"><span class="string">                &lt;script src=&#x27;/index.js&#x27; defer&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SSR/" rel="tag">SSR</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-react/④(SSR)接入redux"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/a8dd4b44a192/"
    >④ ReactSSR 接入redux</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/a8dd4b44a192/" class="article-date">
  <time datetime="2021-11-20T07:21:01.000Z" itemprop="datePublished">2021-11-20</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a> / <a class="article-category-link" href="/categories/React/SSR/">SSR</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="创建Action"><a href="#创建Action" class="headerlink" title="创建Action"></a>创建Action</h4><blockquote>
<p>&#x2F;src&#x2F;components&#x2F;hello&#x2F;action.ts</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Dispatch</span>, <span class="title class_">ActionCreator</span> &#125; <span class="keyword">from</span> <span class="string">&quot;redux&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> axios, &#123; <span class="title class_">AxiosResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">LOAD_DATA</span> = <span class="string">&#x27;LOAD_DATA&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="variable constant_">LOAD_DATA_TYPE</span> = <span class="keyword">typeof</span> <span class="variable constant_">LOAD_DATA</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">FetchDataInterface</span> &#123;</span><br><span class="line">    (match?: any): <span class="title class_">Promise</span>&lt;<span class="title class_">AxiosResponse</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">fetchData</span>: <span class="title class_">FetchDataInterface</span> = <span class="function">(<span class="params">match</span>) =&gt;</span> <span class="title function_">axios</span>(<span class="string">&#x27;https://fakestoreapi.com/products&#x27;</span>);</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">ServerLoadDataInterface</span> &#123;</span><br><span class="line">    (<span class="attr">match</span>: any): <span class="title class_">Promise</span>&lt;any&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">serverLoadData</span>: <span class="title class_">ServerLoadDataInterface</span> = <span class="function">(<span class="params">match</span>) =&gt;</span> <span class="title function_">fetchData</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> (&#123; <span class="attr">hello</span>: &#123; <span class="attr">shopData</span>: data &#125; &#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">loadDataAction</span>: <span class="title class_">ActionCreator</span>&lt;&#123; <span class="attr">type</span>: <span class="variable constant_">LOAD_DATA_TYPE</span> &#125;&gt; = <span class="function">(<span class="params">payload</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="variable constant_">LOAD_DATA</span>,</span><br><span class="line">    payload,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">ActionTypes</span> = <span class="variable constant_">LOAD_DATA_TYPE</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">loadData</span> = (<span class="params"></span>) =&gt; <span class="function">(<span class="params">dispatch: Dispatch</span>) =&gt;</span> <span class="title function_">fetchData</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> <span class="title function_">dispatch</span>(<span class="title function_">loadDataAction</span>(data)));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="创建reducer"><a href="#创建reducer" class="headerlink" title="创建reducer"></a>创建reducer</h4><blockquote>
<p>&#x2F;src&#x2F;components&#x2F;hello&#x2F;reducer.ts</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">AnyAction</span>,<span class="title class_">Reducer</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="variable constant_">LOAD_DATA</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./action&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">StoreType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initStore = &#123;</span><br><span class="line">    <span class="attr">shopData</span>:[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">hello</span>:<span class="title class_">Reducer</span>&lt;<span class="title class_">StoreType</span>,<span class="title class_">AnyAction</span>&gt; = <span class="function">(<span class="params">state=initStore, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="attr">LOAD_DATA</span>:</span><br><span class="line">            <span class="keyword">return</span> (&#123;...state,<span class="attr">shopData</span>:action.<span class="property">payload</span>&#125;)</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> hello;</span><br></pre></td></tr></table></figure>


<h4 id="connect-Hello组件"><a href="#connect-Hello组件" class="headerlink" title="connect Hello组件"></a>connect Hello组件</h4><blockquote>
<p>&#x2F;src&#x2F;components&#x2F;hello&#x2F;hello.ts</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bindActionCreators,<span class="title class_">Dispatch</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">StoreType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../../store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Header</span> <span class="keyword">from</span> <span class="string">&#x27;../header&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;loadData&#125; <span class="keyword">from</span> <span class="string">&#x27;./action&#x27;</span>;</span><br><span class="line"></span><br><span class="line">type <span class="title class_">HelloComponentProps</span> = &#123;</span><br><span class="line">    <span class="attr">loadData</span>:<span class="function">()=&gt;</span><span class="keyword">void</span>,</span><br><span class="line">    <span class="attr">shopData</span>:<span class="title class_">Array</span>&lt;any&gt;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Hello</span>:<span class="title class_">React</span>.<span class="property">FC</span>&lt;<span class="title class_">HelloComponentProps</span>&gt; = <span class="function">(<span class="params">props</span>) =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        loadData,</span><br><span class="line">        shopData</span><br><span class="line">    &#125; = props;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">loadData</span>();</span><br><span class="line">    &#125;,[])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Header</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;</span></span><br><span class="line"><span class="language-xml">            shopData.map(item=&gt; <span class="tag">&lt;<span class="name">h6</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>&#123;alert(&quot;hello&quot;)&#125;&#125; key=&#123;item.id&#125;&gt;&#123;item.title&#125;<span class="tag">&lt;/<span class="name">h6</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">        &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mapStateToProps</span> = (<span class="params">state:StoreType</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">shopData</span>:state.<span class="property">hello</span>.<span class="property">shopData</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">mapDispatchToProps</span> = (<span class="params">dispatch:Dispatch</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">loadData</span>: <span class="title function_">bindActionCreators</span>(loadData,dispatch)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">connect</span>(mapStateToProps,mapDispatchToProps)(<span class="title class_">Hello</span>) ;</span><br></pre></td></tr></table></figure>

<h4 id="修改-Hello-组件入口文件-index-ts"><a href="#修改-Hello-组件入口文件-index-ts" class="headerlink" title="修改 Hello 组件入口文件 index.ts"></a>修改 Hello 组件入口文件 index.ts</h4><ul>
<li><p>暴露服务端渲染时需要的数据请求方法</p>
</li>
<li><p>添加store类型，暴露到外部的 store&#x2F;index.js 统一描述store类型</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Hello</span> <span class="keyword">from</span> <span class="string">&quot;./hello&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;serverLoadData&#125; <span class="keyword">from</span> <span class="string">&#x27;./action&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface <span class="title class_">StoreType</span> &#123;</span><br><span class="line">    <span class="attr">shopData</span>:<span class="title class_">Array</span>&lt;any&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    serverLoadData</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Hello</span>;</span><br></pre></td></tr></table></figure>

<h4 id="创建全局的store"><a href="#创建全局的store" class="headerlink" title="创建全局的store"></a>创建全局的store</h4><blockquote>
<p>src&#x2F;store&#x2F;index.ts</p>
</blockquote>
<p>用于生成store对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Provider</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span></span><br><span class="line"><span class="keyword">import</span> reducers <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">StoreType</span> <span class="keyword">as</span> <span class="title class_">HelloStoreType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../components/hello&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">browserStore</span> = (<span class="params"></span>)=&gt; <span class="title function_">createStore</span>(reducers, (<span class="variable language_">window</span> <span class="keyword">as</span> any).<span class="property">__HYDRATE_DATA__</span>, <span class="title function_">applyMiddleware</span>(thunk));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">serverStores</span> = (<span class="params">__HYDRATE_DATA__: any</span>) =&gt; <span class="title function_">createStore</span>(reducers, __HYDRATE_DATA__, <span class="title function_">applyMiddleware</span>(thunk));</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">StoreType</span> = &#123;</span><br><span class="line">    <span class="attr">hello</span>: <span class="title class_">HelloStoreType</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    <span class="title class_">Provider</span>,</span><br><span class="line">    browserStore,</span><br><span class="line">    serverStores</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>src&#x2F;store&#x2F;reducers.ts</p>
</blockquote>
<p>合并所有组件中的reducer</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> hello <span class="keyword">from</span> <span class="string">&#x27;../components/hello/reducer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">combineReducers</span>(&#123;</span><br><span class="line">    hello</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="服务端预加载数据，改造routers"><a href="#服务端预加载数据，改造routers" class="headerlink" title="服务端预加载数据，改造routers"></a>服务端预加载数据，改造routers</h4><p>之前的routers是一个JSX元素，现在想调用组件暴露出的服务端请求数据的方法，并在拿到结果重新渲染组件，生成html字符串，并返回给浏览器</p>
<p>所以第一步：改造routers让我们可以拿到数据请求的方法</p>
<blockquote>
<p>src&#x2F;components&#x2F;routes.tsx</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Hello</span>, &#123; serverLoadData <span class="keyword">as</span> helloServerLoadData &#125; <span class="keyword">from</span> <span class="string">&quot;./hello&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Login</span> <span class="keyword">from</span> <span class="string">&quot;./login&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/hello&quot;</span>,</span><br><span class="line">        <span class="attr">exact</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Hello</span>,</span><br><span class="line">        <span class="attr">loadData</span>: <span class="function">(<span class="params">match:any</span>) =&gt;</span> <span class="title function_">helloServerLoadData</span>(match)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">        <span class="attr">exact</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Login</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Hello</span>,</span><br><span class="line">        <span class="attr">exact</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">loadData</span>: <span class="function">(<span class="params">match:any</span>) =&gt;</span> <span class="title function_">helloServerLoadData</span>(match)</span><br><span class="line">    &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> routes;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>src&#x2F;components&#x2F;router.tsx</p>
</blockquote>
<p>循环生成路由组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">&#x27;koa&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">BrowserRouter</span>,</span><br><span class="line">    <span class="title class_">Switch</span>,</span><br><span class="line">    <span class="title class_">Route</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;react-router-dom&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> routes <span class="keyword">from</span> <span class="string">&#x27;./routes&#x27;</span></span><br><span class="line"></span><br><span class="line">interface <span class="title class_">RouterProps</span> &#123;</span><br><span class="line">    ctx?: <span class="title class_">Koa</span>.<span class="property">BaseContext</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span>: <span class="title class_">React</span>.<span class="property">FC</span>&lt;<span class="title class_">RouterProps</span>&gt; = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;routes.map(route =&gt; (</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Route</span> &#123;<span class="attr">...route</span>&#125; <span class="attr">key</span>=<span class="string">&#123;route.path&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                ))&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Router</span>;</span><br></pre></td></tr></table></figure>

<h4 id="匹配路由对应的组件"><a href="#匹配路由对应的组件" class="headerlink" title="匹配路由对应的组件"></a>匹配路由对应的组件</h4><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/react-router-config">react-router-config</a> 用于匹配包括子路由在内的所有路由配置对应的组件</p>
<p>在拿到所有的匹配项之后，循环调用所有组件的数据请求方法，并把返回的promise对象放到一个数组中</p>
<p>当所有的返回值拿到之后，组合所有的state,初始化React组件，并渲染成字符串返回给浏览器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">&#x27;@koa/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOMServer</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom/server&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> routes <span class="keyword">from</span> <span class="string">&#x27;../components/routes&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; matchRoutes &#125; <span class="keyword">from</span> <span class="string">&quot;react-router-config&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/(.*)&quot;</span>,<span class="keyword">async</span> (ctx,next)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">promises</span>:<span class="title class_">Array</span>&lt;any&gt; = <span class="title function_">matchRoutes</span>(routes,ctx.<span class="property">request</span>.<span class="property">path</span>).<span class="title function_">map</span>(<span class="function">(<span class="params">&#123;route,match&#125;</span>)=&gt;</span> route.<span class="property">loadData</span>?route.<span class="title function_">loadData</span>(match):<span class="title class_">Promise</span>.<span class="title function_">resolve</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> preloadData = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises);</span><br><span class="line">    <span class="keyword">const</span> __HYDRATE_DATA__ = preloadData.<span class="title function_">reduce</span>(<span class="function">(<span class="params">res,data</span>)=&gt;</span><span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;,res,data) ,&#123;&#125;);</span><br><span class="line"></span><br><span class="line">    ctx.<span class="property">body</span>=<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">        &lt;html lang=&quot;en&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;head&gt;</span></span><br><span class="line"><span class="string">                &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;title&gt;Document&lt;/title&gt;</span></span><br><span class="line"><span class="string">            &lt;/head&gt;</span></span><br><span class="line"><span class="string">            &lt;body&gt;</span></span><br><span class="line"><span class="string">                &lt;div id=&#x27;root&#x27;&gt;<span class="subst">$&#123;ReactDOMServer.renderToString(&lt;App &#123;...&#123;ctx,__HYDRATE_DATA__&#125;&#125;/&gt;)&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;script&gt;</span></span><br><span class="line"><span class="string">                    window.__HYDRATE_DATA__ = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(__HYDRATE_DATA__)&#125;</span></span></span><br><span class="line"><span class="string">                &lt;/script&gt;</span></span><br><span class="line"><span class="string">                &lt;script src=&#x27;/index.js&#x27;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>


<h4 id="数据脱水和注水"><a href="#数据脱水和注水" class="headerlink" title="数据脱水和注水"></a>数据脱水和注水</h4><ul>
<li><p>服务端渲染的时候需要把整合之后的store传入到初始化函数中，用于渲染Html字符串</p>
</li>
<li><p>客户端渲染的时候，由于第一次渲染是并没有数据，会覆盖掉服务端渲染的结构，并重新请求后在渲染，这中间的过程就会白屏<br>所以会在服务端直接把数据以字符串的方式插入到html界面中，在客户端解析的时候会变成window下的一个store对象，这个过程就叫做数据注水</p>
</li>
<li><p>当客户端初始化时，会尝试查找window下有没有服务端插入的数据，如果有就用这个数据作为初始化数据，从而防止两边状态不统一造成的白屏，这一过程也叫做数据脱水</p>
</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SSR/" rel="tag">SSR</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-react/②(原理)react执行流程和整体架构"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/94ab7cddc99f/"
    >React原理 执行流程与架构</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/94ab7cddc99f/" class="article-date">
  <time datetime="2021-10-22T11:04:28.000Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="整体执行流程"><a href="#整体执行流程" class="headerlink" title="整体执行流程"></a>整体执行流程</h4><p><img src="/posts/94ab7cddc99f/0001.png"></p>
<h4 id="初始化事件相关对象"><a href="#初始化事件相关对象" class="headerlink" title="初始化事件相关对象"></a>初始化事件相关对象</h4><p><img src="/posts/94ab7cddc99f/0002.png"></p>
<ul>
<li>registerSimpleEvents 创建对象相关对象</li>
</ul>
<table>
<thead>
<tr>
<th>变量名称</th>
<th>变量对象</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>allNativeEvents</td>
<td>Set集合</td>
<td><div style='width:600px'>保存所有原生事件的名称 例如 <code>0:&quot;cancel&quot;</code></div></td>
</tr>
<tr>
<td>eventPriorities</td>
<td>Map集</td>
<td><div style='width:600px'>保存事件名称和事件优先级对应关系 例如 <code>click=&gt;0</code> </div></td>
</tr>
<tr>
<td>topLevelEventsToReactNames</td>
<td>Map集</td>
<td><div style='width:600px'>保存原始事件名称和 React事件的对应关系 例如 <code>&quot;cancel&quot; =&gt; &quot;onCancel&quot;</code> </div></td>
</tr>
<tr>
<td>registrationNameDependencies</td>
<td>Object</td>
<td><div style='width:600px'>保存React事件和原生事件的对应关系 例如 <code>onClick:(1) [&#39;click&#39;]</code> 每个React事件对应一个数组用于保存合成事件对应关系</div></td>
</tr>
<tr>
<td>possibleRegistrationNames</td>
<td>Object</td>
<td><div style='width:600px'>保存小写的React事件名称和正确的驼峰命名事件的对应关系，用于校验用户输入 例如 <code>onclick:onClick</code></div></td>
</tr>
</tbody></table>
<h4 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h4><p><img src="/posts/94ab7cddc99f/0003.png"></p>
<p><strong>render</strong> : ReactDom.render()<br><strong>createRootImpl</strong> : 创建 FiberRootNode 根节点<br><strong>listenToAllSupportedEvents</strong> : 绑定所有原生事件在root节点上</p>
<h4 id="render阶段"><a href="#render阶段" class="headerlink" title="render阶段"></a>render阶段</h4><p><img src="/posts/94ab7cddc99f/0004.png"></p>
<p><strong>unbatchedUpdates</strong> : 非批量更新，让用户尽早看见页面内容，如果是 batchedUpdates 会以异步执行<br><strong>scheduleUpdateOnFiber</strong> : 调度Fiber节点更新优先级<br><strong>performUnitOfWork</strong> : 以Fiber节点为单位，深度优先递归遍历每一个节点<br><strong>reconcileChildren</strong> ： 创建对比Fiber节点，标记有副作用的节点 （添加，删除，移动，更新）<br><strong>completeUnitOfWork</strong> ： 从下至上遍历节点，创建相应的DOM节点，并创建Effects链表，交给commit阶段使用</p>
<h4 id="commit阶段"><a href="#commit阶段" class="headerlink" title="commit阶段"></a>commit阶段</h4><p><img src="/posts/94ab7cddc99f/0005.png"></p>
<p><strong>commitBeforeMutationEffects</strong>: 操作真实节点前执行，会执行<code>getSnapshotBeforeUpdate</code><br><strong>commitMutationEffects</strong>: 执行节点操作<br><strong>commitLayoutEffects：</strong> 执行副作用函数，包括 <code>componentDidUpdate</code> 或 <code>effect</code>回调函数</p>
<h4 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h4><p>jsx是js语言的扩展，react通过babel词法解析，将jsx转换成React.createElement，React.createElement方法返回virtual-dom对象（内存中用来描述dom阶段的对象），所有jsx本质上就是React.createElement的语法糖，它能声明式的编写我们想要组件呈现出什么样的ui效果.</p>
<h4 id="Fiber双缓存"><a href="#Fiber双缓存" class="headerlink" title="Fiber双缓存"></a>Fiber双缓存</h4><p>Fiber对象上面保存了包括这个节点的属性、类型、dom等，Fiber通过child、sibling、return（指向父节点）来形成Fiber树，还保存了更新状态时用于计算state的updateQueue，updateQueue是一种链表结构，上面可能存在多个未计算的update，update也是一种数据结构，上面包含了更新的数据、优先级等，除了这些之外，上面还有和副作用有关的信息。</p>
<p>双缓存是指存在两颗Fiber树，current Fiber树描述了当前呈现的dom树，workInProgress Fiber是正在更新的Fiber树，这两颗Fiber树都是在内存中运行的，在workInProgress Fiber构建完成之后会将它作为current Fiber应用到dom上</p>
<p>在mount时（首次渲染），会根据jsx对象（Class Component或的render函数者Function Component的返回值），构建Fiber对象，形成Fiber树，然后这颗Fiber树会作为current Fiber应用到真实dom上，在update（状态更新时如setState）的时候，会根据状态变更后的jsx对象和current Fiber做对比形成新的workInProgress Fiber，然后workInProgress Fiber切换成current Fiber应用到真实dom就达到了更新的目的，而这一切都是在内存中发生的，从而减少了对dom好性能的操作。</p>
<p><img src="/posts/94ab7cddc99f/0006.jpg"></p>
<h4 id="Lane模型"><a href="#Lane模型" class="headerlink" title="Lane模型"></a>Lane模型</h4><p>react之前的版本用expirationTime属性代表优先级，该优先级和IO不能很好的搭配工作（io的优先级高于cpu的优先级），现在有了更加细粒度的优先级表示方法Lane，Lane用二进制位表示优先级，二进制中的1表示位置，同一个二进制数可以有多个相同优先级的位，这就可以表示‘批’的概念，而且二进制方便计算。</p>
<p>这好比赛车比赛，在比赛开始的时候会分配一个赛道，比赛开始之后大家都会抢内圈的赛道（react中就是抢优先级高的Lane），比赛的尾声，最后一名赛车如果落后了很多，它也会跑到内圈的赛道，最后到达目的地（对应react中就是饥饿问题，低优先级的任务如果被高优先级的任务一直打断，到了它的过期时间，它也会变成高优先级）</p>
<p>Lane的二进制位如下，1的bits越多，优先级越低</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NoLanes</span>: <span class="title class_">Lanes</span> = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NoLane</span>: <span class="title class_">Lane</span> = <span class="comment">/*                          */</span> <span class="number">0b0000000000000000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">SyncLane</span>: <span class="title class_">Lane</span> = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000000000001</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">SyncBatchedLane</span>: <span class="title class_">Lane</span> = <span class="comment">/*                 */</span> <span class="number">0b0000000000000000000000000000010</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h4><p>Scheduler的作用是调度任务，react15没有Scheduler这部分，所以所有任务没有优先级，也不能中断，只能同步执行。</p>
<p>我们知道了要实现异步可中断的更新，需要浏览器指定一个时间，如果没有时间剩余了就需要暂停任务，requestIdleCallback貌似是个不错的选择，但是它存在兼容和触发不稳定的原因，react17中采用MessageChannel来实现。</p>
<p>在Scheduler中的每的每个任务的优先级使用过期时间表示的，如果一个任务的过期时间离现在很近，说明它马上就要过期了，优先级很高，如果过期时间很长，那它的优先级就低，没有过期的任务存放在timerQueue中，过期的任务存放在taskQueue中，timerQueue和timerQueue都是小顶堆，所以peek取出来的都是离现在时间最近也就是优先级最高的那个任务，然后优先执行它。</p>
<h4 id="reconciler"><a href="#reconciler" class="headerlink" title="reconciler"></a>reconciler</h4><p>Reconciler发生在render阶段，render阶段会分别为节点执行beginWork和completeWork，或者计算state，对比节点的差异，为节点赋值相应的effectFlags（对应dom节点的增删改）。</p>
<p>协调器是在render阶段工作的，简单一句话概括就是Reconciler会创建或者更新Fiber节点。在mount的时候会根据jsx生成Fiber对象，在update的时候会根据最新的state形成的jsx对象和current Fiber树对比构建workInProgress Fiber树，这个对比的过程就是diff算法。</p>
<p>diff算法发生在render阶段的reconcileChildFibers函数中，diff算法分为单节点的diff和多节点的diff（例如一个节点中包含多个子节点就属于多节点的diff），单节点会根据节点的key和type，props等来判断节点是复用还是直接新创建节点，多节点diff会涉及节点的增删和节点位置的变化。</p>
<p>reconcile时会在这些Fiber上打上Flags标签，在commit阶段把这些标签应用到真实dom上，这些标签代表节点的增删改，如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Placement</span> = <span class="comment">/*             */</span> <span class="number">0b0000000000010</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Update</span> = <span class="comment">/*                */</span> <span class="number">0b0000000000100</span>;</span><br></pre></td></tr></table></figure>

<p>render阶段遍历Fiber树类似dfs的过程，处理发生在beginWork函数中，该函数做的主要工作是创建Fiber节点，计算state和diff算法，‘冒泡’阶段发生在completeWork中，该函数主要是做一些收尾工作，例如处理节点的props、和形成一条effectList的链表，该链表是被标记了更新的节点形成的链表。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">   	 <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">          setCount(() =&gt; count + 1);</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">title</span>=<span class="string">&#123;count&#125;</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> hello</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果p和h1节点更新了则effectList如下，从rootFiber-&gt;h1-&gt;p,，顺便说下fiberRoot是整个项目的根节点，只存在一个，rootFiber是应用的根节点，可能存在多个。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-source/react/①认识React"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/d751aac6b0f4/"
    >React源码分析 ① 从入口开始认识React</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/d751aac6b0f4/" class="article-date">
  <time datetime="2021-10-22T11:04:28.000Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="render-方法"><a href="#render-方法" class="headerlink" title="render 方法"></a>render 方法</h4><p>当我们打开 React 的<a target="_blank" rel="noopener" href="https://reactjs.org/docs/hello-world.html">官方文档</a>看到的第一个例子便是 Hello World：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>));</span><br></pre></td></tr></table></figure>

<p><code>render</code>函数将<code>h1</code>标签和<code>Hello World</code>文本渲染在了页面的<code>root</code>元素中，但很显然这段代码没有看到的那么简单，<code>js</code>并不会认识<code>html</code>元素，这个标签最终会被转换成 js 对象，然后通过<code>render</code>方法后面的一系列函数调用，最终被插入到页面中。</p>
<h4 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h4><p>刚才看到的 <code>h1</code> 标签，严格说来并不是<code>html</code>,因为他写在 js 语法中，可以把它叫做标签语法，也就是 JSX。</p>
<p>为什么 JSX 的出现好像又让页面开发回到了刀耕火种的<code>jquery</code>时代，<code>js</code>与<code>html</code>混合在一起，UI(视图)与逻辑耦合。</p>
<p>但实际上 React 认为，渲染逻辑与 UI 的逻辑是耦合的，比如需要在 UI 中绑定事件，数据改变时通知 UI 发生改变，而 React 并没有将这两点分离到不同的文件中，而是通过组件的概念，实现关注点分离，也就是设计原则的分离，每一部分都有自己的关注点。</p>
<p>我们可以在<a target="_blank" rel="noopener" href="https://www.babeljs.cn/">Babel</a>中，看一下 JSX 最终变成了什么。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">CompA</span> = (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>p<span class="tag">&lt;/<span class="name">p</span>&gt;</span>div</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">CompB</span> = (<span class="params"></span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span>a<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">CompA</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">CompB</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>转化为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">CompA</span> = <span class="comment">/*#__PURE__*/</span> <span class="title class_">React</span>.<span class="title function_">createElement</span>(</span><br><span class="line">  <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">/*#__PURE__*/</span> <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;p&quot;</span>),</span><br><span class="line">  <span class="string">&quot;div&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">CompB</span> = (<span class="params"></span>) =&gt; <span class="comment">/*#__PURE__*/</span> <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="comment">/*#__PURE__*/</span> <span class="title class_">React</span>.<span class="title function_">createElement</span>(</span><br><span class="line">    <span class="title class_">React</span>.<span class="property">Fragment</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">/*#__PURE__*/</span> <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="title class_">CompA</span>, <span class="literal">null</span>),</span><br><span class="line">    <span class="comment">/*#__PURE__*/</span> <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="title class_">CompB</span>, <span class="literal">null</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以注意到组件被转化为<code>React.createElement</code>方法的第一个参数，这也是为什么组件的第一个字母需要大写的原因，Babel 会通过大小写来区分原生组件和 React 组件</p>
<p>而正因为 JSX 语法被转换成了<code>React.createElement</code>的函数调用，因此在写 JSX 的时候必须要<code>import React from react</code></p>
<p>而 React 17-RC 以及之后的版本将采用<a target="_blank" rel="noopener" href="https://reactjs.org/blog/2020/09/22/introducing-the-new-jsx-transform.html">新的 JSX 转换</a>，从而无需在引入 React</p>
<h4 id="Virtual-DOM"><a href="#Virtual-DOM" class="headerlink" title="Virtual DOM"></a>Virtual DOM</h4><p>通过 React.createElement 处理的节点，会被转换成 Virtual DOM 也可以称为虚拟 DOM</p>
<p>Virtual DOM 是一种编程概念,它与真是的 DOM 一一对应，而且他是保存在内存中的，当 DOM 的属性发生改变的时候，React 会在内存中把改变映射成 Virtual DOM,在把最终状态渲染在页面中，从而保证最小的 DOM 操作</p>
<p>实际上 React 中的 Fiber,也是属于 Virtual DOM 概念的一部分，在 React.createElement 创建的对象上添加了，更多的属性，例如优先级，副作用，更新队列等。</p>
<blockquote>
<p>React.createElement &#x2F;react&#x2F;packages&#x2F;react&#x2F;src&#x2F;React.js 在源码中非常简单 </p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params">type, config, children</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> propName;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于提取保留字段</span></span><br><span class="line">  <span class="keyword">const</span> props = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> key = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> ref = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> self = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> source = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasValidRef</span>(config)) &#123;</span><br><span class="line">      ref = config.<span class="property">ref</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasValidKey</span>(config)) &#123;</span><br><span class="line">      <span class="comment">// 转换为字符串</span></span><br><span class="line">      key = <span class="string">&quot;&quot;</span> + config.<span class="property">key</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self = config.<span class="property">__self</span> === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.<span class="property">__self</span>;</span><br><span class="line">    source = config.<span class="property">__source</span> === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.<span class="property">__source</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 拷贝外部传入的props属性(这里的形参是config)到props对象上</span></span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> config) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        hasOwnProperty.<span class="title function_">call</span>(config, propName) &amp;&amp;</span><br><span class="line">        !<span class="variable constant_">RESERVED_PROPS</span>.<span class="title function_">hasOwnProperty</span>(propName)</span><br><span class="line">      ) &#123;</span><br><span class="line">        props[propName] = config[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 子元素的个数</span></span><br><span class="line">  <span class="keyword">const</span> childrenLength = <span class="variable language_">arguments</span>.<span class="property">length</span> - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果只有一个子元素直接赋值</span></span><br><span class="line">  <span class="keyword">if</span> (childrenLength === <span class="number">1</span>) &#123;</span><br><span class="line">    props.<span class="property">children</span> = children;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childrenLength &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> childArray = <span class="title class_">Array</span>(childrenLength);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; childrenLength; i++) &#123;</span><br><span class="line">      childArray[i] = <span class="variable language_">arguments</span>[i + <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果大于一个则插入到一个数组中</span></span><br><span class="line">    props.<span class="property">children</span> = childArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果定义了默认属性，则用默认属性覆盖掉，</span></span><br><span class="line">  <span class="keyword">if</span> (type &amp;&amp; type.<span class="property">defaultProps</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> defaultProps = type.<span class="property">defaultProps</span>;</span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> defaultProps) &#123;</span><br><span class="line">      <span class="keyword">if</span> (props[propName] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        props[propName] = defaultProps[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">ReactElement</span>(</span><br><span class="line">    type,                     <span class="comment">// 组件类型 可能是元素标签，也可能是类组件或函数组件的引用</span></span><br><span class="line">    key,                      <span class="comment">// 字符串key</span></span><br><span class="line">    ref,                      <span class="comment">// ref对象 </span></span><br><span class="line">    self,                     <span class="comment">// 内部属性初始化null</span></span><br><span class="line">    source,                   <span class="comment">// 内部属性初始化null</span></span><br><span class="line">    <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span>,<span class="comment">// 用于跟踪拥有当前正在被构建组件的组件</span></span><br><span class="line">    props                     <span class="comment">// 属性集合</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line">                         </span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ReactElement</span> = <span class="keyword">function</span>(<span class="params">type, key, ref, self, source, owner, props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="attr">$$typeof</span>: <span class="variable constant_">REACT_ELEMENT_TYPE</span>,</span><br><span class="line">    <span class="attr">type</span>: type,</span><br><span class="line">    <span class="attr">key</span>: key,</span><br><span class="line">    <span class="attr">ref</span>: ref,</span><br><span class="line">    <span class="attr">props</span>: props,</span><br><span class="line">    <span class="attr">_owner</span>: owner,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当type是一个react组件的时候，他会被赋值到type属性上，最终被实例化。现在看一下，这个组件被定义时的样子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>React.Component  &#x2F;react&#x2F;packages&#x2F;react&#x2F;src&#x2F;ReactBaseClasses.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 基本类，用于帮助更新组件的状态</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Component</span>(<span class="params">props, context, updater</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">props</span> = props;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">context</span> = context;</span><br><span class="line">  <span class="comment">// 如果refs是一个已经过时的string类型，晚一点的时候会重新分配一个不同的对象</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">refs</span> = emptyObject;</span><br><span class="line">  <span class="comment">// 初始化一个默认updater对象，但真实的对象会在渲染的时候被插入</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updater</span> = updater || <span class="title class_">ReactNoopUpdateQueue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">isReactComponent</span> = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置一个状态的子集，必须使用这个方法，你应该确保&#x27;this.state&#x27;是不可变的，也就是不能修改，每次修改必须返回一个新的传入一个新的state</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * setState没有确保立即更新，所以在调用这个方法后使用数据可能是旧的。也没有确保setState会立即执行，实际上最终可能会一起执行</span></span><br><span class="line"><span class="comment"> * 你可以提供一个回调函数，他将在setState真正完成后执行。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 当setState传入一个函数，他将在未来的某一时间执行，并不是同步，它将使用最新的组件参数（state, props, context）被调用</span></span><br><span class="line"><span class="comment"> * 这些参数与this对象上的可以是不同的，因为他可能在receiveProps之后但在shouldComponentUpdate之前，这些新的state, props, and context还没来得及合并到this对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setState</span> = <span class="keyword">function</span>(<span class="params">partialState, callback</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> partialState !== <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> partialState !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">    partialState != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">      <span class="string">&#x27;setState(...): takes an object of state variables to update or a &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;function which returns an object of state variables.&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新会被添加到队列，在未来的某一时间更新</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updater</span>.<span class="title function_">enqueueSetState</span>(<span class="variable language_">this</span>, partialState, callback, <span class="string">&#x27;setState&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 强制更新，它应该只当明确知道我们不在一个DOM事务中才被使用，你可能会想，当你知道一些深层组件的状态已经改变但是setState没有调用的时候去调用它。</span></span><br><span class="line"><span class="comment"> * 它将不会触发shouldComponentUpdate，但会触发 `componentWillUpdate` 和 `componentDidUpdate`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forceUpdate</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updater</span>.<span class="title function_">enqueueForceUpdate</span>(<span class="variable language_">this</span>, callback, <span class="string">&#x27;forceUpdate&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><p>现在已经知道了render执行时的大部分必要信息，那render背后的逻辑又是怎样的，这显然是一个复杂的调用过程，但是我们可以通过浏览器的性能分析去查看render函数的调用那个过程</p>
<p>现在你只需要大概了解调用了哪些方法，这些方法会组成后面的调用流程图，后面会详细的描述</p>
<p><img src="/posts/d751aac6b0f4/0001.png"></p>
<h5 id="初始化事件相关对象"><a href="#初始化事件相关对象" class="headerlink" title="初始化事件相关对象"></a>初始化事件相关对象</h5><p><img src="/posts/d751aac6b0f4/0002.png"></p>
<ul>
<li>registerSimpleEvents 创建对象相关对象</li>
</ul>
<table>
<thead>
<tr>
<th>变量名称</th>
<th>变量对象</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>allNativeEvents</td>
<td>Set 集合</td>
<td><div style='width:600px'>保存所有原生事件的名称 例如 <code>0:&quot;cancel&quot;</code></div></td>
</tr>
<tr>
<td>eventPriorities</td>
<td>Map 集</td>
<td><div style='width:600px'>保存事件名称和事件优先级对应关系 例如 <code>click=&gt;0</code> </div></td>
</tr>
<tr>
<td>topLevelEventsToReactNames</td>
<td>Map 集</td>
<td><div style='width:600px'>保存原始事件名称和 React 事件的对应关系 例如 <code>&quot;cancel&quot; =&gt; &quot;onCancel&quot;</code> </div></td>
</tr>
<tr>
<td>registrationNameDependencies</td>
<td>Object</td>
<td><div style='width:600px'>保存 React 事件和原生事件的对应关系 例如 <code>onClick:(1) [&#39;click&#39;]</code> 每个 React 事件对应一个数组用于保存合成事件对应关系</div></td>
</tr>
<tr>
<td>possibleRegistrationNames</td>
<td>Object</td>
<td><div style='width:600px'>保存小写的 React 事件名称和正确的驼峰命名事件的对应关系，用于校验用户输入 例如 <code>onclick:onClick</code></div></td>
</tr>
</tbody></table>
<h5 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h5><p><img src="/posts/d751aac6b0f4/0003.png"></p>
<p><strong>render</strong> : ReactDom.render()<br><strong>createRootImpl</strong> : 创建 FiberRootNode 根节点<br><strong>listenToAllSupportedEvents</strong> : 绑定所有原生事件在 root 节点上</p>
<h5 id="render-阶段"><a href="#render-阶段" class="headerlink" title="render 阶段"></a>render 阶段</h5><p><img src="/posts/d751aac6b0f4/0004.png"></p>
<p><strong>unbatchedUpdates</strong> : 非批量更新，让用户尽早看见页面内容，如果是 batchedUpdates 会以异步执行<br><strong>scheduleUpdateOnFiber</strong> : 调度 Fiber 节点更新优先级<br><strong>performUnitOfWork</strong> : 以 Fiber 节点为单位，深度优先递归遍历每一个节点<br><strong>reconcileChildren</strong> ： 创建对比 Fiber 节点，标记有副作用的节点 （添加，删除，移动，更新）<br><strong>completeUnitOfWork</strong> ： 从下至上遍历节点，创建相应的 DOM 节点，并创建 Effects 链表，交给 commit 阶段使用</p>
<h5 id="commit-阶段"><a href="#commit-阶段" class="headerlink" title="commit 阶段"></a>commit 阶段</h5><p><img src="/posts/d751aac6b0f4/0005.png"></p>
<p><strong>commitBeforeMutationEffects</strong>: 操作真实节点前执行，会执行<code>getSnapshotBeforeUpdate</code><br><strong>commitMutationEffects</strong>: 执行节点操作<br><strong>commitLayoutEffects：</strong> 执行副作用函数，包括 <code>componentDidUpdate</code> 或 <code>effect</code>回调函数</p>
<p>如此复杂的调用栈，是为了解决哪些问题。下一章，让我们感受一下react的设计理念</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/8/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/10/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2025
        <i class="ri-heart-fill heart_icon"></i> SunZhiqi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.png" alt="四月八日"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>此时无声胜有声！</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="/js/jquery.modal.min.js"></script>
<link rel="stylesheet" href="/css/jquery.modal.min.css" />
<script src="/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
  <div class="pswp__bg"></div>

  <!-- Slides wrapper with overflow:hidden. -->
  <div class="pswp__scroll-wrap">
    <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>

    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <!--  Controls are self-explanatory. Order can be changed. -->

        <div class="pswp__counter"></div>

        <button
          class="pswp__button pswp__button--close"
          title="Close (Esc)"
        ></button>

        <button
          class="pswp__button pswp__button--share"
          style="display: none"
          title="Share"
        ></button>

        <button
          class="pswp__button pswp__button--fs"
          title="Toggle fullscreen"
        ></button>

        <button
          class="pswp__button pswp__button--zoom"
          title="Zoom in/out"
        ></button>

        <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
        <!-- element will get class pswp__preloader--active when preloader is running -->
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip"></div>
      </div>

      <button
        class="pswp__button pswp__button--arrow--left"
        title="Previous (arrow left)"
      ></button>

      <button
        class="pswp__button pswp__button--arrow--right"
        title="Next (arrow right)"
      ></button>

      <div class="pswp__caption">
        <div class="pswp__caption__center"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/photoswipe.min.css" />
<link rel="stylesheet" href="/css/default-skin.min.css" />
<script src="/js/photoswipe.min.js"></script>
<script src="/js/photoswipe-ui-default.min.js"></script>

<script>
  function viewer_init() {
    let pswpElement = document.querySelectorAll(".pswp")[0];
    let $imgArr = document.querySelectorAll(
      ".article-entry img:not(.reward-img)"
    );

    $imgArr.forEach(($em, i) => {
      $em.onclick = () => {
        // slider展开状态
        // todo: 这样不好，后面改成状态
        if (document.querySelector(".left-col.show")) return;
        let items = [];
        $imgArr.forEach(($em2, i2) => {
          let img = $em2.getAttribute("data-idx", i2);
          let src =
            $em2.getAttribute("data-target") || $em2.getAttribute("src");
          let title = $em2.getAttribute("alt");
          // 获得原图尺寸
          const image = new Image();
          image.src = src;
          items.push({
            src: src,
            w: image.width || $em2.width,
            h: image.height || $em2.height,
            title: title,
          });
        });
        var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
          index: parseInt(i),
        });
        gallery.init();
      };
    });
  }
  viewer_init();
</script>
 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="/js/MathJax.js"></script>
<script src="/js/TeX-AMS-MML_HTMLorMML-full.js"></script>

<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="/js/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !(function (e, t, a) {
    var initCopyCode = function () {
      var copyHtml = "";
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += "</button>";
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS(".btn-copy", {
        target: function (trigger) {
          return trigger.nextElementSibling;
        },
      });
      clipboard.on("success", function (e) {
        let $btn = $(e.trigger);
        $btn.addClass("copied");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-checkbox-circle-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPIED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-checkbox-circle-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
      clipboard.on("error", function (e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass("copy-failed");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-time-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPY FAILED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-time-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
    };
    initCopyCode();
  })(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "default" });
  }
</script>


    
    

  </div>
</body>

</html>