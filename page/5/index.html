<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="前端 web react" />
       
      <meta name="description" content="前端技术与生活。" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 四月八日</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">
 
<link rel="stylesheet" href="/css/fonts/remixicon.css">
 
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="/js/pace.min.js"></script>
       
 

      <link rel="stylesheet" href="/css/bulma.min.css" />
      <script src="/js/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <script src="https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js"></script>
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/katex.min.css">

<link rel="stylesheet" href="/css/style.css">
<!-- hexo injector head_end end --></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">四月八日</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['愿你足够强大，也要足够温柔', '最轻的并不是一根羽毛，而是一双飞鸟的翅膀', ''],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="posts-source/react/⑧commit阶段"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/6f8702340d77/"
    >React源码分析 ⑧ commit阶段</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/6f8702340d77/" class="article-date">
  <time datetime="2022-04-21T09:26:56.000Z" itemprop="datePublished">2022-04-21</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p><img src="/posts/6f8702340d77/0001.png"></p>
<h4 id="预备工作"><a href="#预备工作" class="headerlink" title="预备工作"></a>预备工作</h4><p>flushPassiveEffects 执行所有还没执行的副作用,因为执行的时候还可能产生额外的副作用,所以需要 while 判断. rootWithPendingPassiveEffect 表示是否有副作用标记</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">&#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一步执行所有的副作用销毁函数</span></span><br><span class="line"><span class="comment">// 一定要保证在执行副作用函数前,所有的销毁函数已经执行完成,但也有例外的情况</span></span><br><span class="line"><span class="comment">// 例如在兄弟组件中,一个组件的副作用销毁函数,是在兄弟组件的副作用创建函数中定义的</span></span><br><span class="line"><span class="comment">// 并且被添加在Ref 属性上通过引用的方式使用.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> unmountEffects = pendingPassiveHookEffectsUnmount;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; unmountEffects.<span class="property">length</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> destroy = _effect.<span class="property">destroy</span>;</span><br><span class="line">  <span class="title function_">destroy</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行所有的副作用创建函数</span></span><br><span class="line"><span class="keyword">var</span> mountEffects = pendingPassiveHookEffectsMount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>; _i &lt; mountEffects.<span class="property">length</span>; _i += <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> _effect2 = mountEffects[_i];</span><br><span class="line">  <span class="keyword">var</span> create = effect.<span class="property">create</span>;</span><br><span class="line">  effect.<span class="property">destroy</span> = <span class="title function_">create</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在副作用链表上 删除, 用于内存回收</span></span><br><span class="line"><span class="keyword">while</span> (effect !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> nextNextEffect = effect.<span class="property">nextEffect</span>;</span><br><span class="line">  effect.<span class="property">nextEffect</span> = <span class="literal">null</span>;</span><br><span class="line">  effect = nextNextEffect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果与额外的副作产生则重新发起调度</span></span><br><span class="line"><span class="title function_">flushSyncCallbackQueue</span>();</span><br></pre></td></tr></table></figure>

<p>将 rootFiber 添加到 effect 链表中, completeWork 中构建的 effect 链表只包涵它的子元素, 如果 rootFiber 有副作用需要把他添加到链表的最后. 最终的 effect 链表属于 rootFiber 的父元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (finishedWork.<span class="property">flags</span> &gt; <span class="title class_">PerformedWork</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (finishedWork.<span class="property">lastEffect</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">    finishedWork.<span class="property">lastEffect</span>.<span class="property">nextEffect</span> = finishedWork;</span><br><span class="line">    firstEffect = finishedWork.<span class="property">firstEffect</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    firstEffect = finishedWork;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  firstEffect = finishedWork.<span class="property">firstEffect</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="commitBeforeMutationEffects"><a href="#commitBeforeMutationEffects" class="headerlink" title="commitBeforeMutationEffects"></a>commitBeforeMutationEffects</h4><p>尽可能早的去调度 mutation effect</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> current = nextEffect.<span class="property">alternate</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> flags = nextEffect.<span class="property">flags</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getSnapshotBeforeUpdate 将会执行</span></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; <span class="title class_">Snapshot</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">    <span class="title function_">commitBeforeMutationLifeCycles</span>(current, nextEffect);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; <span class="title class_">Passive</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">      rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">      <span class="title function_">scheduleCallback</span>(<span class="title class_">NormalPriority</span>$<span class="number">1</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  nextEffect = nextEffect.<span class="property">nextEffect</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a>commitMutationEffects</h4><p><a target="_blank" rel="noopener" href="https://reactjs.org/docs/refs-and-the-dom.html#caveats-with-callback-refs">为什么需要解绑 Ref ?</a></p>
<p>如果 Ref 被定义为一个函数,在更新阶段会执行两次,第一次为 <code>null</code>,第二次会绑定 DOM 元素,这是因为每次渲染都会创建新的函数实例,所以 React 会先删除旧的 Ref 回收内存,再创建一个新的.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> current = nextEffect.<span class="property">alternate</span>;</span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> currentRef = current.<span class="property">ref</span>;</span><br><span class="line">    <span class="keyword">if</span> (currentRef !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> currentRef === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">currentRef</span>(<span class="literal">null</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        currentRef.<span class="property">current</span> = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不同的 Tag 对应不同的 DOM 操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> primaryFlags = flags &amp; (<span class="title class_">Placement</span> | <span class="title class_">Update</span> | <span class="title class_">Deletion</span> | <span class="title class_">Hydrating</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Placement</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="title function_">commitPlacement</span>(nextEffect);</span><br><span class="line">          nextEffect.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">PlacementAndUpdate</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="title function_">commitPlacement</span>(nextEffect);</span><br><span class="line">          nextEffect.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">          <span class="keyword">var</span> _current = nextEffect.<span class="property">alternate</span>;</span><br><span class="line">          <span class="title function_">commitWork</span>(_current, nextEffect);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Hydrating</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          nextEffect.<span class="property">flags</span> &amp;= ~<span class="title class_">Hydrating</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HydratingAndUpdate</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          nextEffect.<span class="property">flags</span> &amp;= ~<span class="title class_">Hydrating</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">var</span> _current2 = nextEffect.<span class="property">alternate</span>;</span><br><span class="line">          <span class="title function_">commitWork</span>(_current2, nextEffect);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Update</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">var</span> _current3 = nextEffect.<span class="property">alternate</span>;</span><br><span class="line">          <span class="title function_">commitWork</span>(_current3, nextEffect);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Deletion</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="title function_">commitDeletion</span>(root, nextEffect);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">resetCurrentFiber</span>();</span><br><span class="line">    nextEffect = nextEffect.<span class="property">nextEffect</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitPlacement-插入"><a href="#commitPlacement-插入" class="headerlink" title="commitPlacement 插入"></a>commitPlacement 插入</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitPlacement</span>(<span class="params">finishedWork</span>) &#123;</span><br><span class="line">  <span class="comment">// 找到当前插入节点的上级节点</span></span><br><span class="line">  <span class="keyword">var</span> parentFiber = <span class="title function_">getHostParentFiber</span>(finishedWork); <span class="comment">// Note: these two variables *must* always be updated together.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> parent;</span><br><span class="line">  <span class="keyword">var</span> isContainer;</span><br><span class="line">  <span class="keyword">var</span> parentStateNode = parentFiber.<span class="property">stateNode</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是不是跟节点</span></span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">      parent = parentStateNode;</span><br><span class="line">      isContainer = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>:</span><br><span class="line">      parent = parentStateNode.<span class="property">containerInfo</span>;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostPortal</span>:</span><br><span class="line">      parent = parentStateNode.<span class="property">containerInfo</span>;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果上级节点标记了清除内容的副作用,则先清空文本</span></span><br><span class="line">  <span class="keyword">if</span> (parentFiber.<span class="property">flags</span> &amp; <span class="title class_">ContentReset</span>) &#123;</span><br><span class="line">    <span class="title function_">resetTextContent</span>(parent);</span><br><span class="line"></span><br><span class="line">    parentFiber.<span class="property">flags</span> &amp;= ~<span class="title class_">ContentReset</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 插入有两种情况,直接插入一个元素中,或插入兄弟节点前面,这里需要获取兄弟节点</span></span><br><span class="line">  <span class="keyword">var</span> before = <span class="title function_">getHostSibling</span>(finishedWork);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">    如果兄弟节点存在;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果兄弟节点存在</span></span><br><span class="line"><span class="comment">    if (container.nodeType === COMMENT_NODE) &#123;</span></span><br><span class="line"><span class="comment">      container.parentNode.insertBefore(child, beforeChild);</span></span><br><span class="line"><span class="comment">    &#125; else &#123;</span></span><br><span class="line"><span class="comment">      container.insertBefore(child, beforeChild);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    如果兄弟节点不存在</span></span><br><span class="line"><span class="comment">    if (container.nodeType === COMMENT_NODE) &#123;</span></span><br><span class="line"><span class="comment">      parentNode = container.parentNode;</span></span><br><span class="line"><span class="comment">      parentNode.insertBefore(child, container);</span></span><br><span class="line"><span class="comment">    &#125; else &#123;</span></span><br><span class="line"><span class="comment">      parentNode = container;</span></span><br><span class="line"><span class="comment">      parentNode.appendChild(child);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(finishedWork, before, parent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">insertOrAppendPlacementNode</span>(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitWork-更新"><a href="#commitWork-更新" class="headerlink" title="commitWork 更新"></a>commitWork 更新</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params">current, finishedWork</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Block</span>: &#123;</span><br><span class="line">      <span class="comment">// 有可能兄弟组件间的副作用会相互影响,例如在同一次 commit 阶段中</span></span><br><span class="line">      <span class="comment">// 一个组件的副作用销毁函数,不应该依赖与另一个组件的副作用创建函数,通过ref传递,因为执行时机问题造成不会执行</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="title function_">commitHookEffectListUnmount</span>(<span class="title class_">Layout</span> | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">var</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">        <span class="keyword">var</span> newProps = finishedWork.<span class="property">memoizedProps</span>; <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">        <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">        <span class="comment">// this case.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> oldProps = current !== <span class="literal">null</span> ? current.<span class="property">memoizedProps</span> : newProps;</span><br><span class="line">        <span class="keyword">var</span> type = finishedWork.<span class="property">type</span>; <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> updatePayload = finishedWork.<span class="property">updateQueue</span>;</span><br><span class="line">        finishedWork.<span class="property">updateQueue</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">          最终会调用原生节点上的设置属性</span></span><br><span class="line"><span class="comment">        if (value === null) &#123;</span></span><br><span class="line"><span class="comment">          node.removeAttribute(_attributeName);</span></span><br><span class="line"><span class="comment">        &#125; else &#123;</span></span><br><span class="line"><span class="comment">          node.setAttribute(_attributeName,  &#x27;&#x27; + value);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="title function_">commitUpdate</span>(instance, updatePayload, type, oldProps, newProps);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostText</span>: &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(finishedWork.<span class="property">stateNode</span> !== <span class="literal">null</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> textInstance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">var</span> newText = finishedWork.<span class="property">memoizedProps</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> oldText = current !== <span class="literal">null</span> ? current.<span class="property">memoizedProps</span> : newText;</span><br><span class="line">      <span class="title function_">commitTextUpdate</span>(textInstance, oldText, newText);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitDeletion-删除"><a href="#commitDeletion-删除" class="headerlink" title="commitDeletion 删除"></a>commitDeletion 删除</h5><p>虽然只有当前的 Fiber 节点删除,但仍然需要遍历所有的子节点,因为可能子节点会执行 <code>componentWillUnmount</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">tag</span> === <span class="title class_">HostComponent</span> || node.<span class="property">tag</span> === <span class="title class_">HostText</span>) &#123;</span><br><span class="line">    <span class="comment">// 执行 commitUnmount</span></span><br><span class="line">    <span class="comment">// 遍历所有子节点,删除 Ref,或执行 componentWillUnmount</span></span><br><span class="line">    <span class="comment">// HostPortal 需要删除挂载元素</span></span><br><span class="line">    <span class="comment">// 执行 useEffect销毁函数</span></span><br><span class="line">    <span class="title function_">commitNestedUnmounts</span>(finishedRoot, node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有子节点卸载后才能安全的从 DOM 树中删除当前节点</span></span><br><span class="line">    <span class="keyword">if</span> (currentParentIsContainer) &#123;</span><br><span class="line">      <span class="title function_">removeChildFromContainer</span>(currentParent, node.<span class="property">stateNode</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">removeChild</span>(currentParent, node.<span class="property">stateNode</span>);</span><br><span class="line">    &#125; <span class="comment">// Don&#x27;t visit children because we already visited them.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">tag</span> === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">child</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// When we go into a portal, it becomes the parent to remove from.</span></span><br><span class="line">      <span class="comment">// We will reassign it back when we pop the portal on the way up.</span></span><br><span class="line">      currentParent = node.<span class="property">stateNode</span>.<span class="property">containerInfo</span>;</span><br><span class="line">      currentParentIsContainer = <span class="literal">true</span>; <span class="comment">// Visit children because portals might contain host components.</span></span><br><span class="line"></span><br><span class="line">      node.<span class="property">child</span>.<span class="property">return</span> = node;</span><br><span class="line">      node = node.<span class="property">child</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Visit children because we may find more host components below.</span></span><br><span class="line">    <span class="title function_">commitUnmount</span>(finishedRoot, node);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">child</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">      node.<span class="property">child</span>.<span class="property">return</span> = node;</span><br><span class="line">      node = node.<span class="property">child</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (node === current) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (node.<span class="property">sibling</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">return</span> === <span class="literal">null</span> || node.<span class="property">return</span> === current) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node = node.<span class="property">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">tag</span> === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">      <span class="comment">// When we go out of the portal, we need to restore the parent.</span></span><br><span class="line">      <span class="comment">// Since we don&#x27;t keep a stack of them, we will search for it.</span></span><br><span class="line">      currentParentIsValid = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  node.<span class="property">sibling</span>.<span class="property">return</span> = node.<span class="property">return</span>;</span><br><span class="line">  node = node.<span class="property">sibling</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a>commitLayoutEffects</h4><p>执行前会将 current 指向 finishedWork, 在 <code>componentDidMount/Update.</code> 执行結束后, work-in-progress tree 已经变为最终的状态了,可以安全的指向 current</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root.<span class="property">current</span> = finishedWork;</span><br></pre></td></tr></table></figure>

<p>下一个阶段是 layout 节点,会在已经改变的树上读取 effect 执行,这也是为什么此时能获取到 DOM 的最新状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Block</span>: &#123;</span><br><span class="line">      <span class="comment">// 同步执行 layoutEffect</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="title function_">commitHookEffectListMount</span>(<span class="title class_">Layout</span> | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将 mutation effects 创建函数和销毁函数添加到队列中,并执行调度</span></span><br><span class="line">      <span class="title function_">schedulePassiveEffects</span>(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">var</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">Update</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// current 不存在表示首次挂载</span></span><br><span class="line">            instance.<span class="title function_">componentDidMount</span>();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> prevProps =</span><br><span class="line">              finishedWork.<span class="property">elementType</span> === finishedWork.<span class="property">type</span></span><br><span class="line">                ? current.<span class="property">memoizedProps</span></span><br><span class="line">                : <span class="title function_">resolveDefaultProps</span>(finishedWork.<span class="property">type</span>, current.<span class="property">memoizedProps</span>);</span><br><span class="line">            <span class="keyword">var</span> prevState = current.<span class="property">memoizedState</span>; <span class="comment">// We could update instance props and state here,</span></span><br><span class="line">            <span class="comment">// but instead we rely on them being set during last render.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> revisit this when we implement resuming.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 组件更新</span></span><br><span class="line">            instance.<span class="title function_">componentDidUpdate</span>(</span><br><span class="line">              prevProps,</span><br><span class="line">              prevState,</span><br><span class="line">              instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">commitUpdateQueue</span>(finishedWork, updateQueue, instance);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重新绑定 Ref</span></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> ref = finishedWork.<span class="property">ref</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">var</span> instanceToUse;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">          instanceToUse = <span class="title function_">getPublicInstance</span>(instance);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          instanceToUse = instance;</span><br><span class="line">      &#125; <span class="comment">// Moved outside to ensure DCE works with this flag</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> ref === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">ref</span>(instanceToUse);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ref.<span class="property">current</span> = instanceToUse;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="requestPaint"><a href="#requestPaint" class="headerlink" title="requestPaint"></a>requestPaint</h4><p>在上面三个阶段执行結束后,会执行请求绘制的方法, 通过 Scheduler 模块调度, 这也是 <code>useLayoutEffect</code> 会在 DOM 绘制前执行的原因</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">requestPaint</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">  <span class="comment">// 在所有阶段执行结束后 root 节点上还有副作用, 先保存一个引用,在 layout 结束后再去调度</span></span><br><span class="line">  rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">  rootWithPendingPassiveEffects = root;</span><br><span class="line">  pendingPassiveEffectsLanes = lanes;</span><br><span class="line">  pendingPassiveEffectsRenderPriority = renderPriorityLevel;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// We are done with the effect chain at this point so let&#x27;s clear the</span></span><br><span class="line">  <span class="comment">// nextEffect pointers to assist with GC. If we have passive effects, we&#x27;ll</span></span><br><span class="line">  <span class="comment">// clear this in flushPassiveEffects.</span></span><br><span class="line">  nextEffect = firstEffect;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> nextNextEffect = nextEffect.<span class="property">nextEffect</span>;</span><br><span class="line">    nextEffect.<span class="property">nextEffect</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextEffect.<span class="property">flags</span> &amp; <span class="title class_">Deletion</span>) &#123;</span><br><span class="line">      <span class="title function_">detachFiberAfterEffects</span>(nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = nextNextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="comment">// Read this again, since an effect might have updated it</span></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-ts/extends使用技巧"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/a5ff14c8459e/"
    >TS extends 使用技巧</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/a5ff14c8459e/" class="article-date">
  <time datetime="2022-04-15T02:35:28.000Z" itemprop="datePublished">2022-04-15</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/TypeScript/">TypeScript</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>extends 关键字在 TS 中的两种用法，即接口继承和条件判断。</p>
<h4 id="接口继承"><a href="#接口继承" class="headerlink" title="接口继承"></a>接口继承</h4><p>和 class 中的继承类似,但是类型中可以使用多继承</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> T3 <span class="keyword">extends</span> T1, T2 &#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h4><p><code>extends</code> 可以当作类型中的 if 语句使用,当时理念上与 if 略有不同</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> T = <span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">type</span> A = T <span class="keyword">extends</span> <span class="built_in">string</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>上面的语句可以简单理解为, T 的类型是否是 string 类型. 但是,更准确的说法是 <strong>T 的类型能否分配给 string 类型</strong>.</p>
<p>因为类型系统中不能像 <code>if</code> 一样,通过 <code>==</code> 或 <code>===</code> 来判断, 例如下面的接口或对象类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> A1 &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> A2 &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> A = <span class="variable constant_">A2</span> <span class="keyword">extends</span> <span class="variable constant_">A1</span> ? <span class="built_in">string</span> : <span class="built_in">number</span>; <span class="comment">//string</span></span><br></pre></td></tr></table></figure>

<p>这两个类型并不是完全相同,但是 A2 的类型可以分配给 A1 使用,因为 A2 中 完全包括了 A1 中的类型,也就是说可以把 A2 当做 A1 使用.</p>
<p>反过来 A1 不能当作 A2 使用,应为 A1 中没有 age 类型,可能导致类型错误.</p>
<h4 id="条件分配类型"><a href="#条件分配类型" class="headerlink" title="条件分配类型"></a>条件分配类型</h4><p>看一个例子</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="variable constant_">A2</span> = <span class="string">&quot;x&quot;</span> | <span class="string">&quot;y&quot;</span> <span class="keyword">extends</span> <span class="string">&quot;x&quot;</span> ? <span class="built_in">string</span> : <span class="built_in">number</span>; <span class="comment">// number</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> P&lt;T&gt; = T <span class="keyword">extends</span> <span class="string">&quot;x&quot;</span> ? <span class="built_in">string</span> : <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">type</span> <span class="variable constant_">A3</span> = P&lt;<span class="string">&quot;x&quot;</span> | <span class="string">&quot;y&quot;</span>&gt;; <span class="comment">// string | number</span></span><br></pre></td></tr></table></figure>

<p>A3 并不会和 A2 相同,造成这个的原因就是 <strong>分配条件类型（Distributive Conditional Types）</strong></p>
<blockquote>
<p>When conditional types act on a generic type, they become distributive when given a union type</p>
</blockquote>
<p>当条件类型作用在泛型上时, 当传入一个联合类型这个类型是可分配的.</p>
<p>换句话说,当在使用泛型做条件判断的时候, 而且这个泛型传入的是一个联合类型,就会像数学中的分配率一样,把联合类型中的没没一项分别进行条件判断,最终返回一个联合类型</p>
<p>所以上面 A3 类型,等价于</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="variable constant_">A3</span> =</span><br><span class="line">  | (<span class="string">&quot;x&quot;</span> <span class="keyword">extends</span> <span class="string">&quot;x&quot;</span> ? <span class="built_in">string</span> : <span class="built_in">number</span>)</span><br><span class="line">  | (<span class="string">&quot;y&quot;</span> <span class="keyword">extends</span> <span class="string">&quot;x&quot;</span> ? <span class="built_in">string</span> : <span class="built_in">number</span>);</span><br></pre></td></tr></table></figure>

<p>分配条件类型最终会返回一个不同分支返回结果的联合类型,如果返回的结果是一个包装过的类型,那么就是不同分支包装类型的联合类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Test</span>&lt;T, <span class="variable constant_">T2</span> = T&gt; = T <span class="keyword">extends</span> <span class="variable constant_">T2</span> ? &#123;<span class="attr">t</span>: T&#125; : <span class="built_in">never</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> a = <span class="title class_">Test</span>&lt;<span class="built_in">string</span>|<span class="built_in">number</span>&gt;  <span class="comment">// &#123;t:string&#125; | &#123;t:number&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Test2</span>&lt;T, <span class="variable constant_">T2</span> = T&gt; = T <span class="keyword">extends</span> <span class="variable constant_">T2</span> ? [T] : <span class="built_in">never</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> a = <span class="title class_">Test</span>&lt;<span class="built_in">string</span>|<span class="built_in">number</span>&gt;  <span class="comment">// [string] | [number]</span></span><br></pre></td></tr></table></figure>

<p><strong>注意 never</strong></p>
<p>never 在条件语句中的行为可能和想象的不一样,这也是条件类型在对其约束, never 相当于空的联合类型,所以没有判断直接返回</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="variable constant_">A1</span> = <span class="built_in">never</span> <span class="keyword">extends</span> <span class="string">&quot;x&quot;</span> ? <span class="built_in">string</span> : <span class="built_in">number</span>; <span class="comment">// string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> P&lt;T&gt; = T <span class="keyword">extends</span> <span class="string">&quot;x&quot;</span> ? <span class="built_in">string</span> : <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">type</span> <span class="variable constant_">A2</span> = P&lt;<span class="built_in">never</span>&gt;; <span class="comment">// never</span></span><br></pre></td></tr></table></figure>

<p><strong>防止条件类型分配</strong></p>
<p>如果不想让 never 解析成空的联合类型,而是当作一个 never 类型传入,实际上就是阻止类型系统对联合类型自动分配,可以使用一个 <code>[]</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> P&lt;T&gt; = [T] <span class="keyword">extends</span> [<span class="string">&quot;x&quot;</span>] ? <span class="built_in">string</span> : <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">type</span> <span class="variable constant_">A1</span> = P&lt;<span class="string">&quot;x&quot;</span> | <span class="string">&quot;y&quot;</span>&gt;; <span class="comment">// number</span></span><br><span class="line"><span class="keyword">type</span> <span class="variable constant_">A2</span> = P&lt;<span class="built_in">never</span>&gt;; <span class="comment">// string</span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-react/highchartsWrapper"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/5735b2be6e00/"
    >Highcharts wrapper for React</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/5735b2be6e00/" class="article-date">
  <time datetime="2022-04-14T05:46:40.000Z" itemprop="datePublished">2022-04-14</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>一个非常精简的包装工具,可以在 React 项目中使用 highcharts</p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>服务端渲染的时候 <code>useLayoutEffect</code> 会抛出警告,所以需要按条件使用,如果是浏览器环境使用 <code>useLayoutEffect</code>,如果是服务器环境使用 <code>useEffect</code></p>
<p>使用 <code>useLayoutEffect</code> 可以保证在布局阶段, ref 所指向的挂载元素是可以使用的,也可以用在一个父组件的 <code>componentDidMount</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 区分浏览器环境还是</span></span><br><span class="line"><span class="keyword">const</span> useIsomorphicLayoutEffect =</span><br><span class="line">  <span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&#x27;undefined&#x27;</span> ? useLayoutEffect : useEffect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 forwardRef 转发 ref, 将 ref 传递到子组件</span></span><br><span class="line"><span class="comment">// 如果有需要可以通过传入 ref 属性,获取到挂载节点的真是DOM元素</span></span><br><span class="line"><span class="comment">// 也可以配合 useImperativeHandle 使用</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HighchartsReact</span> = <span class="title function_">forwardRef</span>(</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">HighchartsReact</span>(<span class="params">props, ref</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> containerRef = <span class="title function_">useRef</span>();</span><br><span class="line">    <span class="keyword">const</span> chartRef = <span class="title function_">useRef</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">useIsomorphicLayoutEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">createChart</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> H = props.<span class="property">highcharts</span> || (</span><br><span class="line">          <span class="keyword">typeof</span> <span class="variable language_">window</span> === <span class="string">&#x27;object&#x27;</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">Highcharts</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 暴露参数,用于表明实例化图表类型</span></span><br><span class="line">        <span class="keyword">const</span> constructorType = props.<span class="property">constructorType</span> || <span class="string">&#x27;chart&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!H) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;The &quot;highcharts&quot; property was not passed.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!H[constructorType]) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">&#x27;The &quot;constructorType&quot; property is incorrect or some &#x27;</span> +</span><br><span class="line">              <span class="string">&#x27;required module is not imported.&#x27;</span></span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// options 必填参数,如果没有提示警告</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!props.<span class="property">options</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;The &quot;options&quot; property was not passed.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 创建图表实例</span></span><br><span class="line">          chartRef.<span class="property">current</span> = H[constructorType](</span><br><span class="line">            containerRef.<span class="property">current</span>,</span><br><span class="line">            props.<span class="property">options</span>,</span><br><span class="line">            props.<span class="property">callback</span> ? props.<span class="property">callback</span> : <span class="literal">undefined</span></span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!chartRef.<span class="property">current</span>) &#123;</span><br><span class="line">        <span class="title function_">createChart</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 是否允许图表更新,如果为假,在接受到新的 props 之后会直接忽略掉</span></span><br><span class="line">        <span class="keyword">if</span> (props.<span class="property">allowChartUpdate</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">          <span class="comment">// immutable 用于指定是否使用不可变数据</span></span><br><span class="line">          <span class="comment">// 本质就是不会再原有的图表上更新,而会直接创建新图表的实例</span></span><br><span class="line">          <span class="keyword">if</span> (!props.<span class="property">immutable</span> &amp;&amp; chartRef.<span class="property">current</span>) &#123;</span><br><span class="line">            chartRef.<span class="property">current</span>.<span class="title function_">update</span>(</span><br><span class="line">              props.<span class="property">options</span>,</span><br><span class="line">              <span class="comment">// 与用指定原生的更新参数,由 highcharts 自己提供</span></span><br><span class="line">              ...(props.<span class="property">updateArgs</span> || [<span class="literal">true</span>, <span class="literal">true</span>])</span><br><span class="line">            );</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">createChart</span>();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">useIsomorphicLayoutEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 组件卸载的时候注销实例</span></span><br><span class="line">        <span class="keyword">if</span> (chartRef.<span class="property">current</span>) &#123;</span><br><span class="line">          chartRef.<span class="property">current</span>.<span class="title function_">destroy</span>();</span><br><span class="line">          chartRef.<span class="property">current</span> = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, []);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 一般配合 forwardRef 使用</span></span><br><span class="line">    <span class="comment">// 可以用于暴露封装组件内部的状态</span></span><br><span class="line">    <span class="comment">// 通过 ref.current.chart 或 ref.current.chart 可以在外部获取到组件实例,以及挂载节点</span></span><br><span class="line">    <span class="title function_">useImperativeHandle</span>(</span><br><span class="line">      ref,</span><br><span class="line">      <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">        <span class="keyword">get</span> <span class="title function_">chart</span>() &#123;</span><br><span class="line">          <span class="keyword">return</span> chartRef.<span class="property">current</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">container</span>: containerRef</span><br><span class="line">      &#125;),</span><br><span class="line">      []</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create container for the chart</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> &#123; <span class="attr">...props.containerProps</span> &#125; <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">containerRef</span> &#125; /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">memo</span>(<span class="title class_">HighchartsReact</span>);</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-ts/React+TS 实战文档"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/1b7f8cf1e61c/"
    >React+TS 实战文档</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/1b7f8cf1e61c/" class="article-date">
  <time datetime="2022-04-11T15:04:03.000Z" itemprop="datePublished">2022-04-11</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/TypeScript/">TypeScript</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="Function-Components"><a href="#Function-Components" class="headerlink" title="Function Components"></a>Function Components</h4><p>React.FunctionComponent 或 React.FC 与普通函数有什么不同?</p>
<p>React.FC 是隐式的返回值类型, 不同函数是显示的返回值类型</p>
<p>React.FC 提供了一些静态属性类型检查 <code>displayName</code>,<code>propTypes</code>, <code>defaultProps</code></p>
<p>React.FC 隐式的定义了 children 子元素类型, 但某些场景自定义这个类型会更好</p>
<p>第二点中,当在 React.FC 中使用 <code>defaultProps</code> 的时候可能会造成错误</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> &#123;</span><br><span class="line">  <span class="attr">text</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BackButton</span>:<span class="title class_">React</span>.<span class="property">FC</span>&lt;<span class="title class_">Props</span>&gt; = <span class="function">(<span class="params">props</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>/&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">BackButton</span>.<span class="property">defaultProps</span> = &#123;</span><br><span class="line">  <span class="attr">text</span>: <span class="string">&#x27;Go Back&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> a = <span class="language-xml"><span class="tag">&lt;<span class="name">BackButton</span> /&gt;</span></span> <span class="comment">// error: text is missing in type &#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p>这个问题有很多种方法可以解决, 可以使用普通函数来定义,而不是使用函数类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> &#123;</span><br><span class="line">  <span class="attr">text</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">BackButton</span>(<span class="params">props: Props</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>/&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">BackButton</span>.<span class="property">defaultProps</span> = &#123;</span><br><span class="line">  <span class="attr">text</span>: <span class="string">&#x27;Go Back&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> a = <span class="language-xml"><span class="tag">&lt;<span class="name">BackButton</span> /&gt;</span></span> <span class="comment">// it&#x27;s OK</span></span><br></pre></td></tr></table></figure>

<p>或者显示的声明 defaultProps</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> &#123;</span><br><span class="line">  <span class="attr">text</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BackButton</span>: <span class="title class_">React</span>.<span class="property">FC</span>&lt;<span class="title class_">Props</span>&gt; &amp; &#123;</span><br><span class="line">  <span class="attr">defaultProps</span>: &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="built_in">string</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> /&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">BackButton</span>.<span class="property">defaultProps</span> = &#123;</span><br><span class="line">  <span class="attr">text</span>: <span class="string">&#x27;Go Back&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> a = <span class="language-xml"><span class="tag">&lt;<span class="name">BackButton</span> /&gt;</span></span>; <span class="comment">// it&#x27;s OK</span></span><br></pre></td></tr></table></figure>

<p>另一个问题是 children 类型的问题, 有时组件返回的 children 类型并不是 React.FC 默认的 children 类型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Type &#x27;string&#x27; is not assignable to type &#x27;ReactElement&lt;any, any&gt;&#x27;.</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Title</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">() =&gt;</span> <span class="string">&#x27;123&#x27;</span></span><br></pre></td></tr></table></figure>

<p>你可以选择者重新为返回值赋类型,这个处理方法同样适用于条件语句中的子元素,或者通过数组或对象生成的子元素</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Title</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">() =&gt;</span> <span class="string">&#x27;123&#x27;</span> <span class="keyword">as</span> unknown <span class="keyword">as</span> <span class="title class_">React</span>.<span class="property">ReactElement</span></span><br></pre></td></tr></table></figure>

<p>正因为有这种问题, @type&#x2F;react@^18.0.0 将不再把 children 作为默认的属性,而是需要显示声明</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-linux/operation/IP地址、子网掩码、网关"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/964c11e46f74/"
    >IP地址、子网掩码、网关</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/964c11e46f74/" class="article-date">
  <time datetime="2022-04-10T07:48:27.000Z" itemprop="datePublished">2022-04-10</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a> / <a class="article-category-link" href="/categories/Linux/%E8%BF%90%E7%BB%B4/">运维</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="什么是IP地址？"><a href="#什么是IP地址？" class="headerlink" title="什么是IP地址？"></a>什么是IP地址？</h4><p>假如有一群人在一个密闭房间里面，用什么方式能够快速的叫到某一个人呢？没错,一个简单的方式，就是每个人编一个号码，例如，叫到一号，就知道是谁了。</p>
<p>在网络世界中也是一样的，要想快速访问某一台设备，就需要每台设备有一个编号，而这个编号就是网络设备的IP地址。在这个房间里面，如果有两个人的编号相同，那么会怎么样，肯定就是当叫到这个编号的时候，不知道叫的是谁，所以一个房间里面不允许有两个编号相同的人，在一个局域网里面不允许有两个IP地址相同的设备，如果有就被称为IP冲突，会严重危害到网络的稳定。</p>
<p>扩展一下，在一栋大楼里面，有好多个这样的密闭房间，每个密闭的房间也都有一群人，那么要怎么定位到某一个房间里面的一个人呢？</p>
<p>答案肯定也还是编号，给每个房间编号，例如1号房间里面的1号，这样就能定位到特定的那一个人了，这时候我们把房间号也加入到人的编号当中去，房间号和人的编号用一个”.”间隔开来，例如1.1号，说明就这个人就是1号房间里面的1号人。</p>
<p>网络设备中的IP地址也是如此，例如192.168.1.100，我们可以这样理解，192.168.1号房间，也就是我们会提到的网段，100就是在这个网段里面的编号100的设备。</p>
<h4 id="什么是子网掩码？"><a href="#什么是子网掩码？" class="headerlink" title="什么是子网掩码？"></a>什么是子网掩码？</h4><p>根据上面提出的编号：192.168.1.100，会引发一个新的疑问，为什么房间号是：192.168.1，而人的编号是100，可不可以把房间号设置成为192.168，人的编号设置成为1.100呢？</p>
<p>答案当然是可以的，但是这样设置会引发一个问题，同样192.168.1.100这个编号就会有歧义，可以表示192.168.1房间里面的100号人，也可以表示192.168号房间里面的1.100号人，这时候就要引入另外一个规则，告诉人们多少就是房间编号，多少就是人的编号，而这个规则就是子网掩码。</p>
<p>都知道网络时间就是数字世界，所以这个规则设计得很讨巧，长度设置和编号一样长，通过和编号的于运算，最后告诉人们那些是房间号，那些事是人的编号。</p>
<p>举个例子：子网掩码是255.255.255.0这个最常用的规则意思是255.255.255这前三位是房间号，后面0那一位是人编号，再比如192.168.1.100这个IP地址和255.255.0.0这个子网掩码，说明192.168是房间号，也就是网段，而1.100是人的编号，也就是设备在这个网段的编号。</p>
<p>换句话说:子网掩码的作用就是确定设备出于哪个网段。子网掩码 255.255.0.0 表示前两位是网络部分,后两位是主机部分. 所以子网掩码相同且前两位相同的IP (例如:192.168.0.12 与 192.168.1.13) 在同一网段. </p>
<h4 id="什么是网关？"><a href="#什么是网关？" class="headerlink" title="什么是网关？"></a>什么是网关？</h4><p>接着上面的问题，一群人在一个密闭房间里面，已经每一个人都有了一个编号，就是网络设备中的IP地址，那么这时候需求升级了，房间里面的人需要和房间外面的人们进行沟通对话，这时候怎么办呢，就需要一个会穿墙术的超能力者当传话筒，在这个房间里面穿梭，把房间里面的人的话传到外面去，把外面的人回应传回给房间里面的人。</p>
<p>这个有超能力的人就是网络世界中的网关，他负责把内部网络的讯息传递到外网， 把外网信息传递回来，对于一个家庭网络而言，这个角色不正是我们的路由器吗？</p>
<p>路由器是唯一一个和宽带连接的设备，家里所有的设备都要经过路由器才能连接到宽带，进行上网冲浪。所以网关也就是我们家庭宽带网络中的路由器，如果网关设置错误，就好像你把要传递出去的话语传给了一个没有超能力的人，自然也就无法把话语传达到房间外面。</p>
<p>所以这里所说的穿墙只的就是两个设备不在同一网段,如果在同一网段就可以利用交换机通信,如果不是就需要路由器,也就会用到网关的概念.</p>
<p>网关就是跨网段通讯的“关口”。当数据包从本网段设备传输到路由器时，首先要保证网关一致。网关可以使用本网段中任何一个地址，但是有一个不成文的规定，一般网关使用本网段中第一个可用的地址，这是为了避免与局域网中其他设备IP产生冲突。所以上面例子中的局域网1中，所有设备的网关都应该是10.0.0.1。局域网2中所有设备的网关都应该是12.0.0.1。有了网关，局域网内的设备才可以通过路由器与其他网段的设备进行通讯。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/VMWareSSH"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/ed0cae31bd0d/"
    >VMWare 使用SSH链接</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/ed0cae31bd0d/" class="article-date">
  <time datetime="2022-04-10T05:59:18.000Z" itemprop="datePublished">2022-04-10</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="SSH客户端与服务端"><a href="#SSH客户端与服务端" class="headerlink" title="SSH客户端与服务端"></a>SSH客户端与服务端</h4><p>openssh-client 客户端,如果想通过 ssh 链接其他服务器需要安装客户端</p>
<p>ssh-server 服务端,如果想让其他机器通过 ssh 链接本机,需要在本机开机 ssh 服务,即安装服务端</p>
<p>Ubuntu server版 默认没有安装 ssh-client<br>Ubuntu 桌面版    默认没有安装 ssh-server</p>
<p>Ubuntu 安装 ssh 客户端或服务端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update //更新软件源</span><br><span class="line">$ sudo apt-get install openssh-client //安装openssh-client</span><br><span class="line">$ sudo apt-get install openssh-server //安装openssh-server</span><br><span class="line">$ sudo service ssh start //启动ssh服务</span><br></pre></td></tr></table></figure>

<p>centOS 安装 ssh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索 ssh 包名</span></span><br><span class="line">yum search openssh</span><br><span class="line"></span><br><span class="line">yum install openssh-clients.x86_64</span><br><span class="line">yum install openssh-server.x86_64</span><br></pre></td></tr></table></figure>

<p>检查虚拟机是否安装了 ssh-server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -e | grep ssh</span><br><span class="line"><span class="comment"># 1512 00:00:00 sshd</span></span><br></pre></td></tr></table></figure>

<h4 id="VMWare-配置"><a href="#VMWare-配置" class="headerlink" title="VMWare 配置"></a>VMWare 配置</h4><h5 id="查询-IP"><a href="#查询-IP" class="headerlink" title="查询 IP"></a>查询 IP</h5><p>查询宿主机和虚拟机的 ip 备用</p>
<p><img src="/posts/ed0cae31bd0d/0002.png"> </p>
<p>宿主机IP</p>
<p><img src="/posts/ed0cae31bd0d/0003.png"> </p>
<p>虚拟机IP</p>
<h5 id="建立映射"><a href="#建立映射" class="headerlink" title="建立映射"></a>建立映射</h5><p>接下来就需要将宿主机和虚拟机的IP映射起来。</p>
<p>打开VMware的虚拟网络编辑器（编辑&gt;虚拟网络编辑器）：</p>
<p><img src="/posts/ed0cae31bd0d/0004.png"></p>
<p><a href="/posts/964c11e46f74/">检查子网Ip(Subnet IP) 和 子网掩码(Subnet mask)</a>, 正常情况下无需修改</p>
<p>如果保存时报错 <strong>子网ip和子网掩码不匹配</strong>,请检查子网IP, 格式为 xxx.xxx.xxx.0 他与子网掩码 255.255.255.0 对应</p>
<p>不可以写为 <code>xxx.xxx.xxx.120</code> 等其他数字,这表示具体子网中的一个网络设备,并不是子网IP</p>
<p>配置完成后可以使用 ssh 工具链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.255.128</span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VMWare/" rel="tag">VMWare</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-db/练习题"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/7169c91ebbc1/"
    >MySQL 练习题</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/7169c91ebbc1/" class="article-date">
  <time datetime="2022-04-07T17:37:10.000Z" itemprop="datePublished">2022-04-08</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="创建表结构"><a href="#创建表结构" class="headerlink" title="创建表结构"></a>创建表结构</h4><ul>
<li>学生表 Student</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Student(Sid <span class="type">varchar</span>(<span class="number">6</span>), Sname <span class="type">varchar</span>(<span class="number">10</span>), Sage datetime, Ssex <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Student <span class="keyword">values</span>(<span class="string">&#x27;01&#x27;</span> , <span class="string">&#x27;赵雷&#x27;</span> , <span class="string">&#x27;1990-01-01&#x27;</span> , <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Student <span class="keyword">values</span>(<span class="string">&#x27;02&#x27;</span> , <span class="string">&#x27;钱电&#x27;</span> , <span class="string">&#x27;1990-12-21&#x27;</span> , <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Student <span class="keyword">values</span>(<span class="string">&#x27;03&#x27;</span> , <span class="string">&#x27;孙风&#x27;</span> , <span class="string">&#x27;1990-05-20&#x27;</span> , <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Student <span class="keyword">values</span>(<span class="string">&#x27;04&#x27;</span> , <span class="string">&#x27;李云&#x27;</span> , <span class="string">&#x27;1990-08-06&#x27;</span> , <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Student <span class="keyword">values</span>(<span class="string">&#x27;05&#x27;</span> , <span class="string">&#x27;周梅&#x27;</span> , <span class="string">&#x27;1991-12-01&#x27;</span> , <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Student <span class="keyword">values</span>(<span class="string">&#x27;06&#x27;</span> , <span class="string">&#x27;吴兰&#x27;</span> , <span class="string">&#x27;1992-03-01&#x27;</span> , <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Student <span class="keyword">values</span>(<span class="string">&#x27;07&#x27;</span> , <span class="string">&#x27;郑竹&#x27;</span> , <span class="string">&#x27;1989-07-01&#x27;</span> , <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Student <span class="keyword">values</span>(<span class="string">&#x27;08&#x27;</span> , <span class="string">&#x27;王菊&#x27;</span> , <span class="string">&#x27;1990-01-20&#x27;</span> , <span class="string">&#x27;女&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>成绩表 SC</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> SC(Sid <span class="type">varchar</span>(<span class="number">10</span>), Cid <span class="type">varchar</span>(<span class="number">10</span>), score <span class="type">decimal</span>(<span class="number">18</span>,<span class="number">1</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;01&#x27;</span> , <span class="string">&#x27;01&#x27;</span> , <span class="number">80</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;01&#x27;</span> , <span class="string">&#x27;02&#x27;</span> , <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;01&#x27;</span> , <span class="string">&#x27;03&#x27;</span> , <span class="number">99</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;02&#x27;</span> , <span class="string">&#x27;01&#x27;</span> , <span class="number">70</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;02&#x27;</span> , <span class="string">&#x27;02&#x27;</span> , <span class="number">60</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;02&#x27;</span> , <span class="string">&#x27;03&#x27;</span> , <span class="number">80</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;03&#x27;</span> , <span class="string">&#x27;01&#x27;</span> , <span class="number">80</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;03&#x27;</span> , <span class="string">&#x27;02&#x27;</span> , <span class="number">80</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;03&#x27;</span> , <span class="string">&#x27;03&#x27;</span> , <span class="number">80</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;04&#x27;</span> , <span class="string">&#x27;01&#x27;</span> , <span class="number">50</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;04&#x27;</span> , <span class="string">&#x27;02&#x27;</span> , <span class="number">30</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;04&#x27;</span> , <span class="string">&#x27;03&#x27;</span> , <span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;05&#x27;</span> , <span class="string">&#x27;01&#x27;</span> , <span class="number">76</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;05&#x27;</span> , <span class="string">&#x27;02&#x27;</span> , <span class="number">87</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;06&#x27;</span> , <span class="string">&#x27;01&#x27;</span> , <span class="number">31</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;06&#x27;</span> , <span class="string">&#x27;03&#x27;</span> , <span class="number">34</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;07&#x27;</span> , <span class="string">&#x27;02&#x27;</span> , <span class="number">89</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(<span class="string">&#x27;07&#x27;</span> , <span class="string">&#x27;03&#x27;</span> , <span class="number">98</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>课程表 Course</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Course(Cid <span class="type">varchar</span>(<span class="number">10</span>),Cname <span class="type">varchar</span>(<span class="number">10</span>),Tid <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Course <span class="keyword">values</span>(<span class="string">&#x27;01&#x27;</span> , <span class="string">&#x27;语文&#x27;</span> , <span class="string">&#x27;02&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Course <span class="keyword">values</span>(<span class="string">&#x27;02&#x27;</span> , <span class="string">&#x27;数学&#x27;</span> , <span class="string">&#x27;01&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Course <span class="keyword">values</span>(<span class="string">&#x27;03&#x27;</span> , <span class="string">&#x27;英语&#x27;</span> , <span class="string">&#x27;03&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>教师表 Teacher</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> Teacher(Tid <span class="type">varchar</span>(<span class="number">10</span>),Tname <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Teacher <span class="keyword">values</span>(<span class="string">&#x27;01&#x27;</span> , <span class="string">&#x27;张三&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Teacher <span class="keyword">values</span>(<span class="string">&#x27;02&#x27;</span> , <span class="string">&#x27;李四&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Teacher <span class="keyword">values</span>(<span class="string">&#x27;03&#x27;</span> , <span class="string">&#x27;王五&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="练习题"><a href="#练习题" class="headerlink" title="练习题"></a>练习题</h4><p>① <a href="#%E6%9F%A5%E8%AF%A2%2201%E2%80%9C%E8%AF%BE%E7%A8%8B%E6%AF%94%E2%80%9D02%22%E8%AF%BE%E7%A8%8B%E6%88%90%E7%BB%A9%E9%AB%98%E7%9A%84%E5%AD%A6%E7%94%9F%E7%9A%84%E4%BF%A1%E6%81%AF%E5%8F%8A%E8%AF%BE%E7%A8%8B%E5%88%86%E6%95%B0">查询” 01 “课程比” 02 “课程成绩高的学生的信息及课程分数</a><br>② <a href="#%E6%9F%A5%E8%AF%A2%E5%B9%B3%E5%9D%87%E6%88%90%E7%BB%A9%E5%A4%A7%E4%BA%8E%E7%AD%89%E4%BA%8E-60-%E5%88%86%E7%9A%84%E5%90%8C%E5%AD%A6%E7%9A%84%E5%AD%A6%E7%94%9F%E7%BC%96%E5%8F%B7%E5%92%8C%E5%AD%A6%E7%94%9F%E5%A7%93%E5%90%8D%E5%92%8C%E5%B9%B3%E5%9D%87%E6%88%90%E7%BB%A9">查询平均成绩大于等于 60 分的同学的学生编号和学生姓名和平均成绩</a><br>③ <a href="#%E6%9F%A5%E8%AF%A2%E5%9C%A8-SC-%E8%A1%A8%E5%AD%98%E5%9C%A8%E6%88%90%E7%BB%A9%E7%9A%84%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF">查询在 SC 表存在成绩的学生信息</a><br>④ <a href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E5%90%8C%E5%AD%A6%E7%9A%84%E5%AD%A6%E7%94%9F%E7%BC%96%E5%8F%B7%E3%80%81%E5%AD%A6%E7%94%9F%E5%A7%93%E5%90%8D%E3%80%81%E9%80%89%E8%AF%BE%E6%80%BB%E6%95%B0%E3%80%81%E6%89%80%E6%9C%89%E8%AF%BE%E7%A8%8B%E7%9A%84%E6%80%BB%E6%88%90%E7%BB%A9(%E6%B2%A1%E6%88%90%E7%BB%A9%E7%9A%84%E6%98%BE%E7%A4%BA%E4%B8%BA-null-)">查询所有同学的学生编号、学生姓名、选课总数、所有课程的总成绩(没成绩的显示为 null )</a><br>⑤ <a href="%E6%9F%A5%E8%AF%A2%E5%A7%93%E6%9D%8E%E7%9A%84%E8%80%81%E5%B8%88%E6%95%B0%E9%87%8F">查询姓李的老师数量</a><br>⑥ <a href="%E5%AD%A6%E8%BF%87%22%E5%BC%A0%E4%B8%89%22%E8%80%81%E5%B8%88%E6%8E%88%E8%AF%BE%E7%9A%84%E5%90%8C%E5%AD%A6%E7%9A%84%E4%BF%A1%E6%81%AF">学过”张三”老师授课的同学的信息</a><br>⑦ <a href="%E6%B2%A1%E6%9C%89%E5%AD%A6%E8%BF%87%22%E5%BC%A0%E4%B8%89%22%E8%80%81%E5%B8%88%E6%8E%88%E8%AF%BE%E7%9A%84%E5%90%8C%E5%AD%A6%E7%9A%84%E4%BF%A1%E6%81%AF">没有学过”张三”老师授课的同学的信息</a><br>⑧ <a href="%E6%9F%A5%E8%AF%A2%E5%AD%A6%E8%BF%87%E7%BC%96%E5%8F%B7%E4%B8%BA%2201%22%E5%B9%B6%E4%B8%94%E4%B9%9F%E5%AD%A6%E8%BF%87%E7%BC%96%E5%8F%B7%E4%B8%BA%2202%22%E7%9A%84%E8%AF%BE%E7%A8%8B%E7%9A%84%E5%90%8C%E5%AD%A6%E7%9A%84%E4%BF%A1%E6%81%AF">查询学过编号为”01”并且也学过编号为”02”的课程的同学的信息</a><br>⑨ <a href="%E6%9F%A5%E8%AF%A2%E5%AD%A6%E8%BF%87%E7%BC%96%E5%8F%B7%E4%B8%BA%2201%22%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E5%AD%A6%E8%BF%87%E7%BC%96%E5%8F%B7%E4%B8%BA%2202%22%E7%9A%84%E8%AF%BE%E7%A8%8B%E7%9A%84%E5%90%8C%E5%AD%A6%E7%9A%84%E4%BF%A1%E6%81%AF">查询学过编号为”01”但是没有学过编号为”02”的课程的同学的信息</a><br>⑩ <a href="%E6%9F%A5%E8%AF%A2%E6%B2%A1%E6%9C%89%E5%AD%A6%E5%85%A8%E6%89%80%E6%9C%89%E8%AF%BE%E7%A8%8B%E7%9A%84%E5%90%8C%E5%AD%A6%E7%9A%84%E4%BF%A1%E6%81%AF">查询没有学全所有课程的同学的信息</a><br>⑪ <a href="%E6%9F%A5%E8%AF%A2%E8%87%B3%E5%B0%91%E6%9C%89%E4%B8%80%E9%97%A8%E8%AF%BE%E4%B8%8E%E5%AD%A6%E5%8F%B7%E4%B8%BA01%E5%90%8C%E5%AD%A6%E6%89%80%E5%AD%A6%E7%9B%B8%E5%90%8C%E7%9A%84%E5%90%8C%E5%AD%A6%E7%9A%84%E4%BF%A1%E6%81%AF">查询至少有一门课与学号为 01 同学所学相同的同学的信息</a><br>⑫ <a href="%E6%9F%A5%E8%AF%A2%E5%92%8C01%E5%8F%B7%E7%9A%84%E5%90%8C%E5%AD%A6%E5%AD%A6%E4%B9%A0%E7%9A%84%E8%AF%BE%E7%A8%8B,%E5%AE%8C%E5%85%A8%E7%9B%B8%E5%90%8C%E7%9A%84%E5%85%B6%E4%BB%96%E5%90%8C%E5%AD%A6%E7%9A%84%E4%BF%A1%E6%81%AF">查询和 01 号的同学学习的课程,完全相同的其他同学的信息</a><br>⑬ <a href="%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E5%90%8C%E5%AD%A6%E6%9C%80%E9%AB%98%E5%88%86%E5%AF%B9%E5%BA%94%E7%9A%84%E5%AD%A6%E7%A7%91%E5%90%8D%E7%A7%B0">查询所有同学最高分对应的学科名称</a></p>
<h5 id="查询”01“课程比”02”课程成绩高的学生的信息及课程分数"><a href="#查询”01“课程比”02”课程成绩高的学生的信息及课程分数" class="headerlink" title="查询”01“课程比”02”课程成绩高的学生的信息及课程分数"></a>查询”01“课程比”02”课程成绩高的学生的信息及课程分数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Sname <span class="keyword">as</span> 姓名,t1.score <span class="keyword">as</span> &quot;语文&quot; , t2.score <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">  (<span class="keyword">select</span> SId ,score <span class="keyword">from</span> SC <span class="keyword">as</span> sc1 <span class="keyword">where</span> sc1.CId<span class="operator">=</span><span class="string">&#x27;01&#x27;</span>) <span class="keyword">as</span> t1,</span><br><span class="line">  (<span class="keyword">select</span> SId ,score <span class="keyword">from</span> SC <span class="keyword">as</span> sc2 <span class="keyword">where</span> sc2.CId<span class="operator">=</span><span class="string">&#x27;02&#x27;</span>) <span class="keyword">as</span> t2,</span><br><span class="line">  (<span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">from</span> Student) <span class="keyword">as</span> t3</span><br><span class="line"><span class="keyword">where</span> t1.SId<span class="operator">=</span>t2.SId <span class="keyword">and</span>  t2.SId <span class="operator">=</span>t3.SId <span class="keyword">and</span> t1.score<span class="operator">&gt;</span>t2.score;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> st.<span class="operator">*</span>, sc1.score <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,sc2.score <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span></span><br><span class="line"><span class="keyword">from</span> Student <span class="keyword">as</span> st</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> SC <span class="keyword">as</span> sc1 <span class="keyword">on</span> st.SId  <span class="operator">=</span> sc1.SId <span class="keyword">and</span> sc1.CId <span class="operator">=</span><span class="string">&#x27;01&#x27;</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> SC <span class="keyword">as</span> sc2 <span class="keyword">on</span> st.SId  <span class="operator">=</span> sc2.SId <span class="keyword">and</span> sc2.CId <span class="operator">=</span><span class="string">&#x27;02&#x27;</span></span><br><span class="line"><span class="keyword">where</span> sc1.score <span class="operator">&gt;</span> sc2.score;</span><br></pre></td></tr></table></figure>

<h5 id="查询平均成绩大于等于-60-分的同学的学生编号和学生姓名和平均成绩"><a href="#查询平均成绩大于等于-60-分的同学的学生编号和学生姓名和平均成绩" class="headerlink" title="查询平均成绩大于等于 60 分的同学的学生编号和学生姓名和平均成绩"></a>查询平均成绩大于等于 60 分的同学的学生编号和学生姓名和平均成绩</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.SId ,s.Sname,<span class="built_in">AVG</span>(s2.score) avg_score</span><br><span class="line"><span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId  <span class="operator">=</span> s.SId</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.SId</span><br><span class="line"><span class="keyword">having</span> avg_score <span class="operator">&gt;=</span> <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<p>需要注意 where 和 having 的区别, where 是分组前筛选,所以一定写在 group by 的前面, having 是分组后筛选,这道题是想查找求完平均分数之后的结果</p>
<h5 id="查询在-SC-表存在成绩的学生信息"><a href="#查询在-SC-表存在成绩的学生信息" class="headerlink" title="查询在 SC 表存在成绩的学生信息"></a>查询在 SC 表存在成绩的学生信息</h5><p>第一种方法:将学生表和成绩表关联,过滤出没有成绩的条目,再用学生 id 分组</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId <span class="operator">=</span> s.SId</span><br><span class="line"><span class="keyword">where</span> s2.score <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.SId ;</span><br></pre></td></tr></table></figure>

<p>第二种方法: 先将成绩表按学生 id 分组,再查询学生 id 在分组后的临时表中的学生信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">where</span> s.SId <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> s.SId</span><br><span class="line">	<span class="keyword">from</span> SC s</span><br><span class="line">	<span class="keyword">group</span> <span class="keyword">by</span> s.SId</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="查询所有同学的学生编号、学生姓名、选课总数、所有课程的总成绩-没成绩的显示为-null"><a href="#查询所有同学的学生编号、学生姓名、选课总数、所有课程的总成绩-没成绩的显示为-null" class="headerlink" title="查询所有同学的学生编号、学生姓名、选课总数、所有课程的总成绩(没成绩的显示为 null )"></a>查询所有同学的学生编号、学生姓名、选课总数、所有课程的总成绩(没成绩的显示为 null )</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.SId ,s.Sname, <span class="built_in">COUNT</span>(s2.CId),<span class="built_in">sum</span>(s2.score)</span><br><span class="line"><span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId  <span class="operator">=</span> s.SId</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.SId ;</span><br></pre></td></tr></table></figure>

<h5 id="查询姓李的老师数量"><a href="#查询姓李的老师数量" class="headerlink" title="查询姓李的老师数量"></a>查询姓李的老师数量</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> 数量</span><br><span class="line"><span class="keyword">from</span> Teacher t</span><br><span class="line"><span class="keyword">where</span> t.Tname <span class="keyword">LIKE</span> &quot;李%&quot;;</span><br></pre></td></tr></table></figure>

<h5 id="学过”张三”老师授课的同学的信息"><a href="#学过”张三”老师授课的同学的信息" class="headerlink" title="学过”张三”老师授课的同学的信息"></a>学过”张三”老师授课的同学的信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span>,t.Tname  <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s.SId <span class="operator">=</span> s2.SId</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> Course c <span class="keyword">on</span> s2.CId  <span class="operator">=</span> c.CId</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> Teacher t <span class="keyword">on</span> t.TId  <span class="operator">=</span> c.TId</span><br><span class="line"><span class="keyword">where</span> t.Tname <span class="operator">=</span> &quot;张三&quot;;</span><br></pre></td></tr></table></figure>

<h5 id="没有学过”张三”老师授课的同学的信息"><a href="#没有学过”张三”老师授课的同学的信息" class="headerlink" title="没有学过”张三”老师授课的同学的信息"></a>没有学过”张三”老师授课的同学的信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 排除学过张三课的同学,剩下的就是没学过张三课的同学</span></span><br><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span> <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">WHERE</span>  s.SId <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> s.SId  <span class="keyword">from</span> Student s</span><br><span class="line">	<span class="keyword">inner</span> <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s.SId <span class="operator">=</span> s2.SId</span><br><span class="line">	<span class="keyword">inner</span> <span class="keyword">join</span> Course c <span class="keyword">on</span> s2.CId  <span class="operator">=</span> c.CId</span><br><span class="line">	<span class="keyword">inner</span> <span class="keyword">join</span> Teacher t <span class="keyword">on</span> t.TId  <span class="operator">=</span> c.TId</span><br><span class="line">	<span class="keyword">where</span> t.Tname <span class="operator">=</span> &quot;张三&quot;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查找每条成绩对应的课程信息,查找这些信息中是张三老师课的信息</span></span><br><span class="line"><span class="comment">-- 在查找这些信息对应的学生信息,并排除</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> s.<span class="operator">*</span> <span class="keyword">FROM</span> Student s</span><br><span class="line"><span class="keyword">WHERE</span> s.SId <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> s2.SId  <span class="keyword">from</span> SC s2</span><br><span class="line">	<span class="keyword">inner</span> <span class="keyword">JOIN</span> Course c2 <span class="keyword">on</span> c2.CId <span class="operator">=</span> s2.CId</span><br><span class="line">	<span class="keyword">WHERE</span> c2.TId  <span class="operator">=</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> t.TId  <span class="keyword">from</span>  Teacher t</span><br><span class="line">		<span class="keyword">WHERE</span> t.Tname <span class="operator">=</span> &quot;张三&quot;</span><br><span class="line">	)</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="查询学过编号为”01”并且也学过编号为”02”的课程的同学的信息"><a href="#查询学过编号为”01”并且也学过编号为”02”的课程的同学的信息" class="headerlink" title="查询学过编号为”01”并且也学过编号为”02”的课程的同学的信息"></a>查询学过编号为”01”并且也学过编号为”02”的课程的同学的信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 利用inner join 过滤没有匹配结果的条目</span></span><br><span class="line"><span class="keyword">SELECT</span>  <span class="operator">*</span> <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span>  SC s2 <span class="keyword">on</span> s2.SId <span class="operator">=</span>s.SId <span class="keyword">and</span> s2.CId <span class="operator">=</span> &quot;01&quot;</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span>  SC s3 <span class="keyword">on</span> s3.SId <span class="operator">=</span>s.SId <span class="keyword">and</span> s3.CId <span class="operator">=</span> &quot;02&quot;;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 先分组在查询个数</span></span><br><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span> <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId <span class="operator">=</span> s.SId</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> s.SId</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">sum</span>(IF(s2.CId<span class="operator">=</span>&quot;01&quot; <span class="keyword">or</span> s2.CId<span class="operator">=</span>&quot;02&quot;,<span class="number">1</span>,<span class="number">0</span>)) <span class="operator">&gt;</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h5 id="查询学过编号为”01”但是没有学过编号为”02”的课程的同学的信息"><a href="#查询学过编号为”01”但是没有学过编号为”02”的课程的同学的信息" class="headerlink" title="查询学过编号为”01”但是没有学过编号为”02”的课程的同学的信息"></a>查询学过编号为”01”但是没有学过编号为”02”的课程的同学的信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  <span class="operator">*</span> <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span>  SC s2 <span class="keyword">on</span> s2.SId <span class="operator">=</span>s.SId <span class="keyword">and</span> s2.CId <span class="operator">=</span> &quot;01&quot;</span><br><span class="line"><span class="keyword">WHERE</span> s.SId <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">SELECT</span>  s.SId  <span class="keyword">from</span> Student s</span><br><span class="line">	<span class="keyword">inner</span> <span class="keyword">join</span>  SC s2 <span class="keyword">on</span> s2.SId <span class="operator">=</span>s.SId <span class="keyword">and</span> s2.CId <span class="operator">=</span> &quot;02&quot;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="查询没有学全所有课程的同学的信息"><a href="#查询没有学全所有课程的同学的信息" class="headerlink" title="查询没有学全所有课程的同学的信息"></a>查询没有学全所有课程的同学的信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span> <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId  <span class="operator">=</span> s.SId</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">by</span> s.SId</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&lt;</span> (</span><br><span class="line">	<span class="keyword">SELECT</span>  <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">from</span> Course c</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="查询至少有一门课与学号为-01-同学所学相同的同学的信息"><a href="#查询至少有一门课与学号为-01-同学所学相同的同学的信息" class="headerlink" title="查询至少有一门课与学号为 01 同学所学相同的同学的信息"></a>查询至少有一门课与学号为 01 同学所学相同的同学的信息</h5><ol>
<li>查找学号 01 同学学过的科目</li>
<li>查找每个同学学过的科目,排除 01 同学自己</li>
<li>查找每个同学学过的科目在 01 同学学过的科目中的同学</li>
<li>去除重复的同学信息</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span> <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId  <span class="operator">=</span> s.SId</span><br><span class="line"><span class="keyword">where</span> s2.CId <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> s2.CId  <span class="keyword">from</span> Student s</span><br><span class="line">	<span class="keyword">inner</span>  <span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId  <span class="operator">=</span> s.SId <span class="keyword">and</span> s2.SId <span class="operator">=</span><span class="string">&#x27;01&#x27;</span></span><br><span class="line">)  <span class="keyword">and</span> s.SId <span class="operator">&lt;&gt;</span> <span class="string">&#x27;01&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.SId;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化查询01同学学过的科目,直接从成绩表中查</span></span><br><span class="line"><span class="comment">-- 使用distinct去重</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">distinct</span> sc.SId,	 st.<span class="operator">*</span> <span class="keyword">from</span> SC <span class="keyword">as</span> sc</span><br><span class="line"><span class="keyword">Join</span> Student   st</span><br><span class="line"><span class="keyword">On</span> sc.SId  <span class="operator">=</span> st.SId <span class="keyword">and</span> st.SId <span class="operator">&lt;&gt;</span> <span class="string">&#x27;01&#x27;</span></span><br><span class="line"><span class="keyword">Where</span> sc.CId  <span class="keyword">in</span> (<span class="keyword">Select</span> CId  <span class="keyword">from</span> SC <span class="keyword">where</span> SId  <span class="operator">=</span> <span class="string">&#x27;01&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="查询和-01-号的同学学习的课程-完全相同的其他同学的信息"><a href="#查询和-01-号的同学学习的课程-完全相同的其他同学的信息" class="headerlink" title="查询和 01 号的同学学习的课程,完全相同的其他同学的信息"></a>查询和 01 号的同学学习的课程,完全相同的其他同学的信息</h5><ol>
<li>查找所有同学学过的科目是在 01 同学学过的科目中的同学</li>
<li>学过和 01 同学相同课程的科目数时候和 01 同学的科目数相同</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span> <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId  <span class="operator">=</span> s.SId <span class="keyword">and</span> s.SId <span class="operator">&lt;&gt;</span> <span class="string">&#x27;01&#x27;</span> <span class="keyword">and</span> s2.CId <span class="keyword">in</span> (<span class="keyword">select</span> s3.CId  <span class="keyword">from</span> SC s3 <span class="keyword">where</span> s3.SId <span class="operator">=</span> <span class="string">&#x27;01&#x27;</span>)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.SId</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">count</span>(s.SId) <span class="operator">=</span> (</span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> SC s3 <span class="keyword">where</span> s3.SId <span class="operator">=</span> <span class="string">&#x27;01&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 也可以使用group concat 对比课程id</span></span><br><span class="line"><span class="comment">-- join的时候无需确认是否课程是01学过的课程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span> <span class="keyword">from</span> Student s</span><br><span class="line"><span class="keyword">join</span> SC s2 <span class="keyword">on</span> s2.SId  <span class="operator">=</span> s.SId <span class="keyword">and</span> s.SId <span class="operator">&lt;&gt;</span> <span class="string">&#x27;01&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.SId</span><br><span class="line"><span class="keyword">HAVING</span> GROUP_CONCAT(s2.CId <span class="keyword">order</span> <span class="keyword">by</span> s2.CId <span class="keyword">desc</span>) <span class="operator">=</span> (</span><br><span class="line">	<span class="keyword">select</span> GROUP_CONCAT(s3.CId <span class="keyword">order</span> <span class="keyword">by</span> s3.CId <span class="keyword">desc</span>) <span class="keyword">from</span> SC s3 <span class="keyword">where</span> s3.SId <span class="operator">=</span><span class="string">&#x27;01&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h5 id="查询所有同学最高分对应的学科名称"><a href="#查询所有同学最高分对应的学科名称" class="headerlink" title="查询所有同学最高分对应的学科名称"></a>查询所有同学最高分对应的学科名称</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (</span><br><span class="line">	<span class="keyword">select</span> s.SId ,s.Sname ,t.CId,t.score,t.row <span class="keyword">from</span> Student s</span><br><span class="line">	<span class="keyword">left</span> <span class="keyword">join</span> (</span><br><span class="line">	   <span class="keyword">select</span> s2.<span class="operator">*</span>,</span><br><span class="line">		<span class="built_in">row_number</span> () <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> s2.SId <span class="keyword">order</span> <span class="keyword">by</span> s2.score <span class="keyword">desc</span>) <span class="keyword">as</span> <span class="type">row</span></span><br><span class="line">		<span class="keyword">from</span> SC s2</span><br><span class="line">	) <span class="keyword">as</span> t  <span class="keyword">on</span> s.SId <span class="operator">=</span> t.SId</span><br><span class="line">	<span class="keyword">left</span> <span class="keyword">join</span> Course c <span class="keyword">on</span> c.CId  <span class="operator">=</span> t.CId</span><br><span class="line">) <span class="keyword">as</span> t <span class="keyword">where</span> t.row <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93-MySQL/" rel="tag">-数据库 - MySQL</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-ts/练习题"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/0013ba44e010/"
    >TypeScript 练习题</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/0013ba44e010/" class="article-date">
  <time datetime="2022-04-07T10:42:52.000Z" itemprop="datePublished">2022-04-07</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/TypeScript/">TypeScript</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>① <a href="#%E5%AE%9E%E7%8E%B0-Pick">实现 Pick</a><br>② <a href="#%E5%AE%9E%E7%8E%B0-Readonly">实现 Readonly</a><br>③ <a href="#%E5%85%83%E7%BB%84%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%AF%B9%E8%B1%A1">元组转换为对象</a><br>④ <a href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0">第一个元素</a><br>⑤ <a href="#%E5%AE%9E%E7%8E%B0-Exclude">实现 Exclude</a><br>⑥ <a href="#Promise-%E8%BF%94%E5%9B%9E%E5%80%BC%E7%B1%BB%E5%9E%8B">Promise 返回值类型</a><br>⑦ <a href="#%E5%AE%9E%E7%8E%B0-Array-Concat">实现 Array.Concat</a><br>⑧ <a href="#%E5%AE%9E%E7%8E%B0-Array-includes">实现 Array.includes</a><br>⑨ <a href="#%E5%AE%9E%E7%8E%B0-Parameters">实现 Parameters</a><br>⑩ <a href="#%E5%AE%9E%E7%8E%B0-ReturnType">实现 ReturnType</a><br>⑪ <a href="#%E5%AE%9E%E7%8E%B0-Omit">实现 Omit</a><br>⑫ <a href="#Pick-Readonly">Pick Readonly</a><br>⑬ <a href="#Deep-Readonly">Deep Readonly</a><br>⑭ <a href="#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E7%9A%84%E7%B1%BB%E5%9E%8B">链式调用的类型</a><br>⑮ <a href="#%E5%AE%9E%E7%8E%B0-Promise.all">Promise.all </a><br>⑯ <a href="#Type-Lookup">Type Lookup</a><br>⑰ <a href="#%E5%AE%9E%E7%8E%B0-Trim">Trim</a><br>⑱ <a href="#Type-Replace">Type Replace</a><br>⑲ <a href="#%E8%BF%BD%E5%8A%A0%E5%8F%82%E6%95%B0">追加参数</a><br>⑳ <a href="#Flatten">Flatten</a><br>㉑ <a href="#AppendToObject">AppendToObject</a><br>㉒ <a href="#%E6%95%B0%E5%AD%97%E8%BD%AC%E5%AD%97%E7%AC%A6%E4%B8%B2">数字转字符串</a><br>㉓ <a href="#StringToUnion">StringToUnion</a><br>㉔ <a href="#MergeKey">MergeKey</a><br>㉕ <a href="#CamelCase-&-KebabCase">CamelCase &amp; KebabCase</a><br>㉖ <a href="#Diff">Diff</a><br>㉗ <a href="#anyOf">anyOf</a><br>㉘ <a href="#isUnion">isUnion</a></p>
<h5 id="实现-Pick"><a href="#实现-Pick" class="headerlink" title="实现 Pick"></a>实现 Pick</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Pick</span>&lt;T, K <span class="keyword">extends</span> keyof T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> K]: T[P];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>利用 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/2/keyof-types.html">keyof</a> 将对象类型转换成键值的联合类型</p>
<p>利用 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/2/conditional-types.html">extends</a> 进行泛型约束, K 可以分配给 T, 表示 K 是 T 的子集.</p>
<p>利用 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#the-in-operator-narrowing">in</a> 运算符,遍历联合类型</p>
<h5 id="实现-Readonly"><a href="#实现-Readonly" class="headerlink" title="实现 Readonly"></a>实现 Readonly</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Readonly</span>&lt;T&gt; = &#123;</span><br><span class="line">  <span class="keyword">readonly</span> [P <span class="keyword">in</span> keyof T]: T[P];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="元组转换为对象"><a href="#元组转换为对象" class="headerlink" title="元组转换为对象"></a>元组转换为对象</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tuple = [<span class="string">&quot;tesla&quot;</span>, <span class="string">&quot;model 3&quot;</span>, <span class="string">&quot;model X&quot;</span>, <span class="string">&quot;model Y&quot;</span>] <span class="keyword">as</span> <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">TupleToObject</span>&lt;T <span class="keyword">extends</span> <span class="keyword">readonly</span> <span class="built_in">any</span>[]&gt; = &#123;</span><br><span class="line">  [K <span class="keyword">in</span> T[<span class="built_in">number</span>]]: K;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> result = <span class="title class_">TupleToObject</span>&lt;<span class="keyword">typeof</span> tuple&gt;;</span><br><span class="line"><span class="comment">// expected &#123; tesla: &#x27;tesla&#x27;, &#x27;model 3&#x27;: &#x27;model 3&#x27;, &#x27;model X&#x27;: &#x27;model X&#x27;, &#x27;model Y&#x27;: &#x27;model Y&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<p>因为 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#the-in-operator-narrowing">in</a> 运算符可以遍历联合类型,所以把元组 T 转换成联合类型,在进行遍历</p>
<h5 id="第一个元素"><a href="#第一个元素" class="headerlink" title="第一个元素"></a>第一个元素</h5><p>实现一个通用 First<T>，它接受一个数组 T 并返回它的第一个元素的类型。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> arr2 = [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">First</span>&lt;T <span class="keyword">extends</span> <span class="keyword">readonly</span> <span class="built_in">any</span>[]&gt; = T[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">First</span>&lt;T <span class="keyword">extends</span> <span class="keyword">readonly</span> <span class="built_in">any</span>[]&gt; = T <span class="keyword">extends</span> [infer F, ...infer R]</span><br><span class="line">  ? F</span><br><span class="line">  : <span class="built_in">never</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> head1 = <span class="title class_">First</span>&lt;arr1&gt;; <span class="comment">// expected to be &#x27;a&#x27;</span></span><br></pre></td></tr></table></figure>

<p>利用条件语句中 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/2/conditional-types.html#inferring-within-conditional-types">infer</a> 类型推断,返回第一个元素所代表的类型</p>
<h5 id="实现-Exclude"><a href="#实现-Exclude" class="headerlink" title="实现 Exclude"></a>实现 Exclude</h5><p>Exclude 的用法是从联合类型中,排除指定的属性</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Exclude</span>&lt;T, U&gt; = T <span class="keyword">extends</span> U ? <span class="built_in">never</span> : T;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/2/conditional-types.html">extends</a> 条件类型, T 是否能分配给 U, 会去拿 T 中的每一项与 U 进行匹配, 如果当前项可以分配,表示 U 中存在这种类型,需要排除,所以返回 never. 如果不存在则返回这一项的类型.</p>
<h5 id="Promise-返回值类型"><a href="#Promise-返回值类型" class="headerlink" title="Promise 返回值类型"></a>Promise 返回值类型</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Awaited</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;&gt; = T <span class="keyword">extends</span> <span class="title class_">Promise</span>&lt;infer R&gt; ? R : T;</span><br></pre></td></tr></table></figure>

<h5 id="实现-Array-Concat"><a href="#实现-Array-Concat" class="headerlink" title="实现 Array.Concat"></a>实现 Array.Concat</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Concat</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[], U <span class="keyword">extends</span> <span class="built_in">any</span>[]&gt; = [...T, ...U];</span><br></pre></td></tr></table></figure>

<h5 id="实现-Array-includes"><a href="#实现-Array-includes" class="headerlink" title="实现 Array.includes"></a>实现 Array.includes</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Includes</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[], U&gt; = U <span class="keyword">extends</span> T[<span class="built_in">number</span>] ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>利用 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/2/conditional-types.html">extends</a> 条件类型可以进行联合类型的判断,, 首先吧元组转换为联合类型, 如果类型可分配表示 U 存在与元组中.</p>
<h5 id="实现-Parameters"><a href="#实现-Parameters" class="headerlink" title="实现 Parameters"></a>实现 Parameters</h5><p>Parameters 作用是用于获得函数的参数类型组成的元组类型。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Parameters</span>&lt;T <span class="keyword">extends</span> (...<span class="attr">args</span>: <span class="built_in">any</span>) =&gt; <span class="built_in">any</span>&gt; = T <span class="keyword">extends</span> (</span><br><span class="line">  ...<span class="attr">args</span>: infer P</span><br><span class="line">) =&gt; <span class="built_in">any</span></span><br><span class="line">  ? P</span><br><span class="line">  : <span class="built_in">never</span>;</span><br></pre></td></tr></table></figure>

<h5 id="实现-ReturnType"><a href="#实现-ReturnType" class="headerlink" title="实现 ReturnType"></a>实现 ReturnType</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">ReturnType</span>&lt;T <span class="keyword">extends</span> (...<span class="attr">args</span>: <span class="built_in">any</span>) =&gt; <span class="built_in">any</span>&gt; = T <span class="keyword">extends</span> (</span><br><span class="line">  ...<span class="attr">args</span>: <span class="built_in">any</span></span><br><span class="line">) =&gt; infer R</span><br><span class="line">  ? R</span><br><span class="line">  : <span class="built_in">any</span>;</span><br></pre></td></tr></table></figure>

<h5 id="实现-Omit"><a href="#实现-Omit" class="headerlink" title="实现 Omit"></a>实现 Omit</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Omit</span>&lt;T, K <span class="keyword">extends</span> keyof <span class="built_in">any</span>&gt; = <span class="title class_">Pick</span>&lt;T, <span class="title class_">Exclude</span>&lt;keyof T, K&gt;&gt;;</span><br></pre></td></tr></table></figure>

<h5 id="Pick-Readonly"><a href="#Pick-Readonly" class="headerlink" title="Pick Readonly"></a>Pick Readonly</h5><p>指定属性 ReadOnly</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">PickReadonly</span>&lt;T, K <span class="keyword">extends</span> keyof T = keyof T&gt; = &#123;</span><br><span class="line">  [<span class="title class_">Key</span> <span class="keyword">in</span> <span class="title class_">Exclude</span>&lt;keyof T, K&gt;]: T[<span class="title class_">Key</span>];</span><br><span class="line">&#125; &amp; &#123;</span><br><span class="line">  <span class="keyword">readonly</span> [<span class="title class_">Key</span> <span class="keyword">in</span> K]: T[<span class="title class_">Key</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Todo</span> &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">description</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">completed</span>: <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">todo</span>: <span class="title class_">MyReadonly2</span>&lt;<span class="title class_">Todo</span>, <span class="string">&quot;title&quot;</span> | <span class="string">&quot;description&quot;</span>&gt; = &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&quot;Hey&quot;</span>,</span><br><span class="line">  <span class="attr">description</span>: <span class="string">&quot;foobar&quot;</span>,</span><br><span class="line">  <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">todo.<span class="property">title</span> = <span class="string">&quot;Hello&quot;</span>; <span class="comment">// Error: cannot reassign a readonly property</span></span><br><span class="line">todo.<span class="property">description</span> = <span class="string">&quot;barFoo&quot;</span>; <span class="comment">// Error: cannot reassign a readonly property</span></span><br><span class="line">todo.<span class="property">completed</span> = <span class="literal">true</span>; <span class="comment">// OK</span></span><br></pre></td></tr></table></figure>

<h5 id="Deep-Readonly"><a href="#Deep-Readonly" class="headerlink" title="Deep Readonly"></a>Deep Readonly</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> X = &#123;</span><br><span class="line">  <span class="attr">x</span>: &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attr">b</span>: <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="attr">y</span>: <span class="string">&quot;hey&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">DeepReadonly</span>&lt;T&gt; = &#123;</span><br><span class="line">  <span class="keyword">readonly</span> [K <span class="keyword">in</span> keyof T]: T[K] <span class="keyword">extends</span> <span class="built_in">object</span> ? <span class="title class_">DeepReadonly</span>&lt;T[K]&gt; : T[K];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Todo</span> = <span class="title class_">DeepReadonly</span>&lt;X&gt;; <span class="comment">// should be same as `Expected`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Expected</span> = &#123;</span><br><span class="line">  <span class="keyword">readonly</span> <span class="attr">x</span>: &#123;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">a</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">b</span>: <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">readonly</span> <span class="attr">y</span>: <span class="string">&quot;hey&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="链式调用的类型"><a href="#链式调用的类型" class="headerlink" title="链式调用的类型"></a>链式调用的类型</h5><p>假设 key 只接受字符串而 value 接受任何类型，你只需要暴露它传递的类型而不需要进行任何处理。同样的 key 只会被使用一次。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Chainable</span>&lt;T = &#123;&#125;&gt; = &#123;</span><br><span class="line">  <span class="attr">option</span>: &lt;K <span class="keyword">extends</span> <span class="built_in">string</span>, V&gt;<span class="function">(<span class="params">k: K, v: V</span>) =&gt;</span> <span class="title class_">Chainable</span>&lt;T &amp; &#123; [P <span class="keyword">in</span> K]: V &#125;&gt;;</span><br><span class="line">  <span class="attr">get</span>: <span class="function">() =&gt;</span> T;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> <span class="attr">config</span>: <span class="title class_">Chainable</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = config</span><br><span class="line">  .<span class="title function_">option</span>(<span class="string">&quot;foo&quot;</span>, <span class="number">123</span>)</span><br><span class="line">  .<span class="title function_">option</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;type-challenges&quot;</span>)</span><br><span class="line">  .<span class="title function_">option</span>(<span class="string">&quot;bar&quot;</span>, &#123; <span class="attr">value</span>: <span class="string">&quot;Hello World&quot;</span> &#125;)</span><br><span class="line">  .<span class="title function_">get</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 期望 result 的类型是：</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Result</span> &#123;</span><br><span class="line">  <span class="attr">foo</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">bar</span>: &#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="built_in">string</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="实现-Promise-all"><a href="#实现-Promise-all" class="headerlink" title="实现 Promise.all"></a>实现 Promise.all</h4><p>ts 允许像遍历一个对象一样遍历类数组</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Awaited</span>&lt;T&gt; =</span><br><span class="line">  T <span class="keyword">extends</span> <span class="literal">null</span> | <span class="literal">undefined</span> ? T :</span><br><span class="line">  <span class="comment">// special case for `null | undefined` when not in `--strictNullChecks` mode</span></span><br><span class="line">    T <span class="keyword">extends</span> <span class="built_in">object</span> &amp; &#123; <span class="title function_">then</span>(<span class="attr">onfulfilled</span>: infer F): <span class="built_in">any</span> &#125; ?</span><br><span class="line">    <span class="comment">// `await` only unwraps object types with a callable `then`. Non-object types are not unwrapped</span></span><br><span class="line">      F <span class="keyword">extends</span> (<span class="function">(<span class="params">value: infer V, ...args: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span>) ? <span class="comment">// if the argument to `then` is callable, extracts the first argument</span></span><br><span class="line">          <span class="title class_">Awaited</span>&lt;V&gt; :</span><br><span class="line">          <span class="comment">// recursively unwrap the value</span></span><br><span class="line">          <span class="built_in">never</span> :</span><br><span class="line">          <span class="comment">// the argument to `then` was not callable</span></span><br><span class="line">    T;</span><br><span class="line">    <span class="comment">// non-object or non-thenable</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">PromiseAll</span>&lt;T <span class="keyword">extends</span> <span class="keyword">readonly</span> unknown[] | []&gt;(<span class="attr">values</span>: T): <span class="title class_">Promise</span>&lt;&#123; -<span class="keyword">readonly</span> [P <span class="keyword">in</span> keyof T]: <span class="title class_">Awaited</span>&lt;T[P]&gt; &#125;&gt;;</span><br></pre></td></tr></table></figure>

<h4 id="Type-Lookup"><a href="#Type-Lookup" class="headerlink" title="Type Lookup"></a>Type Lookup</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">LookUp</span>&lt;U, T <span class="keyword">extends</span> <span class="built_in">string</span>&gt; = &#123;</span><br><span class="line">  [K <span class="keyword">in</span> T]: U <span class="keyword">extends</span> &#123; <span class="attr">type</span>: T &#125; ? U : <span class="built_in">never</span>;</span><br><span class="line">&#125;[T];</span><br></pre></td></tr></table></figure>

<h4 id="实现-Trim"><a href="#实现-Trim" class="headerlink" title="实现 Trim"></a>实现 Trim</h4><p>类型推断可以用于字符串</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Trim</span>&lt;T <span class="keyword">extends</span> <span class="built_in">string</span>&gt; = T <span class="keyword">extends</span> <span class="string">` <span class="subst">$&#123;infer R&#125;</span>`</span></span><br><span class="line">  ? <span class="title class_">Trim</span>&lt;R&gt;</span><br><span class="line">  : T <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;infer R&#125;</span> `</span></span><br><span class="line">  ? <span class="title class_">Trim</span>&lt;R&gt;</span><br><span class="line">  : T;</span><br></pre></td></tr></table></figure>

<h4 id="Type-Replace"><a href="#Type-Replace" class="headerlink" title="Type Replace"></a>Type Replace</h4><p>ts 没有 indexOf 的能力, 通过条件类型判断两个类型是否匹配</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Replace</span>&lt;</span><br><span class="line">  T <span class="keyword">extends</span> <span class="built_in">string</span>,</span><br><span class="line">  P <span class="keyword">extends</span> <span class="built_in">string</span>,</span><br><span class="line">  U <span class="keyword">extends</span> <span class="built_in">string</span></span><br><span class="line">&gt; = T <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;infer F&#125;</span><span class="subst">$&#123;P&#125;</span><span class="subst">$&#123;infer R&#125;</span>`</span> ? <span class="string">`<span class="subst">$&#123;F&#125;</span><span class="subst">$&#123;U&#125;</span><span class="subst">$&#123;R&#125;</span>`</span> : T;</span><br></pre></td></tr></table></figure>

<h4 id="追加参数"><a href="#追加参数" class="headerlink" title="追加参数"></a>追加参数</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">AppendArgument</span>&lt;F <span class="keyword">extends</span> (...<span class="attr">args</span>: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span>, P&gt; = F <span class="keyword">extends</span> (</span><br><span class="line">  ...<span class="attr">args</span>: infer R</span><br><span class="line">) =&gt; infer L</span><br><span class="line">  ? <span class="function">(<span class="params">...args: [...R, P]</span>) =&gt;</span> L</span><br><span class="line">  : F;</span><br></pre></td></tr></table></figure>

<h4 id="Flatten"><a href="#Flatten" class="headerlink" title="Flatten"></a>Flatten</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Flatten</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[], A <span class="keyword">extends</span> <span class="built_in">any</span>[] = []&gt; = T <span class="keyword">extends</span> [</span><br><span class="line">  infer F,</span><br><span class="line">  ...infer R</span><br><span class="line">]</span><br><span class="line">  ? F <span class="keyword">extends</span> <span class="built_in">any</span>[]</span><br><span class="line">    ? <span class="title class_">Flatten</span>&lt;R, <span class="title class_">Flatten</span>&lt;F, A&gt;&gt;</span><br><span class="line">    : <span class="title class_">Flatten</span>&lt;R, [...A, F]&gt;</span><br><span class="line">  : A;</span><br></pre></td></tr></table></figure>

<h4 id="AppendToObject"><a href="#AppendToObject" class="headerlink" title="AppendToObject"></a>AppendToObject</h4><p>对象 Key 的类型约束,有两种方式</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// K extends PropertyKey 其中 PropertyKey 为内置属性</span></span><br><span class="line"><span class="comment">// K extends keyof any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">AppendToObject</span>&lt;T, K <span class="keyword">extends</span> <span class="title class_">PropertyKey</span>, V&gt; = &#123;</span><br><span class="line">  [<span class="title class_">Key</span> <span class="keyword">in</span> keyof T | K]: <span class="title class_">Key</span> <span class="keyword">extends</span> keyof T ? T[<span class="title class_">Key</span>] : V;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>另一种是现实是重新遍历一次组合后的对象</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">MapKey</span>&lt;T&gt; = &#123; [K <span class="keyword">in</span> keyof T]: T[K] &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">AppendToObject</span>&lt;T, K <span class="keyword">extends</span> keyof <span class="built_in">any</span>, V&gt; = <span class="title class_">MapKey</span>&lt;</span><br><span class="line">  T &amp; &#123;</span><br><span class="line">    [<span class="variable constant_">K1</span> <span class="keyword">in</span> K]: V;</span><br><span class="line">  &#125;</span><br><span class="line">&gt;;</span><br></pre></td></tr></table></figure>

<h4 id="数子转字符串"><a href="#数子转字符串" class="headerlink" title="数子转字符串"></a>数子转字符串</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Test</span>&lt;T <span class="keyword">extends</span> <span class="built_in">number</span>&gt; = <span class="string">`<span class="subst">$&#123;T&#125;</span>`</span>;</span><br></pre></td></tr></table></figure>

<p>可以把非字符串类型转为字符串,利用类型系统处理</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Test</span>&lt;T <span class="keyword">extends</span> <span class="built_in">number</span> | <span class="built_in">string</span> | bigint&gt; = <span class="string">`<span class="subst">$&#123;T&#125;</span>`</span> <span class="keyword">extends</span> <span class="string">`-<span class="subst">$&#123;infer R&#125;</span>`</span></span><br><span class="line">  ? R</span><br><span class="line">  : T;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> dd = <span class="title class_">Test</span>&lt;<span class="string">&quot;-123&quot;</span>&gt;; <span class="comment">//123</span></span><br></pre></td></tr></table></figure>

<h4 id="StringToUnion"><a href="#StringToUnion" class="headerlink" title="StringToUnion"></a>StringToUnion</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">StringToUnion</span>&lt;</span><br><span class="line">  T <span class="keyword">extends</span> <span class="built_in">string</span>,</span><br><span class="line">  A <span class="keyword">extends</span> <span class="built_in">string</span>[] = []</span><br><span class="line">&gt; = T <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;infer F&#125;</span><span class="subst">$&#123;infer R&#125;</span>`</span> ? <span class="title class_">StringToUnion</span>&lt;R, [...A, F]&gt; : A[<span class="built_in">number</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">StringToUnion</span>&lt;</span><br><span class="line">  T <span class="keyword">extends</span> <span class="built_in">string</span>,</span><br><span class="line">  A = <span class="built_in">never</span></span><br><span class="line">&gt; = T <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;infer F&#125;</span><span class="subst">$&#123;infer R&#125;</span>`</span> ? <span class="title class_">StringToUnion</span>&lt;R, A | F&gt; : A;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Result</span> = <span class="title class_">StringToUnion</span>&lt;<span class="title class_">Test</span>&gt;; <span class="comment">// expected to be &quot;1&quot; | &quot;2&quot; | &quot;3&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="MergeKey"><a href="#MergeKey" class="headerlink" title="MergeKey"></a>MergeKey</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Merge</span>&lt;T, P <span class="keyword">extends</span> &#123; [k <span class="keyword">in</span> <span class="title class_">PropertyKey</span>]: <span class="built_in">any</span> &#125;&gt; = &#123;</span><br><span class="line">  [K <span class="keyword">in</span> keyof foo | keyof coo]: (foo &amp; coo)[K] <span class="keyword">extends</span> <span class="built_in">never</span></span><br><span class="line">    ? P[K]</span><br><span class="line">    : (foo &amp; coo)[K];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Merge</span>&lt;F, S&gt; = &#123;</span><br><span class="line">  [K <span class="keyword">in</span> keyof F | keyof S]: K <span class="keyword">extends</span> keyof S</span><br><span class="line">    ? S[K]</span><br><span class="line">    : K <span class="keyword">extends</span> keyof F</span><br><span class="line">    ? F[K]</span><br><span class="line">    : <span class="built_in">never</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="CamelCase-amp-KebabCase"><a href="#CamelCase-amp-KebabCase" class="headerlink" title="CamelCase &amp; KebabCase"></a>CamelCase &amp; KebabCase</h4><p>aa-bb-cc &#x3D;&gt; aaBbCc</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">CamelCase</span>&lt;T <span class="keyword">extends</span> <span class="built_in">string</span>&gt; = T <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;infer F&#125;</span>-<span class="subst">$&#123;infer D&#125;</span><span class="subst">$&#123;infer R&#125;</span>`</span></span><br><span class="line">  ? <span class="title class_">CamelCase</span>&lt;<span class="string">`<span class="subst">$&#123;F&#125;</span><span class="subst">$&#123;Uppercase&lt;D&gt;&#125;</span><span class="subst">$&#123;R&#125;</span>`</span>&gt;</span><br><span class="line">  : T;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">CamelCase</span>&lt;T <span class="keyword">extends</span> <span class="built_in">string</span>&gt; = T <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;infer F&#125;</span>-<span class="subst">$&#123;infer D&#125;</span>`</span></span><br><span class="line">  ? <span class="title class_">CamelCase</span>&lt;<span class="string">`<span class="subst">$&#123;F&#125;</span><span class="subst">$&#123;Capitalize&lt;D&gt;&#125;</span>`</span>&gt;</span><br><span class="line">  : T;</span><br></pre></td></tr></table></figure>

<p>AaBbCc &#x3D;&gt; aa-bb-cc</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">KebabCase</span>&lt;</span><br><span class="line">  T <span class="keyword">extends</span> <span class="built_in">string</span>,</span><br><span class="line">  P <span class="keyword">extends</span> <span class="built_in">string</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">&gt; = T <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;infer F&#125;</span><span class="subst">$&#123;infer R&#125;</span>`</span></span><br><span class="line">  ? <span class="title class_">Lowercase</span>&lt;F&gt; <span class="keyword">extends</span> F</span><br><span class="line">    ? <span class="title class_">KebabCase</span>&lt;R, <span class="string">`<span class="subst">$&#123;P&#125;</span><span class="subst">$&#123;F&#125;</span>`</span>&gt;</span><br><span class="line">    : <span class="title class_">KebabCase</span>&lt;R, <span class="string">`<span class="subst">$&#123;P&#125;</span>-<span class="subst">$&#123;Lowercase&lt;F&gt;&#125;</span>`</span>&gt;</span><br><span class="line">  : P <span class="keyword">extends</span> <span class="string">`-<span class="subst">$&#123;infer R&#125;</span>`</span></span><br><span class="line">  ? R</span><br><span class="line">  : <span class="built_in">never</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Diff"><a href="#Diff" class="headerlink" title="Diff"></a>Diff</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Diff</span>&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>, P <span class="keyword">extends</span> <span class="built_in">object</span>&gt; = &#123;</span><br><span class="line">  [K <span class="keyword">in</span></span><br><span class="line">    | <span class="title class_">Exclude</span>&lt;keyof T, keyof P&gt;</span><br><span class="line">    | <span class="title class_">Exclude</span>&lt;keyof P, keyof T&gt;]: K <span class="keyword">extends</span> keyof T</span><br><span class="line">    ? T[K]</span><br><span class="line">    : K <span class="keyword">extends</span> keyof P</span><br><span class="line">    ? P[K]</span><br><span class="line">    : <span class="built_in">never</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="anyOf"><a href="#anyOf" class="headerlink" title="anyOf"></a>anyOf</h4><p>实现一个类型,接受一个元组,如果元组中的每一个都为 false,返回 false,有一个为 true 则返回 true</p>
<p>需要注意联合类型是通过 T[number] 得到的,并不会进行条件类型分配,所以当联合类型可以分配给指定联合类型, 也就是联合类型中的每一个都在指定的联合类型中的时候返回 false</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">AnyOf</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[]&gt; = T[<span class="built_in">number</span>] <span class="keyword">extends</span></span><br><span class="line">  | <span class="string">&quot;&quot;</span></span><br><span class="line">  | <span class="number">0</span></span><br><span class="line">  | <span class="literal">false</span></span><br><span class="line">  | []</span><br><span class="line">  | <span class="title class_">Record</span>&lt;<span class="built_in">any</span>, <span class="built_in">never</span>&gt;</span><br><span class="line">  ? <span class="literal">false</span></span><br><span class="line">  : <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<h4 id="isUnion"><a href="#isUnion" class="headerlink" title="isUnion"></a>isUnion</h4><p>利用 <a href="/posts/a5ff14c8459e/#%E6%9D%A1%E4%BB%B6%E5%88%86%E9%85%8D%E7%B1%BB%E5%9E%8B">分配条件类型</a>,联合类型在条件分配后会被转换为复合联合类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">IsUnion</span>&lt;T, O = T&gt; = T <span class="keyword">extends</span> O ? ([O] <span class="keyword">extends</span> [T] ? <span class="literal">false</span> : <span class="literal">true</span>) : <span class="built_in">never</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> case1 = <span class="title class_">IsUnion</span>&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line"><span class="keyword">type</span> case2 = <span class="title class_">IsUnion</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span>&gt;; <span class="comment">// true</span></span><br><span class="line"><span class="keyword">type</span> case3 = <span class="title class_">IsUnion</span>&lt;[<span class="built_in">string</span> | <span class="built_in">number</span>]&gt;; <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用分配条件类型把基本类型的联合类型转换为符合类型的联合类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Test</span>&lt;T, O = T&gt; = T <span class="keyword">extends</span> O ? [T] : <span class="built_in">never</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> case1 = <span class="title class_">Test</span>&lt;<span class="built_in">string</span>&gt;; <span class="comment">//[string]</span></span><br><span class="line"><span class="keyword">type</span> case2 = <span class="title class_">Test</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span>&gt;; <span class="comment">// [string] | [number]</span></span><br><span class="line"><span class="keyword">type</span> case3 = <span class="title class_">Test</span>&lt;[<span class="built_in">string</span> | <span class="built_in">number</span>]&gt;; <span class="comment">// [[string|number]]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-css/视觉效果"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/bcb927b5ace5/"
    >CSS艺术 视觉效果</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/bcb927b5ace5/" class="article-date">
  <time datetime="2022-04-07T04:50:13.000Z" itemprop="datePublished">2022-04-07</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/CSS/">CSS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="单侧投影"><a href="#单侧投影" class="headerlink" title="单侧投影"></a>单侧投影</h4><p>先来回忆一下 <code>box-shadow</code> 的几个属性值</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*          水平偏移  垂直偏移  模糊半径  扩张半径  颜色   内侧阴影*/</span></span><br><span class="line"><span class="attribute">box-shadow</span>: h-shadow v-shadow blur spread color inset;</span><br></pre></td></tr></table></figure>

<p>模糊半径和扩张半径共同控制一个阴影的大小.</p>
<p>如果元素原始的尺寸是 100*100, 设置它的模糊半径为 5px,最终的阴影尺寸是 (100+5)*(100+5),所以如果没有进行平移操作, 每个边上都会延伸出 5px 的阴影.</p>
<p>这时再设置它的扩张半径属性,会在已有的阴影尺寸上再继续计算, 而且这个值可以是一个负值,如果设置扩张半径为-5px,它会压缩原有的阴影尺寸,最终变为 (105-5)*(105-5),这个属性并不会切割掉设置了阴影的部分,实际上可以看作是它压缩了实心部分也就是元素所占据的那部分的大小.因此现在每个边上都看不见阴影了,但阴影还是存在的,它被缩小到和元素面积相同,被元素覆盖住</p>
<p>知道了这些实现单侧投影可能就有了一些思路,可以设置一个 4px 的模糊半径, 这样元素四边就都有了 4px 的阴影,再垂直或水平方向上偏移这个阴影 4px,现在一个边上就会有 8px 的阴影,它的对边会被遮盖住,两个临边还是 4px 的阴影,最后在使用扩张半径设置为-4px,把多余的阴影遮盖住,为了效果明显一点,偏移量可以比模糊半径多几个像素</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">box-shadow</span>: <span class="number">0px</span> <span class="number">6px</span> <span class="number">4px</span> -<span class="number">4px</span> <span class="number">#000</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/bcb927b5ace5/0001.png"></p>
<h4 id="不规则投影"><a href="#不规则投影" class="headerlink" title="不规则投影"></a>不规则投影</h4><p>也许你还是想用 box-shadow 来实现,但事实上 box-shadow 也无能为力,有些场景 box-shadow 并不会正确的显示阴影的效果.</p>
<ul>
<li>半透明的(图片,背景图片,border-image) 阴影不会穿过半透明区域,实际上还是围绕在元素周围</li>
<li>元素设置了虚线或点或半透明的边框,但没有背景(或者 background-clip 不是 border-box 时)</li>
<li>伪类元素拼接</li>
<li>切角或折角的效果</li>
<li>clip-path 生成的图形</li>
</ul>
<p>这里需要用到一个从 SVG 中借鉴来的属性 <a target="_blank" rel="noopener" href="https://css-tricks.com/almanac/properties/f/filter/"><code>filter</code></a>,因为模糊算法不一样肯能有细微的差别</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">filter</span>: <span class="built_in">drop-shadow</span>(<span class="number">4px</span> <span class="number">4px</span> <span class="number">2px</span> red);</span><br></pre></td></tr></table></figure>

<p>注意:这个属性会一视同仁的把所有透明区域都打上阴影,所以如果是元素中的文字,如果没有背景颜色也会打上阴影,而且不受 text-shadow 影响,因为他会给 text-shadow 的阴影打上阴影</p>
<h4 id="色彩滤镜"><a href="#色彩滤镜" class="headerlink" title="色彩滤镜"></a>色彩滤镜</h4><p>有的时候想给张图片转换为灰度图,但又需要保留原有的对比度,最好是能与鼠标有交互效果.</p>
<p>虽然通过 canvas 可以通过脚本的方式进行修改,但是成本很高,也有性能问题. css 提供了滤镜系统可以使用,但不是所有的浏览器都兼容.</p>
<p>具体属性参考 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/filter#%E8%A7%84%E8%8C%83">MDN</a> 或 <a target="_blank" rel="noopener" href="https://drafts.fxtf.org/filter-effects/#FilterProperty">W3C</a></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">transition</span>: <span class="number">0.5</span> filter;</span><br><span class="line"><span class="attribute">filter</span>: <span class="built_in">sepia</span>(<span class="number">1</span>) <span class="built_in">saturate</span>(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p>![0002.png]</p>
<p>这种方式基本满足效果,但是滤镜的叠加有时会显得过度不自然, 另外一种方式就是混合模式,将上下两层效果混合在一起,一个最重要的区别就是混合叫过不能使用动画,所以混合模式中,只能控制外层的样式过度进行混合</p>
<p>mix-blend-mode <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/mix-blend-mode">MDN</a> <a target="_blank" rel="noopener" href="https://drafts.fxtf.org/compositing-1/#mix-blend-mode">W3C</a></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">div</span> class=&quot;wrap&quot; &gt; &lt;<span class="selector-tag">div</span> class=&quot;box&quot; &gt; &lt;/<span class="selector-tag">div</span> &gt; &lt;/<span class="selector-tag">div</span> &gt; <span class="selector-class">.wrap</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">hsla</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">100</span>, <span class="number">0.8</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">mix-blend-mode</span>: luminosity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="毛玻璃效果"><a href="#毛玻璃效果" class="headerlink" title="毛玻璃效果"></a>毛玻璃效果</h4><p><img src="/posts/bcb927b5ace5/0003.png"></p>
<p>首先能想到的就是文字模糊的问题, 如何能保证背景模糊但是不影响文字, 这里需要使用两个元素,但是为了简洁可以使用伪元素</p>
<p>另一个元素就是外层的背景图片元素,这里以 body 元素为例, 所以 html 结构如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span>玻璃效果中的文字<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>先把一些简单的样式实现,</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>) <span class="number">0</span> / cover;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">    当把一个元素移动到父元素下面的时候,一定要注意父元素的上级元素有没有背景</span></span><br><span class="line"><span class="comment">    如果父元素上级元素有背景,那个移动的这个元素的背景会出现在父元素上级元素背景的下面</span></span><br><span class="line"><span class="comment">    提升box的层级,防止before移动到box下面的时候背景会在body背景的下面</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>) <span class="number">0</span> / cover;</span><br><span class="line">  <span class="comment">/* 移动到父元素的下面,防止背景挡住文字 */</span></span><br><span class="line">  <span class="attribute">z-index</span>: -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一个重要的问题就是如何让 before 元素中的背景和 body 的背景完全对其,一种可能的办法是获取父元素背景的大小,子元素使用相同的大小,再获取子元素相对于父元素偏移量,为 background-position 设置相同的偏移量</p>
<p>虽然这种办法可行,但是一旦父元素存在滚动条会变的很复杂, 一个比较好的方法就是使用 background-attachment 属性.</p>
<p>background-attachment 设置背景图像是否固定或者随着页面的其余部分滚动。当属性值为 fixed 的时候表示,布景图相关于视口固定，所以随页面翻滚布景不动，相当于布景被设置在了 body 上。也就是说给任何元素的布景图设置 background-attachment:fixed;效果都是一样的，都是相关于视口，因为一个网页只要一个视口，该布景和元素现已没关系</p>
<p>所以分别给这两个元素添加这个属性,但要注意的是填充方式需要相同,否则会有错位的现象, background 最后一个属性就是 background-attachment 的简写形式.</p>
<p>最后通过一个负数的 margin 来解决模糊效果在临近边界的时候会衰弱, 并用外层元素的 <code>overflow:hidden</code> 把多余的部分剪裁掉</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>) <span class="number">0</span> / cover fixed;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: -<span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>) <span class="number">0</span> / cover fixed;</span><br><span class="line">  <span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">20px</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-source/react/⑦Diff算法"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/3686962dff4f/"
    >React源码分析 ⑦ Diff 算法</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/3686962dff4f/" class="article-date">
  <time datetime="2022-03-28T07:40:23.000Z" itemprop="datePublished">2022-03-28</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="设计动机"><a href="#设计动机" class="headerlink" title="设计动机"></a>设计动机</h4><p>调用 React 的 render() 方法，会创建一棵由 React 元素组成的树。在下一次 state 或 props 更新时，相同的 render() 方法会返回一棵不同的树。React 需要基于这两棵树之间的差别来判断如何高效的更新 UI，以保证当前 UI 与最新的树保持同步。</p>
<p>将一棵树转换成另一棵树的最小操作次数,即使使用最优的算法，该算法的复杂程度仍为 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.832ex" height="2.451ex" role="img" focusable="false" viewBox="0 -833.2 2577.6 1083.2" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-31-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-31-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-31-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-31-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-31-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D442" xlink:href="#MJX-31-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763,0)"><use data-c="28" xlink:href="#MJX-31-TEX-N-28"></use></g><g data-mml-node="msup" transform="translate(1152,0)"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-31-TEX-I-1D45B"></use></g><g data-mml-node="mn" transform="translate(633,363) scale(0.707)"><use data-c="33" xlink:href="#MJX-31-TEX-N-33"></use></g></g><g data-mml-node="mo" transform="translate(2188.6,0)"><use data-c="29" xlink:href="#MJX-31-TEX-N-29"></use></g></g></g></svg></mjx-container>，其中 n 是树中元素的数量。</p>
<p>如果在 React 中使用该算法，那么展示 1000 个元素则需要 10 亿次的比较。这个开销实在是太过高昂。于是 React 在以下两个假设的基础之上提出了一套 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2141 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-30-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-30-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-30-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-30-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D442" xlink:href="#MJX-30-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763,0)"><use data-c="28" xlink:href="#MJX-30-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152,0)"><use data-c="1D45B" xlink:href="#MJX-30-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(1752,0)"><use data-c="29" xlink:href="#MJX-30-TEX-N-29"></use></g></g></g></svg></mjx-container> 的启发式算法：</p>
<ul>
<li>两个不同类型的元素会产生出不同的树；</li>
<li>开发者可以通过设置 key 属性，来告知渲染哪些子元素在不同的渲染下可以保存不变；</li>
</ul>
<p>换一种说法就是 :</p>
<ul>
<li>只对同级比较，跨层级的 dom 不会进行复用</li>
<li>不同类型节点生成的 dom 树不同，此时会直接销毁老节点及子孙节点，并新建节点</li>
<li>可以通过 key 来对元素 diff 的过程提供复用的条件</li>
</ul>
<h4 id="单节点-Diff"><a href="#单节点-Diff" class="headerlink" title="单节点 Diff"></a>单节点 Diff</h4><ul>
<li>key 和 type 相同表示可以复用节点</li>
<li>type 不同直接标记删除节点，然后新建节点</li>
<li>key 相同 type 不同，标记删除该节点和兄弟节点，然后新创建节点</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eg1</span></span><br><span class="line"><span class="keyword">const</span> A = <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">key</span>=<span class="string">&quot;a&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> B = <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">kay</span>=<span class="string">&quot;a&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// eg2</span></span><br><span class="line"><span class="keyword">const</span> A = <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">key</span>=<span class="string">&quot;a&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> B = <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">kay</span>=<span class="string">&quot;b&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<p>还记得 <a href="/posts/7db523698f9f/#reconcileChildren">reconcileChildren</a> 方法么, 它是双缓存 Fiber 构建时候调用的方法,因为<strong>新的节点是单节点</strong>,所以会进入 <code>reconcileSingleElement</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//                              div Fiber    span 0 Fiber      span 1 JSXElement</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileSingleElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">  returnFiber,</span></span><br><span class="line"><span class="params">  currentFirstChild,</span></span><br><span class="line"><span class="params">  element,</span></span><br><span class="line"><span class="params">  lanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> key = element.<span class="property">key</span>;</span><br><span class="line">  <span class="keyword">var</span> child = currentFirstChild;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to the first item in the list.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (child.<span class="property">key</span> === key) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (child.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">Fragment</span>: &#123;</span><br><span class="line">          <span class="keyword">if</span> (element.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span>) &#123;</span><br><span class="line">            <span class="title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="property">sibling</span>);</span><br><span class="line">            <span class="keyword">var</span> existing = <span class="title function_">useFiber</span>(child, element.<span class="property">props</span>.<span class="property">children</span>);</span><br><span class="line">            existing.<span class="property">return</span> = returnFiber;</span><br><span class="line">            <span class="keyword">return</span> existing;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">Block</span>:</span><br><span class="line"></span><br><span class="line">        <span class="attr">default</span>: <span class="comment">// key 相同 type 相同 eg1</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            child.<span class="property">elementType</span> === element.<span class="property">type</span> ||</span><br><span class="line">            <span class="comment">// Keep this check inline so it only runs on the false path:</span></span><br><span class="line">            <span class="title function_">isCompatibleFamilyForHotReloading</span>(child, element)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="comment">// 因为新的节点是单节点,所以新的fiber节点不会再有兄弟节点</span></span><br><span class="line">            <span class="comment">// 在重用之前兄弟节点标记为删除</span></span><br><span class="line">            <span class="title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="property">sibling</span>);</span><br><span class="line">            <span class="comment">// 通过 createWorkInProgress clone节点</span></span><br><span class="line">            <span class="comment">// _existing3.sibling = null 因为上面的删除只是标记,而在链表中需要真正删除sibling属性</span></span><br><span class="line">            <span class="comment">// 官方注释为: 在这里把 sibling 赋值为 null, 因为返回节点前很容易忘记赋值</span></span><br><span class="line">            <span class="keyword">var</span> _existing3 = <span class="title function_">useFiber</span>(child, element.<span class="property">props</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ref 属性相关操作,重新为ref节点赋值</span></span><br><span class="line">            _existing3.<span class="property">ref</span> = <span class="title function_">coerceRef</span>(returnFiber, child, element);</span><br><span class="line">            _existing3.<span class="property">return</span> = returnFiber;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回 clone 的节点</span></span><br><span class="line">            <span class="keyword">return</span> _existing3;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="comment">// Didn&#x27;t match.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// key 相同 type 不同,节点本身和兄弟节点全部标记为删除, eg3</span></span><br><span class="line">      <span class="comment">// ke 相同表示两个节点是对应的,所以兄弟节点无效标记为删除</span></span><br><span class="line">      <span class="comment">// 但是type类型不同所以不能复用所以节点本身也需要标记为删除</span></span><br><span class="line">      <span class="title function_">deleteRemainingChildren</span>(returnFiber, child);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果 key 不相同,直接将这个节点删掉 eg2</span></span><br><span class="line">      <span class="title function_">deleteChild</span>(returnFiber, child);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 看兄弟节点是否可以通过 key 相同复用,例如</span></span><br><span class="line">    <span class="comment">// current [a, p, span]</span></span><br><span class="line">    <span class="comment">// new     p</span></span><br><span class="line">    <span class="comment">// 兄弟节点中有一个 p 节点可以复用</span></span><br><span class="line">    child = child.<span class="property">sibling</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果没有节点可以复用, 就通过 JSXElement 创建一个新的 Fiber 节点</span></span><br><span class="line">  <span class="keyword">if</span> (element.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> created = <span class="title function_">createFiberFromFragment</span>(</span><br><span class="line">      element.<span class="property">props</span>.<span class="property">children</span>,</span><br><span class="line">      returnFiber.<span class="property">mode</span>,</span><br><span class="line">      lanes,</span><br><span class="line">      element.<span class="property">key</span></span><br><span class="line">    );</span><br><span class="line">    created.<span class="property">return</span> = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> _created4 = <span class="title function_">createFiberFromElement</span>(element, returnFiber.<span class="property">mode</span>, lanes);</span><br><span class="line"></span><br><span class="line">    _created4.<span class="property">ref</span> = <span class="title function_">coerceRef</span>(returnFiber, currentFirstChild, element);</span><br><span class="line">    _created4.<span class="property">return</span> = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> _created4;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多节点-diff"><a href="#多节点-diff" class="headerlink" title="多节点 diff"></a>多节点 diff</h4><p>react 用 3 次循环实现了 react diff 算法, 下面是整个方法中的全局变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Diff结果的第一个节点</span></span><br><span class="line"><span class="keyword">var</span> resultingFirstChild = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 新的子元素数组的集合</span></span><br><span class="line"><span class="keyword">var</span> knownKeys = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line"><span class="comment">// 上次可复用的位置</span></span><br><span class="line"><span class="keyword">var</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 当前对比的老的元素</span></span><br><span class="line"><span class="keyword">var</span> oldFiber = currentFirstChild;</span><br><span class="line"><span class="comment">// 保存老的节点中下一个需要对比的元素</span></span><br><span class="line"><span class="keyword">var</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 计数器,记录新元素遍历到的位置</span></span><br><span class="line"><span class="keyword">var</span> newIdx = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><strong>第一次循环</strong></p>
<ul>
<li>用 <code>newChildren[newIdx]</code> 与 <code>oldFiber</code> 比较<ul>
<li>如果新元素是 reactElement<ul>
<li>key 相同,type 相同, 则会使用 useFiber 复用节点</li>
<li>key 相同,type 不同, 通过 JSXElement 创建新的节点</li>
<li>key 不同, 直接跳出循环,可能存在移动,用下一个循环处理</li>
</ul>
</li>
<li>如果新元素是文本元素<ul>
<li>由于文本元素没有 key,所以老的节点如果有 key,那么元素类型一定不同,直接跳出循环,等待下一个循环处理</li>
<li>如果老的节点没有 key, 是否 <code>tag=HostText</code>,如果是则 useFiber 复用节点,如果不是 createFiberFromText 创建节点</li>
</ul>
</li>
<li>如果新元素是数组<ul>
<li>老元素没有 key, 直接跳出循环</li>
<li>老元素有 key 且 <code>oldFiber.tag===Fragment</code>, 通过 createFiberFromFragment 创建新的子元素</li>
<li>老元素有 key 且 <code>oldFiber.tag!==Fragment</code>, useFiber 复用节点</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>在复用或创建节点的同时也会传入新的 props 属性, 新的属性在 <a href="/posts/3aa5257401aa/#diffProperties">diffProperties</a> 的时候会被解析,并添加到 updateQueue 中</p>
<p>如果不需要跳出循环, 通过 <code>newFiber.alternate === null</code> 判断返回的节点是复用的还是新建的,因为新建的节点没有 <code>alternate</code>,如果是新建的节点, oldFiber 的服级节点上删除 oldFiber, 因为已经有了新节点,且老的节点也没有被使用</p>
<p>下一步是给新的 Fiber 添加位置信息,调用 placeChild 方法, <code>newFiber.index = newIndex</code>, 并给 lastPlacedIndex 赋值<br>如果是新建的节点,会被标记为插入, lastPlacedIndex 不变,因为这个位置不能复用,如果是复用节点的 <code>index &lt; lastPlacedIndex</code>,说明节点被移动了会打上移动的标记, 如果 <code>index &gt;= lastPlacedIndex</code> 节点位置不需要移动, 因为所有小于这个节点位置的元素都会被移动到后面.</p>
<p>总结: 第一个循环主要处理属性的更新, key 不同则循环结束</p>
<p><strong>第二次循环</strong></p>
<p>如果 <code>oldFiber</code> 已经遍历到头, <code>newChildren</code> 还有剩余, 则会进入第二个循环, 将 <code>newChildren</code> 剩余的子元素,全部新建,并且标记为插入</p>
<p><strong>第三次循环</strong></p>
<p>如果第一次循环提前跳出, <code>oldFiber</code>, <code>newChildren</code> 都有剩余则会进入第三次循环</p>
<p>首先把 <code>oldFiber</code> 转换成 map 格式,方便用 key 迅速查找对应的节点,如果新元素的 key 在 map 中存在则复用节点,如果不存在则新建节点</p>
<p>调用第一次循环中的 placeChild , 为元素排序</p>
<p><img src="/posts/3686962dff4f/0001.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildrenArray</span>(<span class="params"></span></span><br><span class="line"><span class="params">  returnFiber,</span></span><br><span class="line"><span class="params">  currentFirstChild,</span></span><br><span class="line"><span class="params">  newChildren,</span></span><br><span class="line"><span class="params">  lanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// First, validate keys.</span></span><br><span class="line">    <span class="keyword">var</span> knownKeys = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; newChildren.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> child = newChildren[i];</span><br><span class="line">      knownKeys = <span class="title function_">warnOnInvalidKey</span>(child, knownKeys, returnFiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> resultingFirstChild = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> previousNewFiber = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> oldFiber = currentFirstChild;</span><br><span class="line">  <span class="keyword">var</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> newIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldFiber.<span class="property">index</span> &gt; newIdx) &#123;</span><br><span class="line">      nextOldFiber = oldFiber;</span><br><span class="line">      oldFiber = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nextOldFiber = oldFiber.<span class="property">sibling</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> newFiber = <span class="title function_">updateSlot</span>(</span><br><span class="line">      returnFiber,</span><br><span class="line">      oldFiber,</span><br><span class="line">      newChildren[newIdx],</span><br><span class="line">      lanes</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> This breaks on empty slots like null children. That&#x27;s</span></span><br><span class="line">      <span class="comment">// unfortunate because it triggers the slow path all the time. We need</span></span><br><span class="line">      <span class="comment">// a better way to communicate whether this was a miss or null,</span></span><br><span class="line">      <span class="comment">// boolean, undefined, etc.</span></span><br><span class="line">      <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        oldFiber = nextOldFiber;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldFiber &amp;&amp; newFiber.<span class="property">alternate</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We matched the slot, but we didn&#x27;t reuse the existing fiber, so we</span></span><br><span class="line">        <span class="comment">// need to delete the existing child.</span></span><br><span class="line">        <span class="title function_">deleteChild</span>(returnFiber, oldFiber);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastPlacedIndex = <span class="title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">      resultingFirstChild = newFiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Defer siblings if we&#x27;re not at the right index for this slot.</span></span><br><span class="line">      <span class="comment">// I.e. if we had null values before, then we want to defer this</span></span><br><span class="line">      <span class="comment">// for each null value. However, we also don&#x27;t want to call updateSlot</span></span><br><span class="line">      <span class="comment">// with the previous one.</span></span><br><span class="line">      previousNewFiber.<span class="property">sibling</span> = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    previousNewFiber = newFiber;</span><br><span class="line">    oldFiber = nextOldFiber;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newIdx === newChildren.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// We&#x27;ve reached the end of the new children. We can delete the rest.</span></span><br><span class="line">    <span class="title function_">deleteRemainingChildren</span>(returnFiber, oldFiber);</span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If we don&#x27;t have any more existing children we can choose a fast path</span></span><br><span class="line">    <span class="comment">// since the rest will all be insertions.</span></span><br><span class="line">    <span class="keyword">for</span> (; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">      <span class="keyword">var</span> _newFiber = <span class="title function_">createChild</span>(returnFiber, newChildren[newIdx], lanes);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (_newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      lastPlacedIndex = <span class="title function_">placeChild</span>(_newFiber, lastPlacedIndex, newIdx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">        resultingFirstChild = _newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.<span class="property">sibling</span> = _newFiber;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      previousNewFiber = _newFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125; <span class="comment">// Add all children to a key map for quick lookups.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> existingChildren = <span class="title function_">mapRemainingChildren</span>(returnFiber, oldFiber); <span class="comment">// Keep scanning and use the map to restore deleted items as moves.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">var</span> _newFiber2 = <span class="title function_">updateFromMap</span>(</span><br><span class="line">      existingChildren,</span><br><span class="line">      returnFiber,</span><br><span class="line">      newIdx,</span><br><span class="line">      newChildren[newIdx],</span><br><span class="line">      lanes</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_newFiber2 !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_newFiber2.<span class="property">alternate</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// The new fiber is a work in progress, but if there exists a</span></span><br><span class="line">          <span class="comment">// current, that means that we reused the fiber. We need to delete</span></span><br><span class="line">          <span class="comment">// it from the child list so that we don&#x27;t add it to the deletion</span></span><br><span class="line">          <span class="comment">// list.</span></span><br><span class="line">          existingChildren.<span class="title function_">delete</span>(</span><br><span class="line">            _newFiber2.<span class="property">key</span> === <span class="literal">null</span> ? newIdx : _newFiber2.<span class="property">key</span></span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      lastPlacedIndex = <span class="title function_">placeChild</span>(_newFiber2, lastPlacedIndex, newIdx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        resultingFirstChild = _newFiber2;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.<span class="property">sibling</span> = _newFiber2;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      previousNewFiber = _newFiber2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">    <span class="comment">// Any existing children that weren&#x27;t consumed above were deleted. We need</span></span><br><span class="line">    <span class="comment">// to add them to the deletion list.</span></span><br><span class="line">    existingChildren.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">child</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">deleteChild</span>(returnFiber, child);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="属性-Diff"><a href="#属性-Diff" class="headerlink" title="属性 Diff"></a>属性 Diff</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">diffProperties</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domElement,</span></span><br><span class="line"><span class="params">  tag,</span></span><br><span class="line"><span class="params">  lastRawProps,</span></span><br><span class="line"><span class="params">  nextRawProps,</span></span><br><span class="line"><span class="params">  rootContainerElement</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// lastRawProps &#123;children:&#x27;内容&#x27;&#125;</span></span><br><span class="line">  <span class="comment">// nextRawProps &#123;children:&#x27;内容改变&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> updatePayload = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> lastProps;</span><br><span class="line">  <span class="keyword">var</span> nextProps;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这些元素类型,会被添加上特有的元素默认属性</span></span><br><span class="line">  <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;input&quot;</span>:</span><br><span class="line">      lastProps = <span class="title function_">getHostProps</span>(domElement, lastRawProps);</span><br><span class="line">      nextProps = <span class="title function_">getHostProps</span>(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;option&quot;</span>:</span><br><span class="line">      lastProps = <span class="title function_">getHostProps$1</span>(domElement, lastRawProps);</span><br><span class="line">      nextProps = <span class="title function_">getHostProps$1</span>(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;select&quot;</span>:</span><br><span class="line">      lastProps = <span class="title function_">getHostProps$2</span>(domElement, lastRawProps);</span><br><span class="line">      nextProps = <span class="title function_">getHostProps$2</span>(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;textarea&quot;</span>:</span><br><span class="line">      lastProps = <span class="title function_">getHostProps$3</span>(domElement, lastRawProps);</span><br><span class="line">      nextProps = <span class="title function_">getHostProps$3</span>(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      lastProps = lastRawProps;</span><br><span class="line">      nextProps = nextRawProps;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="keyword">typeof</span> lastProps.<span class="property">onClick</span> !== <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> nextProps.<span class="property">onClick</span> === <span class="string">&quot;function&quot;</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This cast may not be sound for SVG, MathML or custom elements.</span></span><br><span class="line">        <span class="title function_">trapClickOnNonInteractiveElement</span>(domElement);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证一些特殊属性,是否合法 例如 dangerouslySetInnerHTML</span></span><br><span class="line">  <span class="title function_">assertValidProps</span>(tag, nextProps);</span><br><span class="line">  <span class="keyword">var</span> propKey;</span><br><span class="line">  <span class="keyword">var</span> styleName;</span><br><span class="line">  <span class="keyword">var</span> styleUpdates = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (propKey <span class="keyword">in</span> lastProps) &#123;</span><br><span class="line">    <span class="comment">// 如果旧的属性没有,而新的属性有,那个就跳出直接分析新的属性</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      nextProps.<span class="title function_">hasOwnProperty</span>(propKey) ||</span><br><span class="line">      !lastProps.<span class="title function_">hasOwnProperty</span>(propKey) ||</span><br><span class="line">      lastProps[propKey] == <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propKey === <span class="variable constant_">STYLE</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> lastStyle = lastProps[propKey];</span><br><span class="line">      <span class="comment">// 如果是style属性,提取出属性的key</span></span><br><span class="line">      <span class="keyword">for</span> (styleName <span class="keyword">in</span> lastStyle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastStyle.<span class="title function_">hasOwnProperty</span>(styleName)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">            styleUpdates = &#123;&#125;;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          styleUpdates[styleName] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">DANGEROUSLY_SET_INNER_HTML</span> || propKey === <span class="variable constant_">CHILDREN</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      propKey === <span class="variable constant_">SUPPRESS_CONTENT_EDITABLE_WARNING</span> ||</span><br><span class="line">      propKey === <span class="variable constant_">SUPPRESS_HYDRATION_WARNING</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">AUTOFOCUS</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameDependencies.<span class="title function_">hasOwnProperty</span>(propKey)) &#123;</span><br><span class="line">      <span class="comment">// This is a special case. If any listener updates we need to ensure</span></span><br><span class="line">      <span class="comment">// that the &quot;current&quot; fiber pointer gets updated so we need a commit</span></span><br><span class="line">      <span class="comment">// to update this element.</span></span><br><span class="line">      <span class="keyword">if</span> (!updatePayload) &#123;</span><br><span class="line">        updatePayload = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// For all other deleted properties we add it to the queue. We use</span></span><br><span class="line">      <span class="comment">// the allowed property list in the commit phase instead.</span></span><br><span class="line">      (updatePayload = updatePayload || []).<span class="title function_">push</span>(propKey, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (propKey <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">    <span class="keyword">var</span> nextProp = nextProps[propKey];</span><br><span class="line">    <span class="keyword">var</span> lastProp = lastProps != <span class="literal">null</span> ? lastProps[propKey] : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果新的属性值为假,或者没有变化,就跳出循环</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !nextProps.<span class="title function_">hasOwnProperty</span>(propKey) ||</span><br><span class="line">      nextProp === lastProp ||</span><br><span class="line">      (nextProp == <span class="literal">null</span> &amp;&amp; lastProp == <span class="literal">null</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propKey === <span class="variable constant_">STYLE</span>) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextProp) &#123;</span><br><span class="line">          <span class="comment">// Freeze the next style object so that we can assume it won&#x27;t be</span></span><br><span class="line">          <span class="comment">// mutated. We have already warned for this in the past.</span></span><br><span class="line">          <span class="title class_">Object</span>.<span class="title function_">freeze</span>(nextProp);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (lastProp) &#123;</span><br><span class="line">        <span class="comment">// Unset styles on `lastProp` but not on `nextProp`.</span></span><br><span class="line">        <span class="keyword">for</span> (styleName <span class="keyword">in</span> lastProp) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            lastProp.<span class="title function_">hasOwnProperty</span>(styleName) &amp;&amp;</span><br><span class="line">            (!nextProp || !nextProp.<span class="title function_">hasOwnProperty</span>(styleName))</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">              styleUpdates = &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            styleUpdates[styleName] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="comment">// Update styles that changed since `lastProp`.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (styleName <span class="keyword">in</span> nextProp) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            nextProp.<span class="title function_">hasOwnProperty</span>(styleName) &amp;&amp;</span><br><span class="line">            lastProp[styleName] !== nextProp[styleName]</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">              styleUpdates = &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            styleUpdates[styleName] = nextProp[styleName];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Relies on `updateStylesByID` not mutating `styleUpdates`.</span></span><br><span class="line">        <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!updatePayload) &#123;</span><br><span class="line">            updatePayload = [];</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          updatePayload.<span class="title function_">push</span>(propKey, styleUpdates);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        styleUpdates = nextProp;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">DANGEROUSLY_SET_INNER_HTML</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> nextHtml = nextProp ? nextProp[<span class="variable constant_">HTML</span>$<span class="number">1</span>] : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">var</span> lastHtml = lastProp ? lastProp[<span class="variable constant_">HTML</span>$<span class="number">1</span>] : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextHtml != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastHtml !== nextHtml) &#123;</span><br><span class="line">          (updatePayload = updatePayload || []).<span class="title function_">push</span>(propKey, nextHtml);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  会以数组的形式,同时插入 key 和 value [&#x27;children&#x27;,&#x27;内容改变&#x27;]</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">CHILDREN</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp === <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> nextProp === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">        (updatePayload = updatePayload || []).<span class="title function_">push</span>(propKey, <span class="string">&quot;&quot;</span> + nextProp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      propKey === <span class="variable constant_">SUPPRESS_CONTENT_EDITABLE_WARNING</span> ||</span><br><span class="line">      propKey === <span class="variable constant_">SUPPRESS_HYDRATION_WARNING</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameDependencies.<span class="title function_">hasOwnProperty</span>(propKey)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextProp != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We eagerly listen to this even though we haven&#x27;t committed yet.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp !== <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">          <span class="title function_">warnForInvalidEventListener</span>(propKey, nextProp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (propKey === <span class="string">&quot;onScroll&quot;</span>) &#123;</span><br><span class="line">          <span class="title function_">listenToNonDelegatedEvent</span>(<span class="string">&quot;scroll&quot;</span>, domElement);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!updatePayload &amp;&amp; lastProp !== nextProp) &#123;</span><br><span class="line">        <span class="comment">// This is a special case. If any listener updates we need to ensure</span></span><br><span class="line">        <span class="comment">// that the &quot;current&quot; props pointer gets updated so we need a commit</span></span><br><span class="line">        <span class="comment">// to update this element.</span></span><br><span class="line">        updatePayload = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="keyword">typeof</span> nextProp === <span class="string">&quot;object&quot;</span> &amp;&amp;</span><br><span class="line">      nextProp !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      nextProp.<span class="property">$$typeof</span> === <span class="variable constant_">REACT_OPAQUE_ID_TYPE</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If we encounter useOpaqueReference&#x27;s opaque object, this means we are hydrating.</span></span><br><span class="line">      <span class="comment">// In this case, call the opaque object&#x27;s toString function which generates a new client</span></span><br><span class="line">      <span class="comment">// ID so client and server IDs match and throws to rerender.</span></span><br><span class="line">      nextProp.<span class="title function_">toString</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// For any other property we always add it to the queue and then we</span></span><br><span class="line">      <span class="comment">// filter it out using the allowed property list during the commit.</span></span><br><span class="line">      (updatePayload = updatePayload || []).<span class="title function_">push</span>(propKey, nextProp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (styleUpdates) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="title function_">validateShorthandPropertyCollisionInDev</span>(styleUpdates, nextProps[<span class="variable constant_">STYLE</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (updatePayload = updatePayload || []).<span class="title function_">push</span>(<span class="variable constant_">STYLE</span>, styleUpdates);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> updatePayload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/6/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> SunZhiqi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.png" alt="四月八日"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Essay">随笔</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>此时无声胜有声！</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="/js/jquery.modal.min.js"></script>
<link rel="stylesheet" href="/css/jquery.modal.min.css" />
<script src="/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
  <div class="pswp__bg"></div>

  <!-- Slides wrapper with overflow:hidden. -->
  <div class="pswp__scroll-wrap">
    <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>

    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <!--  Controls are self-explanatory. Order can be changed. -->

        <div class="pswp__counter"></div>

        <button
          class="pswp__button pswp__button--close"
          title="Close (Esc)"
        ></button>

        <button
          class="pswp__button pswp__button--share"
          style="display: none"
          title="Share"
        ></button>

        <button
          class="pswp__button pswp__button--fs"
          title="Toggle fullscreen"
        ></button>

        <button
          class="pswp__button pswp__button--zoom"
          title="Zoom in/out"
        ></button>

        <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
        <!-- element will get class pswp__preloader--active when preloader is running -->
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip"></div>
      </div>

      <button
        class="pswp__button pswp__button--arrow--left"
        title="Previous (arrow left)"
      ></button>

      <button
        class="pswp__button pswp__button--arrow--right"
        title="Next (arrow right)"
      ></button>

      <div class="pswp__caption">
        <div class="pswp__caption__center"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/photoswipe.min.css" />
<link rel="stylesheet" href="/css/default-skin.min.css" />
<script src="/js/photoswipe.min.js"></script>
<script src="/js/photoswipe-ui-default.min.js"></script>

<script>
  function viewer_init() {
    let pswpElement = document.querySelectorAll(".pswp")[0];
    let $imgArr = document.querySelectorAll(
      ".article-entry img:not(.reward-img)"
    );

    $imgArr.forEach(($em, i) => {
      $em.onclick = () => {
        // slider展开状态
        // todo: 这样不好，后面改成状态
        if (document.querySelector(".left-col.show")) return;
        let items = [];
        $imgArr.forEach(($em2, i2) => {
          let img = $em2.getAttribute("data-idx", i2);
          let src =
            $em2.getAttribute("data-target") || $em2.getAttribute("src");
          let title = $em2.getAttribute("alt");
          // 获得原图尺寸
          const image = new Image();
          image.src = src;
          items.push({
            src: src,
            w: image.width || $em2.width,
            h: image.height || $em2.height,
            title: title,
          });
        });
        var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
          index: parseInt(i),
        });
        gallery.init();
      };
    });
  }
  viewer_init();
</script>
 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="/js/MathJax.js"></script>
<script src="/js/TeX-AMS-MML_HTMLorMML-full.js"></script>

<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="/js/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !(function (e, t, a) {
    var initCopyCode = function () {
      var copyHtml = "";
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += "</button>";
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS(".btn-copy", {
        target: function (trigger) {
          return trigger.nextElementSibling;
        },
      });
      clipboard.on("success", function (e) {
        let $btn = $(e.trigger);
        $btn.addClass("copied");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-checkbox-circle-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPIED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-checkbox-circle-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
      clipboard.on("error", function (e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass("copy-failed");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-time-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPY FAILED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-time-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
    };
    initCopyCode();
  })(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "default" });
  }
</script>


    
    

  </div>
</body>

</html>