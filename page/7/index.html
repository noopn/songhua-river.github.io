<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="前端 web react" />
       
      <meta name="description" content="前端技术与生活。" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 四月八日</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">
 
<link rel="stylesheet" href="/css/fonts/remixicon.css">
 
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="/js/pace.min.js"></script>
       
 

      <link rel="stylesheet" href="/css/bulma.min.css" />
      <script src="/js/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <script src="https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js"></script>
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/katex.min.css">

<link rel="stylesheet" href="/css/style.css">
<!-- hexo injector head_end end --></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">四月八日</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['愿你足够强大，也要足够温柔', '最轻的并不是一根羽毛，而是一双飞鸟的翅膀', ''],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="posts-source/react/⑥Fiber与Effect链表"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/2a574ab5dfc0/"
    >React源码分析 ⑥ Fiber与Effects链表</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/2a574ab5dfc0/" class="article-date">
  <time datetime="2022-03-21T05:16:15.000Z" itemprop="datePublished">2022-03-21</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">App</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [content, setContent] = <span class="title function_">useState</span>(<span class="string">&quot;内容&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setContent(&quot;内容改变&quot;)&#125; role=&quot;presentation&quot;&gt;</span></span><br><span class="line"><span class="language-xml">        标题</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;content&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> 2020.01.01</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>回到 completeUnitOfWork 方法,看一下链表的创建过程</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">completeUnitOfWork</span>(<span class="params">unitOfWork</span>) &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="title function_">completeWork</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.<span class="property">flags</span> &amp; <span class="title class_">Incomplete</span>) === <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="title function_">setCurrentFiber</span>(completedWork);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        returnFiber !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// Do not append effects to parents if a sibling failed to complete</span></span><br><span class="line">        (returnFiber.<span class="property">flags</span> &amp; <span class="title class_">Incomplete</span>) === <span class="title class_">NoFlags</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Append all the effects of the subtree and this fiber onto the effect</span></span><br><span class="line">        <span class="comment">// list of the parent. The completion order of the children affects the</span></span><br><span class="line">        <span class="comment">// side-effect order.</span></span><br><span class="line">        <span class="keyword">if</span> (returnFiber.<span class="property">firstEffect</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">          returnFiber.<span class="property">firstEffect</span> = completedWork.<span class="property">firstEffect</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (completedWork.<span class="property">lastEffect</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (returnFiber.<span class="property">lastEffect</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.<span class="property">lastEffect</span>.<span class="property">nextEffect</span> = completedWork.<span class="property">firstEffect</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          returnFiber.<span class="property">lastEffect</span> = completedWork.<span class="property">lastEffect</span>;</span><br><span class="line">        &#125; <span class="comment">// If this fiber had side-effects, we append it AFTER the children&#x27;s</span></span><br><span class="line">        <span class="comment">// side-effects. We can perform certain side-effects earlier if needed,</span></span><br><span class="line">        <span class="comment">// by doing multiple passes over the effect list. We don&#x27;t want to</span></span><br><span class="line">        <span class="comment">// schedule our own side-effect on our own list because if end up</span></span><br><span class="line">        <span class="comment">// reusing children we&#x27;ll schedule this effect onto itself since we&#x27;re</span></span><br><span class="line">        <span class="comment">// at the end.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> flags = completedWork.<span class="property">flags</span>;</span><br><span class="line">        <span class="comment">// Skip both NoWork and PerformedWork tags when creating the effect</span></span><br><span class="line">        <span class="comment">// list. PerformedWork effect is read by React DevTools but shouldn&#x27;t be</span></span><br><span class="line">        <span class="comment">// committed.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建Effect链表时跳过 tag 为 NoWork 和PerformedWork</span></span><br><span class="line">        <span class="comment">// 他们只会被 DevTools 使用不应该提交</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (flags &gt; <span class="title class_">PerformedWork</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (returnFiber.<span class="property">lastEffect</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.<span class="property">lastEffect</span>.<span class="property">nextEffect</span> = completedWork;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            returnFiber.<span class="property">firstEffect</span> = completedWork;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          returnFiber.<span class="property">lastEffect</span> = completedWork;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    completedWork = returnFiber; <span class="comment">// Update the next thing we&#x27;re working on in case something throws.</span></span><br><span class="line"></span><br><span class="line">    workInProgress = completedWork;</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>); <span class="comment">// We&#x27;ve reached the root.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先,分析一下挂载时的链表创建过程, 第一个结束 completeWork 的是 h1 元素, 它的 returnFiber 是 App, 由于 h1 的 flags 是 0, 因为首次渲染是没有标记副作用,所以 App 和 h1 并不会通过 Effect 指针相连, 同理 p 和 文本元素,也是一样处理</p>
<p>下一个节点是 AppFiber, 它的 returnFiber 是 RootFiber, 由于 App 节点首次渲染的时候需要插入到挂载元素中, 所以它有 Placement 副作用,它的值大于 PerformedWork(标记节点处理过的副作用) ,首次挂载时的 Effect 链表如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">returnFiber.<span class="property">firstEffect</span> = completedWork;</span><br><span class="line">returnFiber.<span class="property">lastEffect</span> = completedWork;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/2a574ab5dfc0/0106.png"></p>
<p>更新时, h1 绑定的函数是匿名函数,所以会携带副作用, 因为第一次执行的时候 h1 和它 returnFiber 的 firstEffect 和 lastEffect,都为 null,所以最先建立这两个节点的联系</p>
<p><img src="/posts/2a574ab5dfc0/0001.png"></p>
<p>下一个节点是 p 节点, 它的副作用也需要添加到 Effect 链表上,所以通过 lastEffect 指针找到当前副作用链表的最后一个副作用,它的下一个副作用就是当前的 p 节点</p>
<p>最后调整 returnFiber 的 lastEffect 指针,指向新的副作用 p 节点. 总结来说,如果下一级的子元素携带副作用, 通过 lastEffect 指针找到最后的副作用,并通过 nextEffect 延长 Effect 链表, 如果是上级元素携带副作用,则修改 firstEffect 指针延长 Effect 链表</p>
<p><img src="/posts/2a574ab5dfc0/0002.png"></p>
<p>下面增加一点组件的复杂性</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Box</span>: <span class="title class_">React</span>.<span class="property">FC</span>&lt;&#123; <span class="attr">content</span>: <span class="built_in">string</span> &#125;&gt; = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [<span class="built_in">number</span>, setNumber] = <span class="title function_">useState</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setNumber((v) =&gt; v + 1)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      &#123;props.content&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;number&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">App</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [content, setContent] = <span class="title function_">useState</span>(<span class="string">&quot;内容&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setContent(&quot;内容改变&quot;)&#125; role=&quot;presentation&quot;&gt;</span></span><br><span class="line"><span class="language-xml">        标题 <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;content&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Box</span> <span class="attr">content</span>=<span class="string">&#123;content&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个组件最终形成的 Fiber 树如下</p>
<p><img src="/posts/2a574ab5dfc0/0003.png"></p>
<p>当点击 h1 标签后</p>
<p>第一个进入的是标题文本节点,但是文本节点不存在副作用,所以会跳过这个节点</p>
<p>下一个节点是 P 节点, 内容改变携带了副作用,所以会最先添加到链表中和 returnFiber 也就是 h1 Fiber 相连</p>
<p><img src="/posts/2a574ab5dfc0/0004.png"></p>
<p>下一个节点是 h1 会被拼接到 effectList 最后面, 这次 returnFiber 是 App, 它的 firstEffect 就是 h1 的 firstEffect, 换句话说也就是,上层节点会延长 effect 链表的头部, 会继承上一个节点 firstEffect</p>
<p><img src="/posts/2a574ab5dfc0/0005.png"></p>
<p>下一个节点是 Box 中的文本节点, 会和他的上级节点形成 effect 链表</p>
<p><img src="/posts/2a574ab5dfc0/0006.png"></p>
<p>下一个是 span 节点, 因为还没有点击 p 标签,所以 span 没有携带副作用,直接跳过</p>
<p>下一个是 span 上级的 p 节点, returnFiber 是 Box 会成为新的头部</p>
<p><img src="/posts/2a574ab5dfc0/0007.png"></p>
<p>下一个是个 Box 节点, returnFiber 是 App,相当于在末尾追加了 effect 链表, 所以修改了 App lastEffect 指针,并且延长了 h1 的 nextEffect</p>
<p><img src="/posts/2a574ab5dfc0/0008.png"></p>
<p>最后遍历到根节点 rootFiber 相当于头部延长 effect 链表</p>
<p><img src="/posts/2a574ab5dfc0/0009.png"></p>
<p>当点击 p 标签触发更新, 会重新构建整个 effect 链表, 最先进入 complete 的 span 节点, 所以会和他的父节点生成 effect 链表</p>
<p>构建步骤与第一次更新时类似</p>
<p><img src="/posts/2a574ab5dfc0/0010.png"></p>
<p><img src="/posts/2a574ab5dfc0/0011.png"></p>
<p><img src="/posts/2a574ab5dfc0/0012.png"></p>
<p><img src="/posts/2a574ab5dfc0/0013.png"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-source/react/④render阶段执行流程"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/49df00acbc4a/"
    >React源码分析 ④ render阶段执行流程</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/49df00acbc4a/" class="article-date">
  <time datetime="2022-03-17T07:21:34.000Z" itemprop="datePublished">2022-03-17</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p><img src="/posts/49df00acbc4a/0001.png"></p>
<h4 id="render"><a href="#render" class="headerlink" title="render"></a>render</h4><p>传入 JSXElement 对象和挂载节点.</p>
<p>何验证根节点是否合法,挂载节点为真,且必须是以下节点之一</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isValidContainer</span>(<span class="params">node</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> !!(</span><br><span class="line">    node &amp;&amp;</span><br><span class="line">    (node.<span class="property">nodeType</span> === <span class="variable constant_">ELEMENT_NODE</span> ||</span><br><span class="line">      node.<span class="property">nodeType</span> === <span class="variable constant_">DOCUMENT_NODE</span> ||</span><br><span class="line">      node.<span class="property">nodeType</span> === <span class="variable constant_">DOCUMENT_FRAGMENT_NODE</span> ||</span><br><span class="line">      (node.<span class="property">nodeType</span> === <span class="variable constant_">COMMENT_NODE</span> &amp;&amp;</span><br><span class="line">        node.<span class="property">nodeValue</span> === <span class="string">&quot; react-mount-point-unstable &quot;</span>))</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>挂载节点必须是首次挂载,已经挂载过的节点不能再次执行 <code>React.render(element,container)</code>,首次挂载之后会给元素打上一个标记 <code>__reactContainer$xxx</code> 是一个自定义字符串后面是随机数, 用这个标记来判断元素是否挂载过</p>
<p>而且 <code>internalContainerInstanceKey = FiberRoot</code> 会被赋值为 FiberRoot</p>
<h4 id="legacyRenderSubtreeIntoContainer-null-element-container-false-callback"><a href="#legacyRenderSubtreeIntoContainer-null-element-container-false-callback" class="headerlink" title="legacyRenderSubtreeIntoContainer(null, element, container, false, callback)"></a>legacyRenderSubtreeIntoContainer(null, element, container, false, callback)</h4><p>首先尝试清空挂载节点中的内容,如果挂载节点中有其他的节点已经通过 render 渲染过,会提示错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((rootSibling = container.<span class="property">lastChild</span>)) &#123;</span><br><span class="line">  container.<span class="title function_">removeChild</span>(rootSibling);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里创建出 <code>FiberFoot</code>和<code>RootFiber</code>两个节点, 并且通过指针相互引用</p>
<p><img src="/posts/49df00acbc4a/0002.png"></p>
<p><code>container._reactRootContainer = new ReactDOMBlockingRoot()</code> 挂载元素上会打上一个标记, 赋值为 RootFiber 构造函数的实例,而 render 方法 <code>_reactRootContainer</code> 中与<code>__reactContainer$xxx</code> 共同判断节点是否挂载过</p>
<p>对于已经渲染过的节点会通过 <code>_reactRootContainer</code> 直接复用 <code>FiberRoot</code>, 并执行 <code>updateContainer</code> 批量更新, 如果是首次渲染则执行 <code>unbatchedUpdates</code>非批量更新,立即调用 <code>updateContainer</code>,同步执行尽快展示元素.</p>
<h4 id="updateContainer-element-container-parentComponent-callback"><a href="#updateContainer-element-container-parentComponent-callback" class="headerlink" title="updateContainer(element, container, parentComponent, callback)"></a>updateContainer(element, container, parentComponent, callback)</h4><p>在首次执行前会标记上下文环境,因为也可能是程序运行之后,人为调用非批量更新,所以这个方法可能重复执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存之前的上下文</span></span><br><span class="line"><span class="keyword">var</span> prevExecutionContext = executionContext;</span><br><span class="line"><span class="comment">// 删除掉批量更新的标记</span></span><br><span class="line">executionContext &amp;= ~<span class="title class_">BatchedContext</span>;</span><br><span class="line"><span class="comment">// 添加非批量更新的标记</span></span><br><span class="line">executionContext |= <span class="title class_">LegacyUnbatchedContext</span>;</span><br></pre></td></tr></table></figure>

<p>下面这里定义了几个比较关键的变量</p>
<p><code>requestUpdateLane</code> 传入了 FiberRoot, <span id="requestUpdateLane">计算出更新优先级为 1 (SyncLane)</span></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算一个时间戳</span></span><br><span class="line"><span class="keyword">var</span> eventTime = <span class="title function_">requestEventTime</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算更新优先级</span></span><br><span class="line"><span class="keyword">var</span> lane = <span class="title function_">requestUpdateLane</span>(container.<span class="property">current</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建更新对象并添加到更新队列中</span></span><br><span class="line"><span class="keyword">var</span> update = &#123;</span><br><span class="line">  <span class="attr">eventTime</span>: eventTime,</span><br><span class="line">  <span class="attr">lane</span>: lane,</span><br><span class="line">  <span class="attr">tag</span>: <span class="title class_">UpdateState</span>,</span><br><span class="line">  <span class="comment">// element 是 render 方法中传入的 JSXElement 对象</span></span><br><span class="line">  <span class="attr">payload</span>: &#123;<span class="attr">element</span>:element&#125;,</span><br><span class="line">  <span class="attr">callback</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">next</span>: <span class="literal">null</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// updateQueue 是一个对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> updateQueue = &#123;</span><br><span class="line">  <span class="attr">baseState</span>:<span class="literal">null</span></span><br><span class="line">  <span class="attr">effects</span>:<span class="literal">null</span></span><br><span class="line">  <span class="attr">firstBaseUpdate</span>:<span class="literal">null</span></span><br><span class="line">  <span class="attr">lastBaseUpdate</span>:<span class="literal">null</span></span><br><span class="line">  <span class="attr">shared</span>:&#123;<span class="attr">pending</span>: <span class="literal">null</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果这是第一个更新,会被处理成循环链表</span></span><br><span class="line"><span class="keyword">if</span> (updateQueue.<span class="property">pending</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">  update.<span class="property">next</span> = update;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 如果有了正在等待的更新,则链接到循环链表中</span></span><br><span class="line">  update.<span class="property">next</span> = pending.<span class="property">next</span>;</span><br><span class="line">  pending.<span class="property">next</span> = update;</span><br><span class="line">&#125;</span><br><span class="line">updateQueue.<span class="property">share</span>.<span class="property">pending</span> = update;</span><br></pre></td></tr></table></figure>

<h4 id="scheduleUpdateOnFiber-fiber-lane-eventTime"><a href="#scheduleUpdateOnFiber-fiber-lane-eventTime" class="headerlink" title="scheduleUpdateOnFiber(fiber, lane, eventTime)"></a>scheduleUpdateOnFiber(fiber, lane, eventTime)</h4><p><code>checkForNestedUpdates()</code> 检查是否嵌套的更新过多</p>
<p>拿到上 RootFiber <a href="/posts/d9523506ae81/#requestUpdateLane">计算出的更新优先级</a>, 与 <code>fiber</code> 上的优先级合并,如果当前节点不是根节点会一直递归到根节点. 首次执行时 fiber &#x3D; FiberRoot</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> root = <span class="title function_">markUpdateLaneFromFiberToRoot</span>(fiber, lane);</span><br></pre></td></tr></table></figure>

<p>在 FiberRoot 上更新 pendingLanes</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">markRootUpdated</span>(<span class="params">root, updateLane, eventTime</span>) &#123;</span><br><span class="line">  root.<span class="property">pendingLanes</span> |= updateLane;</span><br><span class="line">  <span class="keyword">var</span> higherPriorityLanes = updateLane - <span class="number">1</span>; <span class="comment">// Turns 0b1000 into 0b0111</span></span><br><span class="line">  <span class="comment">// 处于当前优先级左边的会通过&amp;被删除掉</span></span><br><span class="line">  <span class="comment">// 其实就是删除了较低的优先级</span></span><br><span class="line">  root.<span class="property">suspendedLanes</span> &amp;= higherPriorityLanes;</span><br><span class="line">  root.<span class="property">pingedLanes</span> &amp;= higherPriorityLanes;</span><br><span class="line">  <span class="keyword">var</span> eventTimes = root.<span class="property">eventTimes</span>;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="title function_">laneToIndex</span>(updateLane);</span><br><span class="line">  eventTimes[index] = eventTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取当前的执行优先级 <code>var priorityLevel = getCurrentPriorityLevel()</code> 这个优先级与 lane 是有区别的</p>
<p>检查上下文环境,准备分析构建 Fiber 树</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果传出的优先级是同步的</span></span><br><span class="line"><span class="keyword">if</span> (lane === <span class="title class_">SyncLane</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// 检查是非批量更新的状态</span></span><br><span class="line">    (executionContext &amp; <span class="title class_">LegacyUnbatchedContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">    <span class="comment">// 检查还没有开始渲染</span></span><br><span class="line">    (executionContext &amp; (<span class="title class_">RenderContext</span> | <span class="title class_">CommitContext</span>)) === <span class="title class_">NoContext</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// Register pending interactions on the root to avoid losing traced interaction data.</span></span><br><span class="line">    <span class="title function_">schedulePendingInteractions</span>(root, lane);</span><br><span class="line">    <span class="comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span></span><br><span class="line">    <span class="comment">// root inside of batchedUpdates should be synchronous, but layout updates</span></span><br><span class="line">    <span class="comment">// should be deferred until the end of the batch.</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">performSyncWorkOnRoot</span>(root);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">ensureRootIsScheduled</span>(root, eventTime);</span><br><span class="line">    <span class="title function_">schedulePendingInteractions</span>(root, lane);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (executionContext === <span class="title class_">NoContext</span>) &#123;</span><br><span class="line">      <span class="comment">// Flush the synchronous work now, unless we&#x27;re already working or inside</span></span><br><span class="line">      <span class="comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span></span><br><span class="line">      <span class="comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span></span><br><span class="line">      <span class="comment">// without immediately flushing it. We only do this for user-initiated</span></span><br><span class="line">      <span class="comment">// updates, to preserve historical behavior of legacy mode.</span></span><br><span class="line">      <span class="title function_">resetRenderTimer</span>();</span><br><span class="line">      <span class="title function_">flushSyncCallbackQueue</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// Schedule a discrete update but only if it&#x27;s not Sync.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (executionContext &amp; <span class="title class_">DiscreteEventContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp; <span class="comment">// Only updates at user-blocking priority or greater are considered</span></span><br><span class="line">    <span class="comment">// discrete, even inside a discrete event.</span></span><br><span class="line">    (priorityLevel === <span class="title class_">UserBlockingPriority</span>$<span class="number">2</span> ||</span><br><span class="line">      priorityLevel === <span class="title class_">ImmediatePriority</span>$<span class="number">1</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// This is the result of a discrete event. Track the lowest priority</span></span><br><span class="line">    <span class="comment">// discrete update per root so we can flush them early, if needed.</span></span><br><span class="line">    <span class="keyword">if</span> (rootsWithPendingDiscreteUpdates === <span class="literal">null</span>) &#123;</span><br><span class="line">      rootsWithPendingDiscreteUpdates = <span class="keyword">new</span> <span class="title class_">Set</span>([root]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      rootsWithPendingDiscreteUpdates.<span class="title function_">add</span>(root);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="comment">// Schedule other updates after in case the callback is sync.</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">ensureRootIsScheduled</span>(root, eventTime);</span><br><span class="line">  <span class="title function_">schedulePendingInteractions</span>(root, lane);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="performSyncWorkOnRoot-fiberRoot"><a href="#performSyncWorkOnRoot-fiberRoot" class="headerlink" title="performSyncWorkOnRoot(fiberRoot)"></a>performSyncWorkOnRoot(fiberRoot)</h4><p>执行 <code>renderRootSync(root, lanes)</code></p>
<p>执行结束后,赋值 finishWork 为最新的 Fiber 树,并进入提交节点,渲染元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> finishedWork = root.<span class="property">current</span>.<span class="property">alternate</span>;</span><br><span class="line">root.<span class="property">finishedWork</span> = finishedWork;</span><br><span class="line">root.<span class="property">finishedLanes</span> = lanes;</span><br><span class="line"><span class="title function_">commitRoot</span>(root);</span><br></pre></td></tr></table></figure>

<h4 id="renderRootSync-root-lanes"><a href="#renderRootSync-root-lanes" class="headerlink" title="renderRootSync(root, lanes)"></a>renderRootSync(root, lanes)</h4><p>这个方法可以算是<a href="/posts/7db523698f9f/">构建 Fiber 树</a>的起点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">renderRootSync</span>(<span class="params">root, lanes</span>) &#123;</span><br><span class="line">  <span class="comment">// 缓存执行环境</span></span><br><span class="line">  <span class="keyword">var</span> prevExecutionContext = executionContext;</span><br><span class="line">  <span class="comment">// 执行环境标记为渲染环境</span></span><br><span class="line">  executionContext |= <span class="title class_">RenderContext</span>;</span><br><span class="line">  <span class="comment">// 调用 createWorkInProgress 创建新的 RootFiber 作为 WorkInProgress</span></span><br><span class="line">  <span class="title function_">prepareFreshStack</span>(root, lanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">workLoopSync</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      <span class="title function_">handleError</span>(root, thrownValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">  workInProgressRootRenderLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-css/绘制形状"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/f50453852f11/"
    >CSS艺术 绘制形状</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/f50453852f11/" class="article-date">
  <time datetime="2022-03-07T01:16:42.000Z" itemprop="datePublished">2022-03-07</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/CSS/">CSS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="椭圆"><a href="#椭圆" class="headerlink" title="椭圆"></a>椭圆</h4><p>border-radius 可以指定数值或百分比,当使用百分比的时候,可以让 border 按各自边长计算圆角,实现椭圆</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">box</span> &#123;</span><br><span class="line">  <span class="attr">width</span>: 200px;</span><br><span class="line">  <span class="attr">height</span>: 100px;</span><br><span class="line">  <span class="attr">background</span>: goldenrod;</span><br><span class="line">  border-<span class="attr">radius</span>: <span class="number">50</span>%;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>半橢圓</strong></p>
<p>border-radius 是一个简写的属性, 它的完整属性可以表述四个角的圆角</p>
<p>border-top-left-radius<br>border-top-right-radius<br>border-bottom-left-radius<br>border-bottom-right-radius</p>
<p>属性的两个长度或百分比值定义了椭圆的四分之一外边框的边缘角落的形状。第一个值是水平半径，第二个是垂直半径。如果省略第二个值，它是从第一个复制。如果任一长度为零，角落里是方的，不圆润。水平半径的百分比是指边界框的宽度，而垂直半径的百分比是指边界框的高度。</p>
<p>这样我们只需要指定上边两个角或下边两个角的圆角即可</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">background</span>: goldenrod;</span><br><span class="line">  <span class="attribute">border-top-left-radius</span>: <span class="number">50%</span> <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">border-top-right-radius</span>:<span class="number">50%</span> <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以是使用简写的属性, border-radius 可以用 <code>/</code> 分隔两组值,左边代表四个角的水平半径,右边代表垂直半径</p>
<p>而且不同的个数代表不同的位置,这与 border 类似</p>
<p><span style='display:inline-block;width:200px'>50%</span>             top-left:50% | top-right:50% | bottom-right:50% | bottom-left:50%<br><span style='display:inline-block;width:200px'>50% 40%</span>         top-left:50% | top-right:40% | bottom-right:50% | bottom-left:40%<br><span style='display:inline-block;width:200px'>50% 40% 30%</span>     top-left:50% | top-right:40% | bottom-right:30% | bottom-left:40%<br><span style='display:inline-block;width:200px'>50% 40% 30% 20%</span> top-left:50% | top-right:40% | bottom-right:30% | bottom-left:20%</p>
<p>所以分析一下这个半椭圆</p>
<p><img src="/posts/f50453852f11/0001.png"></p>
<ul>
<li>水平方向上面的两个角是 <code>50%</code>,  暂时可以写为 <code>50% 50% 0 0 / xx xx xx xx</code></li>
<li>垂直方向上面两个角是 <code>100%</code>,现在变为 <code>50% 50% 0 0 / 100% 100% 0 0</code></li>
<li>因为半椭圆的垂直方向占据了整个元素的高度,所以不能使用简写属性, 必须要指定上面两垂直半径是100%, 这样弧度才会从底部延伸到顶部<br>现在垂直半径后两个为0,意味着对应的水平半径即使给了也不会生效,因为不能只通过一个半轴长度画椭圆,最终能够属性会变为 <code>50% / 100% 100% 0 0</code></li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">background</span>: goldenrod;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>/ <span class="number">100%</span> <span class="number">100%</span> <span class="number">0</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理如果你想画一个垂直方向的半椭圆</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">background</span>: goldenrod;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">100%</span> <span class="number">0</span> <span class="number">0</span> <span class="number">100%</span>/<span class="number">50%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1&#x2F;4 椭圆也是同样的道理,只需指定一个角上的半径 </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">background</span>: goldenrod;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">100%</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://simurai.com/archive/buttons/#">这个网址</a>里你可以看到各种通过圆角制作的精美按钮</p>
<p><img src="/posts/f50453852f11/0002.png"></p>
<h4 id="平行四边形-x2F-菱形"><a href="#平行四边形-x2F-菱形" class="headerlink" title="平行四边形&#x2F;菱形"></a>平行四边形&#x2F;菱形</h4><p>你可能很容易想到使用 <code>skew</code>, 但是有一些细节需要注意, 如果 <code>skew</code> 作用在一个有文字的元素上, 那么里面的文字也会被拉伸</p>
<p>想解决这个问题, 可能会想到使用两个元素嵌套, 让里面的元素使用反向 <code>skew</code>, 让文字重新边正</p>
<p>有没有一种方式,可以不嵌套元素,还能让文字不受影响, 办法就是使用 <strong>伪元素</strong>, 因为伪元素和元素本身不属于嵌套关系,所以更容易处理</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.el</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="comment">/* 写文字相关的样式 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 写背景形状相关的样式 */</span></span><br><span class="line"><span class="selector-class">.el</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">right</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* 放在文字元素下面 */</span></span><br><span class="line">  <span class="attribute">z-index</span>: -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于菱形, 是四边相等的平行四边形, 最容易想到的就是旋转一个正方形</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">45deg</span>);</span><br></pre></td></tr></table></figure>

<p>但是中心线长度不相等平行四边形会遇到一点麻烦, 最核心的一个问题就是, 拉伸后的高度应该等于宽度, 以下面这个 宽为100,高为40 的长方形为例</p>
<p><img src="/posts/f50453852f11/0003.png"></p>
<p>想求的是 AGF 的角度, 那么只要求出 FGE 就可以了, <code>sinFGE = AG / FG</code> 所以 <code>FCE = srcsin(40/100)</code> </p>
<p>再把 FCE 转成角度 <code>FCE = srcsin(40/100) * 360 / (2 * PI) = 23.5781(deg)</code></p>
<p>那么 <code>AGF = (90 - 23.57)deg</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line"><span class="attribute">transform</span>: <span class="built_in">skew</span>(-<span class="number">66.43deg</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/posts/f50453852f11/0004.png"></p>
<h4 id="菱形剪裁"><a href="#菱形剪裁" class="headerlink" title="菱形剪裁"></a>菱形剪裁</h4><p>有时候希望一张图片能剪裁成菱形的形状, 我们已经知道菱形如何制作,所以很容易想到用两个元素嵌套</p>
<p>第一步把外层的元素旋转并处理成菱形, 里面的元素反向旋转修正, 又因为拉伸之后图片的上下可能填不满,所以需要通过缩放填满外层元素</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&#x27;box&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(-<span class="number">78deg</span>) <span class="built_in">skew</span>(-<span class="number">66.43deg</span>);</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span> <span class="selector-tag">img</span>&#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">skew</span>(<span class="number">66.43deg</span>) <span class="built_in">scale</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/f50453852f11/0005.png"></p>
<p>除了这种比较传统的方法, 现在我们有了一个新的属性可以完成这个效果 <code>clip-path</code>,  可以指定点的位置并链接成图形, 如果使用百分比会按照自身的尺寸解析</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">img</span>&#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">320px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">180px</span>;</span><br><span class="line">  <span class="attribute">clip-path</span>: <span class="built_in">polygon</span>(<span class="number">50%</span> <span class="number">0</span>,<span class="number">100%</span> <span class="number">50%</span>,<span class="number">50%</span> <span class="number">100%</span>,<span class="number">0</span> <span class="number">50%</span>);</span><br><span class="line">  <span class="attribute">transition</span>: <span class="number">1s</span> clip-path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">img</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">clip-path</span>: <span class="built_in">polygon</span>(<span class="number">0</span> <span class="number">0</span>,<span class="number">100%</span> <span class="number">0</span>,<span class="number">100%</span> <span class="number">100%</span>,<span class="number">0</span> <span class="number">100%</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="切角效果"><a href="#切角效果" class="headerlink" title="切角效果"></a>切角效果</h4><p>看过<a href="/posts/b24d034ad9f9/">背景与边框</a>一章之后,很容易会想到用渐变的方式是来实现,另外通常情况下会考虑使用scss来处理</p>
<p><img src="/posts/f50453852f11/0006.png"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="number">#5a8</span>;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(-<span class="number">45deg</span>, transparent <span class="number">20px</span>, <span class="number">#5a8</span> <span class="number">0</span>) right,</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">45deg</span>, transparent <span class="number">20px</span>, <span class="number">#fd2</span> <span class="number">0</span>) left;</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">50%</span> <span class="number">100%</span>;</span><br><span class="line"><span class="attribute">background-repeat</span>: no-repeat;</span><br></pre></td></tr></table></figure>


<p><img src="/posts/f50453852f11/0007.png"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* hack */</span></span><br><span class="line"><span class="attribute">background</span>: <span class="number">#5a8</span>;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(-<span class="number">135deg</span>, transparent <span class="number">20px</span>, <span class="number">#5a8</span> <span class="number">0</span>) top right,</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, transparent <span class="number">20px</span>, <span class="number">#542</span> <span class="number">0</span>) top left,</span><br><span class="line">  <span class="built_in">linear-gradient</span>(-<span class="number">45deg</span>, transparent <span class="number">20px</span>, <span class="number">#fd2</span> <span class="number">0</span>) bottom right,</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">45deg</span>, transparent <span class="number">20px</span>, <span class="number">#e93</span> <span class="number">0</span>) bottom left;</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">50%</span> <span class="number">50%</span>;</span><br><span class="line"><span class="attribute">background-repeat</span>: no-repeat;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/f50453852f11/0008.png"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="number">#5a8</span>;</span><br><span class="line"><span class="attribute">background</span>: </span><br><span class="line">  <span class="built_in">radial-gradient</span>(circle at top right , transparent <span class="number">20px</span>, <span class="number">#5a8</span> <span class="number">0</span>) top right,</span><br><span class="line">  <span class="built_in">radial-gradient</span>(circle at top left,transparent <span class="number">20px</span>, <span class="number">#542</span> <span class="number">0</span>) top left,</span><br><span class="line">  <span class="built_in">radial-gradient</span>(circle at bottom right, transparent <span class="number">20px</span>, <span class="number">#fd2</span> <span class="number">0</span>) bottom right,</span><br><span class="line">  <span class="built_in">radial-gradient</span>(circle at bottom left, transparent <span class="number">20px</span>, <span class="number">#e93</span> <span class="number">0</span>) bottom left;</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">50%</span> <span class="number">50%</span>;</span><br><span class="line"><span class="attribute">background-repeat</span>: no-repeat;</span><br></pre></td></tr></table></figure>


<p>上面的方法算是比较完美的解决了这个问题,其中有一点不足就是代码量比较多,可能难以维护</p>
<p>还可以换一个思路,使用 svg + border-image 这种解决方案, svg 当作边框背景, 创造一个可以被九宫格分割的svg图片, 让九宫格的四个角为折角就能实现我们的需求</p>
<p>有几个细节需要注意一下, fill 属性需要编码, 需要添加 background-clip 属性,否则背景颜色会延伸到边框区域, 添加一个 border 属性用于hack, 在 border-image 不支持的时候可以回退</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">border</span>: <span class="number">20px</span> solid <span class="number">#58a</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">140px</span>;</span><br><span class="line"><span class="attribute">background-clip</span>: padding-box;</span><br><span class="line"><span class="attribute">background</span>: <span class="number">#58a</span>;</span><br><span class="line"><span class="attribute">border-image</span>: <span class="number">1</span> <span class="built_in">url</span>(<span class="string">&#x27;data:image/svg+xml,\</span></span><br><span class="line"><span class="string">&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;3&quot; height=&quot;3&quot; fill=&quot;%2358a&quot;&gt;\</span></span><br><span class="line"><span class="string">  &lt;polygon points=&quot;0,1 1,0 2,0 3,1 3,2 2,3 1,3 0,2&quot;/&gt;\</span></span><br><span class="line"><span class="string">&lt;/svg&gt;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="梯形"><a href="#梯形" class="headerlink" title="梯形"></a>梯形</h4><p>从上面的平行四边形中可能会受到一点启发,但实际上在二维变化中,没有一种办法可以将矩形或其他图形,转换成梯形.</p>
<p>也许可以想到利用两个伪类实现梯形两边,但是一旦需要添加边框或圆角, 这种中方案立刻就没有了操作性.</p>
<p>既然二维不行,可以思考一下三维中的实现办法, 可以利用透视让矩形的一条边远离我们,从而在视觉上实现梯形的效果.</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">60px</span>;</span><br><span class="line">  <span class="attribute">line-height</span>:<span class="number">60px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: auto;</span><br><span class="line">  <span class="attribute">z-index</span>: -<span class="number">1</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">2px</span> solid darkorchid;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#58a</span>;</span><br><span class="line">  <span class="comment">/* 保持底边固定,整个图形围绕底边旋转 */</span></span><br><span class="line">  <span class="attribute">transform-origin</span>: bottom;</span><br><span class="line">  <span class="comment">/* 第一个属性是景深, 用于表现出3D效果,经过空间旋转的矩形在视觉上高度会缩小, 所以通过放大高度来使变换后的图形和之前的图形,高度相同 */</span></span><br><span class="line">  <span class="attribute">transform</span>:<span class="built_in">perspective</span>(<span class="number">300px</span>) <span class="built_in">rotateX</span>(<span class="number">30deg</span>) <span class="built_in">scaleY</span>(<span class="number">1.25</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当需要只有一边倾斜的梯形是,只需要修改修改变换中心. 这个中心可以理解为视觉中是一个直角坐标系, 这个中心点永远在你视线的正前方.<br>当变换中心设置为 bottom 的时候,相当于把这个元素的底边放在了视线中心上,但是左右两边会被视线中心平分, 所以元素绕 x 轴转动的时候,左右两边因为透视会向中间收缩.<br>当变换中心设置为 bottom ,left 的时候, 除了底边在视线中心上,左边也在视线中心, 所以旋转的时候,左边只有高度的变化,而不会因为透视,向中间收缩,因为这条边垂直与你的视线.</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">  <span class="attribute">transform-origin</span>: bottom left;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">perspective</span>(<span class="number">91px</span>) <span class="built_in">rotateX</span>(<span class="number">18deg</span>) <span class="built_in">scaleY</span>(<span class="number">1.25</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/f50453852f11/0009.png"></p>
<h4 id="饼图"><a href="#饼图" class="headerlink" title="饼图"></a>饼图</h4><p>先思考一下实现一个双色的饼图需要几个元素, 其实两个元素就够了,其中一个是伪元素, 实现思路是把元素的背景色设置成渐变的两半,伪元素大小为元素的一半,这样就可以把底色漏出来,而显示进度的那一半颜色可以用伪元素覆盖住.</p>
<p>通过旋转伪元素,并切换伪元素的颜色来显示饼图的大小, 说起来简单但是实现起来细节很多</p>
<p>先来实现一个 20% 的饼图, 这里用到了 turn 这个表示圈的单位, 0.2turn 表示的就是 0.2 * 360deg, 可以让你免于计算角度</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">background</span>: yellowgreen;</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, transparent <span class="number">50%</span>,<span class="number">#655</span> <span class="number">0</span>);</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>:<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">100%</span> <span class="number">100%</span> <span class="number">0</span> / <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">top</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: inherit;</span><br><span class="line">  <span class="attribute">transform-origin</span>: left center;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">0.2turn</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/f50453852f11/0010.png"></p>
<p>但是当角度超过 50% 就会有一些问题,因为伪类的颜色还是和没有占比区域的颜色相同,所以还没法表现超出 50% 的饼图, 第一步需要修改伪类的颜色</p>
<p>但是伪类已经旋转了 180deg,仅仅改变颜色会和另一半颜色拼在一起显示出一个 100% 的饼图,所以需要减去半圈 0.5turn, 如果表示 70% 只需要旋转 (0.7turn - 0.5turn) &#x3D; 0.2turn 就够了</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">background</span>: yellowgreen;</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, transparent <span class="number">50%</span>,<span class="number">#655</span> <span class="number">0</span>);</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#665</span>;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">0.2turn</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里似乎已经可以实现饼图的效果了,但如果想修改一个比例,我们能会修改颜色,修改圈数,能不能只通过一个属性就控制为元素的颜色和角度,这里会用到很多 animation 相关的属性</p>
<p>第一点需要解决如何让超过 50% 之后,颜色自动改变,可能只用 animation 有这个能力,因为没有什么选择器可以判断元素是不是旋转过了一半,而 animation 可以控制动画的执行位置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">background</span>: yellowgreen;</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, transparent <span class="number">50%</span>,<span class="number">#655</span> <span class="number">0</span>);</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>:<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">100%</span> <span class="number">100%</span> <span class="number">0</span> / <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">top</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: inherit;</span><br><span class="line">  <span class="attribute">transform-origin</span>: left center;</span><br><span class="line">  <span class="attribute">animation</span>: bg <span class="number">100s</span> step-end infinite,ani <span class="number">50s</span> linear infinite;</span><br><span class="line">  <span class="attribute">animation-delay</span>: -<span class="number">10s</span>;</span><br><span class="line">  <span class="attribute">animation-play-state</span>: paused;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> bg &#123;</span><br><span class="line">  <span class="number">50%</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#655</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> ani &#123;</span><br><span class="line">  <span class="selector-tag">to</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">0.5turn</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>step-end 的目的就是在动画指定到一半也就是 50s 的时候,颜色突然改变,而这时也恰好旋转了半圈因为 ani 动画的执行时间是 50s 旋转半圈, 另外需要使用 <code>animation-play-state: paused </code> 把动画暂停住,这样在一个合适的角度就能显示出比例</p>
<p>这里用到了 <code>animation-delay</code> 很少使用到的属性, 一个负的延时时间,这是有意义的,它的行为与 0s 延时类似,都会立即执行动画,但是一个负值表示动画已经开始播放,并且持续了对应的时间,效果就是显示第一帧的时候,好像动画已经播放了这么长时间.所以指定一个负值来表示已经旋转过的角度. 如果是 70% 那可以设置为 <code>animation-delay: -70s</code></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-source/react/全局变量"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/0bde2678fb55/"
    >React源码分析 $1 全局对象或变量</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/0bde2678fb55/" class="article-date">
  <time datetime="2022-03-06T06:27:09.000Z" itemprop="datePublished">2022-03-06</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="FiberRoot"><a href="#FiberRoot" class="headerlink" title="FiberRoot"></a>FiberRoot</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">FiberRootNode</span>(<span class="params">containerInfo, tag, hydrate</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">tag</span> = tag;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">containerInfo</span> = containerInfo;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingChildren</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">current</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pingCache</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">finishedWork</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">timeoutHandle</span> = noTimeout;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">context</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingContext</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">hydrate</span> = hydrate;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">callbackNode</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">callbackPriority</span> = <span class="title class_">NoLanePriority</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">eventTimes</span> = <span class="title function_">createLaneMap</span>(<span class="title class_">NoLanes</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">expirationTimes</span> = <span class="title function_">createLaneMap</span>(<span class="title class_">NoTimestamp</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">suspendedLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pingedLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">expiredLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mutableReadLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">finishedLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">entangledLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">entanglements</span> = <span class="title function_">createLaneMap</span>(<span class="title class_">NoLanes</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Fiber"><a href="#Fiber" class="headerlink" title="Fiber"></a>Fiber</h4><p>react15 在 render 阶段的 reconcile 是不可打断的，这会在进行大量节点的 reconcile 时可能产生卡顿，因为浏览器所有的时间都交给了 js 执行，并且 js 的执行时单线程。为此 react16 之后就有了 scheduler 进行时间片的调度，给每个 task（工作单元）一定的时间，如果在这个时间内没执行完，也要交出执行权给浏览器进行绘制和重排，所以异步可中断的更新需要一定的数据结构在内存中来保存工作单元的信息，这个数据结构就是 Fiber。</p>
<ul>
<li>工作单元：Fiber 最重要的功能就是作为工作单元，保存原生节点或者组件节点对应信息（包括优先级），这些节点通过指针的形似形成 Fiber 树</li>
<li>增量渲染：通过 jsx 对象和 current Fiber 的对比，生成最小的差异补丁，应用到真实节点上</li>
<li>根据优先级暂停、继续、排列优先级：Fiber 节点上保存了优先级，能通过不同节点优先级的对比，达到任务的暂停、继续、排列优先级等能力，也为上层实现批量更新、Suspense 提供了基础</li>
<li><strong>保存状态：</strong> : 因为 Fiber 能保存状态和更新的信息，所以就能实现函数组件的状态更新，也就是 hooks</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">FiberNode</span>(<span class="params"></span></span><br><span class="line"><span class="params">  tag: WorkTag,</span></span><br><span class="line"><span class="params">  pendingProps: mixed,</span></span><br><span class="line"><span class="params">  key: <span class="literal">null</span> | string,</span></span><br><span class="line"><span class="params">  mode: TypeOfMode</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//作为静态的数据结构 保存节点的信息</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">tag</span> = tag; <span class="comment">//对应组件的类型</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">key</span> = key; <span class="comment">//key属性</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">elementType</span> = <span class="literal">null</span>; <span class="comment">//元素类型</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">type</span> = <span class="literal">null</span>; <span class="comment">//func或者class</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stateNode</span> = <span class="literal">null</span>; <span class="comment">//真实dom节点</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//作为fiber数架构 连接成fiber树</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">return</span> = <span class="literal">null</span>; <span class="comment">//指向父节点</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">child</span> = <span class="literal">null</span>; <span class="comment">//指向child</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">sibling</span> = <span class="literal">null</span>; <span class="comment">//指向兄弟节点</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">index</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ref</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//用作为工作单元 来计算state</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingProps</span> = pendingProps;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">memoizedProps</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updateQueue</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">memoizedState</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dependencies</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mode</span> = mode;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//effect相关</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">effectTag</span> = <span class="title class_">NoEffect</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">nextEffect</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">firstEffect</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lastEffect</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//优先级相关的属性</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">childLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//current和workInProgress的指针</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">alternate</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="updateQueue"><a href="#updateQueue" class="headerlink" title="updateQueue"></a>updateQueue</h4><p>另外 <code>updateQueue</code> 属性在节点创建的时候添加 Fiber 对象上</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initializeUpdateQueue</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> queue = &#123;</span><br><span class="line">    <span class="attr">baseState</span>: fiber.<span class="property">memoizedState</span>,</span><br><span class="line">    <span class="attr">firstBaseUpdate</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lastBaseUpdate</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">shared</span>: &#123;</span><br><span class="line">      <span class="attr">pending</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">effects</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  fiber.<span class="property">updateQueue</span> = queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NoPriority</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ImmediatePriority</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">UserBlockingPriority</span> = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NormalPriority</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LowPriority</span> = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">IdlePriority</span> = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Flags"><a href="#Flags" class="headerlink" title="Flags"></a>Flags</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Don&#x27;t change these two values. They&#x27;re used by React Dev Tools.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NoFlags</span> = <span class="comment">/*                      */</span> <span class="number">0b00000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">PerformedWork</span> = <span class="comment">/*                */</span> <span class="number">0b00000000000000000000000001</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// You can change the rest (and add more).</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Placement</span> = <span class="comment">/*                    */</span> <span class="number">0b00000000000000000000000010</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Update</span> = <span class="comment">/*                       */</span> <span class="number">0b00000000000000000000000100</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">PlacementAndUpdate</span> = <span class="comment">/*           */</span> <span class="title class_">Placement</span> | <span class="title class_">Update</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Deletion</span> = <span class="comment">/*                     */</span> <span class="number">0b00000000000000000000001000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ChildDeletion</span> = <span class="comment">/*                */</span> <span class="number">0b00000000000000000000010000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ContentReset</span> = <span class="comment">/*                 */</span> <span class="number">0b00000000000000000000100000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Callback</span> = <span class="comment">/*                     */</span> <span class="number">0b00000000000000000001000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">DidCapture</span> = <span class="comment">/*                   */</span> <span class="number">0b00000000000000000010000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ForceClientRender</span> = <span class="comment">/*            */</span> <span class="number">0b00000000000000000100000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Ref</span> = <span class="comment">/*                          */</span> <span class="number">0b00000000000000001000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Snapshot</span> = <span class="comment">/*                     */</span> <span class="number">0b00000000000000010000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Passive</span> = <span class="comment">/*                      */</span> <span class="number">0b00000000000000100000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Hydrating</span> = <span class="comment">/*                    */</span> <span class="number">0b00000000000001000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HydratingAndUpdate</span> = <span class="comment">/*           */</span> <span class="title class_">Hydrating</span> | <span class="title class_">Update</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Visibility</span> = <span class="comment">/*                   */</span> <span class="number">0b00000000000010000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">StoreConsistency</span> = <span class="comment">/*             */</span> <span class="number">0b00000000000100000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LifecycleEffectMask</span> =</span><br><span class="line">  <span class="title class_">Passive</span> | <span class="title class_">Update</span> | <span class="title class_">Callback</span> | <span class="title class_">Ref</span> | <span class="title class_">Snapshot</span> | <span class="title class_">StoreConsistency</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Union of all commit flags (flags with the lifetime of a particular commit)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostEffectMask</span> = <span class="comment">/*               */</span> <span class="number">0b00000000000111111111111111</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These are not really side effects, but we still reuse this field.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Incomplete</span> = <span class="comment">/*                   */</span> <span class="number">0b00000000001000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ShouldCapture</span> = <span class="comment">/*                */</span> <span class="number">0b00000000010000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ForceUpdateForLegacySuspense</span> = <span class="comment">/* */</span> <span class="number">0b00000000100000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">DidPropagateContext</span> = <span class="comment">/*          */</span> <span class="number">0b00000001000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NeedsPropagation</span> = <span class="comment">/*             */</span> <span class="number">0b00000010000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Forked</span> = <span class="comment">/*                       */</span> <span class="number">0b00000100000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Static tags describe aspects of a fiber that are not specific to a render,</span></span><br><span class="line"><span class="comment">// e.g. a fiber uses a passive effect (even if there are no updates on this particular render).</span></span><br><span class="line"><span class="comment">// This enables us to defer more work in the unmount case,</span></span><br><span class="line"><span class="comment">// since we can defer traversing the tree during layout to look for Passive effects,</span></span><br><span class="line"><span class="comment">// and instead rely on the static flag as a signal that there may be cleanup work.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">RefStatic</span> = <span class="comment">/*                    */</span> <span class="number">0b00001000000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LayoutStatic</span> = <span class="comment">/*                 */</span> <span class="number">0b00010000000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">PassiveStatic</span> = <span class="comment">/*                */</span> <span class="number">0b00100000000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These flags allow us to traverse to fibers that have effects on mount</span></span><br><span class="line"><span class="comment">// without traversing the entire tree after every commit for</span></span><br><span class="line"><span class="comment">// double invoking</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">MountLayoutDev</span> = <span class="comment">/*               */</span> <span class="number">0b01000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">MountPassiveDev</span> = <span class="comment">/*              */</span> <span class="number">0b10000000000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Groups of flags that are used in the commit phase to skip over trees that</span></span><br><span class="line"><span class="comment">// don&#x27;t contain effects, by checking subtreeFlags.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">BeforeMutationMask</span> =</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Remove Update flag from before mutation phase by re-landing Visibility</span></span><br><span class="line">  <span class="comment">// flag logic (see #20043)</span></span><br><span class="line">  <span class="title class_">Update</span> |</span><br><span class="line">  <span class="title class_">Snapshot</span> |</span><br><span class="line">  (enableCreateEventHandleAPI</span><br><span class="line">    ? <span class="comment">// createEventHandle needs to visit deleted and hidden trees to</span></span><br><span class="line">      <span class="comment">// fire beforeblur</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Only need to visit Deletions during BeforeMutation phase if an</span></span><br><span class="line">      <span class="comment">// element is focused.</span></span><br><span class="line">      <span class="title class_">ChildDeletion</span> | <span class="title class_">Visibility</span></span><br><span class="line">    : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">MutationMask</span> =</span><br><span class="line">  <span class="title class_">Placement</span> |</span><br><span class="line">  <span class="title class_">Update</span> |</span><br><span class="line">  <span class="title class_">ChildDeletion</span> |</span><br><span class="line">  <span class="title class_">ContentReset</span> |</span><br><span class="line">  <span class="title class_">Ref</span> |</span><br><span class="line">  <span class="title class_">Hydrating</span> |</span><br><span class="line">  <span class="title class_">Visibility</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LayoutMask</span> = <span class="title class_">Update</span> | <span class="title class_">Callback</span> | <span class="title class_">Ref</span> | <span class="title class_">Visibility</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Split into PassiveMountMask and PassiveUnmountMask</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">PassiveMask</span> = <span class="title class_">Passive</span> | <span class="title class_">ChildDeletion</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Union of tags that don&#x27;t get reset on clones.</span></span><br><span class="line"><span class="comment">// This allows certain concepts to persist without recalculating them,</span></span><br><span class="line"><span class="comment">// e.g. whether a subtree contains passive effects or portals.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">StaticMask</span> = <span class="title class_">LayoutStatic</span> | <span class="title class_">PassiveStatic</span> | <span class="title class_">RefStatic</span>;</span><br></pre></td></tr></table></figure>

<h4 id="RootTag"><a href="#RootTag" class="headerlink" title="RootTag"></a>RootTag</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">RootTag</span> = <span class="number">0</span> | <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LegacyRoot</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ConcurrentRoot</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h4 id="simpleEventPluginEvents"><a href="#simpleEventPluginEvents" class="headerlink" title="simpleEventPluginEvents"></a>simpleEventPluginEvents</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> simpleEventPluginEvents = [</span><br><span class="line">  <span class="string">&quot;abort&quot;</span>,</span><br><span class="line">  <span class="string">&quot;auxClick&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cancel&quot;</span>,</span><br><span class="line">  <span class="string">&quot;canPlay&quot;</span>,</span><br><span class="line">  <span class="string">&quot;canPlayThrough&quot;</span>,</span><br><span class="line">  <span class="string">&quot;click&quot;</span>,</span><br><span class="line">  <span class="string">&quot;close&quot;</span>,</span><br><span class="line">  <span class="string">&quot;contextMenu&quot;</span>,</span><br><span class="line">  <span class="string">&quot;copy&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cut&quot;</span>,</span><br><span class="line">  <span class="string">&quot;drag&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dragEnd&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dragEnter&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dragExit&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dragLeave&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dragOver&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dragStart&quot;</span>,</span><br><span class="line">  <span class="string">&quot;drop&quot;</span>,</span><br><span class="line">  <span class="string">&quot;durationChange&quot;</span>,</span><br><span class="line">  <span class="string">&quot;emptied&quot;</span>,</span><br><span class="line">  <span class="string">&quot;encrypted&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ended&quot;</span>,</span><br><span class="line">  <span class="string">&quot;error&quot;</span>,</span><br><span class="line">  <span class="string">&quot;gotPointerCapture&quot;</span>,</span><br><span class="line">  <span class="string">&quot;input&quot;</span>,</span><br><span class="line">  <span class="string">&quot;invalid&quot;</span>,</span><br><span class="line">  <span class="string">&quot;keyDown&quot;</span>,</span><br><span class="line">  <span class="string">&quot;keyPress&quot;</span>,</span><br><span class="line">  <span class="string">&quot;keyUp&quot;</span>,</span><br><span class="line">  <span class="string">&quot;load&quot;</span>,</span><br><span class="line">  <span class="string">&quot;loadedData&quot;</span>,</span><br><span class="line">  <span class="string">&quot;loadedMetadata&quot;</span>,</span><br><span class="line">  <span class="string">&quot;loadStart&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lostPointerCapture&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mouseDown&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mouseMove&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mouseOut&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mouseOver&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mouseUp&quot;</span>,</span><br><span class="line">  <span class="string">&quot;paste&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pause&quot;</span>,</span><br><span class="line">  <span class="string">&quot;play&quot;</span>,</span><br><span class="line">  <span class="string">&quot;playing&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pointerCancel&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pointerDown&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pointerMove&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pointerOut&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pointerOver&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pointerUp&quot;</span>,</span><br><span class="line">  <span class="string">&quot;progress&quot;</span>,</span><br><span class="line">  <span class="string">&quot;rateChange&quot;</span>,</span><br><span class="line">  <span class="string">&quot;reset&quot;</span>,</span><br><span class="line">  <span class="string">&quot;resize&quot;</span>,</span><br><span class="line">  <span class="string">&quot;seeked&quot;</span>,</span><br><span class="line">  <span class="string">&quot;seeking&quot;</span>,</span><br><span class="line">  <span class="string">&quot;stalled&quot;</span>,</span><br><span class="line">  <span class="string">&quot;submit&quot;</span>,</span><br><span class="line">  <span class="string">&quot;suspend&quot;</span>,</span><br><span class="line">  <span class="string">&quot;timeUpdate&quot;</span>,</span><br><span class="line">  <span class="string">&quot;touchCancel&quot;</span>,</span><br><span class="line">  <span class="string">&quot;touchEnd&quot;</span>,</span><br><span class="line">  <span class="string">&quot;touchStart&quot;</span>,</span><br><span class="line">  <span class="string">&quot;volumeChange&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scroll&quot;</span>,</span><br><span class="line">  <span class="string">&quot;toggle&quot;</span>,</span><br><span class="line">  <span class="string">&quot;touchMove&quot;</span>,</span><br><span class="line">  <span class="string">&quot;waiting&quot;</span>,</span><br><span class="line">  <span class="string">&quot;wheel&quot;</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-source/react/⑤Fiber与双缓存结构"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/e9338ef539b2/"
    >React源码分析 ⑤ Fiber与双缓存结构</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/e9338ef539b2/" class="article-date">
  <time datetime="2022-03-06T05:24:56.000Z" itemprop="datePublished">2022-03-06</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>先创建一个组件,下面这个了例子在大部分的章节都会用到</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">App</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [content, setContent] = <span class="title function_">useState</span>(<span class="string">&quot;内容&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setContent(&quot;内容改变&quot;)&#125; role=&quot;presentation&quot;&gt;</span></span><br><span class="line"><span class="language-xml">        标题</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;content&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> 2020.01.01</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="mount-阶段"><a href="#mount-阶段" class="headerlink" title="mount 阶段"></a>mount 阶段</h4><p>准备 workInProgress 节点,此节点为 rootFiber 节点的一个副本,无论是更新还是挂载阶段都会先创建这个节点,然后从这个节点头部开始,递归处理每一个节点,最终形成一个 fiber 链表,对整个链表处理之后会交换两个 Fiber 树</p>
<p><strong id='createWorkInProgress'>createWorkInProgress</strong><span id="prepareFreshStack"/></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">prepareFreshStack</span>(<span class="params">root, lanes</span>) &#123;</span><br><span class="line">  workInProgressRoot = root;</span><br><span class="line">  <span class="comment">// 传入rootFiber</span></span><br><span class="line">  workInProgressRoot = root;</span><br><span class="line">  workInProgress = <span class="title function_">createWorkInProgress</span>(root.<span class="property">current</span>, <span class="literal">null</span>);</span><br><span class="line">  workInProgressRootRenderLanes =</span><br><span class="line">    subtreeRenderLanes =</span><br><span class="line">    workInProgressRootIncludedLanes =</span><br><span class="line">      lanes;</span><br><span class="line">  workInProgressRootExitStatus = <span class="title class_">RootIncomplete</span>;</span><br><span class="line">  workInProgressRootFatalError = <span class="literal">null</span>;</span><br><span class="line">  workInProgressRootSkippedLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line">  workInProgressRootUpdatedLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line">  workInProgressRootPingedLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createWorkInProgress</span>(<span class="params">current, pendingProps</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> workInProgress = current.<span class="property">alternate</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// workInProgress 不存在则创建新的节点</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgress === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 我们使用了双缓冲池技术因为我们知道只需要最多两个版本的树</span></span><br><span class="line">    <span class="comment">// 我们存放没有使用的节点以便复用,这是延时创建避免被从不会更新任务,占用额外的对象.</span></span><br><span class="line">    <span class="comment">// 这也允许我们在需要的时候回收的内存.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 克隆出新的rootFiber节点</span></span><br><span class="line">    workInProgress = <span class="title function_">createFiber</span>(</span><br><span class="line">      current.<span class="property">tag</span>,</span><br><span class="line">      pendingProps,</span><br><span class="line">      current.<span class="property">key</span>,</span><br><span class="line">      current.<span class="property">mode</span></span><br><span class="line">    );</span><br><span class="line">    workInProgress.<span class="property">elementType</span> = current.<span class="property">elementType</span>;</span><br><span class="line">    workInProgress.<span class="property">type</span> = current.<span class="property">type</span>;</span><br><span class="line">    workInProgress.<span class="property">stateNode</span> = current.<span class="property">stateNode</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// workInProgress 通过alternate属性链接原始的 FiberRoot 对象</span></span><br><span class="line">    workInProgress.<span class="property">alternate</span> = current;</span><br><span class="line">    current.<span class="property">alternate</span> = workInProgress;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到目前位置 Fiber 树的结构为</p>
<p><img src="/posts/e9338ef539b2/0002.png"></p>
<p>递归处理的开始,在<strong id='performUnitOfWork'>performUnitOfWork</strong> 中传入刚刚克隆出的 rootFiber 节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">unitOfWork</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前正被处理的这个是Fiber的镜像,任何操作都不应该依赖于它</span></span><br><span class="line">  <span class="comment">// 但在这里依赖它,意味在处理进程中不需要额外的字段</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个是原始的 rootFiber 节点</span></span><br><span class="line">  <span class="keyword">var</span> current = unitOfWork.<span class="property">alternate</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个全局current变量指向当前被处理的节点</span></span><br><span class="line">  <span class="title function_">setCurrentFiber</span>(unitOfWork);</span><br><span class="line">  <span class="keyword">var</span> next;</span><br><span class="line"></span><br><span class="line">  next = <span class="title function_">beginWork</span>(current, unitOfWork, subtreeRenderLanes);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理结束后清空current=null指针</span></span><br><span class="line">  <span class="title function_">resetCurrentFiber</span>();</span><br><span class="line">  unitOfWork.<span class="property">memoizedProps</span> = unitOfWork.<span class="property">pendingProps</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// complete 阶段</span></span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">completeUnitOfWork</span>(unitOfWork);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong id='beginWork'>beginWork</strong> 简单来说这个方法就是从根节点解析,如果节点不存在就创建对应的 fiber 节点,如果存在就判断是复用还是重新创建, 并通过 return, sibling 等指针链接各个 fiber 节点<br>最终构建出一颗 Fiber 树, 而这个 Fiber 树与原始的 Fiber 树之间通过 alternate 指针相连. 注意 beginWork 处理的都是 js 对象, 对真正 DOM 元素的创建是在 completeWork 中进行的.</p>
<p>第一个节点是 rootFiber 节点,因为它的镜像节点已经在克隆 rootFiber 节点的时候通过 alternate 指针与原始的 rootFiber 相关联,所以会进入 <code>if(current!==null)</code> 分支, 最终 didReceiveUpdate 标记为 false</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// current 为 alternate 节点,也就是原始的 Fiber 树中的镜像节点</span></span><br><span class="line"><span class="comment">// workInProgress 为当前正在处理的节点</span></span><br><span class="line"><span class="comment">// subtreeRenderLanes 为当前正处理的节点的优先级</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params">current, workInProgress, renderLanes</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> oldProps = current.<span class="property">memoizedProps</span>;</span><br><span class="line">    <span class="keyword">var</span> newProps = workInProgress.<span class="property">pendingProps</span>;</span><br><span class="line">    <span class="comment">// props改变</span></span><br><span class="line">    <span class="comment">// 上下文对象改变</span></span><br><span class="line">    <span class="comment">// Force a re-render if the implementation changed due to hot reload</span></span><br><span class="line">    <span class="comment">// 这三个状态改变会被标记为 didReceiveUpdate 更新</span></span><br><span class="line">    <span class="keyword">if</span> (oldProps !== newProps || <span class="title function_">hasContextChanged</span>() || (</span><br><span class="line">     workInProgress.<span class="property">type</span> !== current.<span class="property">type</span> )) &#123;</span><br><span class="line">      <span class="comment">// If props or context changed, mark the fiber as having performed work.</span></span><br><span class="line">      <span class="comment">// This may be unset if the props are determined to be equal later (memo).</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">includesSomeLane</span>(renderLanes, updateLanes)) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">      <span class="comment">// This fiber does not have any pending work. Bailout without entering</span></span><br><span class="line">      <span class="comment">// the begin phase. There&#x27;s still some bookkeeping we that needs to be done</span></span><br><span class="line">      <span class="comment">// in this optimized path, mostly pushing stuff onto the stack.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (workInProgress.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostRoot</span>:</span><br><span class="line">        <span class="comment">// 不同的 fiber 类型用不同的函数处理</span></span><br><span class="line">        <span class="comment">// 没有对 fiber 进行操作,只是处理上下文</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果节点可以复用,会通过这个函数处理</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">bailoutOnAlreadyFinishedWork</span>(current, workInProgress, renderLanes);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> ((current.<span class="property">flags</span> &amp; <span class="title class_">ForceUpdateForLegacySuspense</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">        <span class="comment">// This is a special case that only exists for legacy mode.</span></span><br><span class="line">        <span class="comment">// See https://github.com/facebook/react/pull/19216.</span></span><br><span class="line">        didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// An update was scheduled on this fiber, but there are no new props</span></span><br><span class="line">        <span class="comment">// nor legacy context. Set this to false. If an update queue or context</span></span><br><span class="line">        <span class="comment">// consumer produces a changed value, it will set this to true. Otherwise,</span></span><br><span class="line">        <span class="comment">// the component will assume the children have not changed and bail out.</span></span><br><span class="line">        didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="comment">// updateHostRoot(...)</span></span><br><span class="line">    <span class="comment">// updateHostComponent(...)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>会跳出 if 条件,进入到下面的 switch 处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateHostRoot</span>(<span class="params">current, workInProgress, renderLanes</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> updateQueue = workInProgress.<span class="property">updateQueue</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把一些原始rootFiber上的属性,复制到 workInProgress</span></span><br><span class="line">  <span class="title function_">cloneUpdateQueue</span>(current, workInProgress);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render方法调用时传入的App jsxElement,被添加到updateQueue</span></span><br><span class="line">  <span class="comment">// 这个方法会将App从update对象中取出,放到memoizedState中</span></span><br><span class="line">  <span class="title function_">processUpdateQueue</span>(workInProgress, nextProps, <span class="literal">null</span>, renderLanes);</span><br><span class="line">  <span class="keyword">var</span> nextState = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// nextChildren 为render方法传入的 App 组件</span></span><br><span class="line">  <span class="keyword">var</span> nextChildren = nextState.<span class="property">element</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果和之前的组件相同,则复用该节点</span></span><br><span class="line">  <span class="keyword">if</span> (nextChildren === prevChildren) &#123;</span><br><span class="line">    <span class="title function_">resetHydrationState</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">bailoutOnAlreadyFinishedWork</span>(current, workInProgress, renderLanes);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 进入协调子节点的方法</span></span><br><span class="line">  <span class="comment">//           原始rootFiber, 当前处理的rootFiber, App节点</span></span><br><span class="line">  <span class="title function_">reconcileChildren</span>(current, workInProgress, nextChildren, renderLanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong id='reconcileChildren'>reconcileChildren</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildren</span>(<span class="params">current, workInProgress, nextChildren, renderLanes</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this is a fresh new component that hasn&#x27;t been rendered yet, we</span></span><br><span class="line">    <span class="comment">// won&#x27;t update its child set by applying minimal side-effects. Instead,</span></span><br><span class="line">    <span class="comment">// we will add them all to the child before it gets rendered. That means</span></span><br><span class="line">    <span class="comment">// we can optimize this reconciliation pass by not tracking side-effects.</span></span><br><span class="line">    workInProgress.<span class="property">child</span> = <span class="title function_">mountChildFibers</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If the current child is the same as the work in progress, it means that</span></span><br><span class="line">    <span class="comment">// we haven&#x27;t yet started any work on these children. Therefore, we use</span></span><br><span class="line">    <span class="comment">// the clone algorithm to create a copy of all the current children.</span></span><br><span class="line">    <span class="comment">// If we had any progressed work already, that is invalid at this point so</span></span><br><span class="line">    <span class="comment">// let&#x27;s throw it out.</span></span><br><span class="line"></span><br><span class="line">    workInProgress.<span class="property">child</span> = <span class="title function_">reconcileChildFibers</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      current.<span class="property">child</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个协调节点的处理函数都是通过一个函数生成的,区别就是 mountChildFibers 不会处理副作用,reconcileChildFibers 会在 fiber 节点上添加副作用的标识,标记删除或更新等操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reconcileChildFibers = <span class="title class_">ChildReconciler</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">var</span> mountChildFibers = <span class="title class_">ChildReconciler</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>由于原始节点 current 存在, 会进入 reconcileChildFibers,根据不同的子元素类型使用不同的处理方法,<a href="/posts/bb4fc484e4b2/"><strong>Diff 算法</strong></a>也发生在这里</p>
<p><strong id='#reconcileChildFibers'>reconcileChildFibers</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildFibers</span>(<span class="params">returnFiber, currentFirstChild, newChild, lanes</span>) &#123;</span><br><span class="line">  <span class="comment">// This function is not recursive.</span></span><br><span class="line">  <span class="comment">// If the top level item is an array, we treat it as a set of children,</span></span><br><span class="line">  <span class="comment">// not as a fragment. Nested arrays on the other hand will be treated as</span></span><br><span class="line">  <span class="comment">// fragment nodes. Recursion happens at the normal flow.</span></span><br><span class="line">  <span class="comment">// Handle top level unkeyed fragments as if they were arrays.</span></span><br><span class="line">  <span class="comment">// This leads to an ambiguity between &lt;&gt;&#123;[...]&#125;&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span><br><span class="line">  <span class="comment">// We treat the ambiguous cases above the same.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个条件用于判断是否是Fragment,如果是顶层的Fragment会直接从props中取出,把他当作子元素</span></span><br><span class="line">  <span class="keyword">var</span> isUnkeyedTopLevelFragment =</span><br><span class="line">    <span class="keyword">typeof</span> newChild === <span class="string">&quot;object&quot;</span> &amp;&amp;</span><br><span class="line">    newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    newChild.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span> &amp;&amp;</span><br><span class="line">    newChild.<span class="property">key</span> === <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">    newChild = newChild.<span class="property">props</span>.<span class="property">children</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">&quot;object&quot;</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (newChild.<span class="property">$$typeof</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REACT_ELEMENT_TYPE</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(</span><br><span class="line">          <span class="title function_">reconcileSingleElement</span>(</span><br><span class="line">            returnFiber,</span><br><span class="line">            currentFirstChild,</span><br><span class="line">            newChild,</span><br><span class="line">            lanes</span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REACT_PORTAL_TYPE</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(</span><br><span class="line">          <span class="title function_">reconcileSinglePortal</span>(returnFiber, currentFirstChild, newChild, lanes)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(</span><br><span class="line">      <span class="title function_">reconcileSingleTextNode</span>(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        <span class="string">&quot;&quot;</span> + newChild,</span><br><span class="line">        lanes</span><br><span class="line">      )</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray$1</span>(newChild)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">reconcileChildrenArray</span>(</span><br><span class="line">      returnFiber,</span><br><span class="line">      currentFirstChild,</span><br><span class="line">      newChild,</span><br><span class="line">      lanes</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终 reconcileSingleElement 会使用 App 生成新的 fiber 节点,并通过 return 指针与 rootFiber 相连</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileSingleElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">  returnFiber,</span></span><br><span class="line"><span class="params">  currentFirstChild,</span></span><br><span class="line"><span class="params">  element,</span></span><br><span class="line"><span class="params">  lanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在这个函数中会判断组件的tag类型,需要注意的函数组件并不会一开始就被标记为FunctionComponent</span></span><br><span class="line"><span class="comment">    因为函数可能没有继承React.Component 是用户自己的行为,所以会在处理这个节点的时候单独判断</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    type会按照以下顺序判断</span></span><br><span class="line"><span class="comment">    type是否是一个函数,如果是原型链上有没有isReactComponent 如果有就是类组件</span></span><br><span class="line"><span class="comment">    type是否是一个字符串, 如果是就是HTMLElement</span></span><br><span class="line"><span class="comment">    type是不是内置的类型,例如 REACT_FRAGMENT_TYPE 等</span></span><br><span class="line"><span class="comment">    如果都不是会被标记为 mountIndeterminateComponent=2 表示一个待定的组件</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">var</span> _created4 = <span class="title function_">createFiberFromElement</span>(element, returnFiber.<span class="property">mode</span>, lanes);</span><br><span class="line">  _created4.<span class="property">return</span> = returnFiber;</span><br><span class="line">  <span class="keyword">return</span> _created4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>placeSingleChild 会把节点的 flag 标记为 Placement 标识这是需要插入的元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newFiber.<span class="property">flags</span> = <span class="title class_">Placement</span>;</span><br></pre></td></tr></table></figure>

<p>最后通过 <code>return workInProgress.child</code> 返回下一个 fiber , 也就是刚刚创建的 AppFiber, 现在链表的结构</p>
<p><img src="/posts/e9338ef539b2/0004.png"></p>
<p>回到 <a href="#performUnitOfWork"> performUnitOfWork </a>方法,next 现在为 App fiber,<code>next!==null</code> 表示还有 App Fiber 这个节点需要处理,所以并不会进入 complete 这个分支,下面经过 workLoopSync 再次进入 performUnitOfWork 方法</p>
<p>由于 React.createElement 创建 virtualDOM 的是否并不会分析组件类型,只能简单区是否是 html 元素, 不能区分是函数组件还是类组件, 所以这里会进入 <code>tag=2</code> 的分支,用于处理一个不确定的组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (workInProgress.<span class="property">tag</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="title class_">IndeterminateComponent</span>: &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">mountIndeterminateComponent</span>(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      workInProgress.<span class="property">type</span>,</span><br><span class="line">      renderLanes</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountIndeterminateComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  _current,</span></span><br><span class="line"><span class="params">  workInProgress,</span></span><br><span class="line"><span class="params">  Component,</span></span><br><span class="line"><span class="params">  renderLanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 首先会尝试执行这个函数,拿到函数的返回值</span></span><br><span class="line">  <span class="keyword">var</span> value = <span class="title function_">renderWithHooks</span>(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    workInProgress,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    props,</span><br><span class="line">    context,</span><br><span class="line">    renderLanes</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否具有类组件的行为,如果有则按类组件处理不,并重新标记tag</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> value === <span class="string">&quot;object&quot;</span> &amp;&amp;</span><br><span class="line">    value !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> value.<span class="property">render</span> === <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">    value.<span class="property">$$typeof</span> === <span class="literal">undefined</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    workInProgress.<span class="property">tag</span> = <span class="title class_">ClassComponent</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果不是类组件才会标记为函数组件</span></span><br><span class="line">    workInProgress.<span class="property">tag</span> = <span class="title class_">FunctionComponent</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 再次调用协调函数</span></span><br><span class="line">  <span class="title function_">reconcileChildren</span>(<span class="literal">null</span>, workInProgress, value, renderLanes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和上次调用<a href='#reconcileChildren'>reconcileChildren</a>的时候不同,这次传入的 current&#x3D;null, 也就是这个节点还没有镜像节点,所以会使用 mountChildFibers 处 理</p>
<p>因为这两个方法只是区分是否是初次挂载,所以大致的流程相同,进入 <a href='#reconcileChildFibers'>reconcileChildFibers</a> 会检查到这是一个 Fragment 节点,所以直接取出它的子元素,是一个由 <code>h1</code>,<code>p</code>,<code>文本元素</code> 三个 virtualDOM 组成的数组, 进入 <code>reconcileChildrenArray</code> 多节点的 Diff 算法就发生在这里</p>
<p>最终这个方法会将三个子节点通过 sibling 指针相连,并返回头节点 <code>h1</code>, 作为下一个工作单元,现在链表的结构为</p>
<p><img src="/posts/e9338ef539b2/0005.png"></p>
<p>再次处理的是 <code>h1</code> 节点, 因为初次挂载它的 <code>alternate</code> 也没有构建,所以直接进入对应的 <code>case</code> 处理</p>
<p>在处理 h1 Fiber 的时候会检查是不是存在唯一的文本子节点,如果存在子元素为<code>null</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateHostComponent</span>(<span class="params">current, workInProgress, renderLanes</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isDirectTextChild) &#123;</span><br><span class="line">    <span class="comment">// 我们把Host Node 唯一字节点当作一个特殊用例,这是一个常见的问题,不会当作一个子节点处理</span></span><br><span class="line">    <span class="comment">// 在执行环境中会处理,依然可以获取这个props,这可以避免用另一个Fiber遍历处理</span></span><br><span class="line">    nextChildren = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>h1 的 beginWork 结束之后会进入 completeWork, 因为 h1 有为文本子节点,并不会算作他的子元素,所以他的 child &#x3D; null</p>
<p>需要注意的是,completeWork 并不一定在所有的节点的 beginWork 执行完成后才会执行,当一个节点没有子节点需要处理的时候,就会进入 completeWork,</p>
<h4 id="complete-阶段"><a href="#complete-阶段" class="headerlink" title="complete 阶段"></a>complete 阶段</h4><p>completeWork 最重要的目的之一就是对比新老节点,把 fiber 对应的真实 DOM 元素创建出来或添加更新属性, 并与 fiber 节点相关联,另一个目的是 <a href="/posts/3aa5257401aa/">构建 Effects 链表</a></p>
<p>这个方法会遍历传入元素的 siblings 兄弟元素,如果没有会返回父级元素,一直递归到根节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">completeUnitOfWork</span>(<span class="params">unitOfWork</span>) &#123;</span><br><span class="line">  <span class="comment">// Attempt to complete the current unit of work, then move to the next</span></span><br><span class="line">  <span class="comment">// sibling. If there are no more siblings, return to the parent fiber.</span></span><br><span class="line">  <span class="keyword">var</span> completedWork = unitOfWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    next = <span class="title function_">completeWork</span>(current, completedWork, subtreeRenderLanes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结束执行后有一段处理 Effect 链表的逻辑</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">var</span> siblingFiber = completedWork.<span class="property">sibling</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line"></span><br><span class="line">    completedWork = returnFiber;</span><br><span class="line">    <span class="comment">// Update the next thing we&#x27;re working on in case something throws.</span></span><br><span class="line"></span><br><span class="line">    workInProgress = completedWork;</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>); <span class="comment">// We&#x27;ve reached the root.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>completeWork 与 beginWork 方法设计类似,不同的 fiber 类型,会进入不同的 case 处理,但以下的节点类型会返回 null,这些类型的 Fiber 节点都没有真实的 DOM 元素与之对应</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="title class_">IndeterminateComponent</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">LazyComponent</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">Fragment</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">Mode</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">Profiler</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">ContextConsumer</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>当 <code>h1</code> 元素首次进入, 会进入对应的 HostComponent 处理,这时的 alternate 节点还没有渲染,所以 <code>current=null</code>, 会进入 else 分支</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> type = workInProgress.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.<span class="property">stateNode</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">updateHostComponent$1</span>(current, workInProgress, type, newProps, rootContainerInstance);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// 会直接调用原生的DOM方法创建元素</span></span><br><span class="line">      <span class="comment">// domElement = ownerDocument.createElement(type);</span></span><br><span class="line">      <span class="keyword">var</span> instance = <span class="title function_">createInstance</span>(type, newProps, rootContainerInstance, currentHostContext, workInProgress);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果元素还有其他子元素例如 &lt;h1&gt;&lt;span/&gt;&lt;span/&gt;&lt;/h1&gt;</span></span><br><span class="line">      <span class="comment">// 会循环遍历子元素,将子元素的原生DOM,插入到 h1 的原生DOM中</span></span><br><span class="line">      <span class="title function_">appendAllChildren</span>(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="comment">// 重新赋值 stateNode 指针,指向原生DOM</span></span><br><span class="line">      workInProgress.<span class="property">stateNode</span> = instance;</span><br><span class="line">      <span class="comment">// Certain renderers require commit-time effects for initial mount.</span></span><br><span class="line">      <span class="comment">// (eg DOM renderer supports auto-focus for certain elements).</span></span><br><span class="line">      <span class="comment">// Make sure such renderers get scheduled for later work.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 通过原生DOM方法将props中的属性添加在原生DOM上</span></span><br><span class="line">      <span class="comment">// node.addAttribute(_attributeName);</span></span><br><span class="line">      <span class="comment">// 如果是点击事件,则会加入到事件系统的队列中</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">finalizeInitialChildren</span>(instance, type, newProps, rootContainerInstance)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加更新的副作用 workInProgress.flags |= Update;</span></span><br><span class="line">        <span class="title function_">markUpdate</span>(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跳出 complete 后,下一个节点是 <code>p</code>,与 <code>h1</code> 类似,还是会先进入 beginWork, 由于没有子节点,所以紧接着进入 completeWork, 当最后一个文本节点处理之后会执行 <code>completedWork = returnFiber</code> 也就是对 AppFiber 执行 completeWork, 所以直接返回 null,最终所有的节点都遍历之后形成的链表为</p>
<p><img src="/posts/e9338ef539b2/0006.png"></p>
<p><img src="/posts/e9338ef539b2/0007.png"></p>
<h4 id="update-阶段"><a href="#update-阶段" class="headerlink" title="update 阶段"></a>update 阶段</h4><p>点击 h1 标签状态更新,依然会进入 <a href='#createWorkInProgress'>createWorkInProgress</a> 第一个节点是 RootFiber,alternate 已经存在,如果不存在则创建一个 <code>FiberInWorkProgress</code> 并用 alternate 相连</p>
<p>与 render 阶段相同都会进入 <a href='#beginWork'>beginWork</a> , 第一个节点为 FiberRoot, 与首次渲染不同,这次的 <code>renderLanes!==updateLanes</code> 表示这个节点需要渲染,但是当前节点不需要更新,这也就意味这这个节点可以复用,会进入下面的复用的逻辑</p>
<p>会直接克隆当前节点,并返回子节点 App</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bailoutOnAlreadyFinishedWork</span>(<span class="params">current, workInProgress, renderLanes</span>) &#123;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">includesSomeLane</span>(renderLanes, workInProgress.<span class="property">childLanes</span>)) &#123;</span><br><span class="line">    <span class="comment">// The children don&#x27;t have any work either. We can skip them.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Once we add back resuming, we should check if the children are</span></span><br><span class="line">    <span class="comment">// a work-in-progress set. If so, we need to transfer their effects.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 当前的节点不需要更新但是子节点需要更新,克隆子节点继续</span></span><br><span class="line">    <span class="comment">// 会再次调用 createWorkInProgress 克隆当前节点的子节点,并通过 alternate 指针,与原节点相连</span></span><br><span class="line">    <span class="title function_">cloneChildFibers</span>(current, workInProgress);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在的 Fiber 树结构为</p>
<p><img src="/posts/e9338ef539b2/0011.png"></p>
<p>下面进入的是 App 节点, 因为这个节点需要更新,但是又没有新的属性或上下文,所以会进入下面的分支,<br>把是否收到更新标记为 false,并重新构建此节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((current.<span class="property">flags</span> &amp; <span class="title class_">ForceUpdateForLegacySuspense</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">  <span class="comment">// This is a special case that only exists for legacy mode.</span></span><br><span class="line">  <span class="comment">// See https://github.com/facebook/react/pull/19216.</span></span><br><span class="line">  didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// An update was scheduled on this fiber, but there are no new props</span></span><br><span class="line">  <span class="comment">// nor legacy context. Set this to false. If an update queue or context</span></span><br><span class="line">  <span class="comment">// consumer produces a changed value, it will set this to true. Otherwise,</span></span><br><span class="line">  <span class="comment">// the component will assume the children have not changed and bail out.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个Fiber上有一个更新被调度,但是没有新的属性或上下文,就设置为false</span></span><br><span class="line">  <span class="comment">// 如果一个更新队列或上下文,消费了一个改变的值,会被设置为true</span></span><br><span class="line">  <span class="comment">// 否则组件则会假定子元素没有改变并跳出</span></span><br><span class="line">  didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一次的 App 节点已经不是 mount 时候无法确定的节点,而是一个 FunctionComponent,会进入对应的 case 处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateFunctionComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current,</span></span><br><span class="line"><span class="params">  workInProgress,</span></span><br><span class="line"><span class="params">  Component,</span></span><br><span class="line"><span class="params">  nextProps,</span></span><br><span class="line"><span class="params">  renderLanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> context;</span><br><span class="line">  <span class="keyword">var</span> nextChildren;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setIsRendering</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 会在创建 virtualDOM 时检查是否更新,如果是 didReceiveUpdate 标记为true</span></span><br><span class="line">  nextChildren = <span class="title function_">renderWithHooks</span>(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    nextProps,</span><br><span class="line">    context,</span><br><span class="line">    renderLanes</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果节点不需要更新则会继续走复用节点的逻辑</span></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; !didReceiveUpdate) &#123;</span><br><span class="line">    <span class="title function_">bailoutHooks</span>(current, workInProgress, renderLanes);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">bailoutOnAlreadyFinishedWork</span>(current, workInProgress, renderLanes);</span><br><span class="line">  &#125; <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 否则创建新的Fiber节点并返回</span></span><br><span class="line">  workInProgress.<span class="property">flags</span> |= <span class="title class_">PerformedWork</span>;</span><br><span class="line">  <span class="title function_">reconcileChildren</span>(current, workInProgress, nextChildren, renderLanes);</span><br><span class="line">  <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>h1 更新阶段, 会进入 if 分支执行 updateHostComponent, 并且因为 props 发生改变,didReceiveUpdate 会被标记为 true. h1 的文本发生了改变,但由于这是它的唯一文本节点所以不需要额外处理,只当作节点更新即可.</p>
<p>下面会紧接着进入 h1 的 completeWork, 进入对应的 case 进行处理, <code>updateHostComponent$1</code> 中会调用 <code>diffProperties</code> 进行<a href="/posts/bb4fc484e4b2/#%E5%B1%9E%E6%80%A7Diff">属性的 Diff</a>, 最终把 Diff 后的属性添加到 updateQueue 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> rootContainerInstance = <span class="title function_">getRootHostContainer</span>();</span><br><span class="line">    <span class="keyword">var</span> type = workInProgress.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.<span class="property">stateNode</span> != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 执行属性Diff算法</span></span><br><span class="line">      <span class="comment">// var updatePayload = diffProperties(domElement, type, oldProps, newProps);</span></span><br><span class="line">      <span class="comment">// workInProgress.updateQueue = updatePayload;</span></span><br><span class="line">      <span class="title function_">updateHostComponent$1</span>(current, workInProgress, type, newProps, rootContainerInstance);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (current.<span class="property">ref</span> !== workInProgress.<span class="property">ref</span>) &#123;</span><br><span class="line">        <span class="title function_">markRef$1</span>(workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> instance = <span class="title function_">createInstance</span>(type, newProps, rootContainerInstance, currentHostContext, workInProgress);</span><br><span class="line">      <span class="title function_">appendAllChildren</span>(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      workInProgress.<span class="property">stateNode</span> = instance;</span><br><span class="line">      <span class="comment">// Certain renderers require commit-time effects for initial mount.</span></span><br><span class="line">      <span class="comment">// (eg DOM renderer supports auto-focus for certain elements).</span></span><br><span class="line">      <span class="comment">// Make sure such renderers get scheduled for later work.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以下一个进来的 <code>p</code> 节点为例, 新的文本是 <code>内容改变</code>, 旧的文本是 <code>内容</code>,与 h1 的处理过程类似,最后会执行 RootFiber 的 completeWork 会给 fiber 添加 snapshot 副作用标记</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Schedule an effect to clear this container at the start of the next commit.</span></span><br><span class="line"><span class="comment">// This handles the case of React rendering into a container with previous children.</span></span><br><span class="line"><span class="comment">// It&#x27;s also safe to do for updates too, because current.child would only be null</span></span><br><span class="line"><span class="comment">// if the previous render was null (so the the container would already be empty).</span></span><br><span class="line">workInProgress.<span class="property">flags</span> |= <span class="title class_">Snapshot</span>;</span><br></pre></td></tr></table></figure>

<p>最终依次处理所有节点之后,生成一个新的 Fiber 树</p>
<p><img src="/posts/e9338ef539b2/0010.png"></p>
<h4 id="双缓存结构"><a href="#双缓存结构" class="headerlink" title="双缓存结构"></a>双缓存结构</h4><p>在内存中构建并直接替换的技术叫做双缓存。</p>
<p>当首次 update 结束,这时产生的两个 Fiber 树就是,Fiber 树的双缓存结构</p>
<p>当 render 阶段执行结束之后会进入 commitRoot</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performSyncWorkOnRoot</span>(<span class="params">root</span>) &#123;</span><br><span class="line">  <span class="comment">// 原 rootFiber 的镜像节点,也就是 workInProgress</span></span><br><span class="line">  <span class="keyword">var</span> finishedWork = root.<span class="property">current</span>.<span class="property">alternate</span>;</span><br><span class="line">  root.<span class="property">finishedWork</span> = finishedWork;</span><br><span class="line">  root.<span class="property">finishedLanes</span> = lanes;</span><br><span class="line">  <span class="comment">// 提交阶段结束之后会重新复制current</span></span><br><span class="line">  <span class="comment">// root.current = finishedWork;</span></span><br><span class="line">  <span class="comment">// FiberRoot的 current 指针会指向最新构建的 Fiber 树</span></span><br><span class="line">  <span class="comment">// 并将原有的 Fiber 树回收 workInProgress = null</span></span><br><span class="line">  <span class="title function_">commitRoot</span>(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-css/背景与边框"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/b24d034ad9f9/"
    >CSS艺术 背景与边框</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/b24d034ad9f9/" class="article-date">
  <time datetime="2022-03-05T02:40:47.000Z" itemprop="datePublished">2022-03-05</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/CSS/">CSS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="半透明边框"><a href="#半透明边框" class="headerlink" title="半透明边框"></a>半透明边框</h4><p>背景颜色会延伸到边框的下面，如果给元素一个虚线边框就能看到</p>
<p><img src="/posts/b24d034ad9f9/0001.png"></p>
<p>使用 <a target="_blank" rel="noopener" href="https://caniuse.com/?search=background-clip"><code>background-clip</code></a> 让元素的背景被内边框裁掉</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">border</span>: <span class="number">20px</span> dashed <span class="built_in">hsla</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">100%</span>, <span class="number">0.5</span>);</span><br><span class="line"><span class="attribute">background</span>: darkgoldenrod;</span><br><span class="line"><span class="attribute">background-clip</span>: padding-box;</span><br></pre></td></tr></table></figure>

<h4 id="多重边框"><a href="#多重边框" class="headerlink" title="多重边框"></a>多重边框</h4><h5 id="box-shadow-模拟"><a href="#box-shadow-模拟" class="headerlink" title="box-shadow 模拟"></a>box-shadow 模拟</h5><p>原理就是让扩张半径增大，偏移量以及模糊值都为 0，需要注意，阴影并不会占据空间大小，需要处理元素的位置。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">background</span>: darkgoldenrod;</span><br><span class="line"><span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">10px</span> <span class="number">#0000ff</span>, <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">20px</span> <span class="number">#00ff00</span>, <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">30px</span> <span class="number">#ff0000</span>;</span><br><span class="line"><span class="attribute">margin</span>: <span class="number">30px</span> <span class="number">0</span> <span class="number">0</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0002.png"></p>
<h5 id="outline"><a href="#outline" class="headerlink" title="outline"></a>outline</h5><p>使用 outline + border 可以实现两侧边框，比 box-shadow 更灵活。</p>
<p>注意，outline 的边框可能和圆角不贴和。一些老的浏览器版本中可能存在</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">background</span>: darkgoldenrod;</span><br><span class="line"><span class="attribute">border</span>: <span class="number">10px</span> solid <span class="number">#0000ff</span>;</span><br><span class="line"><span class="attribute">outline</span>: <span class="number">10px</span> solid <span class="number">#00ff00</span>;</span><br><span class="line"><span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br></pre></td></tr></table></figure>

<p>使用负的 <code>outline-offset</code> 实现缝线的效果</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">background</span>: darkgoldenrod;</span><br><span class="line"><span class="attribute">outline</span>: <span class="number">1px</span> dashed <span class="number">#fff</span>;</span><br><span class="line"><span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line"><span class="attribute">outline-offset</span>: -<span class="number">10px</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0003.png"></p>
<h4 id="背景图片"><a href="#背景图片" class="headerlink" title="背景图片"></a>背景图片</h4><p>background 简写属性如下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:bg-color bg-image position/bg-size bg-repeat bg-origin bg-clip bg-attachment initial|inherit;</span><br></pre></td></tr></table></figure>

<p>background-position 允许指定每个方向的偏移量,在简写属性中添 right bottom,可以防止<code>background-position</code>不被支持的时候位置误差过大 </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">background</span>: darkgoldenrod <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>) right bottom / <span class="number">20px</span> <span class="number">20px</span> no-repeat;</span><br><span class="line"><span class="attribute">background-position</span>: right <span class="number">20px</span> bottom <span class="number">20px</span>;</span><br></pre></td></tr></table></figure>

<p>如果你想让背景图片出现在右下角,但是又要空出与 <code>padding</code> 相等的距离,可以使用 <code>background-origin</code> 可以修改出现背景出现的区域</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">padding</span>:<span class="number">20px</span>;</span><br><span class="line"><span class="attribute">background</span>: darkgoldenrod <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>) right bottom / <span class="number">20px</span> <span class="number">20px</span> no-repeat;</span><br><span class="line"><span class="attribute">background-origin</span>: content-box;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0004.png"></p>
<p>也可使用 <code>calc()</code> 函数</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line"><span class="attribute">box-sizing</span>: border-box;</span><br><span class="line"><span class="attribute">background</span>: darkgoldenrod <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>) right bottom / <span class="number">20px</span> <span class="number">20px</span> no-repeat;</span><br><span class="line"><span class="attribute">background-position</span>: <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">20px</span>) <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">20px</span>);</span><br></pre></td></tr></table></figure>
<h4 id="条纹背景"><a href="#条纹背景" class="headerlink" title="条纹背景"></a>条纹背景</h4><p>首先我们想实现的是一个实色过度的背景,也就是没有渐变的效果</p>
<p>当下个颜色的起点在,上一个颜色的终点时,这时候没有空间让渐变产生就会是一个实色的背景</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:<span class="built_in">linear-gradient</span>(<span class="number">#58a</span> <span class="number">50%</span>,<span class="number">#fba</span> <span class="number">50%</span>);</span><br><span class="line"><span class="attribute">background-size</span>:<span class="number">100%</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0011.png"></p>
<p>还有一个简写的方法,如果某个颜色的位置比整个列表中他前面颜色的位置都要小,这个颜色的起始位置会被设置为前面颜色中的最大位置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:<span class="built_in">linear-gradient</span>(<span class="number">#58a</span> <span class="number">50%</span>,<span class="number">#fba</span> <span class="number">0</span>);</span><br><span class="line"><span class="attribute">background-size</span>:<span class="number">100%</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<p>如果想要垂直方向的条纹,需要给定一个角度,并修改背景大小</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:<span class="built_in">linear-gradient</span>(<span class="number">90deg</span>,<span class="number">#58a</span> <span class="number">50%</span>,<span class="number">#fba</span> <span class="number">50%</span>);</span><br><span class="line"><span class="attribute">background-size</span>:<span class="number">30px</span> <span class="number">100%</span> ;</span><br></pre></td></tr></table></figure>

<p>另一种常用的技巧是,把条纹的主色设置为背景色,再用另一种半透明的颜色覆盖,更容易修改</p>
<h4 id="45度斜向条纹"><a href="#45度斜向条纹" class="headerlink" title="45度斜向条纹"></a>45度斜向条纹</h4><p>如果理所当然的把角度改为其他角度,就以为能得到条纹背景,那就错了</p>
<p>因为旋转的只是一个背景单元(贴片)中的背景,而不是整个背景,他们拼在一起的时候会产生锯齿</p>
<p><img src="/posts/b24d034ad9f9/0012.png"></p>
<p>所以需要在一个单元(贴片)中完整的画出条纹,在使用这个单元(贴片)去铺满背景</p>
<p>现在需要加几个锚点,在单元中画出相间的四条背景线,把这些单元拼接在一起的时候就会形成45度的斜向条纹</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:<span class="built_in">linear-gradient</span>(<span class="number">45deg</span>,<span class="number">#58a</span> <span class="number">25%</span>,<span class="number">#fba</span> <span class="number">0</span>,<span class="number">#fba</span> <span class="number">50%</span>,<span class="number">#58a</span> <span class="number">0</span>,<span class="number">#58a</span> <span class="number">75%</span>,<span class="number">#fba</span> <span class="number">0</span>);</span><br><span class="line"><span class="attribute">background-size</span>:<span class="number">30px</span> <span class="number">30px</span> ;</span><br></pre></td></tr></table></figure>

<h4 id="其他角度的斜向条纹"><a href="#其他角度的斜向条纹" class="headerlink" title="其他角度的斜向条纹"></a>其他角度的斜向条纹</h4><p>但是其他角度的时候,会法相还是无法实现,比如 60度</p>
<p><img src="/posts/b24d034ad9f9/0013.png"></p>
<p>所以css还提供了一个加强版的线性渐变,可以将你画出的部分当作单元并重复铺满整个背景</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:<span class="built_in">repeating-linear-gradient</span>(<span class="number">60deg</span>,<span class="number">#58a</span>,<span class="number">#58a</span> <span class="number">15px</span>,<span class="number">#fba</span> <span class="number">0</span>,<span class="number">#fba</span> <span class="number">30px</span>);</span><br></pre></td></tr></table></figure>

<p>在实现条纹背景的时候,通常两个颜色属于一个色系,可以将主色设置为背景,副色作为条纹背景盖在上面,而且好处是不支持的时候可以显示主色的背景</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="built_in">repeating-linear-gradient</span>(</span><br><span class="line">    <span class="number">60deg</span>,</span><br><span class="line">    <span class="built_in">hsla</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">100%</span>, <span class="number">0.1</span>),</span><br><span class="line">    <span class="built_in">hsla</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">100%</span>, <span class="number">0.1</span>) <span class="number">15px</span>,</span><br><span class="line">    transparent <span class="number">0</span>,</span><br><span class="line">    transparent <span class="number">30px</span></span><br><span class="line">  ),</span><br><span class="line">  <span class="number">#58a</span>;</span><br></pre></td></tr></table></figure>


<h4 id="网格背景"><a href="#网格背景" class="headerlink" title="网格背景"></a>网格背景</h4><p>利用半透明的叠加,可以创建对比更明显的网格</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: white;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>,<span class="built_in">rgba</span>(<span class="number">200</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>) <span class="number">50%</span>,transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="built_in">rgba</span>(<span class="number">200</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>) <span class="number">50%</span>, transparent <span class="number">0</span>);</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">30px</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0005.png"></p>
<p>也可以让渐变的起始宽度为1px.创建更细的网格线</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: white;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#58a</span> <span class="number">1px</span>, transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">#58a</span> <span class="number">1px</span>, transparent <span class="number">0</span>);</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">30px</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<p>也可以加重一些边框,形成层次更深的网格</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:  </span><br><span class="line">  <span class="built_in">linear-gradient</span>(white <span class="number">2px</span>,transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, white <span class="number">2px</span>,transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="built_in">hsla</span>(<span class="number">0</span>,<span class="number">0%</span>,<span class="number">100%</span>,<span class="number">0.3</span>) <span class="number">1px</span>,transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>,<span class="built_in">hsla</span>(<span class="number">0</span>,<span class="number">0%</span>,<span class="number">100%</span>,<span class="number">0.3</span>) <span class="number">1px</span>,transparent <span class="number">0</span>)</span><br><span class="line">   <span class="number">#58a</span>;</span><br><span class="line">  <span class="attribute">background-size</span>: <span class="number">75px</span> <span class="number">75px</span>,<span class="number">75px</span> <span class="number">75px</span>,<span class="number">15px</span> <span class="number">15px</span>,<span class="number">15px</span> <span class="number">15px</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0008.png"></p>
<p><a target="_blank" rel="noopener" href="http://projects.verou.me/css3patterns/">更复杂的背景案例</a></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="built_in">radial-gradient</span>(</span><br><span class="line">      circle at <span class="number">0%</span> <span class="number">50%</span>,</span><br><span class="line">      <span class="built_in">rgba</span>(<span class="number">96</span>, <span class="number">16</span>, <span class="number">48</span>, <span class="number">0</span>) <span class="number">9px</span>,</span><br><span class="line">      <span class="number">#613</span> <span class="number">10px</span>,</span><br><span class="line">      <span class="built_in">rgba</span>(<span class="number">96</span>, <span class="number">16</span>, <span class="number">48</span>, <span class="number">0</span>) <span class="number">11px</span></span><br><span class="line">    )</span><br><span class="line">    <span class="number">0px</span> <span class="number">10px</span>,</span><br><span class="line">  <span class="built_in">radial-gradient</span>(</span><br><span class="line">    at <span class="number">100%</span> <span class="number">100%</span>,</span><br><span class="line">    <span class="built_in">rgba</span>(<span class="number">96</span>, <span class="number">16</span>, <span class="number">48</span>, <span class="number">0</span>) <span class="number">9px</span>,</span><br><span class="line">    <span class="number">#613</span> <span class="number">10px</span>,</span><br><span class="line">    <span class="built_in">rgba</span>(<span class="number">96</span>, <span class="number">16</span>, <span class="number">48</span>, <span class="number">0</span>) <span class="number">11px</span></span><br><span class="line">  ),</span><br><span class="line">  <span class="number">#8a3</span>;</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">20px</span> <span class="number">20px</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0007.png"></p>
<h4 id="波点背景"><a href="#波点背景" class="headerlink" title="波点背景"></a>波点背景</h4><p><img src="/posts/b24d034ad9f9/0009.png"></p>
<p>想实现这样的效果,我们从图形中切出一个小方块.用这个方块铺满整个背景</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:  </span><br><span class="line">  <span class="built_in">radial-gradient</span>(tan <span class="number">30%</span>,transparent <span class="number">0</span>) <span class="number">#58a</span>;</span><br><span class="line">  <span class="attribute">background-size</span>:<span class="number">30px</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<p>但是现在看着还不是很饱满,我们可以生成两层图案,通过背景定位放到稍微错开的位置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>:  </span><br><span class="line">  <span class="built_in">radial-gradient</span>(tan <span class="number">30%</span>,transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">radial-gradient</span>(tan <span class="number">30%</span>,transparent <span class="number">0</span>),</span><br><span class="line">  <span class="number">#58a</span>;</span><br><span class="line">  <span class="attribute">background-size</span>:<span class="number">30px</span> <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">background-position</span>:<span class="number">0</span> <span class="number">0</span> ,<span class="number">15px</span> <span class="number">15px</span>;</span><br></pre></td></tr></table></figure>

<p>使用一个 mixin 让代码更容易维护</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*          单元格大小, 点的半径, 回退颜色, 点的颜色*/</span></span><br><span class="line"><span class="keyword">@mixin</span> polka(<span class="variable">$size</span>,   <span class="variable">$dot</span>,    <span class="variable">$base</span>,  <span class="variable">$accent</span>)&#123;</span><br><span class="line">  <span class="attribute">background</span>:<span class="variable">$base</span>;</span><br><span class="line">  <span class="attribute">background-image</span>:</span><br><span class="line">    radial-gradient(<span class="variable">$accent</span> <span class="variable">$dot</span>,transparent <span class="number">0</span>),</span><br><span class="line">    radial-gradient(<span class="variable">$accent</span> <span class="variable">$dot</span>,transparent <span class="number">0</span>)</span><br><span class="line">    background-size:<span class="variable">$size</span> <span class="variable">$size</span>;</span><br><span class="line">    <span class="attribute">background-position</span>:<span class="number">0</span> <span class="number">0</span>,<span class="variable">$size</span>/<span class="number">2</span> <span class="variable">$size</span>/<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0010.png"></p>
<h4 id="棋盘"><a href="#棋盘" class="headerlink" title="棋盘"></a>棋盘</h4><p><img src="/posts/b24d034ad9f9/0013.png"></p>
<p>期盼的效果看起来简单但实际上有一点麻烦,因为没有一种渐变能实现一个正方形中的1&#x2F;4个小正方形的效果.</p>
<p>所以需要换一种思路,先实现正方形的两个对角,再用这两个对角,和其他正方形中的对角拼成一个小正方形</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(</span><br><span class="line">  <span class="number">45deg</span>,</span><br><span class="line">  <span class="number">#ccc</span> <span class="number">25%</span>,</span><br><span class="line">  transparent <span class="number">0</span>,</span><br><span class="line">  transparent <span class="number">75%</span>,</span><br><span class="line">  <span class="number">#ccc</span> <span class="number">0</span></span><br><span class="line">);</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">30px</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<p>但是在一个渐变里面连续实现两个三角型,没有办法控制他们的位置进行拼接,所以需要分成两个渐变,并控制第二个渐变的背景位置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">45deg</span>, <span class="number">#ccc</span> <span class="number">25%</span>, transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">45deg</span>, transparent <span class="number">75%</span>, <span class="number">#ccc</span> <span class="number">75%</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(-<span class="number">45deg</span>, <span class="number">#ccc</span> <span class="number">25%</span>, transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(-<span class="number">45deg</span>, transparent <span class="number">75%</span>, <span class="number">#ccc</span> <span class="number">75%</span>);</span><br><span class="line"><span class="attribute">background-position</span>: <span class="number">0</span> <span class="number">0</span>, -<span class="number">15px</span> <span class="number">15px</span>, <span class="number">0</span> -<span class="number">15px</span>, -<span class="number">15px</span> <span class="number">0</span>;</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">30px</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<p><strong>部分</strong>浏览器已经支持角向渐变,可以直接画出1&#x2F;4个正方形</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="built_in">conic-gradient</span>(red,yellow,lime,aqua,blue,fuchsia,red);</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">30px</span> <span class="number">30px</span>;</span><br></pre></td></tr></table></figure>

<h4 id="伪随机背景"><a href="#伪随机背景" class="headerlink" title="伪随机背景"></a>伪随机背景</h4><p>如果背景是不透明的,而且是连续的,那就会每隔<code>background-size</code>指定的像素后就会重复一次.</p>
<p>所以可以考虑将背景大小设为不同的数值,并且渐变不会铺满整个背景,让他们相互覆盖,形成随机</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#fb3</span>, <span class="number">10px</span>, transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#ab4</span>, <span class="number">20px</span>, transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#655</span>, <span class="number">30px</span>, transparent <span class="number">0</span>);</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">40px</span> <span class="number">100%</span>, <span class="number">60px</span> <span class="number">100%</span>, <span class="number">80px</span> <span class="number">100%</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0015.png"></p>
<p>但是使用整数还是容易被察觉,每隔240px也就是各个背景大小的最小公倍数,所以这里可以把背景大小换成质数</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#fb3</span>, <span class="number">10px</span>, transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#ab4</span>, <span class="number">20px</span>, transparent <span class="number">0</span>),</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#655</span>, <span class="number">30px</span>, transparent <span class="number">0</span>);</span><br><span class="line"><span class="attribute">background-size</span>: <span class="number">41px</span> <span class="number">100%</span>, <span class="number">61px</span> <span class="number">100%</span>, <span class="number">71px</span> <span class="number">100%</span>;</span><br></pre></td></tr></table></figure>

<h4 id="图像边框"><a href="#图像边框" class="headerlink" title="图像边框"></a>图像边框</h4><p>如何实现把一张照片中间部分当作内容区域,剩下区域当作背景的效果.</p>
<p>最简单的想法是,通过两个元素下面的元素用上面的元素遮挡.这个方法是可行的.但是如果只用一个元素呢?</p>
<p>如果你想到的 <code>background-image</code> 那可能会有一点问题, <code>background-image</code> 会将背景图片按九宫格划分,在四个边上的背景会被拉伸或者重复.</p>
<p>其实还可以用多重背景来做, 用 <code>background-clip</code> 控制背景的显示区域,下面用一个夸张的样式看下现在的效果</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">320px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">180px</span>;</span><br><span class="line"><span class="attribute">border</span>: <span class="number">100px</span> solid transparent;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(white, transparent), <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>);</span><br><span class="line"><span class="attribute">background-size</span>: cover;</span><br><span class="line"><span class="attribute">background-clip</span>: padding-box, border-box;</span><br><span class="line"><span class="attribute">background-origin</span>: padding-box;</span><br></pre></td></tr></table></figure>

<p>在边框上已经有指定的背景,但是背景没有从边框的左上角开始,这是因为 <code>background-origin</code> 默认是 <code>padding-box</code> 会从内边框的左上角开始,所以边框上的图片是重复平铺之后扩展出来的图片,下面稍微修改一下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">320px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">180px</span>;</span><br><span class="line"><span class="attribute">border</span>: <span class="number">20px</span> solid transparent;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">#fff</span>, <span class="number">#fff</span>), <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>);</span><br><span class="line"><span class="attribute">background-size</span>: cover;</span><br><span class="line"><span class="attribute">background-clip</span>: padding-box, border-box;</span><br><span class="line"><span class="attribute">background-origin</span>: border-box;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0017.png"></p>
<p>下面是简化后的属性</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">320px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">180px</span>;</span><br><span class="line"><span class="attribute">border</span>: <span class="number">20px</span> solid transparent;</span><br><span class="line"><span class="attribute">background</span>: </span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">#fff</span>, <span class="number">#fff</span>) padding-box,</span><br><span class="line">  <span class="built_in">url</span>(<span class="string">./cover1.jpg</span>) border-box <span class="number">0</span> / cover;</span><br></pre></td></tr></table></figure>

<h4 id="信封效果边框"><a href="#信封效果边框" class="headerlink" title="信封效果边框"></a>信封效果边框</h4><p>可以利用背景的渐变并应用在边框上</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">320px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">180px</span>;</span><br><span class="line"><span class="attribute">border</span>: <span class="number">10px</span> solid transparent;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">#fff</span>, <span class="number">#fff</span>) padding-box,</span><br><span class="line">  <span class="built_in">repeating-linear-gradient</span>(</span><br><span class="line">      -<span class="number">45deg</span>,</span><br><span class="line">      transparent <span class="number">0</span>,</span><br><span class="line">      transparent <span class="number">12.5%</span>,</span><br><span class="line">      red <span class="number">0</span>,</span><br><span class="line">      red <span class="number">25%</span>,</span><br><span class="line">      transparent <span class="number">0</span>,</span><br><span class="line">      transparent <span class="number">37.5%</span>,</span><br><span class="line">      <span class="number">#58a</span> <span class="number">0</span>,</span><br><span class="line">      <span class="number">#58a</span> <span class="number">50%</span>,</span><br><span class="line">      transparent <span class="number">0</span></span><br><span class="line">    )  <span class="number">0</span> / <span class="number">5em</span> <span class="number">5em</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0018.png"></p>
<h4 id="动态虚线边框"><a href="#动态虚线边框" class="headerlink" title="动态虚线边框"></a>动态虚线边框</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">width</span>: <span class="number">320px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">180px</span>;</span><br><span class="line"><span class="attribute">border</span>: <span class="number">1px</span> solid transparent;</span><br><span class="line"><span class="attribute">background</span>:</span><br><span class="line">  <span class="built_in">linear-gradient</span>(<span class="number">#fff</span>, <span class="number">#fff</span>) padding-box,</span><br><span class="line">  <span class="built_in">repeating-linear-gradient</span>(</span><br><span class="line">    -<span class="number">45deg</span>,</span><br><span class="line">    transparent <span class="number">0</span>,</span><br><span class="line">    transparent <span class="number">25%</span>,</span><br><span class="line">    <span class="number">#000</span> <span class="number">0</span>,</span><br><span class="line">    <span class="number">#000</span> <span class="number">50%</span></span><br><span class="line">  )  <span class="number">0</span> / <span class="number">0.5em</span> <span class="number">0.5em</span>;</span><br><span class="line">  <span class="attribute">animation</span>: ani <span class="number">10s</span> linear infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> ani &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">      <span class="attribute">background-position</span>:<span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    <span class="attribute">background-position</span>:<span class="number">100%</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/posts/b24d034ad9f9/0019.png"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/Docker安装gitlab"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/2f7bd6cd3db4/"
    >Docker 安装 gitlab</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/2f7bd6cd3db4/" class="article-date">
  <time datetime="2022-03-04T14:17:00.000Z" itemprop="datePublished">2022-03-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h4><p>只需要准备好证书文件，配置.yml文件即可使用</p>
<blockquote>
<p>&#x2F;docker&#x2F;gitlab&#x2F;docker-compose.yml</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: <span class="string">&#x27;gitlab/gitlab-ee:latest&#x27;</span></span><br><span class="line">    container_name: gitlab</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url <span class="string">&#x27;https://gitlab.iftrue.club:4917&#x27;</span></span><br><span class="line">        gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 2222</span><br><span class="line">        nginx[<span class="string">&#x27;redirect_http_to_https&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">        nginx[<span class="string">&#x27;ssl_certificate&#x27;</span>] = <span class="string">&quot;/etc/gitlab/trusted-certs/gitlab.iftrue.club.pem&quot;</span></span><br><span class="line">        nginx[<span class="string">&#x27;ssl_certificate_key&#x27;</span>] = <span class="string">&quot;/etc/gitlab/trusted-certs/gitlab.iftrue.club.key&quot;</span></span><br><span class="line"></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&#x27;4917:4917&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;2222:22&#x27;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&#x27;./config:/etc/gitlab&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;./logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;./data:/var/opt/gitlab&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动服务，需要等待一段时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h4 id="获取-x2F-修改-初始密码"><a href="#获取-x2F-修改-初始密码" class="headerlink" title="获取&#x2F;修改 初始密码"></a>获取&#x2F;修改 初始密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it  gitlab /bin/bash</span><br></pre></td></tr></table></figure>

<p>查看初始密码，安装gitlab后24小时会自动删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/gitlab/initial_root_password</span><br></pre></td></tr></table></figure>

<p>修改初始密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rails console                   <span class="comment"># 进入命令行</span></span><br><span class="line">u=User.where(<span class="built_in">id</span>:1).first               <span class="comment"># 查找root用户</span></span><br><span class="line">u.password=<span class="string">&#x27;12345678&#x27;</span>                  <span class="comment"># 修改密码</span></span><br><span class="line">u.password_confirmation=<span class="string">&#x27;12345678&#x27;</span>     <span class="comment"># 确认密码</span></span><br><span class="line">u.save                                 <span class="comment"># 保存配置</span></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitlab/" rel="tag">gitlab</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/Docker安装nextcloud"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/8d0fd81a8531/"
    >Docker 安装 nextcloud</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/8d0fd81a8531/" class="article-date">
  <time datetime="2022-03-04T14:14:00.000Z" itemprop="datePublished">2022-03-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><blockquote>
<p>&#x2F;docker&#x2F;nextCloud&#x2F;docker-compose.yml</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: mariadb:10.5</span><br><span class="line">    <span class="built_in">command</span>: --transaction-isolation=READ-COMMITTED --binlog-format=ROW</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - ./db:/var/lib/mysql</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=myPassword <span class="comment"># db.env环境变量中的相同</span></span><br><span class="line">    env_file:</span><br><span class="line">      - db.env</span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: redis:alpine</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  app:</span><br><span class="line">    image: nextcloud:apache</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - ./nextcloud:/var/www/html</span><br><span class="line">    environment:</span><br><span class="line">      - VIRTUAL_HOST=nextcloud.iftrue.club</span><br><span class="line">      - LETSENCRYPT_HOST=nextcloud.iftrue.club</span><br><span class="line">      - LETSENCRYPT_EMAIL=sunzhiqi@live.com</span><br><span class="line">      - MYSQL_HOST=db</span><br><span class="line">      - REDIS_HOST=redis</span><br><span class="line">    env_file:</span><br><span class="line">      - db.env</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">      - redis</span><br><span class="line">    networks:</span><br><span class="line">      - proxy-tier</span><br><span class="line">      - default</span><br><span class="line"></span><br><span class="line">  cron:</span><br><span class="line">    image: nextcloud:apache</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - ./nextcloud:/var/www/html</span><br><span class="line">    entrypoint: /cron.sh</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">      - redis</span><br><span class="line"></span><br><span class="line">  proxy:</span><br><span class="line">    build: ./proxy</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 7186:80</span><br><span class="line">      - 37186:443</span><br><span class="line">    labels:</span><br><span class="line">      com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy: <span class="string">&quot;true&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./certs:/etc/nginx/certs:ro</span><br><span class="line">      - ./vhost.d:/etc/nginx/vhost.d</span><br><span class="line">      - ./html:/usr/share/nginx/html</span><br><span class="line">      - /var/run/docker.sock:/tmp/docker.sock:ro</span><br><span class="line">    networks:</span><br><span class="line">      - proxy-tier</span><br><span class="line"></span><br><span class="line">  letsencrypt-companion:</span><br><span class="line">    image: nginxproxy/acme-companion</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - ./certs:/etc/nginx/certs</span><br><span class="line">      - ./acme:/etc/acme.sh</span><br><span class="line">      - ./vhost.d:/etc/nginx/vhost.d</span><br><span class="line">      - ./html:/usr/share/nginx/html</span><br><span class="line">      - /var/run/docker.sock:/var/run/docker.sock:ro</span><br><span class="line">    networks:</span><br><span class="line">      - proxy-tier</span><br><span class="line">    depends_on:</span><br><span class="line">      - proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># self signed</span></span><br><span class="line"><span class="comment">#  omgwtfssl:</span></span><br><span class="line"><span class="comment">#    image: paulczar/omgwtfssl</span></span><br><span class="line"><span class="comment">#    restart: &quot;no&quot;</span></span><br><span class="line"><span class="comment">#    volumes:</span></span><br><span class="line"><span class="comment">#      - certs:/certs</span></span><br><span class="line"><span class="comment">#    environment:</span></span><br><span class="line"><span class="comment">#      - SSL_SUBJECT=servhostname.local</span></span><br><span class="line"><span class="comment">#      - CA_SUBJECT=my@example.com</span></span><br><span class="line"><span class="comment">#      - SSL_KEY=/certs/servhostname.local.key</span></span><br><span class="line"><span class="comment">#      - SSL_CSR=/certs/servhostname.local.csr</span></span><br><span class="line"><span class="comment">#      - SSL_CERT=/certs/servhostname.local.crt</span></span><br><span class="line"><span class="comment">#    networks:</span></span><br><span class="line"><span class="comment">#      - proxy-tier</span></span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  db:</span><br><span class="line">  nextcloud:</span><br><span class="line">  certs:</span><br><span class="line">  acme:</span><br><span class="line">  vhost.d:</span><br><span class="line">  html:</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  proxy-tier:</span><br></pre></td></tr></table></figure>


<blockquote>
<p>&#x2F;docker&#x2F;nextCloud&#x2F;db.env</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MYSQL_PASSWORD=myPassword</span><br><span class="line">MYSQL_DATABASE=nextcloud</span><br><span class="line">MYSQL_USER=nextcloud</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x2F;docker&#x2F;nextCloud&#x2F;proxy&#x2F;Dockerfile</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM nginxproxy/nginx-proxy:alpine</span><br><span class="line">COPY uploadsize.conf /etc/nginx/conf.d/uploadsize.conf</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&#x2F;docker&#x2F;nextCloud&#x2F;proxy&#x2F;uploadsize.conf</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">client_max_body_size 10G;</span><br><span class="line">proxy_request_buffering off;</span><br></pre></td></tr></table></figure>

<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /docker/nextCloud</span><br><span class="line">docker-compose</span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nextcloud/" rel="tag">nextcloud</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/国内服务器中转流量"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/9bd88f9d9822/"
    >国内服务器中转流量</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/9bd88f9d9822/" class="article-date">
  <time datetime="2022-03-04T14:12:22.000Z" itemprop="datePublished">2022-03-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="firewalld-流量转发"><a href="#firewalld-流量转发" class="headerlink" title="firewalld 流量转发"></a>firewalld 流量转发</h4><p>firewalld是CentOS7&#x2F;8默认的防火墙前端软件，绝大多数主机商提供的镜像都已经安装。</p>
<p>判断防火墙是否已经开启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --state</span><br></pre></td></tr></table></figure>

<p>如果状态不是 <code>running</code>,使用下面命令安装或开启防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y firewalld         <span class="comment"># 安装</span></span><br><span class="line">systemctl <span class="built_in">enable</span> firewalld       <span class="comment"># 开机启动</span></span><br><span class="line">systemctl start firewalld        <span class="comment"># 开启防火墙</span></span><br></pre></td></tr></table></figure>

<p>配置转发。假设你将国内服务器9090端口流量转发到国外vps的9091端口，转发命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward = 1&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p                        <span class="comment"># 使配置生效</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用伪装 --permanent 配置永久生效</span></span><br><span class="line">firewall-cmd --permanent --add-masquerade</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看伪装是否生效</span></span><br><span class="line">firewall-cmd --permanent --query-masquerade</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启端口</span></span><br><span class="line">firewall-cmd --permanent --add-port=8080/tcp</span><br><span class="line">firewall-cmd --permanent --add-port=8080/udp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置转发</span></span><br><span class="line">firewall-cmd --permanent --add-forward-port=port=9090:proto=tcp:toaddr=xxx.xx.xxx.xx:toport=9091</span><br><span class="line">firewall-cmd --permanent --add-forward-port=port=9090:proto=udp:toaddr=xxx.xx.xxx.xx:toport=9091</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启防火墙生效 </span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p>云服务器需要在控制页面开启端口</p>
<p>ssr 等工具，ip和端口填写为国内转发服务器，链接时间和加密方式，和外网服务器配置相同</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/" rel="tag">CentOS</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/rsync备份"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/e5a73bbf0194/"
    >inotify + rsync 实现数据本地实时备份</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/e5a73bbf0194/" class="article-date">
  <time datetime="2022-03-04T14:06:48.000Z" itemprop="datePublished">2022-03-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h4><p>用 <code>inotify</code> 工具监听文件改变，将改变的文件使用 <code>rsync</code> 同步</p>
<h4 id="inotify介绍"><a href="#inotify介绍" class="headerlink" title="inotify介绍"></a>inotify介绍</h4><p>inotify 是一种强大的、细粒度的、异步文件系统监控机制，它满足各种各样的文件监控需要，可以监控文件系统的访问属性、读写属性、权限属性、创建删除、移动等操作，也可以监控文件发生的一切变化。</p>
<p>inotify-tools 是一个C库和一组命令行的工作提供Linux下inotify的简单接口。</p>
<p>inotify-tools 中包含 inotifywait 和 inotifywatch 两个命令</p>
<p>inotifywatch 命令用于收集关于被监控的文件系统的统计数据，包括每个inotify事件发生多少次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]<span class="comment"># inotifywait --help</span></span><br><span class="line">inotifywait 3.14</span><br><span class="line">Wait <span class="keyword">for</span> a particular event on a file or <span class="built_in">set</span> of files.</span><br><span class="line">Usage: inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]</span><br><span class="line">Options:</span><br><span class="line">    -h|--<span class="built_in">help</span>         Show this <span class="built_in">help</span> text.</span><br><span class="line">    @&lt;file&gt;           Exclude the specified file from being watched.</span><br><span class="line">    --exclude &lt;pattern&gt;</span><br><span class="line">                      Exclude all events on files matching the</span><br><span class="line">                      extended regular expression &lt;pattern&gt;.指定排除部分文件</span><br><span class="line">    --excludei &lt;pattern&gt;</span><br><span class="line">                      Like --exclude but <span class="keyword">case</span> insensitive.（同上，排除且忽略大小写）</span><br><span class="line">    -m|--monitor      Keep listening <span class="keyword">for</span> events forever.  Without</span><br><span class="line">                      this option, inotifywait will <span class="built_in">exit</span> after one</span><br><span class="line">                      event is received.(持续监听）</span><br><span class="line">    -d|--daemon       Same as --monitor, except run <span class="keyword">in</span> the background</span><br><span class="line">                      logging events to a file specified by --outfile.</span><br><span class="line">                      Implies --syslog.（daemon模式）</span><br><span class="line">    -r|--recursive    Watch directories recursively.（递归子目录）</span><br><span class="line">    --fromfile &lt;file&gt;</span><br><span class="line">                      Read files to watch from &lt;file&gt; or <span class="string">&#x27;-&#x27;</span> <span class="keyword">for</span> stdin.</span><br><span class="line">    -o|--outfile &lt;file&gt;</span><br><span class="line">                      Print events to &lt;file&gt; rather than stdout. （将事件输出到文件，而不是屏幕）</span><br><span class="line">    -s|--syslog       Send errors to syslog rather than stderr.</span><br><span class="line">    -q|--quiet        Print less (only <span class="built_in">print</span> events).（打印事件）</span><br><span class="line">    -qq               Print nothing (not even events).（不打印事件）</span><br><span class="line">    --format &lt;<span class="built_in">fmt</span>&gt;    Print using a specified printf-like format</span><br><span class="line">                      string; <span class="built_in">read</span> the man page <span class="keyword">for</span> more details. (设置打印格式%T时间；%w触发事件文件所在绝对路径；%f触发事件文件名称；%e触发的事件名称；)</span><br><span class="line">    --timefmt &lt;<span class="built_in">fmt</span>&gt;    strftime-compatible format string <span class="keyword">for</span> use with</span><br><span class="line">                      %T <span class="keyword">in</span> --format string.（指定输出内容，相当于将时间赋值给%T）</span><br><span class="line">    -c|--csv          Print events <span class="keyword">in</span> CSV format.</span><br><span class="line">    -t|--<span class="built_in">timeout</span> &lt;seconds&gt;</span><br><span class="line">                      When listening <span class="keyword">for</span> a single event, time out after</span><br><span class="line">                      waiting <span class="keyword">for</span> an event <span class="keyword">for</span> &lt;seconds&gt; seconds.</span><br><span class="line">                      If &lt;seconds&gt; is 0, inotifywait will never time out.</span><br><span class="line">    -e|--event &lt;event1&gt; [ -e|--event &lt;event2&gt; ... ]</span><br><span class="line">        Listen <span class="keyword">for</span> specific event(s).  If omitted, all events are </span><br><span class="line">        listened <span class="keyword">for</span>.（指定要监听的事件，多个事件用逗号隔开）</span><br><span class="line"></span><br><span class="line">Exit status:</span><br><span class="line">    0  -  An event you asked to watch <span class="keyword">for</span> was received.</span><br><span class="line">    1  -  An event you did not ask to watch <span class="keyword">for</span> was received</span><br><span class="line">          (usually delete_self or unmount), or some error occurred.</span><br><span class="line">    2  -  The --<span class="built_in">timeout</span> option was given and no events occurred</span><br><span class="line">          <span class="keyword">in</span> the specified interval of time.</span><br><span class="line"></span><br><span class="line">Events:     （事件）</span><br><span class="line">    access        file or directory contents were <span class="built_in">read</span></span><br><span class="line">    modify        file or directory contents were written</span><br><span class="line">    attrib        file or directory attributes changed</span><br><span class="line">    close_write    file or directory closed, after being opened <span class="keyword">in</span></span><br><span class="line">                   writeable mode</span><br><span class="line">    close_nowrite    file or directory closed, after being opened <span class="keyword">in</span></span><br><span class="line">                   read-only mode</span><br><span class="line">    close        file or directory closed, regardless of <span class="built_in">read</span>/write mode</span><br><span class="line">    open        file or directory opened</span><br><span class="line">    moved_to    file or directory moved to watched directory</span><br><span class="line">    moved_from    file or directory moved from watched directory</span><br><span class="line">    move        file or directory moved to or from watched directory</span><br><span class="line">    create        file or directory created within watched directory</span><br><span class="line">    delete        file or directory deleted within watched directory</span><br><span class="line">    delete_self    file or directory was deleted</span><br><span class="line">    unmount        file system containing file or directory unmounted</span><br></pre></td></tr></table></figure>

<p><strong>示例</strong> 监听&#x2F;backup&#x2F;目录下所有文件和目录的增删改操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inotifywait -mrq -e <span class="string">&#x27;create,delete,close_write,attrib,moved_to&#x27;</span> --timefmt <span class="string">&#x27;%Y-%m-%d %H:%M&#x27;</span> --format <span class="string">&#x27;%T %w%f %e&#x27;</span> /backup/</span><br></pre></td></tr></table></figure>

<h4 id="rsync介绍"><a href="#rsync介绍" class="headerlink" title="rsync介绍"></a>rsync介绍</h4><p>rsync是可以实现增量备份的工具。配合任务计划，rsync能实现定时或间隔同步，配合inotify或sersync，可以实现触发式的实时同步。</p>
<p>Rsync的命令格式可以为以下六种：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rsync [OPTION]... SRC DEST</span><br><span class="line">rsync [OPTION]... SRC [USER@]HOST:DEST</span><br><span class="line">rsync [OPTION]... [USER@]HOST:SRC DEST</span><br><span class="line">rsync [OPTION]... [USER@]HOST::SRC DEST</span><br><span class="line">rsync [OPTION]... SRC [USER@]HOST::DEST</span><br><span class="line">rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</span><br></pre></td></tr></table></figure>

<p>对应于以上六种命令格式，rsync有六种不同的工作模式：</p>
<p>　　1)拷贝本地文件。当SRC和DES路径信息都不包含有单个冒号”:”分隔符时就启动这种工作模式。如：rsync -a &#x2F;data &#x2F;backup</p>
<p>　　2)使用一个远程shell程序(如rsh、ssh)来实现将本地机器的内容拷贝到远程机器。当DST路径地址包含单个冒号”:”分隔符时启动该模式。如：rsync -avz *.c foo:src</p>
<p>　　3)使用一个远程shell程序(如rsh、ssh)来实现将远程机器的内容拷贝到本地机器。当SRC地址路径包含单个冒号”:”分隔符时启动该模式。如：rsync -avz foo:src&#x2F;bar &#x2F;data</p>
<p>　　4)从远程rsync服务器中拷贝文件到本地机。当SRC路径信息包含”::”分隔符时启动该模式。如：rsync -av <a href="mailto:&#x72;&#111;&#111;&#x74;&#64;&#49;&#55;&#50;&#46;&#49;&#54;&#x2e;&#55;&#56;&#46;&#x31;&#x39;&#x32;">&#x72;&#111;&#111;&#x74;&#64;&#49;&#55;&#50;&#46;&#49;&#54;&#x2e;&#55;&#56;&#46;&#x31;&#x39;&#x32;</a>::www &#x2F;databack</p>
<p>　　5)从本地机器拷贝文件到远程rsync服务器中。当DST路径信息包含”::”分隔符时启动该模式。如：rsync -av &#x2F;databack <a href="mailto:&#x72;&#111;&#x6f;&#x74;&#x40;&#49;&#55;&#50;&#x2e;&#x31;&#x36;&#46;&#x37;&#x38;&#x2e;&#x31;&#57;&#50;">&#x72;&#111;&#x6f;&#x74;&#x40;&#49;&#55;&#50;&#x2e;&#x31;&#x36;&#46;&#x37;&#x38;&#x2e;&#x31;&#57;&#50;</a>::www</p>
<p>　　6)列远程机的文件列表。这类似于rsync传输，不过只要在命令中省略掉本地机信息即可。如：rsync -v rsync:&#x2F;&#x2F;172.16.78.192&#x2F;www</p>
<p>rsync参数的具体解释如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">-v, --verbose 详细模式输出</span><br><span class="line">-q, --quiet 精简输出模式</span><br><span class="line">-c, --checksum 打开校验开关，强制对文件传输进行校验</span><br><span class="line">-a, --archive 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rlptgoD</span><br><span class="line">-r, --recursive 对子目录以递归模式处理</span><br><span class="line">-R, --relative 使用相对路径信息</span><br><span class="line">-b, --backup 创建备份，也就是对于目的已经存在有同样的文件名时，将老的文件重新命名为~filename。可以使用--suffix选项来指定不同的备份文件前缀。</span><br><span class="line">--backup-dir 将备份文件(如~filename)存放在在目录下。</span><br><span class="line">-suffix=SUFFIX 定义备份文件前缀</span><br><span class="line">-u, --update 仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件。(不覆盖更新的文件)</span><br><span class="line">-l, --links 保留软链结</span><br><span class="line">-L, --copy-links 想对待常规文件一样处理软链结</span><br><span class="line">--copy-unsafe-links 仅仅拷贝指向SRC路径目录树以外的链结</span><br><span class="line">--safe-links 忽略指向SRC路径目录树以外的链结</span><br><span class="line">-H, --hard-links 保留硬链结</span><br><span class="line">-p, --perms 保持文件权限</span><br><span class="line">-o, --owner 保持文件属主信息</span><br><span class="line">-g, --group 保持文件属组信息</span><br><span class="line">-D, --devices 保持设备文件信息</span><br><span class="line">-t, --<span class="built_in">times</span> 保持文件时间信息</span><br><span class="line">-S, --sparse 对稀疏文件进行特殊处理以节省DST的空间</span><br><span class="line">-n, --dry-run现实哪些文件将被传输</span><br><span class="line">-W, --whole-file 拷贝文件，不进行增量检测</span><br><span class="line">-x, --one-file-system 不要跨越文件系统边界</span><br><span class="line">-B, --block-size=SIZE 检验算法使用的块尺寸，默认是700字节</span><br><span class="line">-e, --rsh=COMMAND 指定使用rsh、ssh方式进行数据同步</span><br><span class="line">--rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息</span><br><span class="line">-C, --cvs-exclude 使用和CVS一样的方法自动忽略文件，用来排除那些不希望传输的文件</span><br><span class="line">--existing 仅仅更新那些已经存在于DST的文件，而不备份那些新创建的文件</span><br><span class="line">--delete 删除那些DST中SRC没有的文件</span><br><span class="line">--delete-excluded 同样删除接收端那些被该选项指定排除的文件</span><br><span class="line">--delete-after 传输结束以后再删除</span><br><span class="line">--ignore-errors 及时出现IO错误也进行删除</span><br><span class="line">--max-delete=NUM 最多删除NUM个文件</span><br><span class="line">--partial 保留那些因故没有完全传输的文件，以是加快随后的再次传输</span><br><span class="line">--force 强制删除目录，即使不为空</span><br><span class="line">--numeric-ids 不将数字的用户和组ID匹配为用户名和组名</span><br><span class="line">--<span class="built_in">timeout</span>=TIME IP超时时间，单位为秒</span><br><span class="line">-I, --ignore-times 不跳过那些有同样的时间和长度的文件</span><br><span class="line">--size-only 当决定是否要备份文件时，仅仅察看文件大小而不考虑文件时间</span><br><span class="line">--modify-window=NUM 决定文件是否时间相同时使用的时间戳窗口，默认为0</span><br><span class="line">-T --temp-dir=DIR 在DIR中创建临时文件</span><br><span class="line">--compare-dest=DIR 同样比较DIR中的文件来决定是否需要备份</span><br><span class="line">-P 等同于 --partial</span><br><span class="line">--progress 显示备份过程</span><br><span class="line">-z, --compress 对备份的文件在传输时进行压缩处理</span><br><span class="line">--exclude=PATTERN 指定排除不需要传输的文件模式</span><br><span class="line">--include=PATTERN 指定不排除而需要传输的文件模式</span><br><span class="line">--exclude-from=FILE 排除FILE中指定模式的文件</span><br><span class="line">--include-from=FILE 不排除FILE指定模式匹配的文件</span><br><span class="line">--version 打印版本信息</span><br><span class="line">--address 绑定到特定的地址</span><br><span class="line">--config=FILE 指定其他的配置文件，不使用默认的rsyncd.conf文件</span><br><span class="line">--port=PORT 指定其他的rsync服务端口</span><br><span class="line">--blocking-io 对远程shell使用阻塞IO</span><br><span class="line">-stats 给出某些文件的传输状态</span><br><span class="line">--progress 在传输时现实传输过程</span><br><span class="line">--log-format=formAT 指定日志文件格式</span><br><span class="line">--password-file=FILE 从FILE中得到密码</span><br><span class="line">--bwlimit=KBPS 限制I/O带宽，KBytes per second</span><br><span class="line">-h, --<span class="built_in">help</span> 显示帮助信息</span><br></pre></td></tr></table></figure>

<p><strong>示例1</strong> 将&#x2F;etc&#x2F;fstab拷贝到&#x2F;tmp目录下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync /etc/fstab /tmp</span><br></pre></td></tr></table></figure>

<p><strong>示例2</strong> 将&#x2F;etc&#x2F;cron.d目录拷贝到&#x2F;tmp下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -r /etc/cron.d /tmp</span><br></pre></td></tr></table></figure>

<p><strong>说明</strong>：为了保持文件夹一致，可以将路径写为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avr /src/ /backup/</span><br></pre></td></tr></table></figure>

<p>这样src下面的所有目录会被备份到 backup目录下面,而不会在backup文件夹下面创建src文件夹</p>
<h4 id="创建同步脚本"><a href="#创建同步脚本" class="headerlink" title="创建同步脚本"></a>创建同步脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">fn</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">	src=<span class="variable">$1</span>     <span class="comment"># 需要同步的源路径</span></span><br><span class="line">	des=<span class="variable">$2</span>     <span class="comment"># 目标路径</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">cd</span> <span class="variable">$&#123;src&#125;</span> <span class="comment">#定位到源文件下面</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 此方法中，由于rsync同步的特性，这里必须要先cd到源目录，inotify再监听 ./ 才能rsync同步后目录结构一致</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 把监控到有发生更改的&quot;文件路径列表&quot;循环</span></span><br><span class="line">	/usr/bin/inotifywait -mrq --format <span class="string">&#x27;%Xe %w%f&#x27;</span> -e modify,create,delete,attrib,close_write,move ./ | <span class="keyword">while</span> <span class="built_in">read</span> file; <span class="keyword">do</span></span><br><span class="line">		INO_EVENT=$(<span class="built_in">echo</span> <span class="variable">$file</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>) <span class="comment"># 把inotify输出切割 把事件类型部分赋值给INO_EVENT</span></span><br><span class="line">		INO_FILE=$(<span class="built_in">echo</span> <span class="variable">$file</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)  <span class="comment"># 把inotify输出切割 把文件路径部分赋值给INO_FILE</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;-------------------------------<span class="subst">$(date)</span>------------------------------------&quot;</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$file</span></span><br><span class="line">		<span class="comment">#增加、修改、写入完成、移动进事件</span></span><br><span class="line">		<span class="comment">#增、改放在同一个判断，因为他们都肯定是针对文件的操作，即使是新建目录，要同步的也只是一个空目录，不会影响速度。</span></span><br><span class="line">		<span class="keyword">if</span> [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;CREATE&#x27;</span> ]] || [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;MODIFY&#x27;</span> ]] || [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;CLOSE_WRITE&#x27;</span> ]] || [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;MOVED_TO&#x27;</span> ]]; <span class="keyword">then</span> <span class="comment"># 判断事件类型</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&#x27;CREATE or MODIFY or CLOSE_WRITE or MOVED_TO&#x27;</span></span><br><span class="line">			<span class="comment"># INO_FILE变量代表路径  -c校验文件内容</span></span><br><span class="line">			rsync -avzcR $(<span class="built_in">dirname</span> <span class="variable">$&#123;INO_FILE&#125;</span>) <span class="variable">$&#123;des&#125;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">#上面的rsync同步命令 源是用了$(dirname $&#123;INO_FILE&#125;)变量 即每次只针对性的同步发生改变的文件的目录</span></span><br><span class="line">			<span class="comment">#只同步目标文件的方法在生产环境的某些极端环境下会漏文件 现在可以在不漏文件下也有不错的速度 做到平衡)</span></span><br><span class="line">			<span class="comment">#然后用-R参数把源的目录结构递归到目标后面 保证目录结构一致性</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="comment">#删除、移动出事件</span></span><br><span class="line">		<span class="keyword">if</span> [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;DELETE&#x27;</span> ]] || [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;MOVED_FROM&#x27;</span> ]]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&#x27;DELETE or MOVED_FROM&#x27;</span></span><br><span class="line">			<span class="comment">#并加上--delete来删除目标上有而源中没有的文件，这里不能做到指定文件删除，如果删除的路径越靠近根，则同步的目录月多，同步删除的操作就越花时间。</span></span><br><span class="line">			rsync -avzr --delete $(<span class="built_in">dirname</span> <span class="variable">$&#123;INO_FILE&#125;</span>) <span class="variable">$&#123;des&#125;</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="comment">#修改属性事件 指 touch chmod chown等操作</span></span><br><span class="line">		<span class="keyword">if</span> [[ <span class="variable">$INO_EVENT</span> =~ <span class="string">&#x27;ATTRIB&#x27;</span> ]]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&#x27;ATTRIB&#x27;</span></span><br><span class="line">			<span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$INO_FILE</span>&quot;</span> ]; <span class="keyword">then</span> <span class="comment"># 如果修改属性的是目录 则不同步，因为同步目录会发生递归扫描，等此目录下的文件发生同步时，rsync会顺带更新此目录。</span></span><br><span class="line">				rsync -avzcR $(<span class="built_in">dirname</span> <span class="variable">$&#123;INO_FILE&#125;</span>) <span class="variable">$&#123;des&#125;</span></span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn /home/supreme/Workspace/ /media/supreme/yes/Workspace/ &amp; <span class="comment">#加上&amp;符号表示在后台执行</span></span><br><span class="line">fn 源路径2 目标路径2 &amp; <span class="comment">#加上&amp;符号表示在后台执行</span></span><br></pre></td></tr></table></figure>

<h4 id="添加开机启动项"><a href="#添加开机启动项" class="headerlink" title="添加开机启动项"></a>添加开机启动项</h4><p>将写好的脚本放到指定目录中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> ./sync.sh /usr/sbin</span><br></pre></td></tr></table></figure>
<p>创建一个服务文件 sync.service</p>
<p>systemd有系统和用户区分；系统（&#x2F;user&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;）、用户（&#x2F;etc&#x2F;lib&#x2F;systemd&#x2F;user&#x2F;）.</p>
<p>一般系统管理员手工创建的单元文件建议存放在&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;目录下面。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description= 服务的简单描述</span><br><span class="line">Documentation= 服务文档</span><br><span class="line"><span class="comment"># Before、After:定义启动顺序。Before=xxx.service,代表本服务在xxx.service启动之前启动。After=xxx.service,代表本服务在xxx.service之后启动。</span></span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="comment"># systemd认为当该服务进程fork，且父进程退出后服务启动成功。对于常规的守护进程 daemon</span></span><br><span class="line"><span class="comment"># 除非你确定此启动方式无法满足需求，使用此类型启动即可。使用此启动类型应同时指定 PIDFile=，以便systemd能够跟踪服务的主进程。</span></span><br><span class="line">Type=forking</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/sbin/sync.sh</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="comment"># 单元被允许运行需要的弱依赖性单元，WantBy从Want列表获得依赖信息。</span></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>添加开机启动并重载服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> sync.service</span><br><span class="line"></span><br><span class="line">sudo systemctl start sync.service</span><br><span class="line">sudo systemctl stop sync.service</span><br><span class="line">sudo systemctl reload sync.service</span><br><span class="line"></span><br></pre></td></tr></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/inotify/" rel="tag">inotify</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rsync/" rel="tag">rsync</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/6/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/8/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> SunZhiqi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.png" alt="四月八日"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Essay">随笔</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>此时无声胜有声！</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="/js/jquery.modal.min.js"></script>
<link rel="stylesheet" href="/css/jquery.modal.min.css" />
<script src="/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
  <div class="pswp__bg"></div>

  <!-- Slides wrapper with overflow:hidden. -->
  <div class="pswp__scroll-wrap">
    <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>

    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <!--  Controls are self-explanatory. Order can be changed. -->

        <div class="pswp__counter"></div>

        <button
          class="pswp__button pswp__button--close"
          title="Close (Esc)"
        ></button>

        <button
          class="pswp__button pswp__button--share"
          style="display: none"
          title="Share"
        ></button>

        <button
          class="pswp__button pswp__button--fs"
          title="Toggle fullscreen"
        ></button>

        <button
          class="pswp__button pswp__button--zoom"
          title="Zoom in/out"
        ></button>

        <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
        <!-- element will get class pswp__preloader--active when preloader is running -->
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip"></div>
      </div>

      <button
        class="pswp__button pswp__button--arrow--left"
        title="Previous (arrow left)"
      ></button>

      <button
        class="pswp__button pswp__button--arrow--right"
        title="Next (arrow right)"
      ></button>

      <div class="pswp__caption">
        <div class="pswp__caption__center"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/photoswipe.min.css" />
<link rel="stylesheet" href="/css/default-skin.min.css" />
<script src="/js/photoswipe.min.js"></script>
<script src="/js/photoswipe-ui-default.min.js"></script>

<script>
  function viewer_init() {
    let pswpElement = document.querySelectorAll(".pswp")[0];
    let $imgArr = document.querySelectorAll(
      ".article-entry img:not(.reward-img)"
    );

    $imgArr.forEach(($em, i) => {
      $em.onclick = () => {
        // slider展开状态
        // todo: 这样不好，后面改成状态
        if (document.querySelector(".left-col.show")) return;
        let items = [];
        $imgArr.forEach(($em2, i2) => {
          let img = $em2.getAttribute("data-idx", i2);
          let src =
            $em2.getAttribute("data-target") || $em2.getAttribute("src");
          let title = $em2.getAttribute("alt");
          // 获得原图尺寸
          const image = new Image();
          image.src = src;
          items.push({
            src: src,
            w: image.width || $em2.width,
            h: image.height || $em2.height,
            title: title,
          });
        });
        var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
          index: parseInt(i),
        });
        gallery.init();
      };
    });
  }
  viewer_init();
</script>
 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="/js/MathJax.js"></script>
<script src="/js/TeX-AMS-MML_HTMLorMML-full.js"></script>

<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="/js/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !(function (e, t, a) {
    var initCopyCode = function () {
      var copyHtml = "";
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += "</button>";
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS(".btn-copy", {
        target: function (trigger) {
          return trigger.nextElementSibling;
        },
      });
      clipboard.on("success", function (e) {
        let $btn = $(e.trigger);
        $btn.addClass("copied");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-checkbox-circle-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPIED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-checkbox-circle-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
      clipboard.on("error", function (e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass("copy-failed");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-time-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPY FAILED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-time-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
    };
    initCopyCode();
  })(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "default" });
  }
</script>


    
    

  </div>
</body>

</html>