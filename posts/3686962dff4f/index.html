<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="前端 web react" />
       
      <meta name="description" content="前端技术与生活。" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>React源码分析 ⑦ Diff 算法 |  四月八日</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">
 
<link rel="stylesheet" href="/css/fonts/remixicon.css">
 
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="/js/pace.min.js"></script>
       
 

      <link rel="stylesheet" href="/css/bulma.min.css" />
      <script src="/js/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <script src="https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js"></script>
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/katex.min.css">

<link rel="stylesheet" href="/css/style.css">
<!-- hexo injector head_end end --></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="posts-source/react/⑦Diff算法"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  React源码分析 ⑦ Diff 算法
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/3686962dff4f/" class="article-date">
  <time datetime="2022-03-28T07:40:23.000Z" itemprop="datePublished">2022-03-28</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> / <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/React/">React</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">3.1k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">15 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="设计动机"><a href="#设计动机" class="headerlink" title="设计动机"></a>设计动机</h4><p>调用 React 的 render() 方法，会创建一棵由 React 元素组成的树。在下一次 state 或 props 更新时，相同的 render() 方法会返回一棵不同的树。React 需要基于这两棵树之间的差别来判断如何高效的更新 UI，以保证当前 UI 与最新的树保持同步。</p>
<p>将一棵树转换成另一棵树的最小操作次数,即使使用最优的算法，该算法的复杂程度仍为 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.832ex" height="2.451ex" role="img" focusable="false" viewBox="0 -833.2 2577.6 1083.2" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-31-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-31-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-31-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-31-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-31-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D442" xlink:href="#MJX-31-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763,0)"><use data-c="28" xlink:href="#MJX-31-TEX-N-28"></use></g><g data-mml-node="msup" transform="translate(1152,0)"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-31-TEX-I-1D45B"></use></g><g data-mml-node="mn" transform="translate(633,363) scale(0.707)"><use data-c="33" xlink:href="#MJX-31-TEX-N-33"></use></g></g><g data-mml-node="mo" transform="translate(2188.6,0)"><use data-c="29" xlink:href="#MJX-31-TEX-N-29"></use></g></g></g></svg></mjx-container>，其中 n 是树中元素的数量。</p>
<p>如果在 React 中使用该算法，那么展示 1000 个元素则需要 10 亿次的比较。这个开销实在是太过高昂。于是 React 在以下两个假设的基础之上提出了一套 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2141 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-30-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-30-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-30-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-30-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D442" xlink:href="#MJX-30-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763,0)"><use data-c="28" xlink:href="#MJX-30-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152,0)"><use data-c="1D45B" xlink:href="#MJX-30-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(1752,0)"><use data-c="29" xlink:href="#MJX-30-TEX-N-29"></use></g></g></g></svg></mjx-container> 的启发式算法：</p>
<ul>
<li>两个不同类型的元素会产生出不同的树；</li>
<li>开发者可以通过设置 key 属性，来告知渲染哪些子元素在不同的渲染下可以保存不变；</li>
</ul>
<p>换一种说法就是 :</p>
<ul>
<li>只对同级比较，跨层级的 dom 不会进行复用</li>
<li>不同类型节点生成的 dom 树不同，此时会直接销毁老节点及子孙节点，并新建节点</li>
<li>可以通过 key 来对元素 diff 的过程提供复用的条件</li>
</ul>
<h4 id="单节点-Diff"><a href="#单节点-Diff" class="headerlink" title="单节点 Diff"></a>单节点 Diff</h4><ul>
<li>key 和 type 相同表示可以复用节点</li>
<li>type 不同直接标记删除节点，然后新建节点</li>
<li>key 相同 type 不同，标记删除该节点和兄弟节点，然后新创建节点</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eg1</span></span><br><span class="line"><span class="keyword">const</span> A = <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">key</span>=<span class="string">&quot;a&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> B = <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">kay</span>=<span class="string">&quot;a&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// eg2</span></span><br><span class="line"><span class="keyword">const</span> A = <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">key</span>=<span class="string">&quot;a&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> B = <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">kay</span>=<span class="string">&quot;b&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<p>还记得 <a href="/posts/7db523698f9f/#reconcileChildren">reconcileChildren</a> 方法么, 它是双缓存 Fiber 构建时候调用的方法,因为<strong>新的节点是单节点</strong>,所以会进入 <code>reconcileSingleElement</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//                              div Fiber    span 0 Fiber      span 1 JSXElement</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileSingleElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">  returnFiber,</span></span><br><span class="line"><span class="params">  currentFirstChild,</span></span><br><span class="line"><span class="params">  element,</span></span><br><span class="line"><span class="params">  lanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> key = element.<span class="property">key</span>;</span><br><span class="line">  <span class="keyword">var</span> child = currentFirstChild;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to the first item in the list.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (child.<span class="property">key</span> === key) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (child.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">Fragment</span>: &#123;</span><br><span class="line">          <span class="keyword">if</span> (element.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span>) &#123;</span><br><span class="line">            <span class="title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="property">sibling</span>);</span><br><span class="line">            <span class="keyword">var</span> existing = <span class="title function_">useFiber</span>(child, element.<span class="property">props</span>.<span class="property">children</span>);</span><br><span class="line">            existing.<span class="property">return</span> = returnFiber;</span><br><span class="line">            <span class="keyword">return</span> existing;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">Block</span>:</span><br><span class="line"></span><br><span class="line">        <span class="attr">default</span>: <span class="comment">// key 相同 type 相同 eg1</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            child.<span class="property">elementType</span> === element.<span class="property">type</span> ||</span><br><span class="line">            <span class="comment">// Keep this check inline so it only runs on the false path:</span></span><br><span class="line">            <span class="title function_">isCompatibleFamilyForHotReloading</span>(child, element)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="comment">// 因为新的节点是单节点,所以新的fiber节点不会再有兄弟节点</span></span><br><span class="line">            <span class="comment">// 在重用之前兄弟节点标记为删除</span></span><br><span class="line">            <span class="title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="property">sibling</span>);</span><br><span class="line">            <span class="comment">// 通过 createWorkInProgress clone节点</span></span><br><span class="line">            <span class="comment">// _existing3.sibling = null 因为上面的删除只是标记,而在链表中需要真正删除sibling属性</span></span><br><span class="line">            <span class="comment">// 官方注释为: 在这里把 sibling 赋值为 null, 因为返回节点前很容易忘记赋值</span></span><br><span class="line">            <span class="keyword">var</span> _existing3 = <span class="title function_">useFiber</span>(child, element.<span class="property">props</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ref 属性相关操作,重新为ref节点赋值</span></span><br><span class="line">            _existing3.<span class="property">ref</span> = <span class="title function_">coerceRef</span>(returnFiber, child, element);</span><br><span class="line">            _existing3.<span class="property">return</span> = returnFiber;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回 clone 的节点</span></span><br><span class="line">            <span class="keyword">return</span> _existing3;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="comment">// Didn&#x27;t match.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// key 相同 type 不同,节点本身和兄弟节点全部标记为删除, eg3</span></span><br><span class="line">      <span class="comment">// ke 相同表示两个节点是对应的,所以兄弟节点无效标记为删除</span></span><br><span class="line">      <span class="comment">// 但是type类型不同所以不能复用所以节点本身也需要标记为删除</span></span><br><span class="line">      <span class="title function_">deleteRemainingChildren</span>(returnFiber, child);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果 key 不相同,直接将这个节点删掉 eg2</span></span><br><span class="line">      <span class="title function_">deleteChild</span>(returnFiber, child);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 看兄弟节点是否可以通过 key 相同复用,例如</span></span><br><span class="line">    <span class="comment">// current [a, p, span]</span></span><br><span class="line">    <span class="comment">// new     p</span></span><br><span class="line">    <span class="comment">// 兄弟节点中有一个 p 节点可以复用</span></span><br><span class="line">    child = child.<span class="property">sibling</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果没有节点可以复用, 就通过 JSXElement 创建一个新的 Fiber 节点</span></span><br><span class="line">  <span class="keyword">if</span> (element.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> created = <span class="title function_">createFiberFromFragment</span>(</span><br><span class="line">      element.<span class="property">props</span>.<span class="property">children</span>,</span><br><span class="line">      returnFiber.<span class="property">mode</span>,</span><br><span class="line">      lanes,</span><br><span class="line">      element.<span class="property">key</span></span><br><span class="line">    );</span><br><span class="line">    created.<span class="property">return</span> = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> created;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> _created4 = <span class="title function_">createFiberFromElement</span>(element, returnFiber.<span class="property">mode</span>, lanes);</span><br><span class="line"></span><br><span class="line">    _created4.<span class="property">ref</span> = <span class="title function_">coerceRef</span>(returnFiber, currentFirstChild, element);</span><br><span class="line">    _created4.<span class="property">return</span> = returnFiber;</span><br><span class="line">    <span class="keyword">return</span> _created4;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多节点-diff"><a href="#多节点-diff" class="headerlink" title="多节点 diff"></a>多节点 diff</h4><p>react 用 3 次循环实现了 react diff 算法, 下面是整个方法中的全局变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Diff结果的第一个节点</span></span><br><span class="line"><span class="keyword">var</span> resultingFirstChild = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 新的子元素数组的集合</span></span><br><span class="line"><span class="keyword">var</span> knownKeys = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line"><span class="comment">// 上次可复用的位置</span></span><br><span class="line"><span class="keyword">var</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 当前对比的老的元素</span></span><br><span class="line"><span class="keyword">var</span> oldFiber = currentFirstChild;</span><br><span class="line"><span class="comment">// 保存老的节点中下一个需要对比的元素</span></span><br><span class="line"><span class="keyword">var</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 计数器,记录新元素遍历到的位置</span></span><br><span class="line"><span class="keyword">var</span> newIdx = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><strong>第一次循环</strong></p>
<ul>
<li>用 <code>newChildren[newIdx]</code> 与 <code>oldFiber</code> 比较<ul>
<li>如果新元素是 reactElement<ul>
<li>key 相同,type 相同, 则会使用 useFiber 复用节点</li>
<li>key 相同,type 不同, 通过 JSXElement 创建新的节点</li>
<li>key 不同, 直接跳出循环,可能存在移动,用下一个循环处理</li>
</ul>
</li>
<li>如果新元素是文本元素<ul>
<li>由于文本元素没有 key,所以老的节点如果有 key,那么元素类型一定不同,直接跳出循环,等待下一个循环处理</li>
<li>如果老的节点没有 key, 是否 <code>tag=HostText</code>,如果是则 useFiber 复用节点,如果不是 createFiberFromText 创建节点</li>
</ul>
</li>
<li>如果新元素是数组<ul>
<li>老元素没有 key, 直接跳出循环</li>
<li>老元素有 key 且 <code>oldFiber.tag===Fragment</code>, 通过 createFiberFromFragment 创建新的子元素</li>
<li>老元素有 key 且 <code>oldFiber.tag!==Fragment</code>, useFiber 复用节点</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>在复用或创建节点的同时也会传入新的 props 属性, 新的属性在 <a href="/posts/3aa5257401aa/#diffProperties">diffProperties</a> 的时候会被解析,并添加到 updateQueue 中</p>
<p>如果不需要跳出循环, 通过 <code>newFiber.alternate === null</code> 判断返回的节点是复用的还是新建的,因为新建的节点没有 <code>alternate</code>,如果是新建的节点, oldFiber 的服级节点上删除 oldFiber, 因为已经有了新节点,且老的节点也没有被使用</p>
<p>下一步是给新的 Fiber 添加位置信息,调用 placeChild 方法, <code>newFiber.index = newIndex</code>, 并给 lastPlacedIndex 赋值<br>如果是新建的节点,会被标记为插入, lastPlacedIndex 不变,因为这个位置不能复用,如果是复用节点的 <code>index &lt; lastPlacedIndex</code>,说明节点被移动了会打上移动的标记, 如果 <code>index &gt;= lastPlacedIndex</code> 节点位置不需要移动, 因为所有小于这个节点位置的元素都会被移动到后面.</p>
<p>总结: 第一个循环主要处理属性的更新, key 不同则循环结束</p>
<p><strong>第二次循环</strong></p>
<p>如果 <code>oldFiber</code> 已经遍历到头, <code>newChildren</code> 还有剩余, 则会进入第二个循环, 将 <code>newChildren</code> 剩余的子元素,全部新建,并且标记为插入</p>
<p><strong>第三次循环</strong></p>
<p>如果第一次循环提前跳出, <code>oldFiber</code>, <code>newChildren</code> 都有剩余则会进入第三次循环</p>
<p>首先把 <code>oldFiber</code> 转换成 map 格式,方便用 key 迅速查找对应的节点,如果新元素的 key 在 map 中存在则复用节点,如果不存在则新建节点</p>
<p>调用第一次循环中的 placeChild , 为元素排序</p>
<p><img src="/posts/3686962dff4f/0001.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildrenArray</span>(<span class="params"></span></span><br><span class="line"><span class="params">  returnFiber,</span></span><br><span class="line"><span class="params">  currentFirstChild,</span></span><br><span class="line"><span class="params">  newChildren,</span></span><br><span class="line"><span class="params">  lanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// First, validate keys.</span></span><br><span class="line">    <span class="keyword">var</span> knownKeys = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; newChildren.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> child = newChildren[i];</span><br><span class="line">      knownKeys = <span class="title function_">warnOnInvalidKey</span>(child, knownKeys, returnFiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> resultingFirstChild = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> previousNewFiber = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> oldFiber = currentFirstChild;</span><br><span class="line">  <span class="keyword">var</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> newIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldFiber.<span class="property">index</span> &gt; newIdx) &#123;</span><br><span class="line">      nextOldFiber = oldFiber;</span><br><span class="line">      oldFiber = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nextOldFiber = oldFiber.<span class="property">sibling</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> newFiber = <span class="title function_">updateSlot</span>(</span><br><span class="line">      returnFiber,</span><br><span class="line">      oldFiber,</span><br><span class="line">      newChildren[newIdx],</span><br><span class="line">      lanes</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> This breaks on empty slots like null children. That&#x27;s</span></span><br><span class="line">      <span class="comment">// unfortunate because it triggers the slow path all the time. We need</span></span><br><span class="line">      <span class="comment">// a better way to communicate whether this was a miss or null,</span></span><br><span class="line">      <span class="comment">// boolean, undefined, etc.</span></span><br><span class="line">      <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        oldFiber = nextOldFiber;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldFiber &amp;&amp; newFiber.<span class="property">alternate</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We matched the slot, but we didn&#x27;t reuse the existing fiber, so we</span></span><br><span class="line">        <span class="comment">// need to delete the existing child.</span></span><br><span class="line">        <span class="title function_">deleteChild</span>(returnFiber, oldFiber);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastPlacedIndex = <span class="title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">      resultingFirstChild = newFiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Defer siblings if we&#x27;re not at the right index for this slot.</span></span><br><span class="line">      <span class="comment">// I.e. if we had null values before, then we want to defer this</span></span><br><span class="line">      <span class="comment">// for each null value. However, we also don&#x27;t want to call updateSlot</span></span><br><span class="line">      <span class="comment">// with the previous one.</span></span><br><span class="line">      previousNewFiber.<span class="property">sibling</span> = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    previousNewFiber = newFiber;</span><br><span class="line">    oldFiber = nextOldFiber;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newIdx === newChildren.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// We&#x27;ve reached the end of the new children. We can delete the rest.</span></span><br><span class="line">    <span class="title function_">deleteRemainingChildren</span>(returnFiber, oldFiber);</span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If we don&#x27;t have any more existing children we can choose a fast path</span></span><br><span class="line">    <span class="comment">// since the rest will all be insertions.</span></span><br><span class="line">    <span class="keyword">for</span> (; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">      <span class="keyword">var</span> _newFiber = <span class="title function_">createChild</span>(returnFiber, newChildren[newIdx], lanes);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (_newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      lastPlacedIndex = <span class="title function_">placeChild</span>(_newFiber, lastPlacedIndex, newIdx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move out of the loop. This only happens for the first run.</span></span><br><span class="line">        resultingFirstChild = _newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.<span class="property">sibling</span> = _newFiber;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      previousNewFiber = _newFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125; <span class="comment">// Add all children to a key map for quick lookups.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> existingChildren = <span class="title function_">mapRemainingChildren</span>(returnFiber, oldFiber); <span class="comment">// Keep scanning and use the map to restore deleted items as moves.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">var</span> _newFiber2 = <span class="title function_">updateFromMap</span>(</span><br><span class="line">      existingChildren,</span><br><span class="line">      returnFiber,</span><br><span class="line">      newIdx,</span><br><span class="line">      newChildren[newIdx],</span><br><span class="line">      lanes</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_newFiber2 !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_newFiber2.<span class="property">alternate</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// The new fiber is a work in progress, but if there exists a</span></span><br><span class="line">          <span class="comment">// current, that means that we reused the fiber. We need to delete</span></span><br><span class="line">          <span class="comment">// it from the child list so that we don&#x27;t add it to the deletion</span></span><br><span class="line">          <span class="comment">// list.</span></span><br><span class="line">          existingChildren.<span class="title function_">delete</span>(</span><br><span class="line">            _newFiber2.<span class="property">key</span> === <span class="literal">null</span> ? newIdx : _newFiber2.<span class="property">key</span></span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      lastPlacedIndex = <span class="title function_">placeChild</span>(_newFiber2, lastPlacedIndex, newIdx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        resultingFirstChild = _newFiber2;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.<span class="property">sibling</span> = _newFiber2;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      previousNewFiber = _newFiber2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">    <span class="comment">// Any existing children that weren&#x27;t consumed above were deleted. We need</span></span><br><span class="line">    <span class="comment">// to add them to the deletion list.</span></span><br><span class="line">    existingChildren.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">child</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">deleteChild</span>(returnFiber, child);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="属性-Diff"><a href="#属性-Diff" class="headerlink" title="属性 Diff"></a>属性 Diff</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">diffProperties</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domElement,</span></span><br><span class="line"><span class="params">  tag,</span></span><br><span class="line"><span class="params">  lastRawProps,</span></span><br><span class="line"><span class="params">  nextRawProps,</span></span><br><span class="line"><span class="params">  rootContainerElement</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// lastRawProps &#123;children:&#x27;内容&#x27;&#125;</span></span><br><span class="line">  <span class="comment">// nextRawProps &#123;children:&#x27;内容改变&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> updatePayload = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> lastProps;</span><br><span class="line">  <span class="keyword">var</span> nextProps;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这些元素类型,会被添加上特有的元素默认属性</span></span><br><span class="line">  <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;input&quot;</span>:</span><br><span class="line">      lastProps = <span class="title function_">getHostProps</span>(domElement, lastRawProps);</span><br><span class="line">      nextProps = <span class="title function_">getHostProps</span>(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;option&quot;</span>:</span><br><span class="line">      lastProps = <span class="title function_">getHostProps$1</span>(domElement, lastRawProps);</span><br><span class="line">      nextProps = <span class="title function_">getHostProps$1</span>(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;select&quot;</span>:</span><br><span class="line">      lastProps = <span class="title function_">getHostProps$2</span>(domElement, lastRawProps);</span><br><span class="line">      nextProps = <span class="title function_">getHostProps$2</span>(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;textarea&quot;</span>:</span><br><span class="line">      lastProps = <span class="title function_">getHostProps$3</span>(domElement, lastRawProps);</span><br><span class="line">      nextProps = <span class="title function_">getHostProps$3</span>(domElement, nextRawProps);</span><br><span class="line">      updatePayload = [];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      lastProps = lastRawProps;</span><br><span class="line">      nextProps = nextRawProps;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="keyword">typeof</span> lastProps.<span class="property">onClick</span> !== <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> nextProps.<span class="property">onClick</span> === <span class="string">&quot;function&quot;</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This cast may not be sound for SVG, MathML or custom elements.</span></span><br><span class="line">        <span class="title function_">trapClickOnNonInteractiveElement</span>(domElement);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证一些特殊属性,是否合法 例如 dangerouslySetInnerHTML</span></span><br><span class="line">  <span class="title function_">assertValidProps</span>(tag, nextProps);</span><br><span class="line">  <span class="keyword">var</span> propKey;</span><br><span class="line">  <span class="keyword">var</span> styleName;</span><br><span class="line">  <span class="keyword">var</span> styleUpdates = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (propKey <span class="keyword">in</span> lastProps) &#123;</span><br><span class="line">    <span class="comment">// 如果旧的属性没有,而新的属性有,那个就跳出直接分析新的属性</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      nextProps.<span class="title function_">hasOwnProperty</span>(propKey) ||</span><br><span class="line">      !lastProps.<span class="title function_">hasOwnProperty</span>(propKey) ||</span><br><span class="line">      lastProps[propKey] == <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propKey === <span class="variable constant_">STYLE</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> lastStyle = lastProps[propKey];</span><br><span class="line">      <span class="comment">// 如果是style属性,提取出属性的key</span></span><br><span class="line">      <span class="keyword">for</span> (styleName <span class="keyword">in</span> lastStyle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastStyle.<span class="title function_">hasOwnProperty</span>(styleName)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">            styleUpdates = &#123;&#125;;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          styleUpdates[styleName] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">DANGEROUSLY_SET_INNER_HTML</span> || propKey === <span class="variable constant_">CHILDREN</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      propKey === <span class="variable constant_">SUPPRESS_CONTENT_EDITABLE_WARNING</span> ||</span><br><span class="line">      propKey === <span class="variable constant_">SUPPRESS_HYDRATION_WARNING</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">AUTOFOCUS</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameDependencies.<span class="title function_">hasOwnProperty</span>(propKey)) &#123;</span><br><span class="line">      <span class="comment">// This is a special case. If any listener updates we need to ensure</span></span><br><span class="line">      <span class="comment">// that the &quot;current&quot; fiber pointer gets updated so we need a commit</span></span><br><span class="line">      <span class="comment">// to update this element.</span></span><br><span class="line">      <span class="keyword">if</span> (!updatePayload) &#123;</span><br><span class="line">        updatePayload = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// For all other deleted properties we add it to the queue. We use</span></span><br><span class="line">      <span class="comment">// the allowed property list in the commit phase instead.</span></span><br><span class="line">      (updatePayload = updatePayload || []).<span class="title function_">push</span>(propKey, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (propKey <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">    <span class="keyword">var</span> nextProp = nextProps[propKey];</span><br><span class="line">    <span class="keyword">var</span> lastProp = lastProps != <span class="literal">null</span> ? lastProps[propKey] : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果新的属性值为假,或者没有变化,就跳出循环</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !nextProps.<span class="title function_">hasOwnProperty</span>(propKey) ||</span><br><span class="line">      nextProp === lastProp ||</span><br><span class="line">      (nextProp == <span class="literal">null</span> &amp;&amp; lastProp == <span class="literal">null</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propKey === <span class="variable constant_">STYLE</span>) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextProp) &#123;</span><br><span class="line">          <span class="comment">// Freeze the next style object so that we can assume it won&#x27;t be</span></span><br><span class="line">          <span class="comment">// mutated. We have already warned for this in the past.</span></span><br><span class="line">          <span class="title class_">Object</span>.<span class="title function_">freeze</span>(nextProp);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (lastProp) &#123;</span><br><span class="line">        <span class="comment">// Unset styles on `lastProp` but not on `nextProp`.</span></span><br><span class="line">        <span class="keyword">for</span> (styleName <span class="keyword">in</span> lastProp) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            lastProp.<span class="title function_">hasOwnProperty</span>(styleName) &amp;&amp;</span><br><span class="line">            (!nextProp || !nextProp.<span class="title function_">hasOwnProperty</span>(styleName))</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">              styleUpdates = &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            styleUpdates[styleName] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="comment">// Update styles that changed since `lastProp`.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (styleName <span class="keyword">in</span> nextProp) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            nextProp.<span class="title function_">hasOwnProperty</span>(styleName) &amp;&amp;</span><br><span class="line">            lastProp[styleName] !== nextProp[styleName]</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">              styleUpdates = &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            styleUpdates[styleName] = nextProp[styleName];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Relies on `updateStylesByID` not mutating `styleUpdates`.</span></span><br><span class="line">        <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!updatePayload) &#123;</span><br><span class="line">            updatePayload = [];</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          updatePayload.<span class="title function_">push</span>(propKey, styleUpdates);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        styleUpdates = nextProp;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">DANGEROUSLY_SET_INNER_HTML</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> nextHtml = nextProp ? nextProp[<span class="variable constant_">HTML</span>$<span class="number">1</span>] : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">var</span> lastHtml = lastProp ? lastProp[<span class="variable constant_">HTML</span>$<span class="number">1</span>] : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextHtml != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastHtml !== nextHtml) &#123;</span><br><span class="line">          (updatePayload = updatePayload || []).<span class="title function_">push</span>(propKey, nextHtml);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  会以数组的形式,同时插入 key 和 value [&#x27;children&#x27;,&#x27;内容改变&#x27;]</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">CHILDREN</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp === <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> nextProp === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">        (updatePayload = updatePayload || []).<span class="title function_">push</span>(propKey, <span class="string">&quot;&quot;</span> + nextProp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      propKey === <span class="variable constant_">SUPPRESS_CONTENT_EDITABLE_WARNING</span> ||</span><br><span class="line">      propKey === <span class="variable constant_">SUPPRESS_HYDRATION_WARNING</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameDependencies.<span class="title function_">hasOwnProperty</span>(propKey)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextProp != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We eagerly listen to this even though we haven&#x27;t committed yet.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp !== <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">          <span class="title function_">warnForInvalidEventListener</span>(propKey, nextProp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (propKey === <span class="string">&quot;onScroll&quot;</span>) &#123;</span><br><span class="line">          <span class="title function_">listenToNonDelegatedEvent</span>(<span class="string">&quot;scroll&quot;</span>, domElement);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!updatePayload &amp;&amp; lastProp !== nextProp) &#123;</span><br><span class="line">        <span class="comment">// This is a special case. If any listener updates we need to ensure</span></span><br><span class="line">        <span class="comment">// that the &quot;current&quot; props pointer gets updated so we need a commit</span></span><br><span class="line">        <span class="comment">// to update this element.</span></span><br><span class="line">        updatePayload = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="keyword">typeof</span> nextProp === <span class="string">&quot;object&quot;</span> &amp;&amp;</span><br><span class="line">      nextProp !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      nextProp.<span class="property">$$typeof</span> === <span class="variable constant_">REACT_OPAQUE_ID_TYPE</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If we encounter useOpaqueReference&#x27;s opaque object, this means we are hydrating.</span></span><br><span class="line">      <span class="comment">// In this case, call the opaque object&#x27;s toString function which generates a new client</span></span><br><span class="line">      <span class="comment">// ID so client and server IDs match and throws to rerender.</span></span><br><span class="line">      nextProp.<span class="title function_">toString</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// For any other property we always add it to the queue and then we</span></span><br><span class="line">      <span class="comment">// filter it out using the allowed property list during the commit.</span></span><br><span class="line">      (updatePayload = updatePayload || []).<span class="title function_">push</span>(propKey, nextProp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (styleUpdates) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="title function_">validateShorthandPropertyCollisionInDev</span>(styleUpdates, nextProps[<span class="variable constant_">STYLE</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (updatePayload = updatePayload || []).<span class="title function_">push</span>(<span class="variable constant_">STYLE</span>, styleUpdates);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> updatePayload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          打赏
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/posts/bcb927b5ace5/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            CSS艺术 视觉效果
          
        </div>
      </a>
    
    
      <a href="/posts/2a574ab5dfc0/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">React源码分析 ⑥ Fiber与Effects链表</div>
      </a>
    
  </nav>

  
   
<div class="gitalk" id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.css">


<script src="https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.js"></script>


<script src="https://cdn.staticfile.org/blueimp-md5/2.19.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: 'bce2317b25da7c3c18f6',
    clientSecret: 'e0ab868ca9054234798be82c2b1c0c9dd8632307',
    repo: 'noopn.github.io',
    owner: 'noopn',
    admin: ['noopn'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last'
  })

  gitalk.render('gitalk-container')
</script>

     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> SunZhiqi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.png" alt="四月八日"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Essay">随笔</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>此时无声胜有声！</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="/js/jquery.modal.min.js"></script>
<link rel="stylesheet" href="/css/jquery.modal.min.css" />
<script src="/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
  <div class="pswp__bg"></div>

  <!-- Slides wrapper with overflow:hidden. -->
  <div class="pswp__scroll-wrap">
    <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>

    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <!--  Controls are self-explanatory. Order can be changed. -->

        <div class="pswp__counter"></div>

        <button
          class="pswp__button pswp__button--close"
          title="Close (Esc)"
        ></button>

        <button
          class="pswp__button pswp__button--share"
          style="display: none"
          title="Share"
        ></button>

        <button
          class="pswp__button pswp__button--fs"
          title="Toggle fullscreen"
        ></button>

        <button
          class="pswp__button pswp__button--zoom"
          title="Zoom in/out"
        ></button>

        <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
        <!-- element will get class pswp__preloader--active when preloader is running -->
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip"></div>
      </div>

      <button
        class="pswp__button pswp__button--arrow--left"
        title="Previous (arrow left)"
      ></button>

      <button
        class="pswp__button pswp__button--arrow--right"
        title="Next (arrow right)"
      ></button>

      <div class="pswp__caption">
        <div class="pswp__caption__center"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/photoswipe.min.css" />
<link rel="stylesheet" href="/css/default-skin.min.css" />
<script src="/js/photoswipe.min.js"></script>
<script src="/js/photoswipe-ui-default.min.js"></script>

<script>
  function viewer_init() {
    let pswpElement = document.querySelectorAll(".pswp")[0];
    let $imgArr = document.querySelectorAll(
      ".article-entry img:not(.reward-img)"
    );

    $imgArr.forEach(($em, i) => {
      $em.onclick = () => {
        // slider展开状态
        // todo: 这样不好，后面改成状态
        if (document.querySelector(".left-col.show")) return;
        let items = [];
        $imgArr.forEach(($em2, i2) => {
          let img = $em2.getAttribute("data-idx", i2);
          let src =
            $em2.getAttribute("data-target") || $em2.getAttribute("src");
          let title = $em2.getAttribute("alt");
          // 获得原图尺寸
          const image = new Image();
          image.src = src;
          items.push({
            src: src,
            w: image.width || $em2.width,
            h: image.height || $em2.height,
            title: title,
          });
        });
        var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
          index: parseInt(i),
        });
        gallery.init();
      };
    });
  }
  viewer_init();
</script>
 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="/js/MathJax.js"></script>
<script src="/js/TeX-AMS-MML_HTMLorMML-full.js"></script>

<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="/js/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !(function (e, t, a) {
    var initCopyCode = function () {
      var copyHtml = "";
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += "</button>";
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS(".btn-copy", {
        target: function (trigger) {
          return trigger.nextElementSibling;
        },
      });
      clipboard.on("success", function (e) {
        let $btn = $(e.trigger);
        $btn.addClass("copied");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-checkbox-circle-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPIED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-checkbox-circle-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
      clipboard.on("error", function (e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass("copy-failed");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-time-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPY FAILED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-time-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
    };
    initCopyCode();
  })(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "default" });
  }
</script>


    
    

  </div>
</body>

</html>