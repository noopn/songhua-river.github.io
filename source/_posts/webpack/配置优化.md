---
title: é…ç½®ä¼˜åŒ–
mathjax: true

date: 2021-01-21 02:08:38
categories:
  - webpack
tags:
  - å·¥ç¨‹åŒ–
  - webpack
---


##### HMR æ¨¡å—çƒ­æ›¿æ¢

å½“ä¸€ä¸ªæ¨¡å—æ”¹å˜æ—¶é¿å…æ‰€æœ‰çš„æ¨¡å—éƒ½è¢«é‡æ–°ç¼–è¯‘ä¸€æ¬¡ï¼Œåº”è¯¥åªæ›´æ–°ä¿®æ”¹çš„æ¨¡å—

é€šè¿‡ `hot:true` å¼€å¯hmrï¼Œæ­¤æ—¶æ ·å¼æ–‡ä»¶(.css .scss) å¯ä»¥è¿›è¡Œçƒ­æ¨¡å—æ›¿æ¢ï¼Œ`style-loader`å†…éƒ¨çš„å®žçŽ°ï¼Œä½†æ˜¯jsæ–‡ä»¶æ²¡æœ‰å¼€å¯çƒ­æ›¿æ¢ï¼Œè€Œä¸”htmlçš„æ–‡ä»¶ä¹Ÿä¸èƒ½æ›´æ–°äº†

å› ä¸ºçƒ­æ›¿æ¢é˜»æ­¢äº†åˆ·æ–°ï¼Œé€šè¿‡ä¿®æ”¹`webpack.config.js` å…¥å£é…ç½®`entry: ['./src/index.js','./src/index.html'],`,å¯ä»¥é‡æ–°å¼€å¯`index.html`çš„åˆ·æ–°åŠŸèƒ½

å¦å¤– `html`æ–‡ä»¶ä¸éœ€è¦çƒ­æ›¿æ¢çš„åŠŸèƒ½ï¼Œå› ä¸ºæ¯ä¸ªå…¥å£åªå¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€å®šè¦é‡æ–°åŠ è½½

`.js`æ–‡ä»¶çš„çƒ­æ›¿æ¢ä¸èƒ½æ˜¯å…¥å£æ–‡ä»¶

```javascript
if (module.hot) {
  module.hot.accept('./print.js', function() {
    console.log('Accepting the updated printMe module!');
    printMe();
  })
}
```

##### source-map

æä¾›æºä»£ç åˆ°ç¼–è¯‘åŽä»£ç æ˜ å°„çš„æ–¹æ¡ˆï¼Œå¯ä»¥è¿½è¸ªæºä»£ç çš„ä½ç½® é€šè¿‡[devtool](https://webpack.docschina.org/configuration/devtool/#root)é…ç½®

[inline-|hidden-|eval][nosources-][cheap-[module-]]source-map

inline æž„å»ºé€Ÿåº¦å¿«

source-map èƒ½æç¤ºé”™è¯¯ä»£ç å‡†ç¡®ä¿¡æ¯ï¼Œå’Œæºä»£ç ä¸­å‡†ç¡®ä½ç½®ï¼Œä¼šå•ç‹¬ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶

inline-source-map source-mapä¼šå†…åµŒåˆ°ç”Ÿæˆçš„jsæ–‡ä»¶ä¸­ï¼Œåªç”Ÿæˆä¸€ä¸ªå†…è”çš„source-map ï¼Œèƒ½æç¤ºé”™è¯¯ä»£ç å‡†ç¡®ä¿¡æ¯ï¼Œå’Œæºä»£ç ä¸­å‡†ç¡®ä½ç½®

eval-source-map source-mapä¼šå†…åµŒåˆ°ç”Ÿæˆçš„jsæ–‡ä»¶ä¸­,æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šç”Ÿæˆå¯¹åº”çš„source-mapï¼Œå¯ä»¥æç¤ºé”™è¯¯åŽŸå› ï¼Œä½†ä¸èƒ½è¿½è¸ªåˆ°æºä»£ç ä½ç½®ï¼Œåªä¼šå®šä½åˆ°ç¼–è¯‘åŽçš„é”™è¯¯ä½ç½®

hidden-source-map source-mapæ–‡ä»¶ä¼šå•ç‹¬ç”Ÿæˆï¼Œå¯ä»¥æç¤ºé”™è¯¯åŽŸå› ï¼Œä½†ä¸èƒ½è¿½è¸ªåˆ°æºä»£ç ä½ç½®ï¼Œåªä¼šå®šä½åˆ°ç¼–è¯‘åŽçš„é”™è¯¯ä½ç½®

cheap-source-map åœ¨å¤–éƒ¨å•ç‹¬ç”Ÿæˆï¼Œåªèƒ½æç¤ºåˆ°è¡Œï¼Œå¦‚æžœä»£ç åœ¨ä¸€è¡Œä¸­ï¼Œä¸èƒ½å‡†ç¡®çš„å®šä½

cheap-module-source-map åœ¨å¤–éƒ¨å•ç‹¬ç”Ÿæˆ ä¸Ž cheap-source-map ç±»ä¼¼,ä¼šå°†loaderçš„source-mapåŠ å…¥

nosources-source-map å¯ä»¥æä¾›ä½œç‰©ä¿¡æ¯ï¼Œä½†æ˜¯ä¸èƒ½å®šä½åˆ°é”™è¯¯ä½ç½®ï¼Œæºä»£ç å’Œç¼–è¯‘åŽä»£ç éƒ½ä¸å¯ä»¥

æ•°åº¦å¿«æ…¢: eval=> inline => cheap

å¼€å‘çŽ¯å¢ƒï¼šcheap-source-map
  é€Ÿåº¦å¿« 
    eval-cheap-source-map
    eval-source-map ðŸ†š
  è°ƒè¯•å‹å¥½
    source-map
    cheap-module-source-map
    cheap-source-map

ç”Ÿäº§çŽ¯å¢ƒ
  ç®€å•è°ƒè¯•ï¼Œ
  å†…è”ä¼šè®©ä½“ç§¯å˜å¤§
  nosources-source-map å…¨éƒ¨éšè—ä»£ç ï¼Œåœ¨çº¿ä¸ŠçŽ¯å¢ƒä½¿ç”¨ðŸ†š
  hidden-source-map  åªéšè—æºä»£ç 

  source-map ðŸ†š,å•ç‹¬ç”Ÿæˆæ–‡ä»¶ä¸”ä¾¿äºŽè°ƒè¯•

#### oneOf

ç”¨äºŽæå‡æž„å»ºçš„é€Ÿåº¦ï¼Œåªè¦æœ‰ä¸€ä¸ªloaderåŒ¹é…åˆ°å°±ä¸ä¼šç»§ç»­åŒ¹é…

```javascript
{
  module: {
    rules: [
      {
        //...
        // æŒ‡å®šä¼˜å…ˆçº§ï¼Œéƒ½ä¼šå…ˆè¢«è¿™ä¸ªloaderå¤„ç†
        enforce:'pre'
      }ï¼Œ
      {
        oneOf:[
          // å…¶ä»–çš„loader
        ]
      }
    ]
  }
}
```


#### ç¼“å­˜

åœ¨ç¼–è¯‘æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æžœä¾èµ–æ–‡ä»¶æ²¡æœ‰æ”¹å˜ï¼Œåˆ™ç›´æŽ¥ä½¿ç”¨ç¼–è¯‘å¥½çš„ç¼“å­˜æ–‡ä»¶ï¼Œæ— éœ€æ‰€æœ‰æ–‡ä»¶éƒ½é‡æ–°ç¼–è¯‘

```javascript
{
  test: /\.js$/i,
  use: [{
    loader: 'babel-loader',
    options:{
      cacheDirectory:true
    }
  }],
},
```

æ–‡ä»¶èµ„æºçš„ç¼“å­˜ 

+ hash å¦‚æžœéƒ½ä½¿ç”¨hashçš„è¯ï¼Œå³æ¯æ¬¡ä¿®æ”¹ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€æœ‰æ–‡ä»¶åçš„hashè‡³éƒ½å°†æ”¹å˜ã€‚æ‰€ä»¥ä¸€æ—¦ä¿®æ”¹äº†ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ï¼Œæ•´ä¸ªé¡¹ç›®çš„æ–‡ä»¶ç¼“å­˜éƒ½å°†å¤±æ•ˆ.

+ chunkhash chunkhashæ ¹æ®ä¸åŒçš„å…¥å£æ–‡ä»¶(Entry)è¿›è¡Œä¾èµ–æ–‡ä»¶è§£æžã€æž„å»ºå¯¹åº”çš„chunkï¼Œç”Ÿæˆå¯¹åº”çš„å“ˆå¸Œå€¼ã€‚åœ¨ç”Ÿäº§çŽ¯å¢ƒé‡ŒæŠŠä¸€äº›å…¬å…±åº“å’Œç¨‹åºå…¥å£æ–‡ä»¶åŒºåˆ†å¼€ï¼Œå•ç‹¬æ‰“åŒ…æž„å»ºï¼ŒæŽ¥ç€æˆ‘ä»¬é‡‡ç”¨chunkhashçš„æ–¹å¼ç”Ÿæˆå“ˆå¸Œå€¼ï¼Œé‚£ä¹ˆåªè¦æˆ‘ä»¬ä¸æ”¹åŠ¨å…¬å…±åº“çš„ä»£ç ï¼Œå°±å¯ä»¥ä¿è¯å…¶å“ˆå¸Œå€¼ä¸ä¼šå—å½±å“ã€‚åŠ¨æ€importä¹Ÿå—chunkhashçš„å½±å“.

å› ä¸ºæˆ‘ä»¬æ˜¯å°†æ ·å¼ä½œä¸ºæ¨¡å—importåˆ°JavaScriptæ–‡ä»¶ä¸­çš„ï¼Œæ‰€ä»¥å®ƒä»¬çš„chunkhashæ˜¯ä¸€è‡´çš„,è¿™æ ·å°±ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œåªè¦å¯¹åº”cssæˆ–åˆ™jsæ”¹å˜ï¼Œä¸Žå…¶å…³è”çš„æ–‡ä»¶hashå€¼ä¹Ÿä¼šæ”¹å˜ï¼Œä½†å…¶å†…å®¹å¹¶æ²¡æœ‰æ”¹å˜å‘¢ï¼Œæ‰€ä»¥æ²¡æœ‰è¾¾åˆ°ç¼“å­˜æ„ä¹‰ã€‚å›ºcontenthashçš„ç”¨é€”éšä¹‹è€Œæ¥ã€‚

+ contenthashæ˜¯é’ˆå¯¹æ–‡ä»¶å†…å®¹çº§åˆ«çš„ï¼Œåªæœ‰ä½ è‡ªå·±æ¨¡å—çš„å†…å®¹å˜äº†ï¼Œé‚£ä¹ˆhashå€¼æ‰æ”¹å˜


#### tree-shaking

ä½¿ç”¨es6æ¨¡å—åŒ–è§„èŒƒï¼Œå¼€å¯productionæ¨¡å¼ï¼Œwebpackä¼šè‡ªåŠ¨å¯ç”¨tree-shaking

`webpack.config.js` ä¸­æ·»åŠ `sideEffects:false`è¡¨ç¤ºæ‰€æœ‰çš„ä»£ç éƒ½æ²¡æœ‰å‰¯ä½œç”¨ï¼Œå¦‚æžœæ ‡è®°ä¸º`false`, å…¨å±€å¼•å…¥çš„æ–‡ä»¶(polyfile),æˆ–æ²¡æœ‰é€šè¿‡æ¨¡å—åŒ–ä½¿ç”¨çš„css,éƒ½ä¼šè¢«åˆ é™¤

å¯ä»¥é€šè¿‡ä¸€ä¸ªæ•°ç»„æ¥æ ‡è®°ä¸éœ€è¦å¤„ç†çš„èµ„æº `sideEffects:['*.css']`

#### ä»£ç åˆ†å‰² code-split

**ç”Ÿæˆchunkçš„å‡ ç§æ–¹å¼**

+ å¤šé¡µé¢entryç”Ÿæˆå¤šä¸ªchunk
+ å¼‚æ­¥ç»„ä»¶ç”Ÿæˆchunk
+ code split 

```javascript
// å°†node-modules ä¸­ä»£ç å•ç‹¬æ‰“åŒ…æˆ
// åˆ†æžå¤šå…¥å£æ–‡ä»¶ä¸­æœ‰æ²¡æœ‰å…¬å…±çš„ä¾èµ–ï¼Œä¼šæŠŠä¾èµ–å•ç‹¬æ‰“åŒ…
optimization: {
  splitChunks: {
    chunks: 'all'
  }
},
```

#### æ‡’åŠ è½½ é¢„åŠ è½½

[dynamic-imports](https://webpack.docschina.org/guides/code-splitting/#dynamic-imports)

`babel-loader`ä¼šè‡ªåŠ¨å¤„ç† `dynamic-imports`è¯­æ³•ï¼Œ å¦‚æžœ`eslint`æç¤ºé”™è¯¯ï¼Œåœ¨`.eslintrc`ä¸­æ·»åŠ `"parser": "babel-eslint"`

#### PWA

work-box -> [workbox-webpack-plugin](https://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin)

```javascript
yarn add -D workbox-webpack-plugin
```

`webpack.config.js` ä¸­æ·»åŠ æ’ä»¶å’Œ[é…ç½®é¡¹](https://developers.google.com/web/tools/workbox/reference-docs/latest/module-workbox-webpack-plugin.GenerateSW#GenerateSW)

```javascript
{
  plugins:[
    //...
    new GenerateSW({
      // å¸®åŠ©serviceWorkå¿«é€Ÿå¯åŠ¨ï¼Œ
      // åˆ é™¤æ—§çš„serverwork
      clientsClaim:true,
      skipWaiting:true
    })
  ]
}
```

æ³¨å†Œservicework

åœ¨å…¥å£æ–‡ä»¶`index.js`ä¸­

```javascript
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(() => {
        console.log('æ³¨å†ŒæˆåŠŸ');
      })
      .catch(() => {
        console.log('æ³¨å†Œå¤±è´¥');
      });
  });
}
```

å¦‚æžœ`eslint`ä¸æ”¯æŒå…¨å±€å˜é‡,åœ¨`.eslinrc`æ·»åŠ `{env:browser: true,}`

#### å¤šè¿›ç¨‹æ‰“åŒ…

[thread-loader](https://www.npmjs.com/package/thread-loader)

è¿›ç¨‹çš„å¯ç”¨ä¼šå ç”¨æ—¶é—´ï¼ˆå¤§çº¦600msï¼‰ï¼Œåªæœ‰å¤æ‚çš„ä»»åŠ¡å¤„ç†çš„æ—¶å€™æ‰ä¼šæœ‰æ˜Žæ˜¾çš„æ•ˆæžœ


#### externals å¿½ç•¥æŸäº›èµ„æº

åœ¨`webpack.config.js`ä¸­æ·»åŠ [`externals`](https://webpack.docschina.org/configuration/externals/#root)

```javascript
module.exports = {
  //...
  externals: {
    jquery: 'jQuery'
  }
};
```

å’Œdllçš„åŒºåˆ«æ˜¯ï¼Œexternalså¹¶æ²¡æœ‰æ‰“åŒ…æ–‡ä»¶ï¼Œéœ€è¦é€šè¿‡cdnçš„æ–¹å¼å¼•å…¥è¿›æ¥ï¼Œdllåªæ˜¯æŠŠæŒ‡å®šçš„åŒ…å•ç‹¬æ‰“åŒ…ï¼Œå¹¶é€šè¿‡æ’ä»¶æŠŠå•ç‹¬æ‰“åŒ…çš„æ–‡ä»¶é‡æ–°å¼•å…¥

#### dll 

å¯¹ç¬¬ä¸‰æ–¹çš„åº“ï¼Œè¿›è¡Œå•ç‹¬æ‰“åŒ… webpack5ä¸é€‚ç”¨

é€šè¿‡ä¸¤ä»½é…ç½®ï¼Œå¯ä»¥é¿å…æ¯æ¬¡å¯¹ç¬¬ä¸‰æ–¹çš„åº“é‡æ–°æ‰“åŒ…

webpack.dll.js

```javascript
const path = require('path');
const webpack = require('webpack');

module.exports = {
  entry:{
    lodash:['lodash'],
    jquery:['jquery'],
    moment:["moment"]
  },
  output:{
    // ç”Ÿæˆæ–‡ä»¶çš„åç§°
    filename:'[name]_[contenthash:8].js',
    path:path.resolve(__dirname,'dll'),
    // å•ç‹¬æ‰“åŒ…çš„åº“å¯¹å¤–æš´éœ²çš„åç§°
    library: "[name]_[fullhash]"
  },
  plugins:[
    new webpack.DllPlugin({
      context: __dirname,
      // æ˜ å°„å•ç‹¬æ‰“åŒ…çš„åº“çš„åç§°
      name: '[name]_[fullhash]',
      // ç”Ÿæˆçš„manifestæ–‡ä»¶
      path:path.resolve(__dirname,'dll/[name]_manifest.json')
    })
  ],
  mode:'production'
}
```

webpack.config.js

ä½¿ç”¨ [add-asset-html-webpack-plugin](https://www.npmjs.com/package/add-asset-html-webpack-plugin)æŠŠå•ç‹¬æ‰“åŒ…çš„èµ„æºå¼•å…¥

```javascript
module.export = {
  plugins:[
    new webpack.DllReferencePlugin({
      // å­˜åœ¨äºŽmanifestæ–‡ä»¶ä¸­çš„åŒ…ï¼Œä¸ä¼šè¢«æ‰“åŒ…
			manifest: require(path.resolve(__dirname,'dll/moment_manifest.json'))
    }),
    new webpack.DllReferencePlugin({
			manifest: require(path.resolve(__dirname,'dll/lodash_manifest.json'))
    }),
    new webpack.DllReferencePlugin({
			manifest: require(path.resolve(__dirname,'dll/jquery_manifest.json'))
		}),
    new AddAssetHtmlPlugin({
      filepath: path.resolve(__dirname, './dll/*.js'),
    })
  ]
}

```

#### optimization

```javascript
{
  optimization: {
    minimize: true,
    // https://webpack.docschina.org/plugins/terser-webpack-plugin/
    minimizer: [new TerserPlugin({
      cache:true,// å¼€å¯ç¼“å­˜
      parallel:true,//å¤šè¿›ç¨‹æ‰“åŒ…
      sourceMap:true //å¯ç”¨source-map
    })],
   splitChunks: {
      // asyncè¡¨ç¤ºåªä»Žå¼‚æ­¥åŠ è½½å¾—æ¨¡å—ï¼ˆåŠ¨æ€åŠ è½½import()ï¼‰é‡Œé¢è¿›è¡Œæ‹†åˆ†
      // initialè¡¨ç¤ºåªä»Žå…¥å£æ¨¡å—è¿›è¡Œæ‹†åˆ†
      // allè¡¨ç¤ºä»¥ä¸Šä¸¤è€…éƒ½åŒ…æ‹¬
      chunks: 'async', //all 
      minSize: 1024 * 30 , //åˆ†å‰²chunkçš„æœ€å°å¤§å°ï¼Œå¤§äºŽ30kbæ‰ä¼šè¢«æå–
      minRemainingSize: 0,
      maxSize: 0,// æ²¡æœ‰æœ€å¤§é™åˆ¶
      minChunks: 1, // è‡³å°‘è¢«å¼•ç”¨ä¸€æ¬¡
      // æŒ‰éœ€åŠ è½½çš„æ—¶å€™å¹¶è¡ŒåŠ è½½æ–‡ä»¶çš„æœ€å¤§ä¸ªæ•°
      // å¯ä»¥ç†è§£ä¸ºé’ˆå¯¹ä¸€ä¸ªæ¨¡å—æ‹†åˆ†åŽçš„ä¸ªæ•°ï¼ŒåŒ…æ‹¬æ¨¡å—æœ¬èº«
      // import()æ–‡ä»¶æœ¬èº«ç®—ä¸€ä¸ªè¯·æ±‚
      // å¹¶ä¸ç®—jsä»¥å¤–çš„å…¬å…±èµ„æºè¯·æ±‚æ¯”å¦‚css
      // å¦‚æžœåŒæ—¶æœ‰ä¸¤ä¸ªæ¨¡å—æ»¡è¶³cacheGroupçš„è§„åˆ™è¦è¿›è¡Œæ‹†åˆ†ï¼Œä½†æ˜¯maxInitialRequestsçš„å€¼åªèƒ½å…è®¸å†æ‹†åˆ†ä¸€ä¸ªæ¨¡å—ï¼Œé‚£å°ºå¯¸æ›´å¤§çš„æ¨¡å—ä¼šè¢«æ‹†åˆ†å‡ºæ¥
      // ä¸€ä¸ªæŒ‰éœ€åŠ è½½çš„åŒ…æœ€ç»ˆè¢«æ‹†åˆ†æˆ n ä¸ªåŒ…ï¼ŒmaxAsyncRequests å°±æ˜¯ç”¨æ¥é™åˆ¶ n çš„æœ€å¤§å€¼ã€‚
      maxAsyncRequests: 30, 
      maxInitialRequests: 30, //å…¥å£jsæ–‡ä»¶æœ€å¤§è¯·æ±‚æ•°é‡
      enforceSizeThreshold: 50000,
      name: true, // å¯ä»¥ä½¿ç”¨å‘½åè§„åˆ™
      cacheGroups: {
        // node_moduleä¸­çš„åŒ…ä¼šè¢«å¼•å…¥åˆ°defaultVendorsåŒ…ä¸­
        defaultVendors: {
          test: /[\\/]node_modules[\\/]/,
          priority: -10,
          // å¦‚æžœå½“å‰æ‰“åŒ…çš„æ¨¡å—å’Œä¹‹å‰çš„æ˜¯åŒä¸€ä¸ªå°±ä¼šå¤ç”¨ï¼Œè€Œä¸æ˜¯é‡å¤æ‰“åŒ…
          reuseExistingChunk: true,
        },
        default: {
          minChunks: 2,
          priority: -20,
          reuseExistingChunk: true,
        },
      },
      // å°†å½“å‰æ¨¡å—ä¸­è®°å½•çš„å…¶ä»–æ¨¡å—çš„hashå•ç‹¬æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶
      // å› ä¸ºå¦‚æžœmain.js å¼•ç”¨ a.js,main.jsä¸­ä¼šä¿å­˜a.jsæ‰“åŒ…æ—¶ç”Ÿæˆçš„cotenthash
      // å¦‚æžœa.jså‘ç”Ÿæ”¹å˜åˆ™contenthashå‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆmain.jsçš„contenthashä¹Ÿä¼šæ”¹å˜
      // ä»£ç åˆ†å‰²çš„æ—¶å€™ä¸€å®šè¦åŠ 
      runtimeChunk:()=> {
        name:entrypoint=>`runtime-${entrypoint.name}`
      }
    },

  },
}
```