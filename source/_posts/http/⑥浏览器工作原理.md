---
layout: posts
title: 浏览器工作原理 ⑥ 页面元素
date: 2022-08-08 09:18:10
categories:
  - HTTP与浏览器
tags:
  - HTTP
  - 浏览器
---

#### 时间线面板的参数

![](0001.png)

+ **Queuing 排队时间** 

图片,音频等低优先级资源可能需要给 css, js 等高优先级资源让路，所以进入排队状态。
同一域名下只允许6个Tcp链接，解决方法可以是使用多个二级域名，或升级http2.

+ **Stalled 停滞事件**

在真正发起链接之前，还会有因为其他原因暂停一段时间。

+ **Request sent 发送数据时间**

因为不需要关心数据是否发送成功，这一时间一般都比较快。

+ **Waiting for server**

一般也叫做TTFB,第一字节响应时间，发起请求后到收到第一个相应字节花费的时间。
慢的原因可能是服务器生成页面时间过久，请求头中携带的cookie过多，也可能是网络原因。


+ **Content Download**

从接受第一个字节到收到全部数据所用的时间。

#### JS,CSS 对DOM解析的影响

HTML解析器（HTML Parser）实现DOM有三个作用:
+ 描述页面结构
+ 提供Api供JS消费
+ 安全防护，防止不安全的内容

DOM的解析和文档的加载是同步执行的，网络进程回合渲染进程创建管道链接，HTML文档会以字节流的形式发送到渲染进程中。

解析的过程是通过分词器将字节流分成不同的Token,如果是StartTag会被压入栈中，栈中默认有一个Document根节点，如果是EndTag并且匹配就会弹出栈。

当在解析的过程中遇到了script标签，因为JS脚本可能会修改DOM结构，所以会暂停HTML的解析，而且当前script标签后面的元素是访问不到的。

如果script标签是一个外部资源的引用，就会停止HTML解析并下载JS文件，因为下载文件是一个耗时的操作，所以浏览器本身会做一些优化，其中包括**预解析操作**，浏览器会单独开启一个线程，解析页面中的JS,CSS资源，并将这些资源提前下载。

另外如果JS文件中没有操作DOM的逻辑，可以使用async,defer属性，让JS文件而HTML解析，并行执行。

CSS文件加载和JS的加载也是同步进行的，但是一定要等CSS加载结束之后并生成 CSSOM 之后，才会执行JS脚本。


#### 分层，分块，与合成机制

显示图像的本质就是不断从显卡的前缓冲区中读取图片并绘制到显示器的过程，创建图片的频率和显示器的刷新率一般相同，新创建的图片会放到后缓冲区，并将前后缓冲区互换。

绘制一帧图像的方式，可能是重排，重绘，合成，其中的一个或是几个。不同的方式需要的性能不同。

实现合成的目的就是避免每一帧都需要整个页面经历重排重绘的过程，从而提高绘制性能。浏览器会将某些属性下的元素，或特定的元素单独分出一层。生成布局树之后，渲染引擎会根据布局树的特点将其转换为层树（Layer Tree）。

另外，绘制图片的过程并不是真的在显卡内存中保存一帧图片，而是生成一个绘制指令列表，层树中的每一层对应着一张待合成的图片，最终合成线程会将这些图层合成一张完整的图片，并发送到后缓冲区中。

也因为是在合成线程执行的原因，当JS主线程卡住的时候，CSS动画还是可以一直执行。

分块是浏览器为了提升绘制性能，在底层做的一些优化，对用户来讲是无感的。分块的目的是优先绘制靠近视口的图块，因为整个页面可能比较大，只绘制用户可见范围即可。不过有时候， 即使只绘制那些优先级最高的图块，也要耗费不少的时间，因为涉及到一个很关键的因素——**纹理上传**，这是因为从计算机内存上传到 GPU 内存的操作会比较慢。Chrome 又采取了一个策略：在首次合成图块的时候使用一个低分辨率的图片。比如可以是正常分辨率的一半，分辨率减少一半，纹理就减少了四分之三。在首次显示页面内容的时候，将这个低分辨率的图片显示出来，然后合成器继续绘制正常比例的网页内容，当正常比例的网页内容绘制完成后，再替换掉当前显示的低分辨率内容。这种方式会让用户在开始时看到的是低分辨率的内容,但会降低等待时间

CSS will-change 属性会让元素单独在一层中，从而优化变换时的性能。

#### PWA

Progressive Web App 渐进式应用， 相当于渐进式 + web应用

下面来理解一下渐进式的含义, PWA让Web应用逐渐拥有本地应用的能力，可以逐步支持各种新的技术，不断优化加载速度，动画效果等。不断的缩短与本地应用的距离，这种理念下的技术都算是PWA.

Web应用相对于本地应用缺少：

+ 离线，或弱网环境中的使用能力。(serviceWorker)
+ web应用缺少了消息推送能力 (serviceWorker)
+ web应用缺少一级入口，希望可以从桌面直接打开而不是在浏览器中。(manifest.json)

